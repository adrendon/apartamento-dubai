(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[1996],{93084:(t,e,i)=>{"use strict";i.d(e,{m:()=>g});var s=i(74848),a=i(22432),o=i(95846),n=i(89395),r=i(28479),h=i(13397),l=i(95143),d=i(93137),c=i(88372),u=i(48463),p=i(55666),m=i(68375);const g=({item:t})=>{const e=(0,m.s)(),i=(0,o.B)(t.id),g=(0,h.e)(),f=(0,n.E)(),v=(0,r.L)();if(!i)return null;const{id:b,textParser:S,title:y,description:C,icon:E}=t,x=b===f,L=i.info.type===a.S.FloorplanOnly?"floorplan":"dollhouse",D=g?(0,l.x8)(y,g):y,w=g?(0,l.x8)(C,g):C,I=(0,s.jsxs)("div",{className:"item-details",children:[(0,s.jsxs)("div",{className:"item-header",children:[(0,s.jsx)(p.L,{text:D||"",textParser:S,markers:l.S8}),(0,s.jsx)("div",{className:"list-item-decal",children:(0,s.jsx)(d.I,{name:L})})]}),C&&(0,s.jsx)("div",{className:"item-description",children:(0,s.jsx)(p.L,{text:w,textParser:S,markers:l.S8})})]});return(0,s.jsx)(c.c,{id:b,className:"search-result-item",title:I,active:x,disabled:!t.enabled,onClick:async()=>{e.trackGuiEvent("search_item_measurement_click",{tool:v}),t.onSelect()},badge:(0,s.jsx)(u.E,{iconClass:E})},b)}},84414:(t,e,i)=>{"use strict";i.d(e,{JU:()=>r,rn:()=>o,tz:()=>n});var s=i(77201),a=i(68909);const o=30,n=1;class r extends s.vm{constructor(){super(...arguments),this.position=new a.Vector3,this.floorId="",this.sid="",this.layerId="",this.text="",this.visible=!1,this.roomId=void 0,this.created=new Date,this.modified=new Date,this.version="3.1"}copy(t){return this.floorId=t.floorId,this.roomId=t.roomId,this.sid=t.sid,this.text=t.text,this.visible=t.visible,this.roomId=t.roomId,this.created=t.created,this.modified=t.modified,this.position.copy(t.position),this.version=t.version,this.commit(),this}}},80500:(t,e,i)=>{"use strict";i.d(e,{D:()=>r,M:()=>h});var s=i(68909),a=i(92237),o=i(93790),n=i(76571);const r={OpacityMaxDefault:1,OpacityMaxNonSelected:.4};class h extends s.Object3D{constructor(t){super(),this.text=t,this.maxOpacity=1,this.labelAnim=new a.z(0),this.filtered=!1,this.hidden=!1,this.selectState={active:!1,on:()=>{},off:()=>{}},this.validState={active:!0,on:()=>{const t=this.hoverState.active?n.RD.ColorHovered:n.RD.ColorDefault;this.text.setColor(t)},off:()=>{this.text.setColor(n.RD.ColorInvalid)}},this.hoverState={active:!1,on:()=>{this.validState.active&&this.text.setColor(n.RD.ColorHovered)},off:()=>{this.validState.active&&this.text.setColor(n.RD.ColorDefault)}},this.add(t)}use(t){this.data=t,this.userData.sid=t.sid,this.userData.data=t,this.text.use(this),this.labelUpdate(t.position,new s.Quaternion,"")}getId(){return this.data.sid}labelVisible(){return!this.filtered&&!this.hidden}updatePose(t,e){return this.labelUpdate(t,e,this.data.text),this}setMaxOpacity(t){this.maxOpacity=t,this.toggleLabel(this.labelVisible())}free(){this.labelAnim.value>0&&this.toggleLabel(!1)}tickAnimations(t){return this.animateLabelOpacity(.5*t),this}toggleLabel(t){this.hidden=!t,this.updateOpacity()}isHidden(){return this.hidden}toggleFiltered(t){t!==this.filtered&&(this.filtered=t,this.updateOpacity())}updateOpacity(){const t=this.labelVisible()?this.maxOpacity:0;this.labelAnim.endValue!==t&&this.labelAnim.modifyAnimation(this.labelAnim.value,t,o.Q.FADE_DURATION)}animateLabelOpacity(t){const e=this.labelAnim.tick(t);Math.min(e,this.maxOpacity)!==this.text.opacity&&(this.text.opacity=e)}labelUpdate(t,e,i){this.text.position.copy(t),this.text.quaternion.copy(e),this.text.text=i}billboard(t,e,i,s,a,o,n){this.text.scaleBillboard(t,e,i,s,a,o,n)}}},76571:(t,e,i)=>{"use strict";i.d(e,{F5:()=>h,RD:()=>n,Z3:()=>r});var s=i(52514),a=i(68909),o=i(38069);const n={ColorDefault:o.V.WHITE.clone(),ColorHovered:o.V.MP_BRAND.clone(),ColorInvalid:new a.Color(16750933)};class r extends s.QM{use(t){this.userData.sid=t.data.sid,this.collider.data=t.data,this.collider.name=t.data.text,this.collider.labelMesh=t}}class h extends a.Mesh{constructor(){super(...arguments),this.hitTest=(()=>{const t=new a.Matrix4,e=new a.Ray,i=new a.Plane(new a.Vector3(0,0,-1)),s=new a.Vector3;return(a,o)=>{if(t.copy(this.matrixWorld).invert(),e.copy(a.ray).applyMatrix4(t),e.intersectPlane(i,s)){const t=this.scale.x/this.scale.y;let e=.5;t<1.5&&(e=1/t),Math.abs(s.x)<=e&&Math.abs(s.y)<=.75&&(s.applyMatrix4(this.matrixWorld),o.push({distance:a.ray.origin.distanceTo(s),point:s.clone(),object:this}))}}})()}labelVisible(){return!(!this.labelMesh||!this.labelMesh.labelVisible())}getId(){if(!this.data)throw new Error("LabelInputCollider used before configure");return this.data.sid}raycast(t,e){if(!this.labelVisible())return;if(this.material.depthTest)return void this.hitTest(t,e);const i=this.material.depthTest?e:[];this.hitTest(t,i),i.length>0&&(i[0].distance/=1e4,e.push(i[0]))}}},93790:(t,e,i)=>{"use strict";i.d(e,{Q:()=>a,n:()=>s});const s=30,a={LABEL_SIZE:0,FADE_DURATION:200}},18952:(t,e,i)=>{"use strict";i.d(e,{CW:()=>d,yp:()=>u});var s=i(68909),a=i(53172),o=i(19968);const n=new s.Vector2,r=new s.Vector3,h=new s.Vector2,l=new s.Vector2,d=(t,e,i)=>{const s=((t,e,i)=>((0,o.bz)(i,t,h),(0,o.bz)(i,e,l),{pixelDistance:h.distanceTo(l),startScreenPosition:h,endScreenPosition:l}))(t,e,i),a=((t,e,i)=>(r.copy(t).add(e).multiplyScalar(.5),(0,o.bz)(i,r,n),n))(t,e,i);return{screenPosition:a,rotation:c(h,l),pixelDistance:s.pixelDistance,startScreenPosition:s.startScreenPosition,endScreenPosition:s.endScreenPosition}},c=(t,e)=>{const i=t.y-e.y,s=t.x-e.x;let o=Math.atan2(i,s)*a.tm;return o=o>=90||o<=-90?o+180:o,o},u=(t,e=10,i=40)=>({width:Math.max(9*Math.max(t,2)+e,i),height:18+e})},74061:(t,e,i)=>{"use strict";i.d(e,{k:()=>a});var s=i(77201);class a extends s.uB{constructor(t,e=""){super(),this.payload={sid:t,text:e}}}a.id="RENAME_MEASUREMENT"},76863:(t,e,i)=>{"use strict";i.d(e,{k:()=>a});var s=i(77201);class a extends s.uB{constructor(t,...e){super(),this.payload={sids:e,visible:t}}}a.id="MEASUREMENTS_SET_VISIBILITY"},72068:(t,e,i)=>{"use strict";i.d(e,{Yp:()=>l,ZP:()=>d,_U:()=>a,_s:()=>u,d:()=>c,eT:()=>o,gy:()=>n,i7:()=>r,rS:()=>h});var s=i(69483);const a=.01,o=.001,n={highResThreshold:1081,desktopSize:192,desktopSizeHighRes:320,mobileSize:128},r={smoothness:.4,perspective:{fov:40,thresholdClose:1,thresholdFar:8,offsetClose:.25,offsetFar:.5,scale:1},ortho:{fov:5,thresholdClose:5,thresholdFar:20,offsetClose:15,offsetFar:30,scale:4}},h={desktop:s.tx.Edges,floorplan:s.tx.Axes,mobile:s.tx.Edges,alt:s.tx.Free,shift:s.tx.PlanarAxes,shiftAlt:s.tx.EdgesAndPlanarAxes,disabled:s.tx.Free},l={mobile:.15,desktop:.1},d={SCALE:.1,SCALE_NDC:.5,SCALE_ASPECT:.035,SCALE_DISTANCE:.025},c="measurements",u=24},22432:(t,e,i)=>{"use strict";var s;i.d(e,{S:()=>s}),function(t){t[t.FloorplanOnly=0]="FloorplanOnly",t[t.ThreeD=1]="ThreeD"}(s||(s={}))},73026:(t,e,i)=>{"use strict";i.d(e,{k:()=>n});var s=i(68909),a=i(86324),o=i(60552);class n extends s.Object3D{constructor(t,e){super(),this.units=t,this.roomBoundViewData=e,this.userIsInside=!1,this.currentRoomHeight=0,this.linesInScene=!1,this.removeLineTimeout=null,this.linesInScene=!1}onLinesAdded(){}onLinesRemoved(){}onRender(t){const{solid:e,faded:i}=this.calcOpacities(t);(e>.1||i>.1)&&this.userIsInside&&this.roomBoundViewData.roomDimensionsVisible?this.addLinesToScene():this.removeLinesFromScene()}addLinesToScene(){if(!this.linesInScene){for(const t of this.lineSceneObjs())this.add(t),t.startTransition();this.onLinesAdded(),this.linesInScene=!0,this.removeLineTimeout&&(window.clearTimeout(this.removeLineTimeout),this.removeLineTimeout=null)}}removeLinesFromScene(){if(this.linesInScene){const t=()=>{for(const t of this.lineSceneObjs())this.remove(t);this.onLinesRemoved(),this.removeLineTimeout=null};null!=this.removeLineTimeout&&(window.clearTimeout(this.removeLineTimeout),this.removeLineTimeout=null);for(const t of this.lineSceneObjs())t.startTransition(a.ES.FADE_OUT);this.removeLineTimeout=window.setTimeout(t,o.rH),this.linesInScene=!1}}setUserIsInsideRoom(t,e){this.userIsInside=t,this.currentRoomHeight=e}updateUnits(t){this.units=t,this.updateLabelEndpoints()}}},13199:(t,e,i)=>{"use strict";i.d(e,{y:()=>p});var s=i(38069),a=i(25601),o=i(52885),n=i(94814),r=i(68909),h=i(71101),l=i(23689),d=i(60552),c=i(41644);const u={baseState:{innerColor:s.V.WHITE,outerColor:s.V.WHITE,opacity:1},hoverState:{innerColor:s.V.WHITE,outerColor:s.V.NEPTUNE,opacity:1},selectState:{innerColor:s.V.WHITE,outerColor:s.V.NEPTUNE,opacity:1},dimState:{innerColor:s.V.WHITE,outerColor:s.V.WHITE,opacity:.5},highlightState:{innerColor:s.V.WHITE,outerColor:s.V.NEPTUNE,opacity:1}};class p extends l.r{constructor(t,e,i,l,c,p){super(t,e,i),this.floorId=e,this.instanceBuffer=l,this.lineLabel=c,this.isAddState=p,this.line3=new r.Line3(new r.Vector3,new r.Vector3),this.widthCache=.1,this.currOutlineColor=new r.Color,this.currInnerColor=new r.Color,this.updateMaterial=()=>{super.updateMaterial(),this.targetColorScheme!==u.highlightState||this.isAddState()||(this.targetColorScheme=u.baseState),this.prevColorState.innerColor.copy(this.currInnerColor),this.prevColorState.outerColor.copy(this.currOutlineColor),this.prevColorState.opacity=this.opacity,this.animation.modifyAnimation(0,1,d.JT,n.WD),this.lineLabel.setVisible(this.selectState.active||this.highlightState.active||this.hoverState.active)},this.onEdgePositionChanged=(()=>{const t=new r.Vector3,e=new r.Vector3,i=new r.Vector3,s=new r.Vector3,o=new r.Vector3,n=new r.Vector3,h=new r.Vector3;return(r,l,d)=>{const c=r.getWall(this.roomBoundsId);c.from.getVec3(t),c.to.getVec3(e),c.getBiasAdjustmentVec(h),i.set(t.x,t.y+l,t.z),s.set(e.x,e.y+l,e.z),o.addVectors(i,h),n.addVectors(s,h),this.line3.start.copy(o),this.line3.end.copy(n),this.widthCache=c.width,this.lineLabel.updateDimensions(o,n,c.width,d);const u=(0,a.A)(c,r);this.instanceBuffer.setGeometryForInstance(this,l,o.x,o.z,n.x,n.z,c.width,i.x,i.z,s.x,s.z,u)}})(),this.instanceBuffer.allocInstance(this),this.renderOrder=h.S.EDGE,this.colors=u,this.animation.onChanged((()=>{const t=this.prevColorState,e=this.targetColorScheme;this.currOutlineColor.lerpColors(t.outerColor,e.outerColor,this.animation.value),this.currInnerColor.lerpColors(t.innerColor,e.innerColor,this.animation.value);const i=(0,o.C)(t.opacity,e.opacity,this.animation.value);this.opacity=i,this.instanceBuffer.setColorsForInstance(this,this.currOutlineColor,this.currInnerColor),this.instanceBuffer.setOpacityForInstance(this,this.opacity)})),this.instanceBuffer.setColorsForInstance(this,s.V.WHITE,s.V.WHITE),this.instanceBuffer.setOpacityForInstance(this,1)}raycast(t,e){(0,c.a)(this.line3.start,this.line3.end,this.widthCache,this.cameraData,this,t,e)}tickAnimations(t){super.tickAnimations(t),this.lineLabel.tickAnimations(t)}beforeRender(){}setLabelVisible(t){this.lineLabel.setVisible(t)}dispose(){this.lineLabel.dispose(),this.instanceBuffer.removeInstance(this)}onRender(t,e){super.onRender(t,e),this.lineLabel.update()}}},14767:(t,e,i)=>{"use strict";i.d(e,{L:()=>m});var s=i(68909),a=i(71101),o=i(23689),n=i(38069),r=i(52885),h=i(94814),l=i(60552),d=i(40397),c=i(81662);const u={baseState:{opacity:1,innerColor:n.V.MIRROR,outerColor:n.V.PORTAL},hoverState:{opacity:1,innerColor:n.V.MIRROR,outerColor:n.V.PORTAL},selectState:{opacity:1,innerColor:n.V.MP_BRAND,outerColor:n.V.WHITE},dimState:{opacity:1,innerColor:n.V.MIRROR,outerColor:n.V.PORTAL}},p=new s.Plane;class m extends o.r{constructor(t,e,i,o){super(t,e,i),this.floorId=e,this.instanceBuffer=o,this.position=new s.Vector3,this.targetRadius=.3,this.prevRadius=.3,this.currOuterColor=u.baseState.outerColor.clone(),this.currInnerColor=u.baseState.innerColor.clone(),this.currRadius=l.m7,this.renderOrder=a.S.NODE,this.colors=u,this.animation.onChanged((()=>this.onAnimationChange())),this.instanceBuffer.allocInstance(this),this.instanceBuffer.setColorsForInstance(this,this.currOuterColor,this.currInnerColor),this.instanceBuffer.setRadiusForInstance(this,this.currRadius),this.instanceBuffer.setOpacityForInstance(this,1)}onAnimationChange(){const t=this.prevColorState,e=this.targetColorScheme;this.currOuterColor.lerpColors(t.outerColor,e.outerColor,this.animation.value),this.currInnerColor.lerpColors(t.innerColor,e.innerColor,this.animation.value),this.instanceBuffer.setColorsForInstance(this,this.currOuterColor,this.currInnerColor),this.opacity=(0,r.C)(t.opacity,e.opacity,this.animation.value),this.instanceBuffer.setOpacityForInstance(this,this.opacity);const i=(0,r.C)(this.prevRadius,this.targetRadius,this.animation.value);this.instanceBuffer.setRadiusForInstance(this,i)}beforeRender(){}onRender(t,e){super.onRender(t,e)}raycast(t,e){p.setFromNormalAndCoplanarPoint(c.B1.UP,this.position);const i=t.ray.intersectPlane(p,new s.Vector3);if(i){const s=t.ray.origin.distanceTo(this.position),a=(0,d.ff)(s,this.cameraData.pose.projection.asThreeMatrix4(),this.cameraData.width),o=l.ub*a;i.distanceTo(this.position)<l.m7+o&&e.push({point:i,normal:c.B1.UP.clone(),distance:i.distanceTo(t.ray.origin),object:this})}}updateMaterial(){this.prevRadius=this.currRadius,this.targetRadius=l.m7+(this.hoverState.active?l.xX:0)+(this.selectState.active?l.xX:0),super.updateMaterial(),this.prevColorState.innerColor.copy(this.currInnerColor),this.prevColorState.outerColor.copy(this.currOuterColor),this.prevColorState.opacity=this.opacity,this.animation.modifyAnimation(0,1,l.JT,h.WD)}updatePosition(t){this.position.copy(t),this.instanceBuffer.setPositionForInstance(this,t)}dispose(){this.instanceBuffer.removeInstance(this)}}},43510:(t,e,i)=>{"use strict";i.d(e,{iM:()=>A,D9:()=>w,V1:()=>D,jP:()=>I});var s=i(38069),a=i(94814),o=i(68909),n=i(14767),r=i(71101),h=i(23689),l=(i(87708),i(60552)),d=i(41644),c=i(20854),u=i(81662),p=i(86324),m=i(73026),g=i(6525),f=i(76185),v=i(48758);class b extends m.k{constructor(t,e,i,s,a,n,h,l,d,m){super(a,l),this.floorId=s,this.baseHeight=n,this.cameraPoseData=h,this.labelManager=d,this.datumLabels=[],this.heightAboveRoom=0,this.heightDatum={btm:new o.Vector3},this.endPoints={start:new o.Vector3,end:new o.Vector3,halfWidth:.1},this.shouldSnapToWall=!1,this.applyViewOffsetToLines=(()=>{const t=new o.Vector3,e=new o.Vector3;return()=>{(0,v.K)(this.endPoints.start,this.endPoints.end,this.endPoints.halfWidth,this.cameraPoseData,t);const i=this.baseHeight-this.currentRoomHeight;this.heightAboveRoom=i;const s=Math.abs(i)<.05?-i:0;e.set(0,s,0),this.shouldSnapToWall&&e.add(t),this.solidLines.translationOffset(e),this.fadedLines.translationOffset(e),this.updateHeightDatumLines(t),this.updateHeightAboveLines(t)}})(),this.updateHeightAboveLines=(()=>{const t=new o.Vector3,e=new o.Vector3,i=new o.Vector3,s=new o.Vector3;return a=>{const o=this.heightAboveRoom-c.u4,n=[{points:[t.copy(this.endPoints.start).addScaledVector(u.B1.DOWN,o).add(a),e.copy(this.endPoints.start).add(a)]},{points:[i.copy(this.endPoints.end).addScaledVector(u.B1.DOWN,o).add(a),s.copy(this.endPoints.end).add(a)]}];this.heightAboveLines.updateEndpoints(n)}})(),this.solidLines=new p.y4(t,(0,c.ay)(m),this.cameraPoseData),this.fadedLines=new p.y4(i,(0,c.ay)(m,c.BC),this.cameraPoseData),this.heightAboveLines=new p.y4([],(0,c.ay)(m,c.BC,c.Wh),this.cameraPoseData),this.datumLines=new g.uG(e,this.cameraPoseData,m),this.widthLabel=this.labelManager.createInsideLabel(this.floorId,this),this.widthLabel.setVisible(!1),this.solidLines.renderOrder=r.S.INSIDE_LINES,this.fadedLines.renderOrder=r.S.INSIDE_LINES}updateEndpoints(t,e,i,s,a,o){this.units=o,this.heightDatum=i,this.baseHeight=i.btm.y,this.endPoints=s,this.shouldSnapToWall=a,this.applyViewOffsetToLines(),this.solidLines.updateEndpoints(t),this.fadedLines.updateEndpoints(e),this.widthLabel.updateDimensions(this.endPoints.start,this.endPoints.end,0,this.units)}updateLabelEndpoints(){for(const t of this.datumLabels)t.updateUnits(this.units);this.widthLabel.updateUnits(this.units)}lineSceneObjs(){return[this.solidLines,this.fadedLines,this.heightAboveLines,this.datumLines.solidDatums]}calcOpacities(t){return{solid:t*c.lO,faded:t*c.z2}}onLinesAdded(){this.add(this.datumLines.datumCircles)}onLinesRemoved(){this.remove(this.datumLines.datumCircles)}setColor(t){this.solidLines.color(t),this.fadedLines.color(t)}setWidth(t){this.solidLines.lineWidth(t),this.fadedLines.lineWidth(t)}onRender(t){super.onRender(t);const e=this.calcOpacities(t);this.solidLines.globalOpacity(e.solid),this.fadedLines.globalOpacity(e.solid),this.datumLines.globalOpacity(e.solid,e.faded);const i=this.userIsInside&&this.roomBoundViewData.roomDimensionsVisible;for(const t of this.datumLabels)t.setVisible(i);this.widthLabel.setVisible(i)}setUserIsInsideRoom(t,e){super.setUserIsInsideRoom(t,e),this.applyViewOffsetToLines()}updateHeightDatumLines(t){const e=this.heightDatum.top?[{points:[this.heightDatum.btm,this.heightDatum.top]}]:[];this.heightAboveRoom>l.W5&&e.push({points:[(new o.Vector3).copy(this.heightDatum.btm).addScaledVector(u.B1.DOWN,this.heightAboveRoom),this.heightDatum.btm]}),this.datumLines.updateEndpoints(e),this.datumLines.translationOffset(t),this.updateDatumLabels(e,t)}updateDatumLabels(t,e){const i=this.datumLabels.length-t.length;if(i>0)for(let t=0;t<Math.abs(i);t++){const t=this.datumLabels.pop();(0,f.$)(t),this.labelManager.deleteLabel(t),t.dispose()}else for(let t=0;t<Math.abs(i);t++){const t=this.labelManager.createInsideDatumLabel(this.floorId,this);t.setVisible(!1),this.datumLabels.push(t)}for(let i=0;i<t.length;i++){const s=this.datumLabels[i],a=t[i].points;s.updateDimensions(a[0].clone().add(e),a[1].clone().add(e),0,this.units,"")}}}var S=i(84615),y=i(78291),C=i(40397),E=i(52885),x=i(941),L=i(99380);o.ShaderMaterial;class D extends h.r{constructor(t,e,i,a,n,h,l,d,p,m,f,v,D){super(t,e,i),this.floorId=e,this.cameraData=i,this.labelManager=a,this.roomBoundViewData=n,this.instanceBufferOpening=l,this.instanceBufferOpeningStencil=d,this.rootFloor=p,this.units=m,this.readonly=D,this.insideHandles=null,this.start=new o.Vector3,this.end=new o.Vector3,this.width=0,this.outlineColor=s.V.WHITE.clone(),this.heightLinesInScene=!1,this.onEdgePositionChanged=(()=>{const t=new o.Vector3,e=new o.Vector3,i=new o.Vector3,s=new o.Vector3,a=new o.Quaternion,n=(new o.Quaternion).setFromAxisAngle(new o.Vector3(0,1,0),Math.PI/2),r=new o.Quaternion,h=new o.Vector3;return(o,l,d,c,p)=>{this.start.copy(o),this.end.copy(l),this.width=d,t.subVectors(l,o),s.copy(t).normalize();const m=t.length(),g=d;e.set(m,.05,g),this.instanceBufferOpening.setScaleForInstance(this,e),this.instanceBufferOpeningStencil.setScaleForInstance(this,e);const f=Math.atan2(l.x-o.x,l.z-o.z)+Math.PI/2;this.instanceBufferOpening.setRotationForInstance(this,f),this.instanceBufferOpeningStencil.setRotationForInstance(this,f);const v=t.addVectors(l,o).multiplyScalar(.5),b=h.copy(v).addScaledVector(s,.2);this.instanceBufferOpening.setPositionForInstance(this,v),this.instanceBufferOpeningStencil.setPositionForInstance(this,v),this.startHandle.updatePosition(o),this.endHandle.updatePosition(l);let S=1;const y=(0,L.jd)(c),E=(0,L.l6)(c);y&&(S=2),E&&(S=3),this.instanceBufferOpening.setNumLines(this,S),this.instanceBufferOpeningStencil.setNumLines(this,S),this.updateHeightlines(o,l,d,c,p),i.crossVectors(s,u.B1.UP).normalize(),(0,C.LM)(a,u.B1.UP,i,s),r.copy(a).multiply(n);const D={start:o.clone(),end:l.clone(),halfWidth:d/2};if(this.insideHandles){const t=p||x.Sj;this.insideHandles.start.updatePlacement(o,a,t,D),this.insideHandles.end.updatePlacement(l,a,t,D),this.insideHandles.top.updatePlacement(v,r,t,D),this.insideHandles.bottom.updatePlacement(b,r,t,D),this.insideHandles.bottom.setEnabled(E),this.insideHandles.main.updatePlacement(v,r,t,D),this.insideHandles.main.updateIcon()}}})(),this.updateHeightlines=(()=>{const t=new o.Vector3,e=new o.Vector3,i=new o.Vector3,s=new o.Vector3,a=new o.Vector3,n=new o.Vector3,r=new o.Vector3,h=new o.Vector3,l=new o.Vector3,d=new o.Vector3,p=new o.Vector3,m=new o.Vector3,g=new o.Vector3,f=new o.Vector3,v=new o.Vector3,b=new o.Vector3,y=new o.Vector3,C=new o.Vector3,E=new o.Vector3,D=new o.Vector3;return(o,w,I,A,O)=>{const V=O||x.Sj;D.copy(u.B1.UP).multiplyScalar(V),E.subVectors(w,o).normalize(),E.set(-E.z,E.y,E.x);const T=.5*I;t.set(o.x,o.y+c.u4,o.z).addScaledVector(E,T),a.set(o.x,o.y+c.u4,o.z).addScaledVector(E,-T),n.set(w.x,w.y+c.u4,w.z).addScaledVector(E,T),d.set(w.x,w.y+c.u4,w.z).addScaledVector(E,-T),p.copy(t).add(D),m.copy(a).add(D),f.copy(n).add(D),v.copy(d).add(D),e.copy(t).add(a).multiplyScalar(.5),r.copy(n).add(d).multiplyScalar(.5),g.copy(e).add(D),b.copy(r).add(D),y.copy(e).multiplyScalar(3/4).addScaledVector(r,1/4),C.copy(y).add(D);const P=null!=O,M=[],R=[],B=(0,L.jd)(A),H=A===S.k.DIVIDER,F=(0,L.l6)(A);if(B||H){R.push({points:[t,a]},{points:[n,d]});const e=[{points:[t,p]},{points:[a,m]},{points:[n,f]},{points:[d,v]}];P?R.push({points:[p,m]},{points:[f,v]},{points:[p,f]},{points:[m,v]},...e):M.push(...e)}else F&&R.push({points:[e,r]},{points:[e,g]},{points:[r,b]},{points:[g,b]});B?(i.copy(e).addScaledVector(E,.02),s.copy(e).addScaledVector(E,-.02),h.copy(r).addScaledVector(E,.02),l.copy(r).addScaledVector(E,-.02),R.push({points:[i,h]},{points:[s,l]})):H&&R.push({points:[e,r]});const N=P?{btm:y,top:C}:{btm:y};this.insideModeLines.updateEndpoints(R,M,N,{start:e.clone(),end:r.clone(),halfWidth:T},F,this.units),this.heightLines.updateEndpoints(R,M)}})(),this.renderOrder=r.S.OPENING_LINES,this.startHandle=new I(t,e,i,h,this),this.endHandle=new A(t,e,i,h,this),this.readonly||(this.insideHandles={start:new y.HW(t,e,i,this,v),end:new y.Gt(t,e,i,this,v),top:new y.O8(t,e,i,this,v),main:new y.yd(t,e,i,this,v),bottom:new y.mk(t,e,i,this,v)},this.insideHandles.bottom.setEnabled(!1)),this.instanceBufferOpening.allocInstance(this),this.instanceBufferOpeningStencil.allocInstance(this),this.instanceBufferOpening.setColorForInstance(this,this.outlineColor),this.instanceBufferOpeningStencil.setColorForInstance(this,this.outlineColor),this.heightLines=new g.M2([],[],this.cameraData.pose),this.insideModeLines=new b([],[],[],this.floorId,this.units,0,this.cameraData.pose,this.roomBoundViewData,this.labelManager,f),this.rootFloor.add(this.insideModeLines),this.animation.onChanged((()=>{this.outlineColor.lerpColors(s.V.WHITE,s.V.NEPTUNE,this.animation.value),this.instanceBufferOpening.setColorForInstance(this,this.outlineColor),this.instanceBufferOpeningStencil.setColorForInstance(this,this.outlineColor),this.readonly||(this.insideModeLines.setColor(this.outlineColor),this.insideModeLines.setWidth((0,E.C)(c.kV,c.Yv,this.animation.value)))}))}*allSubViews(){this.startHandle&&(yield this.startHandle),this.endHandle&&(yield this.endHandle),this.insideHandles&&(yield this.insideHandles.start,yield this.insideHandles.end,yield this.insideHandles.top,yield this.insideHandles.main,yield this.insideHandles.bottom)}*insideModeHandles(){this.insideHandles&&(yield this.insideHandles.start,yield this.insideHandles.end,yield this.insideHandles.top,yield this.insideHandles.main,yield this.insideHandles.bottom)}onRender(t,e){super.onRender(t,e),this.raycastEnabled=this.pitchFactor<1&&this.roomBoundViewData.roomWallsVisible;const i=(1-e)*t;this.heightLines.globalOpacity(i),this.insideModeLines.onRender(e);for(const i of this.allSubViews())i.onRender(t,e)}setIsInside(t,e){this.insideModeLines.setUserIsInsideRoom(t,e);for(const i of this.insideModeHandles())i.setUserIsInsideRoom(t,e)}updateMaterial(){const t=this.highlightState.active,e=this.selectState.active||this.hoverState.active;this.animation.modifyAnimation(this.animation.value,e?1:0,l.JT,a.WD),t?this.heightLinesInScene||(this.rootFloor.add(this.heightLines),this.heightLinesInScene=!0):this.heightLinesInScene&&(this.rootFloor.remove(this.heightLines),this.heightLinesInScene=!1)}tickAnimations(t){super.tickAnimations(t);for(const e of this.allSubViews())e.tickAnimations(t)}raycast(t,e){this.raycastEnabled&&(0,d.a)(this.start,this.end,this.width,this.cameraData,this,t,e)}updateUnits(t){this.insideModeLines.updateUnits(t)}beforeRender(){}dispose(){for(const t of this.allSubViews())t.dispose();this.insideHandles=null,this.instanceBufferOpening.removeInstance(this),this.instanceBufferOpeningStencil.removeInstance(this),this.rootFloor.remove(this.heightLines),this.rootFloor.remove(this.insideModeLines)}}class w extends n.L{constructor(t,e,i,s,a){super(t,e,i,s),this.floorId=e,this.parentOpeningView=a}}class I extends w{}class A extends w{}},71101:(t,e,i)=>{"use strict";i.d(e,{S:()=>s,j:()=>a});var s,a,o=i(37458);!function(t){t[t.BASE=o.X.roomBounds]="BASE",t[t.OPENING_STENCIL=o.X.roomBounds+1]="OPENING_STENCIL",t[t.EDGE_STENCIL=o.X.roomBounds+2]="EDGE_STENCIL",t[t.ROOM=o.X.roomBounds+3]="ROOM",t[t.EDGE=o.X.roomBounds+4]="EDGE",t[t.OPENING_LINES=o.X.roomBounds+5]="OPENING_LINES",t[t.INSIDE_LINES=o.X.roomBounds+6]="INSIDE_LINES",t[t.NODE=o.X.roomBounds+7]="NODE"}(s||(s={})),function(t){t[t.OPENINGS=0]="OPENINGS",t[t.EDGE=1]="EDGE"}(a||(a={}))},48823:(t,e,i)=>{"use strict";i.d(e,{y:()=>y});var s=i(38069),a=i(18952),o=i(52885),n=i(94814),r=i(68909),h=i(71101),l=i(23689),d=i(60552),c=i(87708),u=i(74634),p=i(19968),m=i(86324),g=i(20854),f=i(73026),v=i(6525);class b extends f.k{constructor(t,e,i,s,a,o,n,r,h,l,d){super(n,h),this.labelManager=a,this.floorId=o,this.cameraPoseData=r,this.depthMesh=d,this.labels=[],this.lines=[],this.datumLines=[],this.labelLines=[],this.labelsVisible=!1,this.solidOutlines=new m.y4(this.lines,(0,g.ay)(l),this.cameraPoseData),this.datumLinesObj=new v.uG([],this.cameraPoseData),this.updateEndpoints(t,e,i,s),this.updateLabelEndpoints()}lineSceneObjs(){return[this.solidOutlines,this.datumLinesObj.solidDatums]}calcOpacities(t){return{solid:t*g.lO,faded:t*g.z2}}updateEndpoints(t,e,i,s){this.datumLines=t.map((t=>({points:t.points,opacity:1})));const a=[];if(null!=s)for(const t of i){const e=(new r.Vector3).copy(t.points[0]);e.y-=s,a.push({points:[t.points[0].clone(),e]})}this.lines=e.concat(a,i),this.labelLines=e.concat(a).filter((t=>!t.skipLabel)),this.solidOutlines.updateEndpoints(this.lines),this.datumLinesObj.updateEndpoints(this.datumLines),this.updateLabelEndpoints()}onRender(t){var e,i;super.onRender(t);const{solid:s,faded:a}=this.calcOpacities(t);this.solidOutlines.globalOpacity(s),this.datumLinesObj.globalOpacity(s,a);const o=this.userIsInside&&this.roomBoundViewData.roomDimensionsVisible;if(o){for(const t of this.labels)t.setVisible(!0);null===(e=this.datumLabel)||void 0===e||e.setVisible(!0)}else{for(const t of this.labels)t.setVisible(!1);null===(i=this.datumLabel)||void 0===i||i.setVisible(!1)}this.labelsVisible!==o&&(this.labelManager.needsImmediateCollsisionDetection(),this.labelsVisible=o)}onLinesAdded(){this.add(this.datumLinesObj.datumCircles),this.depthMesh.visible=!0}onLinesRemoved(){this.remove(this.datumLinesObj.datumCircles),this.depthMesh.visible=!1}updateLabelEndpoints(){var t;const e=this.labelLines.length-this.labels.length;e>0?this.createLabels(e,this.labels):e<0&&this.deleteLabels(e,this.labels);for(let t=0;t<this.labelLines.length;t++){const e=this.labelLines[t];this.labels[t].updateDimensions(e.points[0],e.points[1],0,this.units),this.labels[t].isVertical(e.points[0],e.points[1])&&(this.labels[t].labelGroupId="inside_height_label")}this.datumLines.length>0&&(null==this.datumLabel&&(this.datumLabel=this.labelManager.createDatumLabel(this.floorId,this),this.datumLabel.setVisible(!1)),null===(t=this.datumLabel)||void 0===t||t.updateDimensions(this.datumLines[0].points[0],this.datumLines[0].points[1],0,this.units))}createLabels(t,e){for(let i=0;i<t;i++){const t=this.labelManager.createInsideLabel(this.floorId,this);t.setVisible(!1),e.push(t)}}deleteLabels(t,e){const i=Math.abs(t);for(let t=0;t<i;t++){const t=e.pop();t&&this.labelManager.deleteLabel(t)}}}const S={baseState:{innerColor:s.V.LENS_GRAY,outerColor:s.V.WHITE,opacity:0},hoverState:{innerColor:s.V.WHITE,outerColor:s.V.WHITE,opacity:.25},selectState:{innerColor:s.V.NEPTUNE,outerColor:s.V.WHITE,opacity:0},dimState:{innerColor:s.V.LENS_GRAY,outerColor:s.V.WHITE,opacity:.5}};class y extends l.r{constructor(t,e,i,n,l,d,u,m,f,v){const C=y.getGeoFromRoom(t,i),E=new r.MeshBasicMaterial({color:s.V.LENS_GRAY,depthTest:!1,side:r.DoubleSide,transparent:!0,opacity:0,blending:r.NormalBlending,blendEquation:r.AddEquation,blendSrc:r.SrcAlphaFactor,blendDst:r.DstColorFactor,stencilRef:65535,stencilFuncMask:1<<h.j.EDGE,stencilFail:r.KeepStencilOp,stencilZFail:r.KeepStencilOp,stencilZPass:r.KeepStencilOp,stencilFunc:r.GreaterStencilFunc,stencilWrite:!0});super(t.id,e,n),this.floorId=e,this.baseHeight=i,this.roomBoundViewData=d,this.labelManager=u,this.units=m,this.calcBaseHeight=f,this.caretsInstanceBuffer=v,this.currRoomLabelRadius=.5,this.potentialLabels=[],this.perimeterLabels=[],this.hideMaterial=new r.ShaderMaterial({vertexShader:c.Om.vertexShader,fragmentShader:c.Om.fragmentShader,uniforms:r.UniformsUtils.clone(c.Om.uniforms),depthTest:!1,side:r.DoubleSide,transparent:!0}),this.depthMaterial=new r.ShaderMaterial({vertexShader:c.Tx.vertexShader,fragmentShader:c.Tx.fragmentShader,uniforms:r.UniformsUtils.clone(c.Tx.uniforms),depthTest:!0,side:r.FrontSide}),this.perimeterLabelsVisible=!1,this.fullLabelVisible=!1,this.hoverTimer=null,this.labelHovered=!1,this.heightLines=new r.Group,this.heightLinesInScene=!1,this.heightLabels=[],this.insideNess=1,this.getLabelRadiusPx=t=>{const e=t.split("\n"),i=e.reduce(((t,e)=>Math.max(t,e.length)),0),s=(0,a.yp)(i,0,0),o=.5*s.width,n=.5*s.height*e.length;return Math.max(o,n)},this.worldRadiusToScreen=(()=>{const t=[new r.Vector3(1,0,0),new r.Vector3(-1,0,0),new r.Vector3(0,0,1),new r.Vector3(0,0,-1)],e=new r.Vector3,i=new r.Vector2,s=new r.Vector2,a=new r.Vector3;return(o,n,r)=>{let h=Number.MAX_SAFE_INTEGER;(0,p.bz)(this.cameraData,o,i,a),r.copy(i);for(const r of t){e.copy(o).addScaledVector(r,n),(0,p.bz)(this.cameraData,e,s,a);const t=i.distanceTo(s);t<h&&(h=t)}return h}})(),this.updateCarets=(()=>{const t=[new r.Vector2,new r.Vector2,new r.Vector2,new r.Vector2];return()=>{const e=this.cameraData.metersPerPx(),i=this.room.length/e,s=this.room.width/e,a=this.roomLabel.getSize(),o=a.width+2>i,n=a.height+2>s,r=this.fullLabelVisible&&(o||n),h=this.roomBoundViewData.roomDimensionsVisible&&this.roomBoundViewData.roomWallsVisible;this.room.canDisplayDimensions()&&!this.perimeterLabelsVisible&&this.fullLabelVisible&&!r&&h?(this.caretsInstanceBuffer.setVisibilityForInstances(this,!0),t[0].subVectors(this.room.w2,this.room.w1).normalize(),t[1].subVectors(this.room.w1,this.room.w2).normalize(),t[2].subVectors(this.room.l2,this.room.l1).normalize(),t[3].subVectors(this.room.l1,this.room.l2).normalize(),this.caretsInstanceBuffer.updateStateForInstances(this,[{normal:t[0],tip:this.room.w1,height:this.baseHeight},{normal:t[1],tip:this.room.w2,height:this.baseHeight},{normal:t[2],tip:this.room.l1,height:this.baseHeight},{normal:t[3],tip:this.room.l2,height:this.baseHeight}])):this.caretsInstanceBuffer.setVisibilityForInstances(this,!1)}})(),this.main2DMesh=new r.Mesh(C,E),this.baseHeight+=g.u4,this.standardMaterial=E,this.renderOrder=h.S.ROOM,this.roomLabel=this.labelManager.createRoomLabel(t.floorId,t.id,this.main2DMesh),this.roomLabel.setVisible(!t.hide),this.room=t,this.caretsInstanceBuffer.allocInstance(this),this.updateRoomLabelPositionAndText(!0),this.colors=S,this.extrusionMesh=new r.Mesh(y.getExtrudedGeo(this.room,this.baseHeight),this.depthMaterial),this.animation.onChanged((()=>{const t=this.prevColorState;this.standardMaterial.color.lerpColors(t.innerColor,this.targetColorScheme.innerColor,this.animation.value);const e=(0,o.C)(t.opacity,this.targetColorScheme.opacity,this.animation.value);this.opacity=e}));const{datumLines:x,floorLines:L,roofLines:D,height:w}=this.calculateInsideModeLinePositions();this.insideModeLines=new b(x,L,D,w,u,t.floorId,this.units,this.cameraData.pose,this.roomBoundViewData,l,this.extrusionMesh),this.main2DMesh.add(this.insideModeLines)}hasIntersectionPriorityWithRespectTo(t){return!(!t.object||!t.object.isModelMesh)}dispose(){this.labelManager.deleteLabel(this.roomLabel);for(const t of this.perimeterLabels)this.labelManager.deleteLabel(t),t.dispose();for(const t of this.heightLabels)this.labelManager.deleteLabel(t),t.dispose();this.datumLabel&&(this.labelManager.deleteLabel(this.datumLabel),this.datumLabel.dispose()),this.clearHoverTimer(),this.caretsInstanceBuffer.removeInstance(this)}hoverRoomLabel(t){const e=()=>{if(!t&&this.roomLabel.getDisplayingTooltip()===t||t&&this.fullLabelVisible)return void(t||(this.labelHovered=!1,this.updateMaterial()));this.roomLabel.setDisplayingTooltip(t),this.updateMaterial();const e=this.roomLabel.label.collider.material;e.opacity=t?.65:0,e.transparent=!0,this.updateRoomLabelPositionAndText(!1),this.updateCarets()};this.labelHovered=t,t?null===this.hoverTimer&&(this.hoverTimer=window.setTimeout(e,d.jd),this.updateMaterial()):(e(),this.clearHoverTimer())}updateUnits(t){this.units=t,this.insideModeLines.updateUnits(this.units),this.updateLabels()}updateGeo(t){this.room=t;const e=isNaN(this.room.floorHeight)?this.calcBaseHeight(this.room):this.room.floorHeight;this.baseHeight=e+g.u4;const i=y.getGeoFromRoom(t,e);this.main2DMesh.geometry.dispose(),this.main2DMesh.geometry=i,this.main2DMesh.geometry.computeBoundingBox();const s=y.getExtrudedGeo(t,e);this.extrusionMesh.geometry.dispose(),this.extrusionMesh.geometry=s,this.updateRoomLabelPositionAndText(!1),this.updateLabels(),this.createHeightObjects();const{datumLines:a,floorLines:o,roofLines:n,height:r}=this.calculateInsideModeLinePositions();this.insideModeLines.updateEndpoints(a,o,n,r)}beforeRender(){this.standardMaterial.opacity=this.opacity*(1-this.pitchFactor)*Number(this.roomBoundViewData.roomWallsVisible);const t=this.dimState.active?.5:1;this.caretsInstanceBuffer.setOpacityForInstances(this,t),this.updateLabelBillboard(),this.updateMaterial(),this.updateCarets()}updateLabelBillboard(){if(this.isRoomLabelVisible()){const{position:t,rotation:e,projection:i}=this.cameraData.pose,{height:s}=this.cameraData,a=this.cameraData.isOrtho()?this.cameraData.zoom():1,o=this.cameraData.aspect(),n=.1;this.roomLabel.label.quaternion.copy(e),this.roomLabel.label.scaleBillboard(t,e,i,a,s,o,n),this.roomLabel.label.updateMatrix(),this.roomLabel.label.updateMatrixWorld()}}updateLabelVisibility(){const t=this.hoverState.active||this.labelHovered;this.perimeterLabelsVisible=this.roomBoundViewData.roomDimensionsVisible&&(this.selectState.active||t&&(0,p.aY)(this.pitchFactor))&&this.insideNess<.9,this.updateLabels();for(const t of this.perimeterLabels)t.setVisible(this.perimeterLabelsVisible);const e=this.perimeterLabelsVisible&&!(0,p.aY)(this.pitchFactor);for(const t of this.heightLabels)t.setVisible(e);this.datumLabel&&this.datumLabel.setVisible(e),this.updateCarets()}updateMaterial(){this.main2DMesh.material=this.room.hide?this.hideMaterial:this.standardMaterial,super.updateMaterial();const t=this.hoverState.active||this.labelHovered,e=(0,p.aY)(this.pitchFactor);(this.selectState.active||t)&&!e&&this.roomBoundViewData.roomDimensionsVisible?this.heightLinesInScene||(this.main2DMesh.add(this.heightLines),this.heightLinesInScene=!0):this.heightLinesInScene&&(this.main2DMesh.remove(this.heightLines),this.heightLinesInScene=!1),t&&e&&(this.targetColorScheme=this.colors.hoverState),this.hideMaterial.uniforms.opacity.value=t?1:0;const i=this.standardMaterial;this.prevColorState.innerColor.copy(i.color),this.prevColorState.opacity=i.opacity,this.animation.modifyAnimation(0,1,d.JT,n.WD),this.roomLabel.setDimmed(this.dimState.active),this.roomLabel.setVisible(this.isRoomLabelVisible()),this.updateLabelVisibility()}isRoomLabelVisible(){const t=this.hoverState.active||this.labelHovered;return!(this.insideNess>.9)&&((!this.room.hide||t)&&this.potentialLabels.length>0)}updateText(t,e){this.potentialLabels=t,this.updateRoomLabelPositionAndText(e),this.updateCarets()}static getGeoFromRoom(t,e){const{points:i,faces:s}=t.getGeometry(),a=i.map((t=>[t.x,e,t.y])).flat(1),o=new r.BufferGeometry;return o.setAttribute("position",new r.BufferAttribute(new Float32Array(a),3)),o.setIndex(s.flat(1)),o}static getExtrudedGeo(t,e){const{points:i,faces:s}=t.getGeometry(),a=i.map((t=>[t.x,e,t.y])),o=s.slice(),n=t.calculateMinimalInnerLoop(.01);for(const t of n.wallLoop)for(let i=0;i<t.length;i++){const s=a.length,n=t[i],r=t[(i+1)%t.length],h=[n.x,e,n.z],l=[r.x,e,r.z],d=[r.x,e+100,r.z],c=[n.x,e+100,n.z];a.push(h,l,d,c),o.push([s+0,s+2,s+1],[s+0,s+3,s+2])}const h=new r.BufferGeometry;return h.setAttribute("position",new r.BufferAttribute(new Float32Array(a.flat(1)),3)),h.setIndex(o.flat(1)),h}updateRoomLabelPositionAndText(t){if(0===this.potentialLabels.length)return;const e=[];if(!t){const{position:t}=this.roomLabel.label,i={x:t.x,y:t.z};this.room.holesCW.find((t=>{const e=t.map((t=>({x:t.x,y:t.z})));return(0,u.L)(i,e)}))||e.push({point:t.clone(),radius:this.currRoomLabelRadius})}const i=this.room.getViewCenter(new r.Vector3,1.5);i.y=this.baseHeight+d.Dh;const s=this.room.getViewCenterDistance(1.5);e.push({point:i,radius:s});const{screenPosition:a}=(0,p.bz)(this.cameraData,i,new r.Vector2,new r.Vector3),o=new r.Vector2;for(const t of e){this.roomLabel.label.position.copy(t.point),this.roomLabel.label.position.y=this.baseHeight+d.Dh,this.currRoomLabelRadius=t.radius;let e=!1;this.fullLabelVisible=!0;for(const i of this.potentialLabels){const s=this.getLabelRadiusPx(i),n=1.5*this.worldRadiusToScreen(this.roomLabel.label.position,t.radius,o),r=o.distanceTo(a);if(!this.cameraData.pose.isOrtho()||s+r<=n||this.roomLabel.getDisplayingTooltip()){this.roomLabel.label.text=i,e=!0;break}this.fullLabelVisible=!1}if(e)break}}calculateInsideModeLinePositions(){const t=this.room.getMaxCeilingDatum(),e=[];if(t){const i=new r.Vector3(t.position.x,this.baseHeight,t.position.z),s=new r.Vector3(t.position.x,this.baseHeight+t.height,t.position.z);e.push({points:[i,s]})}const i=[],s=this.room.canDisplayHeight()?this.room.getMinCeilingHeight():void 0;if(null!=s){const t=this.baseHeight+s,e=this.room.minimalInnerLoop;for(const s of e){const e=s.length;for(let a=0;a<e;a++){const o=(new r.Vector3).copy(s[a]);o.y=t;const n=(new r.Vector3).copy(s[(a+1)%e]);n.y=t,i.push({points:[o,n]})}}}const a=[];for(const t of this.room.minimalInnerEdges)t.solid&&a.push({points:[new r.Vector3(t.start.x,this.baseHeight,t.start.z),new r.Vector3(t.end.x,this.baseHeight,t.end.z)],skipLabel:t.skipInsideLabel});return{datumLines:e,roofLines:i,height:s,floorLines:a}}updateLabels(){var t;if(!this.perimeterLabelsVisible)return;const e=this.room.hide?[]:this.room.minimalInnerEdges,i=this.room.canDisplayHeight()?e.filter((t=>t.needsHeightLabel)):[],s=i.length;for(;e.length>this.perimeterLabels.length;)this.perimeterLabels.push(this.labelManager.createPerimeterLabel(this.room.floorId,this.main2DMesh,!0));for(;s>this.heightLabels.length;){const t=this.labelManager.createHeightLabel(this.room.floorId,!1,this.main2DMesh,!0);t.labelGroupId=this.room.id,this.heightLabels.push(t)}for(;e.length<this.perimeterLabels.length;){const t=this.perimeterLabels.pop();if(!t)throw new Error("Label should exist!");this.labelManager.deleteLabel(t)}for(;s<this.heightLabels.length;){const t=this.heightLabels.pop();if(!t)throw new Error("Label should exist!");this.labelManager.deleteLabel(t)}for(let t=0;t<e.length;t++){const i=e[t],s=i.start.clone();s.y=this.baseHeight;const a=i.end.clone();a.y=this.baseHeight,this.perimeterLabels[t].updateDimensions(s,a,0,this.units)}for(let t=0;t<s;t++){const e=i[t].start.clone();e.y=this.baseHeight;const s=e.clone();s.y=this.baseHeight+this.room.getMinCeilingHeight(),this.heightLabels[t].updateDimensions(e,s,0,this.units)}const a=this.room.getMaxCeilingDatum();if(null!=a){null==this.datumLabel&&(this.datumLabel=this.labelManager.createDatumLabel(this.room.floorId,this.main2DMesh),this.datumLabel.labelGroupId=this.room.id+"_max_height",this.datumLabel.labelHeightFraction=2/3);const e=a.position.clone();e.y=this.baseHeight;const i=e.clone();i.y+=a.height,null===(t=this.datumLabel)||void 0===t||t.updateDimensions(e,i,0,this.units)}else this.datumLabel&&(this.datumLabel.dispose(),this.labelManager.deleteLabel(this.datumLabel),this.datumLabel=null);this.labelManager.needsImmediateCollsisionDetection()}clearHoverTimer(){null!==this.hoverTimer&&(clearTimeout(this.hoverTimer),this.hoverTimer=null)}createHeightObjects(){this.heightLines.clear();const t=[],e=(e,i,s=t)=>{s.push({points:[e.clone(),i.clone()]})},i=[],s=new r.Vector3,a=new r.Vector3,o=this.room.minimalInnerLoop,n=this.room.getMinCeilingHeight(),h=this.baseHeight+n;for(const t of this.room.minimalInnerEdges)t.solid&&(s.copy(t.start),s.y=this.baseHeight,a.copy(t.end),a.y=this.baseHeight,e(s,a));if(this.room.canDisplayHeight())for(const t of o){const i=t.length;for(let o=0;o<i;o++)s.copy(t[o]),s.y=h,a.copy(t[(o+1)%i]),a.y=h,e(s,a),s.copy(t[o]),s.y=this.baseHeight,a.copy(s),a.y+=n,e(s,a)}const l=this.room.getMaxCeilingDatum();l&&(s.copy(l.position),s.y=this.baseHeight,a.copy(s),a.y+=l.height,e(s,a,i)),this.dhOutlines=new v.M2(t,[],this.cameraData.pose),this.dhDatumLines=new v.hZ(i,this.cameraData.pose),this.heightLines.add(this.dhOutlines),this.heightLines.add(this.dhDatumLines)}setIsInside(t){this.insideModeLines.setUserIsInsideRoom(t,this.baseHeight)}onRender(t,e){this.pitchFactor=t,this.insideNess=e,this.raycastEnabled=e<.1&&(this.roomBoundViewData.roomDimensionsVisible||(0,p.aY)(this.pitchFactor)),this.insideModeLines.onRender(e);const i=(1-e)*t;this.dhOutlines&&this.dhOutlines.globalOpacity(i),this.dhDatumLines&&this.dhDatumLines.globalOpacity(i)}raycast(t,e){if(!this.raycastEnabled)return;const i=[];if(this.main2DMesh.raycast(t,i),i.length>0){i[0].object=this,e.push(i[0])}}}},23689:(t,e,i)=>{"use strict";i.d(e,{r:()=>r});var s=i(19968),a=i(92237),o=i(68909),n=i(71101);class r{constructor(t,e,i){this.roomBoundsId=t,this.floorId=e,this.cameraData=i,this.visible=!0,this.animation=new a.z(0),this.prevColorState={opacity:1,innerColor:new o.Color,outerColor:new o.Color},this.pitchFactor=1,this.raycastEnabled=!0,this.fullyInitialized=!1,this.opacity=1,this.selectState={active:!1,on:()=>{this.updateMaterial()},off:()=>{this.updateMaterial()}},this.hoverState={active:!1,on:()=>{this.updateMaterial()},off:()=>{this.updateMaterial()}},this.highlightState={active:!1,on:()=>{this.updateMaterial()},off:()=>{this.updateMaterial()}},this.dimState={active:!1,on:()=>{this.updateMaterial()},off:()=>{this.updateMaterial()}},this.name=t,this.renderOrder=n.S.BASE}updateMaterial(){var t;let e=this.colors.baseState;this.dimState.active&&(e=this.colors.dimState),this.hoverState.active&&(e=this.colors.hoverState),this.highlightState.active&&(e=null!==(t=this.colors.highlightState)&&void 0!==t?t:this.colors.selectState),this.selectState.active&&(e=this.colors.selectState);e!==this.targetColorScheme&&(this.targetColorScheme=e)}tickAnimations(t){this.animation.tick(t)}onRender(t,e){this.pitchFactor=t,this.raycastEnabled=(0,s.aY)(this.pitchFactor)}}},6525:(t,e,i)=>{"use strict";i.d(e,{hZ:()=>f,M2:()=>g,uG:()=>v});var s=i(68909),a=i(45138),o=i.n(a),n=i(68216),r=i.n(n);const h={uniforms:{screenSize:{value:new s.Vector2(0,0)},pixelRatio:{value:1},color:{value:new s.Vector3(1,1,1)},cameraPos:{value:new s.Vector3(0,0,0)},radius:{value:10},opacity:{value:1},depthTex:{value:null},fadeMaxDepth:{value:100},translationOffset:{value:new s.Vector3(0,0,0)}},vertexShader:o(),fragmentShader:r()};class l extends s.Mesh{constructor(t,e,i){const a=new Float32Array([-9999,-9999,-9999,9999,9999,9999,-9999,-9999,-9999,9999,9999,9999]),o=new Float32Array([-1,1,1,1,1,-1,-1,-1]),n=new s.InstancedBufferGeometry;n.setAttribute("position",new s.Float32BufferAttribute(a,3)),n.setAttribute("offsetDirection",new s.Float32BufferAttribute(o,2)),n.setIndex([0,3,1,1,3,2]);const r={FADE_WIDTH:.8.toFixed(3)},l=null==e?void 0:e.fadeDepth,d=null==e?void 0:e.fadeDepthTexture;null!=l&&null!=d&&(r.FADE_DEPTH=l.toFixed(3));super(n,new s.ShaderMaterial({uniforms:s.UniformsUtils.clone(h.uniforms),vertexShader:h.vertexShader,fragmentShader:h.fragmentShader,transparent:!0,depthTest:!1,depthWrite:!1,defines:r})),this.cameraPose=i,this.material.uniforms.depthTex.value=null==d?void 0:d.texture,this.setPositions(t),this.setMaterialParams(e),this.frustumCulled=!1,this.onBeforeRender=t=>{t.getSize(this.material.uniforms.screenSize.value),this.material.uniforms.pixelRatio.value=t.getPixelRatio(),null!=this.cameraPose&&this.material.uniforms.cameraPos.value.copy(this.cameraPose.position)}}setMaterialParams(t){null!=t.color&&this.material.uniforms.color.value.copy(t.color),null!=t.opacity&&(this.material.uniforms.opacity.value=t.opacity),null!=t.radius&&(this.material.uniforms.radius.value=t.radius),null!=t.translationOffset&&this.material.uniforms.translationOffset.value.copy(t.translationOffset)}setPositions(t){this.geometry.dispose();const e=new Float32Array(3*t.length);for(let i=0;i<t.length;i++)e[3*i]=t[i].position.x,e[3*i+1]=t[i].position.y,e[3*i+2]=t[i].position.z;const i=new s.InstancedBufferAttribute(e,3);this.geometry.setAttribute("center",i),i.needsUpdate=!0}}var d=i(86324),c=i(71101),u=i(20854),p=i(38069),m=i(60552);class g extends s.Group{constructor(t,e,i){super(),this.occlusionLine=new d.y4(t,u.lQ,i),this.perspectiveLine=new d.y4(t,u.Lv,i),this.occlusionLineFaded=new d.y4(e,u.Pm,i),this.perspectiveLineFaded=new d.y4(e,u.Vr,i),this.add(this.perspectiveLine),this.add(this.occlusionLine),this.add(this.occlusionLineFaded),this.add(this.perspectiveLineFaded)}updateEndpoints(t,e){this.occlusionLine.updateEndpoints(t),this.perspectiveLine.updateEndpoints(t),this.occlusionLineFaded.updateEndpoints(e),this.perspectiveLineFaded.updateEndpoints(e)}globalOpacity(t){this.perspectiveLine.globalOpacity(t*u.lO),this.occlusionLine.globalOpacity(t*u.jT),this.perspectiveLineFaded.globalOpacity(t*u.lO),this.occlusionLineFaded.globalOpacity(t*u.jT)}}class f extends s.Group{constructor(t,e){super(),this.occlusionDatums=new d.y4(t,u.dr,e),this.perspectiveDatums=new d.y4(t,u.LH,e);const i=[];for(const e of t)for(const t of e.points)i.push({position:t});this.datumCircles=new l(i,{radius:5}),this.renderOrder=c.S.INSIDE_LINES,this.occlusionDatums.renderOrder=this.renderOrder,this.perspectiveDatums.renderOrder=this.renderOrder,this.datumCircles.renderOrder=this.renderOrder,this.add(this.occlusionDatums),this.add(this.perspectiveDatums),this.add(this.datumCircles)}globalOpacity(t){this.perspectiveDatums.globalOpacity(t*u.lO),this.occlusionDatums.globalOpacity(t*u.jT),this.datumCircles.setMaterialParams({opacity:t*u.lO})}}class v extends s.Group{constructor(t,e,i){super(),this.cameraPoseData=e;const a={dashed:!0,dashSize:10,gapSize:4,lineWidth:u.kV,color:p.V.WHITE,dashUnits:d.EX.PIXELS,depthWrite:!1,depthTest:!1,depthFunc:s.LessDepth,globalOpacity:u.lO,transitionType:d.ES.FADE_IN,transitionDuration:m.rH},o={radius:5};i&&(a.fadeDepth=m.Zc,a.fadeDepthTexture=i,o.fadeDepth=m.Zc,o.fadeDepthTexture=i),this.solidDatums=new d.y4([],a,this.cameraPoseData),this.datumCircles=new l([],o,this.cameraPoseData),this.updateEndpoints(t)}updateEndpoints(t){this.solidDatums.updateEndpoints(t);const e=[];for(const i of t)for(const t of i.points)e.push({position:t});this.datumCircles.setPositions(e)}globalOpacity(t,e){this.solidDatums.globalOpacity(t),this.datumCircles.setMaterialParams({opacity:t})}translationOffset(t){this.solidDatums.translationOffset(t),this.datumCircles.setMaterialParams({translationOffset:t})}}},48758:(t,e,i)=>{"use strict";i.d(e,{K:()=>o});var s=i(68909);const a=new s.Vector3,o=(t,e,i,s,o)=>(a.subVectors(e,s.position).normalize(),o.subVectors(e,t).normalize(),o.set(-o.z,o.y,o.x),o.multiplyScalar(-Math.sign(o.dot(a))*i),o)},78291:(t,e,i)=>{"use strict";i.d(e,{Gt:()=>g,HW:()=>m,O8:()=>f,Zd:()=>c,mk:()=>v,yd:()=>p});var s=i(23689),a=i(71101),o=i(68909),n=i(52885),r=i(60552),h=i(94814),l=i(81662),d=i(48758);class c extends s.r{get iconScale(){return r.xE}constructor(t,e,i,s,n){super(t,e,i),this.floorId=e,this.parentOpeningView=s,this.instanceBuffer=n,this.iconName="arrows",this.heightOffset=.5,this.outlinePct=.4,this.currOuterColor=r.fj.baseState.outerColor.clone(),this.currInnerColor=r.fj.baseState.innerColor.clone(),this.userIsInside=!1,this.enabled=!0,this.centerPosition=new o.Vector3,this.endPoints={start:new o.Vector3,end:new o.Vector3,halfWidth:.1},this.updatePosition=(()=>{const t=new o.Vector3,e=new o.Vector3;return()=>{(0,d.K)(this.endPoints.start,this.endPoints.end,this.endPoints.halfWidth,this.cameraData.pose,t),e.copy(this.centerPosition).add(t),this.instanceBuffer.setPositionForInstance(this,e)}})(),this.currScale=this.iconScale,this.targetScale=this.iconScale,this.prevScale=this.iconScale,this.renderOrder=a.S.NODE,this.colors=r.fj,this.animation.onChanged((()=>this.onAnimationChange())),this.instanceBuffer.createIcon(this.iconName,this),this.instanceBuffer.setInnerColorForInstance(this,this.currInnerColor),this.instanceBuffer.setOutlineForInstance(this,this.currOuterColor,this.outlinePct),this.instanceBuffer.setScaleForInstance(this,this.currScale),this.instanceBuffer.setOpacityForInstance(this,1),this.instanceBuffer.renderOrder=this.renderOrder}beforeRender(){}onAnimationChange(){const t=this.prevColorState,e=this.targetColorScheme;this.currOuterColor.lerpColors(t.outerColor,e.outerColor,this.animation.value),this.currInnerColor.lerpColors(t.innerColor,e.innerColor,this.animation.value),this.instanceBuffer.setInnerColorForInstance(this,this.currInnerColor),this.instanceBuffer.setOutlineForInstance(this,this.currOuterColor,this.outlinePct);const i=(0,n.C)(this.prevScale,this.targetScale,this.animation.value);this.instanceBuffer.setScaleForInstance(this,i)}updateMaterial(){this.prevScale=this.currScale,this.targetScale=this.iconScale+(this.hoverState.active?r.w4:0);let t=this.colors.baseState;this.hoverState.active&&(t=this.colors.hoverState);t!==this.targetColorScheme&&(this.targetColorScheme=t),this.prevColorState.innerColor.copy(this.currInnerColor),this.prevColorState.outerColor.copy(this.currOuterColor),this.animation.modifyAnimation(0,1,r.JT,h.WD)}hasIntersectionPriorityWithRespectTo(t){return!(!t.object||!t.object.isModelMesh)}onRender(t,e){this.raycastEnabled=e>.8&&this.userIsInside&&this.enabled}raycast(t,e){this.userIsInside&&this.instanceBuffer.material.uniforms.globalOpacity.value>.8&&this.instanceBuffer.raycastInstance(this,this.iconName,t,e)}updateOpacity(){const t=this.userIsInside&&this.enabled?1:0;this.instanceBuffer.setOpacityForInstance(this,t)}setUserIsInsideRoom(t,e){this.userIsInside=t,this.updateOpacity(),this.updatePosition()}updatePlacement(t,e,i,s){const a=t.clone().addScaledVector(l.B1.UP,i*this.heightOffset);this.endPoints=s,this.centerPosition.copy(a),this.updatePosition(),this.instanceBuffer.setRotationForInstance(this,e)}updateIcon(){this.instanceBuffer.setIconName(this.iconName,this)}centerPos(){return this.centerPosition}setEnabled(t){this.enabled=t,this.updateOpacity()}dispose(){this.instanceBuffer.removeIcon(this)}}class u extends c{constructor(){super(...arguments),this.heightOffset=.5,this.iconName="arrows"}beforeRender(){throw new Error("Method not implemented.")}}class p extends c{constructor(){super(...arguments),this.heightOffset=.4,this.iconName="position-3d-horizontal",this.outlinePct=.3}get iconScale(){return 1.5*r.xE}beforeRender(){throw new Error("Method not implemented.")}}class m extends u{}class g extends u{}class f extends u{constructor(){super(...arguments),this.heightOffset=1}}class v extends u{constructor(){super(...arguments),this.heightOffset=0}}},41644:(t,e,i)=>{"use strict";i.d(e,{a:()=>n});var s=i(68909),a=i(40397),o=i(60552);const n=(()=>{const t=new s.Vector3,e=new s.Vector2,i=new s.Vector2,n=new s.Line3;return(r,h,l,d,c,u,p)=>{n.set(r,h);const m=n.closestPointToPoint(u.ray.origin,!0,t);e.set(m.x,m.z),i.set(u.ray.origin.x,u.ray.origin.z);const g=e.distanceTo(i),f=u.ray.origin.distanceTo(n.start),v=(0,a.ff)(f,d.pose.projection.asThreeMatrix4(),d.width),b=o.ub*v;g<.5*Math.max(l,o.FY)+b&&p.push({distance:f,object:c,point:m.clone(),face:{a:-1,b:-1,c:-1,materialIndex:-1,normal:new s.Vector3(0,1,0)}})}})()},20854:(t,e,i)=>{"use strict";i.d(e,{BC:()=>c,LH:()=>S,Lv:()=>g,Pm:()=>b,Vr:()=>f,Wh:()=>d,Yv:()=>m,ay:()=>C,dr:()=>y,jT:()=>h,kV:()=>p,lO:()=>r,lQ:()=>v,u4:()=>u,z2:()=>l});var s=i(38069),a=i(86324),o=i(68909),n=i(60552);const r=1,h=.3,l=.4,d=.6,c=.6,u=.01,p=1,m=2,g={dashed:!1,dashSize:1,gapSize:1,lineWidth:p,color:s.V.WHITE,dashUnits:a.EX.METERS,depthWrite:!1,depthTest:!0,depthFunc:o.LessDepth,globalOpacity:r},f=Object.assign(Object.assign({},g),{fadeAlongLineStartPct:c}),v={dashed:!1,dashSize:.08,gapSize:.04,lineWidth:.5,color:s.V.WHITE,dashUnits:a.EX.METERS,depthWrite:!1,depthTest:!0,depthFunc:o.GreaterDepth,globalOpacity:h},b=Object.assign(Object.assign({},v),{fadeAlongLineStartPct:c}),S={dashed:!0,dashSize:10,gapSize:4,lineWidth:p,color:s.V.WHITE,dashUnits:a.EX.PIXELS,depthWrite:!1,depthTest:!0,depthFunc:o.LessDepth,globalOpacity:r},y={dashed:!0,dashSize:10,gapSize:4,lineWidth:p,color:s.V.WHITE,dashUnits:a.EX.PIXELS,depthWrite:!1,depthTest:!0,depthFunc:o.GreaterDepth,globalOpacity:h},C=(t,e,i)=>{const h={dashed:!1,dashSize:1,gapSize:1,lineWidth:.5,color:s.V.WHITE,dashUnits:a.EX.METERS,depthWrite:!1,depthTest:!1,depthFunc:o.LessDepth,globalOpacity:null!=i?i:r,fadeDistanceFromCamera:n.GG,transitionType:a.ES.FADE_IN,transitionDuration:n.rH};return t&&(h.fadeDepth=n.Zc,h.fadeDepthTexture=t),e&&(h.fadeAlongLineStartPct=e),h}},60552:(t,e,i)=>{"use strict";i.d(e,{Dh:()=>p,FY:()=>h,Fg:()=>S,GG:()=>b,IS:()=>c,JT:()=>d,W5:()=>y,Zc:()=>v,fj:()=>C,jd:()=>u,kt:()=>m,m7:()=>a,rH:()=>f,ub:()=>r,w4:()=>n,wX:()=>g,xE:()=>o,xX:()=>l});var s=i(38069);const a=.06,o=2,n=1,r=7,h=.1,l=.02,d=100,c=8,u=500,p=.9,m=1e3,g="room-label-collision",f=300,v=.1,b=20,S=.6,y=.05,C={baseState:{opacity:1,innerColor:s.V.MIRROR,outerColor:s.V.PORTAL},hoverState:{opacity:1,innerColor:s.V.MP_BRAND,outerColor:s.V.WHITE},selectState:{opacity:1,innerColor:s.V.MIRROR,outerColor:s.V.PORTAL},dimState:{opacity:1,innerColor:s.V.MIRROR,outerColor:s.V.PORTAL}}},87708:(t,e,i)=>{"use strict";i.d(e,{OW:()=>R,Om:()=>M,Tx:()=>B,p$:()=>V,zP:()=>T,zs:()=>P});var s=i(38069),a=i(68909),o=i(32686),n=i.n(o),r=i(47876),h=i.n(r),l=i(82312),d=i.n(l),c=i(93854),u=i.n(c),p=i(63380),m=i.n(p),g=i(1834),f=i.n(g),v=i(66083),b=i.n(v),S=i(4605),y=i.n(S),C=i(69555),E=i.n(C),x=i(17709),L=i.n(x),D=i(12201),w=i.n(D),I=i(76539),A=i.n(I),O=i(40160);const V={uniforms:{outlinePct:{value:.8},globalOpacity:{value:0}},vertexShader:n(),fragmentShader:h()},T={uniforms:{selectedWidth:{value:.03},globalOpacity:{value:0}},vertexShader:d(),fragmentShader:u()},P={uniforms:{globalOpacity:{value:0}},vertexShader:m(),fragmentShader:f()},M={uniforms:{opacity:{value:1},centerSpacing:{value:24},radius:{value:4},color:{value:s.V.LENS_GRAY}},vertexShader:b(),fragmentShader:y()},R={uniforms:{color:{type:"v4",value:s.V.WHITE},globalOpacity:{type:"f",value:0},outline:{value:1},outlineColor:{value:s.V.BLACK},screenSize:{value:new a.Vector2},tipPaddingPx:{value:2},widthPx:{value:12},heightPx:{value:6},aaPaddingPx:{value:2},metersPerPx:{value:.01},autoScale:{value:1}},vertexShader:E(),fragmentShader:L()},B={uniforms:{maxDistance:{value:O.sv}},vertexShader:w(),fragmentShader:A()}},59126:(t,e,i)=>{"use strict";i.d(e,{K:()=>a});var s=i(77201);class a extends s.B_{constructor(t){super(),this.editorState=t,this.name="room-bound-editor-state-data",this.commit()}}},80587:(t,e,i)=>{"use strict";i.d(e,{D:()=>h});var s=i(92788),a=i(98720),o=i(87440),n=i(8129),r=i(81020);class h{constructor(t,e){this.editor=t,this.data=e,this.readBindings=[],this.mover={onMove:(t,e)=>{}},this.onCurrentChange=({target:t})=>{this.editor.state.toolState!==o.K.ToolState.ADDING&&this.clearHighlightedViews(),this.highlightView(t)},this.onSelectChange=({target:t})=>{this.setSelectedView(t)},this.onHoverChange=({target:t,previous:e})=>{if(this.editor.state.toolState===o.K.ToolState.ADDING)return;if(!t)return this.editor.clearAllDims(),this.editor.clearAllHighlights(),void(this.editor.state.selected&&this.setSelectedView(this.editor.state.selected));const i=this.data.getEntity(t);this.hoverView(i)},this.editableEntities=new n.F.EditorEntityAdapter(this.editor)}addEditableEntity(t,e){this.editableEntities.registerEntity(e,this,t)}removeEditableEntity(t){this.editableEntities.unregisterEntity(t)}activate(){0===this.readBindings.length?this.readBindings.push(this.editor.subscribe(r.S.Events.CurrentChange,this.onCurrentChange),this.editor.subscribe(r.S.Events.SelectChange,this.onSelectChange),this.editor.subscribe(o.K.Events.HoverChange,this.onHoverChange)):this.readBindings.forEach((t=>t.renew()))}deactivate(){this.readBindings.forEach((t=>t.cancel()))}clearHighlightedViews(){this.editor.clearAllHighlights()}highlightView(t){if(!t)return;const e=this.data.getEntity(t);e instanceof a.j&&this.editor.highlight(t,e.from.id,e.to.id)}setSelectedView(t){if(!t)return void this.editor.clearAllDims();const e=this.data.getEntity(t);e instanceof a.j&&this.editor.highlight(e.from.id,e.to.id),e instanceof s.pQ&&(this.clearHighlightedViews(),this.dimAllRooms(),this.selectRoom(e))}dimAllRooms(){this.editor.clearAllDims();for(const[,t]of this.data.rooms)this.dimRoom(t)}hoverView(t){t instanceof s.pQ&&this.hoverRoom(t)}hoverRoom(t){const e=t.id;this.editor.clearDim(e);for(const e of t.walls)this.editor.clearDim(e.id),this.highlightWallOpenings(e);for(const e of t.points)this.editor.clearDim(e.id)}selectRoom(t){const e=t.id;this.editor.clearDim(e);for(const e of t.walls)this.editor.clearDim(e.id),this.highlightWallOpenings(e);for(const e of t.points)this.editor.clearDim(e.id)}dimRoom(t){const e=t.id;this.editor.dim(e);for(const e of t.walls)this.editor.dim(e.id),this.clearHighlightWallOpenings(e);for(const e of t.points)this.editor.dim(e.id)}highlightWallOpenings(t){this.editor.highlight(...t.openings.map((t=>t.id)))}clearHighlightWallOpenings(t){this.editor.clearHighlight(...t.openings.map((t=>t.id)))}}},84574:(t,e,i)=>{"use strict";i.d(e,{C:()=>a,Z:()=>o});var s=i(77201);class a extends s.uB{constructor(t){super(),this.payload={id:t}}}a.id="roombound_unselect";class o extends s.uB{constructor(t){super(),this.payload={allowRendering:t}}}o.id="room_bound_set_allow_rendering"},58687:(t,e,i)=>{"use strict";i.d(e,{M:()=>o});var s=i(77201),a=i(98848);class o extends s.B_{constructor(t={}){super(),this.name="storage-data",this.lastPublished=null,this.transactionState=a.i.IDLE,this.isInProcessingSubState=!1,Object.assign(this,t)}setTransactionState(t){if(t!==this.transactionState){if(![this.transactionState,t].includes(a.i.IDLE))throw new Error(`Cannot transition from ${this.transactionState} to ${t}`);this.transactionState=t,this.transactionState===a.i.IDLE&&(this.isInProcessingSubState=!1),this.commit()}}setProcessingSubState(t){if(t&&this.transactionState===a.i.IDLE)throw new Error("Cannot be in a Processing sub-state while Transaction State is Idle");this.isInProcessingSubState=t,this.commit()}}},98848:(t,e,i)=>{"use strict";var s,a;i.d(e,{i:()=>s,w:()=>a}),function(t){t.IDLE="idle",t.SAVING="saving"}(s||(s={})),function(t){t.ON="on",t.BEFORE="before",t.AFTER="after"}(a||(a={}))},89432:(t,e,i)=>{"use strict";i.d(e,{w:()=>m});var s=i(74848),a=i(96540),o=i(56147),n=i(73566);const{NEW_BADGE:r}=o.A.WORKSHOP.EDIT_BAR,{AUTOGEN_TOUR_CREATED_TITLE:h,AUTOGEN_TOUR_CREATED_MESSAGE:l,AUTOGEN_TOUR_READY_TITLE:d,AUTOGEN_TOUR_READY_MESSAGE:c}=o.A.WORKSHOP.HLR,u={[n.Q7.HLR_AUTOGEN_TOUR_CREATED]:{AnnouncementComponent:(0,a.lazy)((()=>Promise.all([i.e(654),i.e(8636)]).then(i.bind(i,61055)))),configProps:{icon:"sparkle",badgePhraseKey:r,titlePhraseKey:h,messagePhraseKey:l}},[n.Q7.HLR_AUTOGEN_TOUR_READY]:{AnnouncementComponent:(0,a.lazy)((()=>Promise.all([i.e(654),i.e(8636)]).then(i.bind(i,61055)))),configProps:{icon:"sparkle",badgePhraseKey:r,titlePhraseKey:d,messagePhraseKey:c,tooltipOptions:{placement:"top",strategy:"absolute"}}}};var p=i(78591);function m({target:t,announcement:e}){if((0,p.C)(e)!==n.zR.OPEN)return null;const{AnnouncementComponent:i,configProps:o}=u[e];return(0,s.jsx)(a.Suspense,{children:(0,s.jsx)(i,Object.assign({},o,{target:t,announcement:e}))})}},62772:(t,e,i)=>{"use strict";i.d(e,{R:()=>o});var s=i(17904),a=i(71687);function o(){return(0,s.S)(a.uq)}},78591:(t,e,i)=>{"use strict";i.d(e,{C:()=>n});var s=i(96540),a=i(73566),o=i(62772);function n(t){const e=(0,o.R)(),[i,n]=(0,s.useState)((()=>{var i;return null!==(i=null==e?void 0:e.getToolAnnouncementState(t))&&void 0!==i?i:a.zR.IDLE}));return(0,s.useEffect)((()=>{if(!e)return;n(e.getToolAnnouncementState(t));const i=e.onToolAnnouncementStateChanged(t,((t,e)=>{n(e)}));return()=>{i.cancel()}}),[e,t]),i}},35568:(t,e,i)=>{"use strict";i.d(e,{o:()=>s,A:()=>l});var s,a=i(54387),o=i(77201),n=i(68909),r=i(12767);class h extends n.Object3D{constructor(t){super(),this.anchor=this,this.reset=()=>{this.camera.position.set(0,0,0),this.camera.layers.mask=o.HU.ALL.mask,this.camera.updateMatrixWorld(!0)},this.update=t=>{this.anchor.position.copy(t.position),this.camera.quaternion.copy(t.rotation),this.camera.projectionMatrix.copy(t.projection.asThreeMatrix4()),this.camera.projectionMatrixInverse.copy(t.projection.asThreeMatrix4()),this.camera.projectionMatrixInverse.invert(),this.updateMatrixWorld(!0)},this.camera=new n.PerspectiveCamera(r.Bv.fov,t,r.Bv.near,r.Bv.far),this.add(this.camera),this.name="CameraRig",this.reset()}dispose(){this.remove(this.camera)}}!function(t){t[t.Root=0]="Root",t[t.CameraRig=1]="CameraRig"}(s||(s={}));class l{get lastRenderCallTime(){return this._lastRenderCallTime}constructor(t,e,i,a,o){this.scene=t,this.threeRenderer=e,this.cameraData=i,this.viewportManager=a,this.engine=o,this.ids=s,this.frameCount=0,this.effectComposer=null,this.rendering=!1,this.cameraRigStale=!0,this.canvasSizeChanged=!0,this.updateComposer=(()=>{const t=new n.Vector2;return()=>{this.canvasSizeChanged&&this.effectComposer&&(this.effectComposer.setPixelRatio(this.effectComposer.renderer.getPixelRatio()),this.effectComposer.renderer.getSize(t),this.effectComposer.setSize(t.x,t.y),this.canvasSizeChanged=!1)}})(),this.renderViewports=(()=>{const t=new n.Vector2;return e=>{var i,s;this.threeRenderer.clear();const a=this.cameraRig.camera.layers.mask;for(const a of this.viewportManager.viewports)if(this.viewportManager.renderingViewport=a,this.viewportManager.commit(),a.rect.getSize(t),this.threeRenderer.setViewport(a.rect.min.x,a.rect.min.y,t.x,t.y),null===(s=(i=this.engine).triggerRenderViewport)||void 0===s||s.call(i,e),this.effectComposer){const t=this.effectComposer.passes[0];t.scene=a.scene||this.scene,t.camera=a.camera,this.effectComposer.render(e)}else this.threeRenderer.render(a.scene||this.scene,a.camera);this.cameraRig.camera.layers.mask=a,this.viewportManager.renderingViewport=null,this.viewportManager.commit()}})(),this.cameraRig=new h(i.aspect()),a.setDomElement(e.domElement),this.viewportManager.defaultViewport.scene=this.scene,this.viewportManager.defaultViewport.camera=this.cameraRig.camera,e.info.autoReset=!1}add(...t){for(const e of t)this.addChild(s.Root,e)}remove(...t){for(const e of t)this.removeChild(s.Root,e)}addChild(t,e){switch(t){case s.Root:this.scene.add(e);break;case s.CameraRig:this.cameraRig.add(e);break;default:return!1}return!0}removeChild(t,e){switch(t){case s.Root:this.scene.remove(e);break;case s.CameraRig:this.cameraRig.remove(e);break;default:return!1}return!0}getSubTree(t){return(0,a.W9)(this.scene,t)}get camera(){return this.updateCameraRig(),this.cameraRig.camera}init(){this.cameraRigStale=!0}dispose(){this.cameraRig.dispose()}startRender(t){this.rendering=t}activate(t){this.scene.add(this.cameraRig),this.cameraDataCallback=()=>this.cameraRigStale=!0,this.cameraData.onChanged(this.cameraDataCallback),this.canvasSizeSub=new o.PF(this.cameraData.onPropertyChanged("width",(()=>this.onCanvasSizeChanged())),this.cameraData.onPropertyChanged("height",(()=>this.onCanvasSizeChanged())))}deactivate(t){var e;this.scene.remove(this.cameraRig),this.cameraData.pose.removeOnChanged(this.cameraDataCallback),null===(e=this.canvasSizeSub)||void 0===e||e.cancel()}beforeRender(){this.updateCameraRig(),this.updateComposer()}setCameraDirty(){this.cameraRigStale=!0,this.cameraRig.camera.updateProjectionMatrix()}onCanvasSizeChanged(){this.viewportManager.updateDefaultViewport(),this.canvasSizeChanged=!0}updateCameraRig(){this.cameraRigStale&&(this.cameraRig.update(this.cameraData.pose),this.cameraRigStale=!1)}render(t){var e,i;if(this.rendering)this.threeRenderer.info.reset(),this.renderViewports(t),this.frameCount++;else{for(const s of this.viewportManager.viewports)this.viewportManager.renderingViewport=s,this.viewportManager.commit(),null===(i=(e=this.engine).triggerRenderViewport)||void 0===i||i.call(e,t);this.viewportManager.renderingViewport=null,this.viewportManager.commit()}this._lastRenderCallTime=Date.now()}}},69483:(t,e,i)=>{"use strict";i.d(e,{bK:()=>l,tx:()=>n});var s=i(81662),a=i(68909),o=i(53172);var n;!function(t){t[t.Axes=1]="Axes",t[t.PlanarAxes=2]="PlanarAxes",t[t.EdgesAndPlanarAxes=3]="EdgesAndPlanarAxes",t[t.Edges=4]="Edges",t[t.Free=5]="Free",t[t.Locked=6]="Locked"}(n||(n={}));const r={[s.os.UP]:{dir:Object.freeze(s.B1.UP.clone())},[s.os.DOWN]:{dir:Object.freeze(s.B1.DOWN.clone())},[s.os.BACK]:{dir:Object.freeze(s.B1.BACK.clone())},[s.os.LEFT]:{dir:Object.freeze(s.B1.LEFT.clone())},[s.os.RIGHT]:{dir:Object.freeze(s.B1.RIGHT.clone())},[s.os.FORWARD]:{dir:Object.freeze(s.B1.FORWARD.clone())}},h={[s.os.HORIZONTAL_PLANE]:{dir:Object.freeze(s.B1.HORIZONTAL_PLANE.clone())}},l=(()=>{let t=0;const e=new a.Vector3,i=new a.Vector3,l=new a.Vector3,d=new a.Vector3,c=999,u=Object.freeze(s.B1.ZERO.clone()),p=Object.keys(r).map((t=>Object.assign(Object.assign({},r[t]),{name:t,angleTo:c}))),m=Object.keys(h).map((t=>Object.assign(Object.assign({},h[t]),{name:t,angleTo:c}))),g=t=>(t+3)%2;let f=p[0];return(a,r,h=n.Axes)=>{if(h===n.Free)return{position:r.clone(),constrainedAxis:u,axisName:s.os.NONE};if(p.forEach((t=>t.angleTo=c)),m.forEach((t=>t.angleTo=c)),l.copy(r).sub(a),t=l.length(),t<.05)return{position:r.clone(),constrainedAxis:u,axisName:s.os.NONE};d.copy(l).normalize();const v=.05*Math.min(t,1);if(h!==n.Locked){for(const t of p){const e=(0,o.H)(d.angleTo(t.dir));e<f.angleTo&&(f=t),t.angleTo=e}if(f.angleTo>20){const t=Math.abs(l.y);t*t<v&&(f=m[0])}}e.set(a.x*g(f.dir.x),a.y*g(f.dir.y),a.z*g(f.dir.z)),i.set(r.x*Math.abs(f.dir.x),r.y*Math.abs(f.dir.y),r.z*Math.abs(f.dir.z)).add(e);return h===n.Locked||i.distanceToSquared(r)<v?{position:i.clone(),constrainedAxis:f.dir,axisName:f.name}:{position:r.clone(),constrainedAxis:u,axisName:s.os.NONE}}})()},8129:(t,e,i)=>{"use strict";i.d(e,{F:()=>a});var s,a,o=i(87440),n=i(81020);!function(t){class e extends o.K.DragAndDropBase{constructor(t=new i){super(t,new o.K.EventConstructors(s.AddStart,s.EditStart,s.AddConfirm,s.AddDiscard,s.EditConfirm,s.EditDiscard,s.Delete,s.Move,s.CurrentChange,s.SelectChange,s.ValidChange)),this.state=t}add(t){this.internalAdd(new Set(t))}edit(t){this.internalEdit(new Set(t))}place(t){this.internalPlace(new Set(t))}select(t,e){const i=(null==e?void 0:e.addToExistingSelection)&&this.state.selected?Array.from(this.state.selected.keys()).concat(t):t;this.internalSelect(new Set(i),e)}toggleSelect(t){var e;const i=new Set(null===(e=this.state.selected)||void 0===e?void 0:e.keys());for(const e of t)i.has(e)?i.delete(e):i.add(e);this.internalSelect(i)}}t.DragAndDrop=e;class i extends o.K.BaseState{}let s;t.State=i,function(t){class e extends o.K.Events.BaseAddStart{}t.AddStart=e;class i extends o.K.Events.BaseEditStart{}t.EditStart=i;class s extends o.K.Events.BaseAddConfirm{}t.AddConfirm=s;class a extends o.K.Events.BaseAddDiscard{}t.AddDiscard=a;class n extends o.K.Events.BaseEditConfirm{}t.EditConfirm=n;class r extends o.K.Events.BaseEditDiscard{}t.EditDiscard=r;class h extends o.K.Events.BaseDelete{}t.Delete=h;class l extends o.K.Events.BaseMove{}t.Move=l;class d extends o.K.Events.BaseCurrentChange{}t.CurrentChange=d;class c extends o.K.Events.BaseSelectChange{}t.SelectChange=c;class u extends o.K.Events.BaseValidChange{}t.ValidChange=u}(s=t.Events||(t.Events={}))}(s||(s={})),function(t){const e={[o.K.Events.HoverChange.type]:"hoverState",[o.K.Events.HighlightAdd.type]:"highlightState",[o.K.Events.HighlightClear.type]:"highlightState",[o.K.Events.DimAdd.type]:"dimState",[o.K.Events.DimClear.type]:"dimState"};class i{constructor(t){this.editor=t,this.bindings=[],this.entities=new Map,this.bindings.push(this.editor.subscribe(o.K.Events.HoverChange,(t=>this.bindTargetedCallback(o.K.Events.HoverChange.type,t))),this.editor.subscribe(o.K.Events.HighlightAdd,(t=>this.bindTargetedCallback(o.K.Events.HighlightAdd.type,t))),this.editor.subscribe(o.K.Events.HighlightClear,(t=>this.bindClearCallback(o.K.Events.HighlightClear.type,t))),this.editor.subscribe(o.K.Events.DimAdd,(t=>this.bindTargetedCallback(o.K.Events.DimAdd.type,t))),this.editor.subscribe(o.K.Events.DimClear,(t=>this.bindClearCallback(o.K.Events.DimClear.type,t))))}registerEntity(t,...e){let i=this.entities.get(t);i||(i=[]),i.push(...e),this.entities.set(t,i)}unregisterEntity(t){return this.entities.delete(t)}bindTargetedCallback(t,e){const{target:i,previousTarget:s}=this.getTargetAndPrevIds(e),a=this.eventToCallbackMapping[t];if(!a)throw Error(`implement targetted callback for ${t}`);for(const t of s)(this.entities.get(t)||[]).forEach((t=>{a in t&&(t[a].active=!1,t[a].off())}));for(const t of i)(this.entities.get(t)||[]).forEach((t=>{a in t&&(t[a].active=!0,t[a].on())}))}bindMoveCallback(t){const{target:e}=this.getTargetAndPrevIds(t);for(const i of e)(this.entities.get(i)||[]).forEach((e=>{e.mover&&t.target&&e.mover.onMove(i,t.ev)}))}bindClearCallback(t,e){const i=this.eventToCallbackMapping[t],{target:s}=this.getTargetAndPrevIds(e);for(const t of s)(this.entities.get(t)||[]).forEach((t=>{i in t&&(t[i].active=!1,t[i].off())}))}}t.BaseEditorEntityAdapter=i;t.EditorEntityAdapter=class extends i{constructor(t){super(t),this.eventToCallbackMapping=Object.assign(Object.assign({},e),{[n.S.Events.SelectChange.type]:"selectState",[n.S.Events.ValidChange.type]:"validState",[n.S.Events.Move.type]:"mover"}),this.bindings.push(this.editor.subscribe(n.S.Events.SelectChange,(t=>this.bindTargetedCallback(n.S.Events.SelectChange.type,t))),this.editor.subscribe(n.S.Events.ValidChange,(t=>this.bindTargetedCallback(n.S.Events.ValidChange.type,t))),this.editor.subscribe(n.S.Events.Move,(t=>this.bindMoveCallback(t))))}getTargetAndPrevIds(t){if(o.K.Events.hasTargetAndPrev(t))return{target:t.target?[t.target]:[],previousTarget:t.previous?[t.previous]:[]};if(o.K.Events.hasTarget(t))return{target:t.target?[t.target]:[],previousTarget:[]};throw new Error("Unexpected message!!")}};t.MultiSelectEditorEntityAdapter=class extends i{constructor(t){super(t),this.eventToCallbackMapping=Object.assign(Object.assign({},e),{[s.Events.SelectChange.type]:"selectState",[s.Events.ValidChange.type]:"validState",[s.Events.Move.type]:"mover"}),this.bindings.push(this.editor.subscribe(s.Events.SelectChange,(t=>this.bindTargetedCallback(s.Events.SelectChange.type,t))),this.editor.subscribe(s.Events.ValidChange,(t=>this.bindTargetedCallback(s.Events.ValidChange.type,t))),this.editor.subscribe(s.Events.Move,(t=>this.bindMoveCallback(t))))}getTargetAndPrevIds(t){const e=t=>t instanceof Set?Array.from(t.keys()):null!==t?[t]:[];if(o.K.Events.hasTargetAndPrev(t))return{target:t.target?e(t.target):[],previousTarget:t.previous?e(t.previous):[]};if(o.K.Events.hasTarget(t))return{target:t.target?e(t.target):[],previousTarget:[]};throw new Error("Unexpected message!!")}}}(a||(a={}))},87440:(t,e,i)=>{"use strict";i.d(e,{K:()=>r});var s=i(77201),a=i(97800),o=i(52018);const n=new a.Vy("editor");var r;!function(t){t.DragAndDropBase=class{subscribe(t,e){return this.events.subscribe(t,e)}constructor(t=new a,e){this.state=t,this.eventConstructors=e,this.events=new s.QY,this.bindings=[],this.validator=null,this.state.commit(),this.bindings.push(this.state.onPropertyChanged("toolState",(()=>{n.debug("toolState:",{from:this.state.previousToolState,to:this.state.toolState},this.state),this.events.broadcast(new i.StateChange(this.state.toolState,this.state.previousToolState))})),this.onSelectedChanged(((t,i)=>{this.events.broadcast(new e.SelectChange(t,i))})),this.onHoveredChanged(((t,e)=>{this.events.broadcast(new i.HoverChange(t,e))})),this.state.onCurrentIdChanged(((t,i)=>{this.events.broadcast(new e.CurrentChange(t,i))}))),this.bindings.forEach((t=>t.cancel()))}setState(t){t!==this.state.toolState&&(this.state.previousToolState=this.state.toolState,this.state.toolState=t,this.state.commit())}start(){const{toolState:t}=this.state;if(t!==e.CLOSED)throw new r("Editor already started");this.bindings.forEach((t=>t.renew())),this.setState(e.IDLE),this.events.broadcast(new i.Start)}setEnabled(t){if(this.state.toolState===e.CLOSED)throw new r("Editor not started");if(t)this.state.toolState===e.DISABLED&&this.setState(e.IDLE);else switch(this.state.toolState){case e.DISABLED:break;case e.IDLE:this.setState(e.DISABLED);break;default:this.unhover({commit:!1}),this.deselect({commit:!1}),this.discard(),this.setState(e.DISABLED)}}exit(){this.state.toolState!==e.CLOSED&&(this.state.toolState!==e.DISABLED&&(this.unhover({commit:!1}),this.deselect({commit:!1}),this.discard()),this.setState(e.CLOSED),this.bindings.forEach((t=>t.cancel())),this.events.broadcast(new i.Exit))}setValidator(t){this.validator=t}onDiscard(t){this.state.onBeforeDiscard=t||null}internalEdit(t){if(this.assertActive(),null!==this.state.pendingEdit)throw n.error(`Trying to edit asset ${t}, but currently editing ${this.state.pendingEdit}`),new r("Edit in progress");this.state.pendingEdit=t,this.setState(e.EDITING),this.events.broadcast(new this.eventConstructors.EditStart(t,!1))}waitForAdd(){if(this.assertActive(),null!==this.state.pendingAdd)throw n.error(`Entering wait for add state, but already adding ${this.state.pendingAdd}`),new r("Add in progress");null!==this.state.selected&&(n.debug(`Entering the wait for add state, deselecting previous ${this.state.selected}`),this.deselect({commit:!1})),this.events.broadcast(new i.WaitForAddStart),this.setState(e.WAIT_FOR_ADD)}internalAdd(t){if(this.assertActive(),null!==this.state.pendingAdd)throw n.error(`Trying to add new asset ${t}, but already adding ${this.state.pendingAdd}`),new r("Add in progress");null!==this.state.selected&&(n.debug(`Add ${t} called, deselecting previous ${this.state.selected}`),this.deselect({commit:!1})),this.state.pendingAdd=t,this.events.broadcast(new this.eventConstructors.AddStart(t)),this.setState(e.ADDING)}internalPlace(t){this.assertActive();const{pendingAdd:i,pendingEdit:s}=this.state,a=i||s;a&&t===a||(this.state.pendingEdit=t),this.setState(e.PLACING),this.events.broadcast(new this.eventConstructors.EditStart(t,!0))}move(t){this.assertActive(),this.validate(t);const{pendingAdd:e,pendingEdit:i,selected:s}=this.state,a=e||i||s;a&&this.events.broadcast(new this.eventConstructors.Move(a,t)),this.state.ndcPosition.value=t.clientPosition}highlight(...t){this.assertActive();for(const e of t)this.state.highlighted.add(e),this.events.broadcast(new i.HighlightAdd(e))}clearHighlight(...t){this.assertActive();for(const e of t)this.state.highlighted.delete(e),this.events.broadcast(new i.HighlightClear(e))}clearAllHighlights(){this.assertActive();for(const t of this.state.highlighted)this.events.broadcast(new i.HighlightClear(t));this.state.highlighted.clear()}dim(t){this.assertActive(),this.state.dimmed.add(t),this.events.broadcast(new i.DimAdd(t))}clearDim(t){this.assertActive(),this.state.dimmed.delete(t),this.events.broadcast(new i.DimClear(t))}clearAllDims(){this.assertActive();for(const t of this.state.dimmed)this.events.broadcast(new i.DimClear(t));this.state.dimmed.clear()}internalSelect(t,i){this.assertActive(),this.state.pendingAdd||this.state.pendingEdit||(this.state.previousSelected=this.state.selected,this.state.selected=t,this.state.commit(),i&&i.transitionTo?this.setState(i.transitionTo):this.setState(e.SELECTED))}deselect(t={commit:!0}){this.assertActive(),this.state.pendingAdd||this.state.pendingEdit||null!==this.state.selected&&(this.state.previousSelected=this.state.selected,this.state.selected=null,t.commit&&this.state.commit(),t&&t.transitionTo?this.setState(t.transitionTo):this.setState(e.IDLE))}hover(t){this.assertActive(),t!==this.state.hovered&&(this.state.previousHovered=this.state.hovered,this.state.hovered=t,this.state.commit())}unhover(t={commit:!0}){this.state.hovered&&(this.state.previousHovered=this.state.hovered,this.state.hovered=null,t.commit&&this.state.commit())}tryCommit(){this.assertActive();const t=this.state.pendingAdd,e=this.state.pendingEdit;if(!1===this.state.pendingValid)return n.warn("nop, pendingValid",this.state.pendingValid),!1;let i=!1;const s=this.state.selected,a=this.state.pendingAdd||this.state.pendingEdit;if(a){const o=null===this.state.pendingValid||!0===this.state.pendingValid;o&&(this.state.pendingAdd=null,this.state.pendingEdit=null,this.state.pendingValid=null,this.state.onBeforeDiscard=null,e&&this.events.broadcast(new this.eventConstructors.EditConfirm(e)),t&&this.events.broadcast(new this.eventConstructors.AddConfirm(t)),this.state.pendingAdd||this.state.pendingEdit||s!==this.state.selected||this.internalSelect(a)),i=o}return i}discard(){const t=this.state.pendingAdd||this.state.pendingEdit,i=this.state.pendingAdd,s=this.state.pendingEdit;t&&(this.state.onBeforeDiscard&&this.state.onBeforeDiscard(),s&&(this.state.pendingEdit=null,this.events.broadcast(new this.eventConstructors.EditDiscard(s))),i&&(this.state.pendingAdd=null,this.events.broadcast(new this.eventConstructors.AddDiscard(i))),this.events.broadcast(new this.eventConstructors.ValidChange(null,null)),this.state.pendingValid=null,this.state.onBeforeDiscard=null),this.unhover({commit:!1}),this.deselect({commit:!1}),this.state.toolState!==e.IDLE&&this.setState(e.IDLE),this.state.commit()}validate(t){const e=this.state.pendingAdd||this.state.pendingEdit||this.state.selected;if(e){const i=this.state.pendingValid;let s=!0;this.validator?(s=this.validator.validate(e,t),this.state.pendingValid=s):this.state.pendingValid=null,null!==this.state.pendingValid&&i!==this.state.pendingValid&&this.events.broadcast(new this.eventConstructors.ValidChange(s?e:null,s?null:e))}}assertActive(){if(this.state.toolState===t.ToolState.CLOSED)throw new r("Editor closed");if(this.state.toolState===t.ToolState.DISABLED)throw new r("Editor disabled")}onSelectedChanged(t){return this.state.onPropertyChanged("selected",(()=>t(this.state.selected,this.state.previousSelected)))}onHoveredChanged(t){return this.state.onPropertyChanged("hovered",(()=>t(this.state.hovered,this.state.previousHovered)))}};let e,i;t.EventConstructors=class{constructor(t,e,i,s,a,o,n,r,h,l,d){this.AddStart=t,this.EditStart=e,this.AddConfirm=i,this.AddDiscard=s,this.EditConfirm=a,this.EditDiscard=o,this.Delete=n,this.Move=r,this.CurrentChange=h,this.SelectChange=l,this.ValidChange=d}},function(t){t.CLOSED="CLOSED",t.DISABLED="DISABLED",t.IDLE="IDLE",t.SELECTED="SELECTED",t.WAIT_FOR_ADD="WAIT_FOR_ADD",t.ADDING="ADDING",t.EDITING="EDITING",t.PLACING="PLACING"}(e=t.ToolState||(t.ToolState={}));class a extends s.vm{constructor(){super(...arguments),this.toolState=e.CLOSED,this.previousToolState=e.CLOSED,this.pendingAdd=null,this.pendingEdit=null,this.selected=null,this.previousSelected=null,this.hovered=null,this.previousHovered=null,this.highlighted=new Set,this.dimmed=new Set,this.ndcPosition=new s.Lj(null),this.onBeforeDiscard=null,this.pendingValid=null}get currentId(){return this.pendingAdd||this.pendingEdit||this.selected||null}onCurrentIdChanged(t,e=!1){let i=this.currentId;const a=()=>{this.currentId!==i&&(t(this.currentId,i),i=this.currentId)},o=new s.PF(this.onPropertyChanged("selected",a),this.onPropertyChanged("pendingAdd",a),this.onPropertyChanged("pendingEdit",a));return e?o.renew():o.cancel(),o}}t.BaseState=a;class r extends o.t{constructor(t="invalid state"){super(t),this.name="invalid state"}}t.EditorException=r,function(t){class e extends s.QB{}e.type="edit",t.EditEvent=e;class i extends e{constructor(t){super(),this.target=t}}i.type="editt",t.BaseEditTarget=i;class a extends e{constructor(t,e){super(),this.target=t,this.previous=e}}a.type="edittp",t.BaseEditTargetAndPrev=a;class o extends e{constructor(t,e){super(),this.target=t,this.previous=e}}o.type="toolchange",t.StateChange=o;class n extends e{}n.type="editorstart",t.Start=n;class r extends e{}r.type="editorexit",t.Exit=r;class h extends e{}h.type="waitforaddstart",t.WaitForAddStart=h;class l extends i{}l.type="addstart",t.BaseAddStart=l;class d extends i{constructor(t,e){super(t),this.placeOnly=e}}d.type="editstart",t.BaseEditStart=d;class c extends i{}c.type="addconfirm",t.BaseAddConfirm=c;class u extends i{}u.type="adddiscard",t.BaseAddDiscard=u;class p extends i{}p.type="editconfirm",t.BaseEditConfirm=p;class m extends i{}m.type="editdiscard",t.BaseEditDiscard=m;class g extends i{}g.type="delete",t.BaseDelete=g;class f extends i{constructor(t,e){super(t),this.target=t,this.ev=e}}f.type="move",t.BaseMove=f;class v extends a{}v.type="target",t.BaseCurrentChange=v;class b extends a{}b.type="hover",t.HoverChange=b;class S extends a{}S.type="select",t.BaseSelectChange=S;class y extends i{}y.type="highlight",t.HighlightAdd=y;class C extends i{}C.type="highlightclear",t.HighlightClear=C;class E extends i{}E.type="dim",t.DimAdd=E;class x extends i{}x.type="dimclear",t.DimClear=x;class L extends a{}L.type="valid",t.BaseValidChange=L,t.hasTarget=function(t){return t instanceof i},t.hasTargetAndPrev=function(t){return t instanceof a}}(i=t.Events||(t.Events={}))}(r||(r={}))},81020:(t,e,i)=>{"use strict";i.d(e,{S:()=>s});var s,a=i(87440);!function(t){class e extends a.K.DragAndDropBase{constructor(t=new i){super(t,new a.K.EventConstructors(s.AddStart,s.EditStart,s.AddConfirm,s.AddDiscard,s.EditConfirm,s.EditDiscard,s.Delete,s.Move,s.CurrentChange,s.SelectChange,s.ValidChange)),this.state=t}add(t){this.internalAdd(t)}edit(t){this.internalEdit(t)}place(t){this.internalPlace(t)}select(t,e){this.internalSelect(t,e)}toggleSelect(t){this.state.selected===t?this.deselect():this.select(t)}}t.DragAndDrop=e;class i extends a.K.BaseState{}let s;t.State=i,function(t){class e extends a.K.Events.BaseAddStart{}t.AddStart=e;class i extends a.K.Events.BaseEditStart{}t.EditStart=i;class s extends a.K.Events.BaseAddConfirm{}t.AddConfirm=s;class o extends a.K.Events.BaseAddDiscard{}t.AddDiscard=o;class n extends a.K.Events.BaseEditConfirm{}t.EditConfirm=n;class r extends a.K.Events.BaseEditDiscard{}t.EditDiscard=r;class h extends a.K.Events.BaseDelete{}t.Delete=h;class l extends a.K.Events.BaseMove{}t.Move=l;class d extends a.K.Events.BaseCurrentChange{}t.CurrentChange=d;class c extends a.K.Events.BaseSelectChange{}t.SelectChange=c;class u extends a.K.Events.BaseValidChange{}t.ValidChange=u}(s=t.Events||(t.Events={}))}(s||(s={}))},79243:(t,e,i)=>{"use strict";i.d(e,{n:()=>s});const s=(t,e)=>{let i,s=Date.now()-e;return(...a)=>{const o=Date.now()-s,n=()=>{t.apply(null,a),s=Date.now()};if(i&&clearTimeout(i),o>=e)n();else{const t=e-o;i=window.setTimeout(n,t)}}}},17709:t=>{t.exports="precision highp float;uniform float aaPaddingPx;uniform vec3 color;uniform float globalOpacity;varying vec2 vOffsetPx;uniform float outline;uniform vec3 outlineColor;varying vec2 scaledWidthHeightPx;varying float vOpacity;float sdTriangle(vec2 p,vec2 p0,vec2 p1,vec2 p2){vec2 e0=p1-p0;vec2 e1=p2-p1;vec2 e2=p0-p2;vec2 v0=p-p0;vec2 v1=p-p1;vec2 v2=p-p2;vec2 pq0=v0-e0*clamp(dot(v0,e0)/dot(e0,e0),0.,1.);vec2 pq1=v1-e1*clamp(dot(v1,e1)/dot(e1,e1),0.,1.);vec2 pq2=v2-e2*clamp(dot(v2,e2)/dot(e2,e2),0.,1.);float s=e0.x*e2.y-e0.y*e2.x;vec2 d=min(min(vec2(dot(pq0,pq0),s*(v0.x*e0.y-v0.y*e0.x)),vec2(dot(pq1,pq1),s*(v1.x*e1.y-v1.y*e1.x))),vec2(dot(pq2,pq2),s*(v2.x*e2.y-v2.y*e2.x)));return-sqrt(d.x)*sign(d.y);}void main(){float padding=aaPaddingPx+outline;float halfWidth=scaledWidthHeightPx.x/2.;vec2 p0=vec2(-halfWidth,scaledWidthHeightPx.y+padding);vec2 p1=vec2(halfWidth,scaledWidthHeightPx.y+padding);vec2 p2=vec2(0.,padding);float sd=sdTriangle(vOffsetPx,p0,p1,p2);float aaOpacity=1.-smoothstep(outline,outline+0.5,sd);float colorMix=smoothstep(0.,outline,sd);vec3 colorWithOutline=mix(color,outlineColor,colorMix);gl_FragColor=linearToOutputTexel(vec4(colorWithOutline,aaOpacity*globalOpacity*vOpacity));}"},69555:t=>{t.exports="precision highp float;uniform vec2 screenSize;vec2 rotate90(vec2 v){return vec2(-v.y,v.x);}vec2 ndcToScreen(vec4 pt){return(vec2(pt.x,pt.y)+vec2(1.,1.))*screenSize/2.;}vec2 screenToNdc(vec2 pt){return(pt*2./screenSize)-vec2(1.,1.);}\n#define MIN_SCALE  0.4\n#define MIN_METERS_PER_PX  0.006\n#define MAX_METERS_PER_PX  0.012\nuniform float tipPaddingPx;uniform float widthPx;uniform float heightPx;uniform float aaPaddingPx;uniform float metersPerPx;uniform float outline;uniform float autoScale;attribute vec2 offset;attribute vec2 tip;attribute float height;attribute float opacity;attribute float visibility;varying vec2 vOffsetPx;varying vec2 scaledWidthHeightPx;varying float vOpacity;vec2 scaleByZoom(){float t=clamp((metersPerPx-MIN_METERS_PER_PX)/(MAX_METERS_PER_PX-MIN_METERS_PER_PX),0.,1.);float scale=1.;if(autoScale>0.){scale=mix(1.,MIN_SCALE,t);}return vec2(widthPx,heightPx)*scale;}void main(){if(visibility>0.){vec2 yAxis=normal.xy;vec2 xAxis=rotate90(yAxis);vec4 tipWorld=vec4(tip.x,height,tip.y,1.);vec4 xOffsetWorld=tipWorld+vec4(xAxis.x,0.,xAxis.y,0.);vec4 yOffsetWorld=tipWorld+vec4(yAxis.x,0.,yAxis.y,0.);vec4 ndcTip=projectionMatrix*modelViewMatrix*tipWorld;vec2 tipScreen=ndcToScreen(ndcTip/ndcTip.w);vec4 ndcXOffset=projectionMatrix*modelViewMatrix*xOffsetWorld;vec2 xOffsetScreen=ndcToScreen(ndcXOffset/ndcXOffset.w);vec4 ndcYOffset=projectionMatrix*modelViewMatrix*yOffsetWorld;vec2 yOffsetScreen=ndcToScreen(ndcYOffset/ndcYOffset.w);vec2 xAxisScreen=normalize(xOffsetScreen-tipScreen);vec2 yAxisScreen=normalize(yOffsetScreen-tipScreen);float padding=aaPaddingPx+outline;scaledWidthHeightPx=scaleByZoom();float halfWidth=scaledWidthHeightPx.x/2.+padding;float quadHeight=scaledWidthHeightPx.y+padding*2.;vec2 vertexScreen=(tipScreen+yAxisScreen*tipPaddingPx)+xAxisScreen*halfWidth*offset.x+yAxisScreen*quadHeight*offset.y;vec2 ndcVert=screenToNdc(vertexScreen);vOffsetPx=vec2(offset.x*halfWidth,offset.y*quadHeight);vOpacity=opacity;gl_Position=vec4(ndcVert*ndcTip.w,ndcTip.z,ndcTip.w);}else{gl_Position=vec4(-1000.,-1000.,-1000.,-1000.);}}"},4605:t=>{t.exports="precision highp float;uniform float opacity;uniform float centerSpacing;uniform float radius;uniform vec3 color;void main(){vec2 center=mod(gl_FragCoord.xy,vec2(centerSpacing))-vec2(centerSpacing*0.5);float polkaDot=1.-smoothstep(radius-(radius*0.2),radius,length(center));gl_FragColor=linearToOutputTexel(vec4(color,opacity*polkaDot));}"},66083:t=>{t.exports="precision highp float;void main(){gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}"},47876:t=>{t.exports="#define ANTIALIAS_WIDTH  1.0\nprecision highp float;uniform float globalOpacity;uniform float outlinePct;varying vec3 vOuterColor;varying vec3 vInnerColor;varying float vRadius;varying float vOpacity;varying vec3 vPosition;void main(){float fragRadius=length(vPosition.xz);float outlineRadius=vRadius*outlinePct;float smoothAmt=fwidth(fragRadius)*ANTIALIAS_WIDTH;float mixAmt=smoothstep(outlineRadius-smoothAmt,outlineRadius,fragRadius);gl_FragColor=linearToOutputTexel(vec4(mix(vInnerColor,vOuterColor,mixAmt),1.));gl_FragColor.a=globalOpacity*vOpacity*(1.-smoothstep(vRadius-smoothAmt,vRadius,fragRadius));}"},32686:t=>{t.exports="precision highp float;attribute vec3 centerPosition;attribute float radius;attribute float opacity;attribute vec3 innerColor;attribute vec3 outerColor;varying vec3 vPosition;varying float vRadius;varying float vOpacity;varying vec3 vInnerColor;varying vec3 vOuterColor;void main(){vPosition=position;vRadius=radius;vOpacity=opacity;vInnerColor=innerColor;vOuterColor=outerColor;vec3 worldPos=position+centerPosition;gl_Position=projectionMatrix*modelViewMatrix*vec4(worldPos,1.);}"},76539:t=>{t.exports="precision highp float;precision highp int;vec3 closestPointToRay(vec3 point,vec3 origin,vec3 direction){vec3 d=point-origin;float D=dot(d,direction);return origin+D*direction;}vec3 rayIntersectsSphere(vec3 origin,float radius,vec3 rayOrigin,vec3 rayDirection){vec3 chordPoint=closestPointToRay(origin,rayOrigin,rayDirection);float D1=length(rayOrigin-chordPoint);float D=length(chordPoint-origin);float D2=sqrt(radius*radius-D*D);return rayOrigin+(D1+D2)*rayDirection;}uniform vec3 color;uniform float maxDistance;varying vec3 vWorldPosition;vec4 normalizeDepth(float depth){float depthNormalized=clamp(depth/maxDistance,0.,1.);return vec4(depthNormalized,0.,0.,1.);}void main(){float distanceToCamera=distance(cameraPosition,vWorldPosition);gl_FragColor=normalizeDepth(distanceToCamera);}"},12201:t=>{t.exports="precision highp float;precision highp int;varying vec3 vWorldPosition;void main(){vWorldPosition=(modelMatrix*vec4(position,1.)).xyz;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}"},1834:t=>{t.exports="precision highp float;uniform float globalOpacity;varying vec3 vBaseColor;varying float vNumLines;varying vec3 vPosition;float lineAround(float signedDist){const float halfWidth=0.1/2.;float aaWidth=fwidth(vPosition.z);float left=signedDist-halfWidth;float right=signedDist+halfWidth;float rise=smoothstep(left-aaWidth,left,vPosition.z);float drop=1.-smoothstep(right,right+aaWidth,vPosition.z);return min(rise,drop);}void main(){float alpha=0.;const float small=0.0001;const float centerSignedDist=0.;const float twoLineSignedDist=0.15;const float threeLineSignedDist=0.3;if(abs(vNumLines-1.)<small){alpha=lineAround(centerSignedDist);}else if(abs(vNumLines-2.)<small){alpha=lineAround(-twoLineSignedDist)+lineAround(twoLineSignedDist);}else if(abs(vNumLines-3.)<small){alpha=lineAround(-threeLineSignedDist)+lineAround(centerSignedDist)+lineAround(threeLineSignedDist);}gl_FragColor=vec4(vBaseColor,alpha*globalOpacity);gl_FragColor=linearToOutputTexel(gl_FragColor);}"},63380:t=>{t.exports="precision highp float;attribute float rotationY;attribute vec3 offset;attribute vec3 scaleAttr;attribute vec3 baseColor;attribute float numLines;varying vec3 vPosition;varying vec3 vBaseColor;varying float vNumLines;vec3 rotateY(vec3 v,float r){float c2=cos(r/2.);float s2=sin(r/2.);float qy=s2;float qw=c2;float tx=2.*qy*v.z;float tz=2.*(-qy*v.x);float x=v.x+qw*tx+qy*tz;float y=v.y;float z=v.z+qw*tz-qy*tx;return vec3(x,y,z);}void main(){vPosition=position;vBaseColor=baseColor;vNumLines=numLines;vec3 wsPosition=rotateY(position*scaleAttr,rotationY)+offset;gl_Position=projectionMatrix*modelViewMatrix*vec4(wsPosition,1.);}"},93854:t=>{t.exports="#define ANTIALIAS_WIDTH  1.0\nprecision highp float;uniform float selectedWidth;uniform float globalOpacity;varying vec3 outlineColor;varying vec3 color;varying float opacity;varying float width;varying vec3 lineStart;varying vec3 lineEnd;varying vec3 vWorldPos;float distanceBetween(vec2 l1,vec2 l2,vec2 p){float D=length(l2-l1);float N=abs((l2.x-l1.x)*(l1.y-p.y)-(l1.x-p.x)*(l2.y-l1.y));return N/D;}void main(){float distanceToLine=distanceBetween(lineStart.xz,lineEnd.xz,vWorldPos.xz);float aaWidth=fwidth(distanceToLine)*ANTIALIAS_WIDTH;float lineLerp=smoothstep(selectedWidth-aaWidth,selectedWidth,distanceToLine);float halfWidth=width*0.5;float aaOpacity=smoothstep(halfWidth,halfWidth-aaWidth,distanceToLine);float finalOpacity=opacity*globalOpacity*aaOpacity;gl_FragColor=linearToOutputTexel(mix(vec4(outlineColor,finalOpacity),vec4(color,finalOpacity),lineLerp));if(gl_FragColor.a<0.01){discard;}}"},82312:t=>{t.exports="precision highp float;attribute vec4 colorAndOpacity;attribute vec3 outlineColorAttr;attribute vec4 lineBiasedStartAndEnd;attribute float widthAttr;attribute float baseHeight;attribute vec4 fromLeft;attribute vec4 fromRight;attribute vec4 toLeft;attribute vec4 toRight;attribute vec4 lineStartAndEnd;attribute float vertIndex;varying vec3 outlineColor;varying vec3 color;varying float opacity;varying float width;varying vec3 lineStart;varying vec3 lineEnd;varying vec3 vWorldPos;void main(){vec3 position=vec3(0.,0.,0.);if(floor(vertIndex)==0.){position=vec3(lineStartAndEnd.x,baseHeight,lineStartAndEnd.y);}else if(floor(vertIndex)==3.){position=vec3(lineStartAndEnd.z,baseHeight,lineStartAndEnd.w);}else if(floor(vertIndex)==1.){position=vec3(fromRight.x,baseHeight,fromRight.y);}else if(floor(vertIndex)==2.){position=vec3(toRight.x,baseHeight,toRight.y);}else if(floor(vertIndex)==4.){position=vec3(toLeft.x,baseHeight,toLeft.y);}else if(floor(vertIndex)==5.){position=vec3(fromLeft.x,baseHeight,fromLeft.y);}else if(floor(vertIndex)==9.){position=vec3(fromRight.z,baseHeight,fromRight.w);}else if(floor(vertIndex)==6.){position=vec3(toRight.z,baseHeight,toRight.w);}else if(floor(vertIndex)==7.){position=vec3(toLeft.z,baseHeight,toLeft.w);}else if(floor(vertIndex)==8.){position=vec3(fromLeft.z,baseHeight,fromLeft.w);}outlineColor=outlineColorAttr;color=colorAndOpacity.xyz;opacity=colorAndOpacity.w;width=widthAttr;lineStart=vec3(lineBiasedStartAndEnd.x,baseHeight,lineBiasedStartAndEnd.y);lineEnd=vec3(lineBiasedStartAndEnd.z,baseHeight,lineBiasedStartAndEnd.w);vWorldPos=position;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}"},68216:t=>{t.exports="precision highp float;uniform vec3 color;uniform float opacity;uniform float radius;uniform vec2 screenSize;uniform float pixelRatio;varying vec2 vCenter;varying vec2 vScreenPos;\n#ifdef FADE_DEPTH\nvarying vec3 vWorldPos;uniform vec3 cameraPos;\n#endif\n#ifdef FADE_DEPTH\nuniform sampler2D depthTex;uniform float fadeMaxDepth;float sample_depth(){vec2 frameBufferSize=screenSize*pixelRatio;vec2 screenUv=gl_FragCoord.xy/frameBufferSize;vec2 onePx=1./frameBufferSize;float nearestDepth=texture2D(depthTex,screenUv).r*fadeMaxDepth;return nearestDepth;}float calcDepthFadeOpacity(float currDepth){float nearestDepth=sample_depth();float behindDepth=max(currDepth-nearestDepth,0.);float depthFadeStartDist=FADE_DEPTH;float depthFadeEndDist=FADE_DEPTH+FADE_WIDTH;float depthFadeT=clamp((behindDepth-depthFadeStartDist)/(depthFadeEndDist-depthFadeStartDist),0.,1.);float depthFadeOpacity=1.-mix(0.,1.,depthFadeT);return depthFadeOpacity;}\n#endif\nvoid main(){float distanceFromCenter=length(vScreenPos-vCenter);float sdfOpacity=1.-smoothstep(radius-0.5,radius+0.5,distanceFromCenter);float depthFadeOpacity=1.;\n#ifdef FADE_DEPTH\nfloat distanceFromCamera=length(cameraPos-vWorldPos);depthFadeOpacity=calcDepthFadeOpacity(distanceFromCamera);\n#endif\nfloat alpha=sdfOpacity*opacity*depthFadeOpacity;if(alpha<0.01){discard;}gl_FragColor=linearToOutputTexel(vec4(color,alpha));}"},45138:t=>{t.exports="precision highp float;uniform vec2 screenSize;vec2 rotate90(vec2 v){return vec2(-v.y,v.x);}vec2 ndcToScreen(vec4 pt){return(vec2(pt.x,pt.y)+vec2(1.,1.))*screenSize/2.;}vec2 screenToNdc(vec2 pt){return(pt*2./screenSize)-vec2(1.,1.);}\n#define ANTIALIAS_BUFFER  10.0\nuniform float radius;uniform vec3 translationOffset;attribute vec3 center;attribute vec2 offsetDirection;varying vec2 vCenter;varying vec2 vScreenPos;varying vec3 vWorldPos;void main(){vec3 translatedCenter=center+translationOffset;vec4 centerNdc=projectionMatrix*modelViewMatrix*vec4(translatedCenter,1.);vec2 centerScreen=ndcToScreen(centerNdc/centerNdc.w);vec2 vertexScreen=centerScreen+normalize(offsetDirection)*(radius+ANTIALIAS_BUFFER);vec2 vertexNdc=screenToNdc(vertexScreen);vCenter=centerScreen;vScreenPos=vertexScreen;vWorldPos=translatedCenter;gl_Position=vec4(vertexNdc*centerNdc.w,centerNdc.z,centerNdc.w);}"}}]);