"use strict";(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[9504],{25434:(i,n,e)=>{e.d(n,{Z:()=>o,u:()=>a});var t=e(77201);class a extends t.QB{constructor(i,n,e){super(),this.name=i,this.version=n,this.loadTime=e}}class o{constructor(){this.handlers=[{msgType:a,func:(i,n,e)=>{i.track("plugin_loaded",{name:n.name,version:n.version,time:n.loadTime})}}]}}},41122:(i,n,e)=>{e.d(n,{My:()=>d,W:()=>r,YB:()=>o,ho:()=>a,nq:()=>s,u3:()=>l});var t=e(77201);class a extends t.uB{constructor(i,n=!1){super(),this.payload={exclude:i||[],hard:n}}}a.id="PLUGIN_RESET_ALL";class o extends t.uB{constructor(i,n,e,t,a){super(),this.payload={name:i,config:n,configMeta:e,permissions:t||{},force:a||!1}}}o.id="PLUGIN_RELOAD";class s extends t.uB{constructor(i,n,e,t){super(),this.payload={name:i,config:n,configMeta:e,permissions:t||{}}}}s.id="PLUGIN_LOAD";class l extends t.uB{constructor(i){super(),this.payload={name:i}}}l.id="PLUGIN_UNLOAD";class d extends t.uB{constructor(i,n){super(),this.payload={operation:i,callback:n}}}d.id="PLUGIN_CONFIG_FETCH_DATA";class r extends t.uB{constructor(i,n){super(),this.payload={attachmentId:i,pluginId:n}}}r.id="ATTACHMENT_ASSOCIATE_WITH_PLUGIN";class c extends t.uB{constructor(i,n){super(),this.payload={attachmentId:i,pluginId:n}}}c.id="ATTACHMENT_DISSOCIATE_FROM_PLUGIN"},69504:(i,n,e)=>{e.r(n),e.d(n,{PluginPermissionLevel:()=>a,debounceCurrentPlugin:()=>y,default:()=>m});var t,a,o=e(77201),s=e(97800),l=e(25316),d=e(90082),r=e(71687),c=e(30877),u=e(62193),g=e(32948),h=e(56846),p=e(41122),f=e(25434);!function(i){i[i.FetchAnonymous=1]="FetchAnonymous",i[i.FetchAsUser=2]="FetchAsUser",i[i.AnyFetch=3]="AnyFetch",i[i.LocalData=4]="LocalData",i[i.EarlyLoad=268435456]="EarlyLoad",i[i.DisableSES=2147483648]="DisableSES"}(t||(t={})),function(i){i[i.Locked=0]="Locked",i[i.Default=4]="Default",i[i.DefaultEarlyLoad=268435462]="DefaultEarlyLoad",i[i.Fetch=6]="Fetch",i[i.FetchEarlyLoad=268435462]="FetchEarlyLoad",i[i.OpenEnvironment=4294967295]="OpenEnvironment"}(a||(a={}));const y=i=>{let n;return(e,t)=>{window.clearTimeout(n),n=window.setTimeout((()=>i.apply(null,[e,t])),(null==t?void 0:t.hackDebounceDelayRemoveASAP)||100)}};class v{getFactory(i){return i.messengerFactory}}class m extends o.nV{constructor(){super(...arguments),this.name="plugin",this.data=new g.C,this.allowLoad=!1,this.allowLiveReload=!0,this.unsavedConfiguredPlugins=[],this.applicationType=void 0,this.onResetPlugins=async({exclude:i,hard:n})=>{n&&await this.pluginConfigDataModule.reloadStoreData(!0),await this.unloadPlugins(i),await this.loadConfigured(i)},this.onLoadPlugin=async({config:i,configMeta:n,permissions:e},t)=>{var a;if(this.allowLiveReload&&t){const o={properties:n,required:[]};for(const i of Object.keys(o.properties)){(null===(a=o.properties[i].required)||void 0===a?void 0:a.includes(i))&&o.required.push(i)}if(!this.jsonSchemaValidator.validate(o,i))return;const s={applicationKey:t.applicationKey,id:t.id};if(this.data.get(s))return;const l=Object.assign(Object.assign(Object.assign({},t),{config:i}),e);await this.load(l);const d=this.unsavedConfiguredPlugins.findIndex((i=>i.id===t.id));-1===d?this.unsavedConfiguredPlugins.push(l):this.unsavedConfiguredPlugins[d]=l}},this.onUnloadPlugin=async i=>{if(this.allowLiveReload&&i){const n={applicationKey:i.applicationKey,id:i.id};await this.unload(n)}},this.onReloadPlugin=async({name:i,config:n,configMeta:e,permissions:t,force:a},o)=>{var l;if(this.allowLiveReload){if(null===(l=null==o?void 0:o.inferredSettings)||void 0===l?void 0:l.noReloadOnConfig){const e={applicationKey:o.applicationKey,id:o.id},t=this.data.get(e);if(t&&t.module.onConfigUpdated&&!a)try{return o.config=n,void await t.module.onConfigUpdated(n)}catch(n){s.Vy.for(this).warn(`Plugin config update failed for ${i}, falling back to reload`,n)}}await this.onUnloadPlugin(o),this.debouncedOnLoadPlugin({name:i,config:n,configMeta:e,permissions:t},o)}},this.debouncedOnReloadPlugin=y(this.onReloadPlugin),this.onReloadPluginCommand=async i=>{if(!this.allowLiveReload)return;let n=this.configuredPlugins.find((n=>n.id===i.name))||this.unsavedConfiguredPlugins.find((n=>n.id===i.name));n||(n=this.createLoadableConfig(i.name)),this.debouncedOnReloadPlugin(i,n)},this.debouncedOnLoadPlugin=y(this.onLoadPlugin),this.onLoadPluginCommand=async i=>{this.debouncedOnLoadPlugin(i,this.createLoadableConfig(i.name))},this.debouncedOnUnloadPlugin=(0,s.sg)(this.onUnloadPlugin,100),this.onUnloadPluginCommand=async i=>{let n=this.configuredPlugins.find((n=>n.id===i.name))||this.unsavedConfiguredPlugins.find((n=>n.id===i.name));if(!n){const e=this.availablePlugins.get(i.name);e&&(n={applicationKey:e.applicationKey,id:e.name})}this.debouncedOnUnloadPlugin(n)},this.onFetchSdkDataCommand=async i=>{const n=await this.engine.diContainer.resolve("$ServiceSdk");try{const{sdkEndpoint:e,path:t}=await this.resolveSdkEndpoint(n,i.operation);let a;a="function"==typeof e?await this.resolvePath(await e(),t):await this.handleSubscription(e,t),i.callback(a)}catch(n){throw new Error(`Failed to run command: ${i.operation}\n${null==n?void 0:n.message}`)}}}async init(i,n){if(this.jsonSchemaValidator=i.jsonSchemaValidator,[this.ses,this.sdk,this.pluginConfigDataModule,this.pluginUIData,this.settings]=await Promise.all([n.getModuleBySymbol(r.JY),n.getModuleBySymbol(d.S1),n.getModuleBySymbol(r.lf),n.market.waitForData(u.kR),n.market.waitForData(l.o)]),this.separator=this.pluginUIData.separator,this.engine=n,this.allowLoad=i.pluginPolicies.enabled,this.allowLiveReload=this.allowLoad&&!this.pluginConfigDataModule.pluginConfigData.disabled&&!this.pluginConfigDataModule.pluginConfigData.preventLiveEdit,this.allowLoad&&(this.initializeServiceConnection()?await this.loadConfigured([],!0):s.Vy.for(this).error("Plugins Disabled: Failed to connect service SDK")),this.allowLoad){const i=n.subscribe(o.uv,(async({phase:e,application:t})=>{if(s.Vy.for(this).debug("AppPhaseChangeMessage received:",o.Jj[e],"in",t),e===o.Jj.PLAYING)if(i.cancel(),this.applicationType=t,this.allowLiveReload){if(await this.loadConfigured(),!this.settings.getOverrideParam(h.L$,!1))if(t===o.lg.WORKSHOP)s.Vy.for(this).devInfo("In Workshop - waiting for workshop load to be called"),await n.diContainer.get(o.T6),s.Vy.for(this).devInfo("Interface connections ready, activating editOnly plugins"),await this.loadEditOnly();else{const i=n.subscribe(o.Fj,(async n=>{s.Vy.for(this).devInfo("Switch in active application detected by plugin system: ",n.application),n.application===o.lg.WORKSHOP&&(s.Vy.for(this).devInfo("Activating editOnly plugins upon switch to Workshop application"),await this.loadEditOnly(),i.cancel())}));this.bindings.push(i)}}else s.Vy.for(this).devInfo("Reached PLAYING stage, checking whether configured plugins need to load to start: ",t),t===o.lg.SHOWCASE&&await this.loadConfigured(),this.bindings.push(n.subscribe(o.Fj,(async i=>{if(s.Vy.for(this).devInfo("Switch in active application detected by plugin system: ",i.application),i.application===o.lg.WORKSHOP)try{await this.disposeAll()}catch(i){s.Vy.for(this).debugWarn("Entering workshop, one or more plugins failed to dispose properly:",i)}else i.application===o.lg.SHOWCASE&&await this.loadConfigured()})))}))}this.bindings.push(n.commandBinder.addBinding(p.ho,this.onResetPlugins),n.commandBinder.addBinding(p.YB,this.onReloadPluginCommand),n.commandBinder.addBinding(p.nq,this.onLoadPluginCommand),n.commandBinder.addBinding(p.u3,this.onUnloadPluginCommand),n.commandBinder.addBinding(p.My,this.onFetchSdkDataCommand)),n.market.register(g.C,this.data)}initializeServiceConnection(){try{const i=this.pluginConfigDataModule.serviceSdkKey;this.engine.diContainer.bindAsyncFactory("$ServiceSdk",(()=>c.p.connect({connect:()=>this.sdk.connectPlugin(i,"PluginConfigRootConnection"),cancelConnecting:()=>{}},new v,window)))}catch(i){return s.Vy.for(this).error(i),!1}return!0}broadcastLoadEvent(i){this.engine.broadcast(new f.u(i.id,i.src,Date.now()-performance.timing.navigationStart))}async loadEditOnly(){var i,n,e;this.availablePlugins=this.pluginConfigDataModule.pluginConfigData.availablePlugins;const t=this.availablePlugins.values.filter((i=>{var n;return null===(n=i.options)||void 0===n?void 0:n.editOnly}));if(t.length>0){const a=t.map((i=>i.name));s.Vy.for(this).debug("Loading editOnly plugins: "+a.join(", "));const o=[];for(const a of t){const t={id:a.name,src:a.src,config:a.config,outputs:a.outputs,applicationKey:a.applicationKey,strict:a.strict,peerDependencies:a.peerDependencies,permissionLevel:a.fetchLevel,canPlaceInGrid:null===(i=a.options)||void 0===i?void 0:i.canPlaceInGrid,hideViewToggle:!1!==(null===(n=a.options)||void 0===n?void 0:n.hideViewToggle),hackDebounceDelayRemoveASAP:null===(e=a.options)||void 0===e?void 0:e.hackDebounceDelayRemoveASAP};o.push(this.load(t).then((()=>{this.broadcastLoadEvent(t)})))}await Promise.all(o)}}async loadConfigured(i=[],n=!1){if(!this.pluginConfigDataModule.pluginConfigData.disabled)return this.pluginConfigDataModule.registryLoaded?void await this.updatePluginDataAndLoad(i,n):new Promise((e=>{this.registrySubscription=this.pluginConfigDataModule.registryLoadedObservable.onChanged((async t=>{t&&(await this.updatePluginDataAndLoad(i,n),e())}))}));s.Vy.for(this).debug("Cannot load plugins! Disabled by URL parameter.")}async updatePluginDataAndLoad(i,n){this.configuredPlugins=await this.pluginConfigDataModule.getConfiguredPlugins(this.applicationType,n),this.unsavedConfiguredPlugins=[],this.availablePlugins=this.pluginConfigDataModule.pluginConfigData.availablePlugins,s.Vy.for(this).debug("Combined configuration with registry data, loading plugins: "+JSON.stringify(this.configuredPlugins,void 0,2)),await this.waitForPluginLoad(i)}async waitForPluginLoad(i){if(!this.configuredPlugins)return void s.Vy.for(this).error("Waiting for load before plugin records fetched.");const n=[];for(const i of this.configuredPlugins){const e={applicationKey:i.applicationKey,id:i.id};this.data.get(e)||n.push(this.load(i).then((()=>{this.broadcastLoadEvent(i)})))}try{await Promise.all(n)}catch(i){s.Vy.for(this).warn("Issues were encountered loading configured plugins.")}this.pluginUIData.restoreAllVisibility(i)}async fetchPlugin(i,n,e,t,a){t.strict&&this.ses.freezeForStrict();const o=await this.ses.makeSecureEnvironment(i+`${e?this.separator+e:""}`,n,t,this.pluginConfigDataModule.pluginConfigData.eventTarget,a);if(await(null==o?void 0:o.initialEvaluation()),o){return[o,o.compartment.globalThis.plugin]}return null}async unload(i){const n=i.id&&""!==i.id?i.id:"default",e={applicationKey:i.applicationKey,id:n},t=this.data.get(e);let a=null;if(t){try{a=t.dispose()}catch(i){s.Vy.for(this).warn("An error occurred when disposing a plugin, it may be in a partially disposed state",i)}this.data.delete(e)}return a||Promise.resolve()}async load(i){var n;const{applicationKey:e,src:o,id:s,strict:l,permissionLevel:d=a.Default,peerDependencies:r,canPlaceInGrid:c}=i;if(!this.allowLoad){const i=o.startsWith("http")?o:`${o.substring(0,16)}...`;return Promise.reject(`Load for plugin <${s}:${i}> requested, but plugin system is not available.`)}if(e.includes(this.separator))return Promise.reject(`Application Key cannot contain the separator character: ${this.separator}`);if(s.includes(this.separator))return Promise.reject(`Plugin ID cannot contain the separator character: ${this.separator}`);const u=void 0===l||l,g=s||"default",h={applicationKey:e,id:g};if(this.data.get(h))return Promise.reject(`Plugin for ${e}-${g} already loaded.`);const p={strict:u,canFetch:!!(d&t.AnyFetch),canFetchAsUser:!!(d&t.FetchAsUser),canStoreLocal:!0,canPlaceInGrid:c||!1,shadowRootMode:"closed",isFullyOpen:!!(d&t.DisableSES)},[f,y]=await this.fetchPlugin(e,o,g,p,r)||[];if(f&&y){const e=null===(n=f.overlayElement)||void 0===n?void 0:n.querySelector(`.${s}`);e&&!i.hideViewToggle&&this.pluginUIData.initVisibilityData(g,e,i),await this.initPlugin(f,y.factory,i,g)}}async initPlugin(i,n,e,t){var a;const o=n(),{applicationKey:l,id:d,config:r}=e;(null!==(a=e.inferredSettings)&&void 0!==a?a:e.inferredSettings={}).noReloadOnConfig=!!o.onConfigUpdated;let u=()=>{};const g=o.onInit||o.init;let h=Promise.resolve();if(g){class i{constructor(i){this.sdk=i}connect(){return this.sdk.connectPlugin(l,d)}cancelConnecting(){}}const n=await c.p.connect(new i(this.sdk),new v,window);h=g.call(o,n,r),u=()=>n.disconnect()}const p=this.pluginConfigDataModule.pluginConfigData.eventTarget,f=this.pluginUIData.setupVisibilityEvents(p);async function y(){const n=o.onDestroy||o.dispose;return((null==n?void 0:n.call(o))||Promise.resolve()).finally((()=>{u(),f.cancel(),p.delete(t),i.dispose()}))}const m={applicationKey:l,id:d};try{return await h,this.data.set(m,o,y),Promise.resolve()}catch(i){s.Vy.for(this).warn(`Plugin initialization failed for ${d} `,i),s.Vy.for(this).debugWarn("Attemptying dispose for clean up...");try{await y()}catch(i){s.Vy.for(this).warn("Auto-cleanup of plugin had errors: ",i)}return Promise.reject(i)}}dispose(i){super.dispose(i),this.registrySubscription.cancel(),this.disposeAll().catch((i=>{s.Vy.for(this).warn("One or more plugins failed to dispose properly.",i)}))}disposeAll(){return this.configuredPlugins=[],this.unsavedConfiguredPlugins=[],this.unloadPlugins()}unloadPlugins(i=[]){s.Vy.for(this).devInfo("Unloading all plugins...except: "+i.join(", "));const n=[];for(const[e,t]of this.data.plugins.entries()){const a=e.split(".")[1];i.includes(a)||(n.push(t.dispose()),this.data.plugins.delete(e)),this.pluginUIData.pluginIdSet.delete(e)}return Promise.all(n)}createLoadableConfig(i){var n,e,t;const a=this.availablePlugins.get(i),{src:o,config:s,applicationKey:l,strict:d,outputs:r,peerDependencies:c}=a,u=this.configuredPlugins.find((n=>n.id===i))||this.unsavedConfiguredPlugins.find((n=>n.id===i));return{id:i,src:o,config:s,outputs:r,applicationKey:l,strict:d,peerDependencies:c,permissionLevel:a.fetchLevel,canPlaceInGrid:null===(n=a.options)||void 0===n?void 0:n.canPlaceInGrid,hideViewToggle:null===(e=a.options)||void 0===e?void 0:e.hideViewToggle,hackDebounceDelayRemoveASAP:null===(t=a.options)||void 0===t?void 0:t.hackDebounceDelayRemoveASAP,inferredSettings:null==u?void 0:u.inferredSettings}}async resolveSdkEndpoint(i,n){const[e,...t]=n.split(":"),a=e.split(".");let o="";const s=a.reduce(((i,n)=>(o=n,null==i?void 0:i[n])),i);if(!s)throw new Error(`Invalid SDK namespace or endpoint for ${n} at ${o}`);return{sdkEndpoint:s,path:t}}async handleSubscription(i,n){return new Promise(((e,t)=>{const a=i.subscribe((i=>{a.cancel();try{const t=this.resolvePath(i,n);e(t)}catch(i){t(i)}}))}))}resolvePath(i,n){for(let e=0;e<n.length;e++){const t=n[e],a="object"!=typeof i&&null!==i,o=e!==n.length-1;if(a)throw new Error(`Invalid path: ${n.join(".")} - can't index ${t} into non-object`);if(!i.hasOwnProperty(t)){if(o)throw new Error(`Invalid path: ${n.join(".")} - key "${t}" not found`);return s.Vy.for(this).debugWarn(`Invalid path: ${n.join(".")} - key "${t}" not found`),"--KeyError--"}i=i[t]}return i}}},30877:(i,n,e)=>{e.d(n,{p:()=>t});var t,a=e(50505);!function(i){const n=new a.o;i.connect=async function(i,e,t){let a;try{a=await i.connect()}finally{i.cancelConnecting()}return function(i,n,e,t){return new n(e,i).build(t)}(t,await async function(i){if(!i)throw new Error("Unabled to load the sdk");try{const e=await n.load(i,"sdk-client");if(e&&e.SdkBuilder&&"function"==typeof e.SdkBuilder)return e.SdkBuilder}catch(i){}throw Error(`Could not load the sdk from ${i}`)}(a.scriptUrl),e.getFactory(a),a.serializedInterface)}}(t||(t={}))}}]);