(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[9114],{79955:e=>{var t={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"GetSplats"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"model"},arguments:[{kind:"Argument",name:{kind:"Name",value:"id"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"FragmentSpread",name:{kind:"Name",value:"ModelSplatsFragment"},directives:[]}]}}]}},{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"GetUnpublishedSplats"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"model"},arguments:[{kind:"Argument",name:{kind:"Name",value:"id"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"views"},arguments:[{kind:"Argument",name:{kind:"Name",value:"types"},value:{kind:"StringValue",value:"matterport.model.exterior",block:!1}}],directives:[{kind:"Directive",name:{kind:"Name",value:"onError"},arguments:[{kind:"Argument",name:{kind:"Name",value:"id"},value:{kind:"StringValue",value:"not.found",block:!1}},{kind:"Argument",name:{kind:"Name",value:"null"},value:{kind:"BooleanValue",value:!0}}]}],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"model"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"FragmentSpread",name:{kind:"Name",value:"ModelSplatsFragment"},directives:[]}]}}]}}]}}]}},{kind:"FragmentDefinition",name:{kind:"Name",value:"ModelSplatsFragment"},typeCondition:{kind:"NamedType",name:{kind:"Name",value:"Model"}},directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"assets"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"splats"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"FragmentSpread",name:{kind:"Name",value:"SplatFragment"},directives:[]}]}}]}}]}},{kind:"FragmentDefinition",name:{kind:"Name",value:"SplatFragment"},typeCondition:{kind:"NamedType",name:{kind:"Name",value:"Splat"}},directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"url"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"urlTemplate"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"validUntil"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"transform"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"translation"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"x"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"y"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"z"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"rotation"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"x"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"y"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"z"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"w"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"scale"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"x"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"y"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"z"},arguments:[],directives:[]}]}}]}},{kind:"Field",name:{kind:"Name",value:"layer"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"views"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"view"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"type"},arguments:[],directives:[]}]}}]}}]}}]}},{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"PatchSplat"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"splatId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"transform"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"SpatialTransformInput"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"patchModelSplat"},arguments:[{kind:"Argument",name:{kind:"Name",value:"id"},value:{kind:"Variable",name:{kind:"Name",value:"splatId"}}},{kind:"Argument",name:{kind:"Name",value:"modelId"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}},{kind:"Argument",name:{kind:"Name",value:"transform"},value:{kind:"Variable",name:{kind:"Name",value:"transform"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"FragmentSpread",name:{kind:"Name",value:"SplatFragment"},directives:[]}]}}]}},{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"UploadSplat"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"contents"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"FileUpload"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"uploadExteriorView"},arguments:[{kind:"Argument",name:{kind:"Name",value:"id"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}},{kind:"Argument",name:{kind:"Name",value:"contents"},value:{kind:"Variable",name:{kind:"Name",value:"contents"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"model"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"FragmentSpread",name:{kind:"Name",value:"ModelSplatsFragment"},directives:[]}]}}]}}]}},{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"PublishSplat"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"splatLayerId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"patchLayerViews"},arguments:[{kind:"Argument",name:{kind:"Name",value:"id"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}},{kind:"Argument",name:{kind:"Name",value:"layerId"},value:{kind:"Variable",name:{kind:"Name",value:"splatLayerId"}}},{kind:"Argument",name:{kind:"Name",value:"views"},value:{kind:"ListValue",values:[{kind:"ObjectValue",fields:[{kind:"ObjectField",name:{kind:"Name",value:"viewId"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}}]}]}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}}]}},{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"UnpublishSplat"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"splatLayerId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"removeLayer"},arguments:[{kind:"Argument",name:{kind:"Name",value:"id"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}},{kind:"Argument",name:{kind:"Name",value:"layerId"},value:{kind:"Variable",name:{kind:"Name",value:"splatLayerId"}}},{kind:"Argument",name:{kind:"Name",value:"deleteIfOrphaned"},value:{kind:"BooleanValue",value:!1}}],directives:[]}]}},{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"DeleteSplat"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"viewId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"splatLayerId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"deleteLayer"},arguments:[{kind:"Argument",name:{kind:"Name",value:"id"},value:{kind:"Variable",name:{kind:"Name",value:"viewId"}}},{kind:"Argument",name:{kind:"Name",value:"layerId"},value:{kind:"Variable",name:{kind:"Name",value:"splatLayerId"}}}],directives:[]}]}}],loc:{start:0,end:1853}};t.loc.source={body:'query GetSplats($modelId: ID!) {\n  model(id: $modelId) {\n    ...ModelSplatsFragment\n  }\n}\n\nquery GetUnpublishedSplats($modelId: ID!) {\n  model(id: $modelId) {\n    views(types: "matterport.model.exterior") @onError(id: "not.found", null: true) {\n      id\n      model {\n        ...ModelSplatsFragment\n      }\n    }\n  }\n}\n\nfragment ModelSplatsFragment on Model {\n  assets {\n    splats {\n      ...SplatFragment\n    }\n  }\n}\n\nfragment SplatFragment on Splat {\n  id\n  url\n  urlTemplate\n  validUntil\n  transform {\n    translation { x y z }\n    rotation { x y z w }\n    scale { x y z }\n  }\n  layer {\n    id\n    views {\n      view {\n        # lets us determine if this splat is published to the main view or not\n        id\n        type\n      }\n    }\n  }\n}\n\n# Update a splat\'s transform\nmutation PatchSplat($modelId: ID!, $splatId: ID!, $transform: SpatialTransformInput!) {\n  patchModelSplat(\n    id: $splatId\n    modelId: $modelId\n    transform: $transform\n  ) {\n    ...SplatFragment\n  }\n}\n\n# Upload a splat file\n# Returns the "matterport.model.exterior" unpublished splat view\nmutation UploadSplat($modelId: ID!, $contents: FileUpload!) {\n  uploadExteriorView(\n    id: $modelId,\n    contents: $contents\n  ) {\n    id\n    model {\n      ...ModelSplatsFragment\n    }\n  }\n}\n\n# Copy a splat layer from the unpublished view to the base view\nmutation PublishSplat($modelId: ID!, $splatLayerId: ID!) {\n  patchLayerViews(id: $modelId, layerId: $splatLayerId, views: [{viewId: $modelId}]) {\n    id\n  }\n}\n\n# Remove a splat layer from the base view, keeping it in the unpublished view\nmutation UnpublishSplat($modelId: ID!, $splatLayerId: ID!) {\n  removeLayer(id: $modelId, layerId: $splatLayerId, deleteIfOrphaned: false)\n}\n\n# Delete a splat layer from all views\nmutation DeleteSplat($viewId: ID!, $splatLayerId: ID!) {\n  deleteLayer(id: $viewId, layerId: $splatLayerId)\n}\n',name:"GraphQL request",locationOffset:{line:1,column:1}};function i(e,t){if("FragmentSpread"===e.kind)t.add(e.name.value);else if("VariableDefinition"===e.kind){var o=e.type;"NamedType"===o.kind&&t.add(o.name.value)}e.selectionSet&&e.selectionSet.selections.forEach((function(e){i(e,t)})),e.variableDefinitions&&e.variableDefinitions.forEach((function(e){i(e,t)})),e.definitions&&e.definitions.forEach((function(e){i(e,t)}))}var o={};function s(e,t){for(var i=0;i<e.definitions.length;i++){var o=e.definitions[i];if(o.name&&o.name.value==t)return o}}function n(e,t){var i={kind:e.kind,definitions:[s(e,t)]};e.hasOwnProperty("loc")&&(i.loc=e.loc);var n=o[t]||new Set,a=new Set,r=new Set;for(n.forEach((function(e){r.add(e)}));r.size>0;){var l=r;r=new Set,l.forEach((function(e){a.has(e)||(a.add(e),(o[e]||new Set).forEach((function(e){r.add(e)})))}))}return a.forEach((function(t){var o=s(e,t);o&&i.definitions.push(o)})),i}t.definitions.forEach((function(e){if(e.name){var t=new Set;i(e,t),o[e.name.value]=t}})),e.exports=t,e.exports.GetSplats=n(t,"GetSplats"),e.exports.GetUnpublishedSplats=n(t,"GetUnpublishedSplats"),e.exports.ModelSplatsFragment=n(t,"ModelSplatsFragment"),e.exports.SplatFragment=n(t,"SplatFragment"),e.exports.PatchSplat=n(t,"PatchSplat"),e.exports.UploadSplat=n(t,"UploadSplat"),e.exports.PublishSplat=n(t,"PublishSplat"),e.exports.UnpublishSplat=n(t,"UnpublishSplat"),e.exports.DeleteSplat=n(t,"DeleteSplat")},27419:(e,t)=>{"use strict";var i=t.binary_mesh={};i.read=function(e,t){return e.readFields(i._readField,{chunk:[],quantized_chunk:[]},t)},i._readField=function(e,t,i){1===e?t.chunk.push(n.read(i,i.readVarint()+i.pos)):2===e&&t.quantized_chunk.push(h.read(i,i.readVarint()+i.pos))},i.write=function(e,t){if(e.chunk)for(var i=0;i<e.chunk.length;i++)t.writeMessage(1,n.write,e.chunk[i]);if(e.quantized_chunk)for(i=0;i<e.quantized_chunk.length;i++)t.writeMessage(2,h.write,e.quantized_chunk[i])};var o=t.vertices_simple={};o.read=function(e,t){return e.readFields(o._readField,{xyz:[],uv:[]},t)},o._readField=function(e,t,i){1===e?i.readPackedFloat(t.xyz):2===e&&i.readPackedFloat(t.uv)},o.write=function(e,t){e.xyz&&t.writePackedFloat(1,e.xyz),e.uv&&t.writePackedFloat(2,e.uv)};var s=t.faces_simple={};s.read=function(e,t){return e.readFields(s._readField,{faces:[]},t)},s._readField=function(e,t,i){1===e&&i.readPackedVarint(t.faces)},s.write=function(e,t){e.faces&&t.writePackedVarint(1,e.faces)};var n=t.chunk_simple={};n.read=function(e,t){return e.readFields(n._readField,{vertices:null,faces:null,chunk_name:"",material_name:""},t)},n._readField=function(e,t,i){1===e?t.vertices=o.read(i,i.readVarint()+i.pos):2===e?t.faces=s.read(i,i.readVarint()+i.pos):3===e?t.chunk_name=i.readString():4===e&&(t.material_name=i.readString())},n.write=function(e,t){e.vertices&&t.writeMessage(1,o.write,e.vertices),e.faces&&t.writeMessage(2,s.write,e.faces),e.chunk_name&&t.writeStringField(3,e.chunk_name),e.material_name&&t.writeStringField(4,e.material_name)};var a=t.vertices_quantized={};a.read=function(e,t){return e.readFields(a._readField,{quantization:0,translation:[],x:[],y:[],z:[]},t)},a._readField=function(e,t,i){1===e?t.quantization=i.readFloat():2===e?i.readPackedFloat(t.translation):3===e?i.readPackedSVarint(t.x):4===e?i.readPackedSVarint(t.y):5===e&&i.readPackedSVarint(t.z)},a.write=function(e,t){e.quantization&&t.writeFloatField(1,e.quantization),e.translation&&t.writePackedFloat(2,e.translation),e.x&&t.writePackedSVarint(3,e.x),e.y&&t.writePackedSVarint(4,e.y),e.z&&t.writePackedSVarint(5,e.z)};var r=t.uv_quantized={};r.read=function(e,t){return e.readFields(r._readField,{name:"",quantization:0,u:[],v:[]},t)},r._readField=function(e,t,i){1===e?t.name=i.readString():2===e?t.quantization=i.readFloat():3===e?i.readPackedSVarint(t.u):4===e&&i.readPackedSVarint(t.v)},r.write=function(e,t){e.name&&t.writeStringField(1,e.name),e.quantization&&t.writeFloatField(2,e.quantization),e.u&&t.writePackedSVarint(3,e.u),e.v&&t.writePackedSVarint(4,e.v)};var l=t.faces_compressed={};l.read=function(e,t){return e.readFields(l._readField,{faces:[]},t)},l._readField=function(e,t,i){1===e&&i.readPackedSVarint(t.faces)},l.write=function(e,t){e.faces&&t.writePackedSVarint(1,e.faces)};var h=t.chunk_quantized={};h.read=function(e,t){return e.readFields(h._readField,{chunk_name:"",material_name:"",vertices:null,uvs:[],faces:null},t)},h._readField=function(e,t,i){1===e?t.chunk_name=i.readString():2===e?t.material_name=i.readString():3===e?t.vertices=a.read(i,i.readVarint()+i.pos):4===e?t.uvs.push(r.read(i,i.readVarint()+i.pos)):5===e&&(t.faces=s.read(i,i.readVarint()+i.pos))},h.write=function(e,t){if(e.chunk_name&&t.writeStringField(1,e.chunk_name),e.material_name&&t.writeStringField(2,e.material_name),e.vertices&&t.writeMessage(3,a.write,e.vertices),e.uvs)for(var i=0;i<e.uvs.length;i++)t.writeMessage(4,r.write,e.uvs[i]);e.faces&&t.writeMessage(5,s.write,e.faces)}},15335:(e,t,i)=>{"use strict";e.exports=s;var o=i(251);function s(e){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(e)?e:new Uint8Array(e||0),this.pos=0,this.type=0,this.length=this.buf.length}s.Varint=0,s.Fixed64=1,s.Bytes=2,s.Fixed32=5;var n=4294967296,a=1/n;function r(e){return e.type===s.Bytes?e.readVarint()+e.pos:e.pos+1}function l(e,t,i){return i?4294967296*t+(e>>>0):4294967296*(t>>>0)+(e>>>0)}function h(e,t,i){var o=t<=16383?1:t<=2097151?2:t<=268435455?3:Math.ceil(Math.log(t)/(7*Math.LN2));i.realloc(o);for(var s=i.pos-1;s>=e;s--)i.buf[s+o]=i.buf[s]}function d(e,t){for(var i=0;i<e.length;i++)t.writeVarint(e[i])}function c(e,t){for(var i=0;i<e.length;i++)t.writeSVarint(e[i])}function u(e,t){for(var i=0;i<e.length;i++)t.writeFloat(e[i])}function m(e,t){for(var i=0;i<e.length;i++)t.writeDouble(e[i])}function p(e,t){for(var i=0;i<e.length;i++)t.writeBoolean(e[i])}function g(e,t){for(var i=0;i<e.length;i++)t.writeFixed32(e[i])}function v(e,t){for(var i=0;i<e.length;i++)t.writeSFixed32(e[i])}function f(e,t){for(var i=0;i<e.length;i++)t.writeFixed64(e[i])}function w(e,t){for(var i=0;i<e.length;i++)t.writeSFixed64(e[i])}function y(e,t){return(e[t]|e[t+1]<<8|e[t+2]<<16)+16777216*e[t+3]}function D(e,t,i){e[i]=t,e[i+1]=t>>>8,e[i+2]=t>>>16,e[i+3]=t>>>24}function b(e,t){return(e[t]|e[t+1]<<8|e[t+2]<<16)+(e[t+3]<<24)}s.prototype={destroy:function(){this.buf=null},readFields:function(e,t,i){for(i=i||this.length;this.pos<i;){var o=this.readVarint(),s=o>>3,n=this.pos;this.type=7&o,e(s,t,this),this.pos===n&&this.skip(o)}return t},readMessage:function(e,t){return this.readFields(e,t,this.readVarint()+this.pos)},readFixed32:function(){var e=y(this.buf,this.pos);return this.pos+=4,e},readSFixed32:function(){var e=b(this.buf,this.pos);return this.pos+=4,e},readFixed64:function(){var e=y(this.buf,this.pos)+y(this.buf,this.pos+4)*n;return this.pos+=8,e},readSFixed64:function(){var e=y(this.buf,this.pos)+b(this.buf,this.pos+4)*n;return this.pos+=8,e},readFloat:function(){var e=o.read(this.buf,this.pos,!0,23,4);return this.pos+=4,e},readDouble:function(){var e=o.read(this.buf,this.pos,!0,52,8);return this.pos+=8,e},readVarint:function(e){var t,i,o=this.buf;return t=127&(i=o[this.pos++]),i<128?t:(t|=(127&(i=o[this.pos++]))<<7,i<128?t:(t|=(127&(i=o[this.pos++]))<<14,i<128?t:(t|=(127&(i=o[this.pos++]))<<21,i<128?t:function(e,t,i){var o,s,n=i.buf;if(s=n[i.pos++],o=(112&s)>>4,s<128)return l(e,o,t);if(s=n[i.pos++],o|=(127&s)<<3,s<128)return l(e,o,t);if(s=n[i.pos++],o|=(127&s)<<10,s<128)return l(e,o,t);if(s=n[i.pos++],o|=(127&s)<<17,s<128)return l(e,o,t);if(s=n[i.pos++],o|=(127&s)<<24,s<128)return l(e,o,t);if(s=n[i.pos++],o|=(1&s)<<31,s<128)return l(e,o,t);throw new Error("Expected varint not more than 10 bytes")}(t|=(15&(i=o[this.pos]))<<28,e,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var e=this.readVarint();return e%2==1?(e+1)/-2:e/2},readBoolean:function(){return Boolean(this.readVarint())},readString:function(){var e=this.readVarint()+this.pos,t=function(e,t,i){var o="",s=t;for(;s<i;){var n,a,r,l=e[s],h=null,d=l>239?4:l>223?3:l>191?2:1;if(s+d>i)break;1===d?l<128&&(h=l):2===d?128==(192&(n=e[s+1]))&&(h=(31&l)<<6|63&n)<=127&&(h=null):3===d?(n=e[s+1],a=e[s+2],128==(192&n)&&128==(192&a)&&((h=(15&l)<<12|(63&n)<<6|63&a)<=2047||h>=55296&&h<=57343)&&(h=null)):4===d&&(n=e[s+1],a=e[s+2],r=e[s+3],128==(192&n)&&128==(192&a)&&128==(192&r)&&((h=(15&l)<<18|(63&n)<<12|(63&a)<<6|63&r)<=65535||h>=1114112)&&(h=null)),null===h?(h=65533,d=1):h>65535&&(h-=65536,o+=String.fromCharCode(h>>>10&1023|55296),h=56320|1023&h),o+=String.fromCharCode(h),s+=d}return o}(this.buf,this.pos,e);return this.pos=e,t},readBytes:function(){var e=this.readVarint()+this.pos,t=this.buf.subarray(this.pos,e);return this.pos=e,t},readPackedVarint:function(e,t){var i=r(this);for(e=e||[];this.pos<i;)e.push(this.readVarint(t));return e},readPackedSVarint:function(e){var t=r(this);for(e=e||[];this.pos<t;)e.push(this.readSVarint());return e},readPackedBoolean:function(e){var t=r(this);for(e=e||[];this.pos<t;)e.push(this.readBoolean());return e},readPackedFloat:function(e){var t=r(this);for(e=e||[];this.pos<t;)e.push(this.readFloat());return e},readPackedDouble:function(e){var t=r(this);for(e=e||[];this.pos<t;)e.push(this.readDouble());return e},readPackedFixed32:function(e){var t=r(this);for(e=e||[];this.pos<t;)e.push(this.readFixed32());return e},readPackedSFixed32:function(e){var t=r(this);for(e=e||[];this.pos<t;)e.push(this.readSFixed32());return e},readPackedFixed64:function(e){var t=r(this);for(e=e||[];this.pos<t;)e.push(this.readFixed64());return e},readPackedSFixed64:function(e){var t=r(this);for(e=e||[];this.pos<t;)e.push(this.readSFixed64());return e},skip:function(e){var t=7&e;if(t===s.Varint)for(;this.buf[this.pos++]>127;);else if(t===s.Bytes)this.pos=this.readVarint()+this.pos;else if(t===s.Fixed32)this.pos+=4;else{if(t!==s.Fixed64)throw new Error("Unimplemented type: "+t);this.pos+=8}},writeTag:function(e,t){this.writeVarint(e<<3|t)},realloc:function(e){for(var t=this.length||16;t<this.pos+e;)t*=2;if(t!==this.length){var i=new Uint8Array(t);i.set(this.buf),this.buf=i,this.length=t}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(e){this.realloc(4),D(this.buf,e,this.pos),this.pos+=4},writeSFixed32:function(e){this.realloc(4),D(this.buf,e,this.pos),this.pos+=4},writeFixed64:function(e){this.realloc(8),D(this.buf,-1&e,this.pos),D(this.buf,Math.floor(e*a),this.pos+4),this.pos+=8},writeSFixed64:function(e){this.realloc(8),D(this.buf,-1&e,this.pos),D(this.buf,Math.floor(e*a),this.pos+4),this.pos+=8},writeVarint:function(e){(e=+e||0)>268435455||e<0?function(e,t){var i,o;e>=0?(i=e%4294967296|0,o=e/4294967296|0):(o=~(-e/4294967296),4294967295^(i=~(-e%4294967296))?i=i+1|0:(i=0,o=o+1|0));if(e>=0x10000000000000000||e<-0x10000000000000000)throw new Error("Given varint doesn't fit into 10 bytes");t.realloc(10),function(e,t,i){i.buf[i.pos++]=127&e|128,e>>>=7,i.buf[i.pos++]=127&e|128,e>>>=7,i.buf[i.pos++]=127&e|128,e>>>=7,i.buf[i.pos++]=127&e|128,e>>>=7,i.buf[i.pos]=127&e}(i,0,t),function(e,t){var i=(7&e)<<4;if(t.buf[t.pos++]|=i|((e>>>=3)?128:0),!e)return;if(t.buf[t.pos++]=127&e|((e>>>=7)?128:0),!e)return;if(t.buf[t.pos++]=127&e|((e>>>=7)?128:0),!e)return;if(t.buf[t.pos++]=127&e|((e>>>=7)?128:0),!e)return;if(t.buf[t.pos++]=127&e|((e>>>=7)?128:0),!e)return;t.buf[t.pos++]=127&e}(o,t)}(e,this):(this.realloc(4),this.buf[this.pos++]=127&e|(e>127?128:0),e<=127||(this.buf[this.pos++]=127&(e>>>=7)|(e>127?128:0),e<=127||(this.buf[this.pos++]=127&(e>>>=7)|(e>127?128:0),e<=127||(this.buf[this.pos++]=e>>>7&127))))},writeSVarint:function(e){this.writeVarint(e<0?2*-e-1:2*e)},writeBoolean:function(e){this.writeVarint(Boolean(e))},writeString:function(e){e=String(e),this.realloc(4*e.length),this.pos++;var t=this.pos;this.pos=function(e,t,i){for(var o,s,n=0;n<t.length;n++){if((o=t.charCodeAt(n))>55295&&o<57344){if(!s){o>56319||n+1===t.length?(e[i++]=239,e[i++]=191,e[i++]=189):s=o;continue}if(o<56320){e[i++]=239,e[i++]=191,e[i++]=189,s=o;continue}o=s-55296<<10|o-56320|65536,s=null}else s&&(e[i++]=239,e[i++]=191,e[i++]=189,s=null);o<128?e[i++]=o:(o<2048?e[i++]=o>>6|192:(o<65536?e[i++]=o>>12|224:(e[i++]=o>>18|240,e[i++]=o>>12&63|128),e[i++]=o>>6&63|128),e[i++]=63&o|128)}return i}(this.buf,e,this.pos);var i=this.pos-t;i>=128&&h(t,i,this),this.pos=t-1,this.writeVarint(i),this.pos+=i},writeFloat:function(e){this.realloc(4),o.write(this.buf,e,this.pos,!0,23,4),this.pos+=4},writeDouble:function(e){this.realloc(8),o.write(this.buf,e,this.pos,!0,52,8),this.pos+=8},writeBytes:function(e){var t=e.length;this.writeVarint(t),this.realloc(t);for(var i=0;i<t;i++)this.buf[this.pos++]=e[i]},writeRawMessage:function(e,t){this.pos++;var i=this.pos;e(t,this);var o=this.pos-i;o>=128&&h(i,o,this),this.pos=i-1,this.writeVarint(o),this.pos+=o},writeMessage:function(e,t,i){this.writeTag(e,s.Bytes),this.writeRawMessage(t,i)},writePackedVarint:function(e,t){this.writeMessage(e,d,t)},writePackedSVarint:function(e,t){this.writeMessage(e,c,t)},writePackedBoolean:function(e,t){this.writeMessage(e,p,t)},writePackedFloat:function(e,t){this.writeMessage(e,u,t)},writePackedDouble:function(e,t){this.writeMessage(e,m,t)},writePackedFixed32:function(e,t){this.writeMessage(e,g,t)},writePackedSFixed32:function(e,t){this.writeMessage(e,v,t)},writePackedFixed64:function(e,t){this.writeMessage(e,f,t)},writePackedSFixed64:function(e,t){this.writeMessage(e,w,t)},writeBytesField:function(e,t){this.writeTag(e,s.Bytes),this.writeBytes(t)},writeFixed32Field:function(e,t){this.writeTag(e,s.Fixed32),this.writeFixed32(t)},writeSFixed32Field:function(e,t){this.writeTag(e,s.Fixed32),this.writeSFixed32(t)},writeFixed64Field:function(e,t){this.writeTag(e,s.Fixed64),this.writeFixed64(t)},writeSFixed64Field:function(e,t){this.writeTag(e,s.Fixed64),this.writeSFixed64(t)},writeVarintField:function(e,t){this.writeTag(e,s.Varint),this.writeVarint(t)},writeSVarintField:function(e,t){this.writeTag(e,s.Varint),this.writeSVarint(t)},writeStringField:function(e,t){this.writeTag(e,s.Bytes),this.writeString(t)},writeFloatField:function(e,t){this.writeTag(e,s.Fixed32),this.writeFloat(t)},writeDoubleField:function(e,t){this.writeTag(e,s.Fixed64),this.writeDouble(t)},writeBooleanField:function(e,t){this.writeVarintField(e,Boolean(t))}}},29228:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>M});var o=i(77201),s=i(97800),n=i(71687),a=i(12837),r=i(99583),l=i(28454),h=i(72354),d=i(34184),c=i(47004),u=i(40899),m=i(22937),p=i(98309),g=i(1197),v=i(44351),f=i(596),w=i(90572),y=i(85227),D=i(2993),b=i(90834);class S extends o.nV{constructor(){super(...arguments),this.name="mesh-quality",this.measurementModeData=null,this.updateMaxQuality=(()=>{let e,t,i;return({modeChange:o,criticalChange:s,interactionChange:n})=>{var a,r,l;void 0!==s&&(t=s),void 0!==o&&(e=o),void 0!==n&&(i=n);const h=i===v.o.VrOrientOnly||i===v.o.VrWithController||i===v.o.VrTransientPointer||i===v.o.VrWithTrackedController,d=this.modelMeshModule.stats(),c=d.textureCount<=this.config.textureLODThreshold?Math.max(f.M.ULTRA,this.config.maxQuality):f.M.MEDIUM,u=null!==(l=null===(r=null===(a=this.modelMeshModule.getMeshGroupVisuals())||void 0===a?void 0:a.meshTextureOpacity)||void 0===r?void 0:r.value)&&void 0!==l?l:0,m=Math.max(c,e===D.N3.Panorama&&0===u?c:this.config.maxQuality);this.modelMeshModule.setTextureLimits(c,m);const p=this.viewmodeData.currentMode!==D.N3.Mesh&&this.viewmodeData.currentMode!==D.N3.Dollhouse&&this.viewmodeData.currentMode!==D.N3.Floorplan,g=this.viewmodeData.transition.active&&(0,D.nI)(this.viewmodeData.transition.to);h||g||(d.streaming||t)&&p?this.modelMeshModule.setTextureStreamMode(w.R.NONE):this.modelMeshModule.setTextureStreamMode(this.config.textureLOD)}})()}async init(e,t){this.config=e,this.engine=t,[this.modelMeshModule,this.viewmodeData,this.sweepData,this.appData,this.interactionModeData]=await Promise.all([t.getModuleBySymbol(n.GR),t.market.waitForData(r.X),t.market.waitForData(a.A),t.market.waitForData(o.zH),t.market.waitForData(b.O)]),await this.modelMeshModule.firstMeshLoadPromise,this.bindAppEventsToTextureQuality(),this.bindAppEventsToTextureVisibility(),this.updateMaxQuality({}),this.showcaseMeshDetailRules()}bindAppEventsToTextureQuality(){var e;let t=0;const i=null===(e=this.modelMeshModule.getMeshGroupVisuals())||void 0===e?void 0:e.meshTextureOpacity;i&&this.bindings.push(i.onChanged((()=>{i.value!==t&&this.updateMaxQuality({}),t=i.value}))),this.bindings.push(this.appData.onPhase((()=>{this.updateMaxQuality({})})),this.engine.subscribe(p.A,(e=>{this.updateMaxQuality({criticalChange:!0,modeChange:e.toMode})})),this.engine.subscribe(g.A,(e=>{this.updateMaxQuality({criticalChange:!1,modeChange:e.toMode})})),this.engine.subscribe(m.zM,(()=>{this.updateMaxQuality({criticalChange:!0})})),this.engine.subscribe(m.pT,(()=>{this.updateMaxQuality({criticalChange:!1})})),this.engine.subscribe(d.A,(()=>{this.updateMaxQuality({criticalChange:!0})})),this.engine.subscribe(c.A,(()=>{this.updateMaxQuality({criticalChange:!1})})),this.engine.subscribe(h.b,(e=>{this.updateMaxQuality({interactionChange:e.mode})})))}showcaseMeshDetailRules(){var e,t;const{modelMeshModule:i}=this,o=s.Vy.for(this),n=()=>this.appData.phase<=this.appData.phases.LOADING,a=()=>this.appData.phase===this.appData.phases.STARTING,r=()=>this.appData.phase>=this.appData.phases.PLAYING&&this.appData.phase!==this.appData.phases.ERROR,h=()=>this.appData.phase===this.appData.phases.ERROR,d=e=>this.viewmodeData.closestMode===e,c=()=>d(D.N3.Dollhouse)||d(D.N3.Floorplan)||d(D.N3.Mesh),u=()=>d(D.N3.Panorama),m=()=>this.viewmodeData.transition.active,p=e=>m()&&this.viewmodeData.transition.to===e,g=()=>{var e,t;return null!==(t=null===(e=this.measurementModeData)||void 0===e?void 0:e.isEditingOrCreating())&&void 0!==t&&t},v=()=>this.interactionModeData.isVR()&&!c(),f=()=>void 0!==this.sweepData.currentAlignedSweepObject;function w(){const e=i.getMeshDetail();let t=e;r()?m()?(p(D.N3.Dollhouse)||p(D.N3.Floorplan)||p(D.N3.Mesh))&&(t="max"):(t="default",u()&&v()&&(t="minimal"),u()&&!f()&&(t="minimal"),u()&&g()&&(t="max"),c()&&(t="max")):(n()&&(t="minimal"),h()&&(t="minimal"),a()&&(t="default")),e!==t&&(o.debug(`overrideMaxDetail from ${e} to ${t}`),i.setMeshOptions({overrideMaxDetail:t}))}const y=null===(t=null===(e=this.modelMeshModule.getMeshGroupVisuals())||void 0===e?void 0:e.meshTextureOpacity)||void 0===t?void 0:t.onComplete(w);y&&this.bindings.push(y),this.bindings.push(this.appData.onPhase(w),this.viewmodeData.onChanged(w),this.interactionModeData.onChanged(w)),this.engine.market.waitForData(l.s).then((e=>{this.bindings.push(e.onPhaseChanged(w)),this.measurementModeData=e})),w()}bindAppEventsToTextureVisibility(){this.bindings.push(this.engine.subscribe(u.A,(e=>{const t=this.sweepData.isSweepUnaligned(e.toSweep);t!==this.sweepData.isSweepUnaligned(e.fromSweep)&&this.modelMeshModule.setRenderMode(t?y.p.PanoramaCube:y.p.PanoramaMesh)})))}}const M=S},13070:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>g});var o=i(77201),s=i(97800),n=i(71687),a=i(60043),r=i(71397),l=i(46793),h=i(28337),d=i(99583),c=i(2993),u=i(25316),m=i(47299),p=i(10459);class g extends o.nV{constructor(){super(...arguments),this.name="showcase-hotkeys",this.inputCommandMap={[h.$.PRESSED]:{[r.D.ONE]:()=>(this.viewmodeData.currentMode===c.N3.Panorama&&(this.settings.setSetting(m._Z,!1),this.currentView=0),this.switchToMode(l.w5.INSIDE)),[r.D.TWO]:()=>this.switchToMode(l.w5.DOLLHOUSE),[r.D.THREE]:()=>this.switchToMode(l.w5.FLOORPLAN),[r.D.ZERO]:()=>{const e=this.currentView++%this.meshViews.length;return this.meshViews[e]()},[r.D.FOUR]:()=>this.layersModule.toggleDefurnishView()}},this.currentView=0,this.meshViews=[()=>(this.settings.setSetting(m._Z,!1),this.switchToMode(l.w5.MESH)),()=>(this.settings.setSetting(m._Z,!0),this.switchToMode(l.w5.MESH)),()=>(this.settings.setSetting(m._Z,!0),this.switchToMode(l.w5.INSIDE)),()=>(this.settings.setSetting(m._Z,!1),this.switchToMode(l.w5.INSIDE))]}async init(e,t){this.layersModule=await t.getModuleBySymbol(n.az);const i=await t.getModuleBySymbol(n.mL);[this.viewmodeData,this.settings,this.cameraData]=await Promise.all([t.market.waitForData(d.X),t.market.waitForData(u.o),t.market.waitForData(p.M)]),this.issueCommand=t.commandBinder.issueCommand.bind(t.commandBinder);let o=null;i.registerHandler(a.k,(async e=>{!o&&this.inputCommandMap[e.state]&&this.inputCommandMap[e.state][e.key]&&(o=this.inputCommandMap[e.state][e.key](),await o,o=null)}))}async switchToMode(e){const{currentMode:t}=this.viewmodeData;if(t!==c.N3.Transition){const i=(0,c.nI)(t)&&(e===l.w5.MESH||e===l.w5.INSIDE)?this.cameraData.pose.rotation:void 0;try{await this.issueCommand(new l.S2(e,void 0,{rotation:i}))}catch(e){s.Vy.for(this).debug("Unable to switchToMode",e)}}}}},9120:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>F});var o=i(77201),s=i(97800),n=i(90082),a=i(71687),r=i(56208),l=i(88664),h=i(13893),d=i(81530),c=i(41122),u=i(47737),m=i(20968),p=i(71271),g=i(23339),v=i(1333),f=i(5601),w=i(74381),y=i(15506);const D=new s.Vy("mds-player-options-deserializer"),b={[w.zf.BLACK]:f.v.black,[w.zf.GREY]:f.v.grey,[w.zf.WHITE]:f.v.white};class S{deserialize(e){var t,i;if(!e||!this.validate(e))return D.debug("Deserialized invalid options data from MDS",e),null;const o=(null===(t=e.publication)||void 0===t?void 0:t.options)||{},s=e.options||{},n=(null==s?void 0:s.tourPanDirection)?y.nl[s.tourPanDirection]:v.ND.Auto,a={defurnish_view:s.defurnishViewEnabled,address:o.address,contact_email:o.contactEmail,contact_name:o.contactName,contact_phone:o.contactPhone,dollhouse:s.dollhouseEnabled,external_url:o.externalUrl,floor_plan:s.floorplanEnabled,floor_select:s.floorSelectEnabled,highlight_reel:s.highlightReelEnabled,labels:s.labelsEnabled,labels_dh:s.dollhouseLabelsEnabled,model_name:o.modelName,model_summary:o.modelSummary,presented_by:o.presentedBy,measurements:s.measurements!==w.jG.DISABLED,measurements_saved:s.measurements===w.jG.MEASUREANDVIEW,room_bounds:s.roomBoundsEnabled,unit_type:s.unitType===w.WU.IMPERIAL?g.t.IMPERIAL:g.t.METRIC,background_color:(null==s?void 0:s.backgroundColor)?b[s.backgroundColor]:f.v.black,tour_buttons:s.tourButtonsEnabled,fast_transitions:s.tourFastTransitionsEnabled,transition_speed:s.tourTransitionSpeed,transition_time:s.tourTransitionTime,pan_speed:s.tourPanSpeed,dollhouse_pan_speed:s.tourDollhousePanSpeed,zoom_duration:s.tourZoomDuration,pan_alignment:y.j7[null!==(i=s.tourPanAlignment)&&void 0!==i?i:l.K6],pan_angle:s.tourPanAngle,pan_direction:n,space_search:s.spaceSearchEnabled};return new r.EY(a)}validate(e){if(!e)return!1;return["id","options","publication"].every((t=>t in e))}}const M=(0,s.hc)(b);class T{serialize(e){const t={},i=e.options||{};if(void 0!==i.defurnish_view&&(t.defurnishViewOverride=i.defurnish_view?w.D6.ENABLED:w.D6.DISABLED),void 0!==i.dollhouse&&(t.dollhouseOverride=i.dollhouse?w.D6.ENABLED:w.D6.DISABLED),void 0!==i.floor_plan&&(t.floorplanOverride=i.floor_plan?w.D6.ENABLED:w.D6.DISABLED),void 0!==i.floor_select&&(t.floorSelectOverride=i.floor_select?w.D6.ENABLED:w.D6.DISABLED),void 0!==i.room_bounds&&(t.roomBoundsOverride=i.room_bounds?w.D6.ENABLED:w.D6.DISABLED),void 0!==i.space_search&&(t.spaceSearchOverride=i.space_search?w.D6.ENABLED:w.D6.DISABLED),void 0!==i.labels&&(t.labelsOverride=i.labels?w.D6.ENABLED:w.D6.DISABLED),void 0!==i.labels_dh&&(t.dollhouseLabelsOverride=i.labels_dh?w.D6.ENABLED:w.D6.DISABLED),void 0!==i.highlight_reel&&(t.highlightReelOverride=i.highlight_reel?w.D6.ENABLED:w.D6.DISABLED),void 0!==i.background_color&&(t.backgroundColor={set:M[i.background_color]||w.zf.BLACK}),void 0!==i.unit_type){const e=i.unit_type===g.t.METRIC?w.WU.METRIC:w.WU.IMPERIAL;t.unitType={set:e}}if(void 0!==i.measurements||void 0!==i.measurements_saved){const e=i.measurements&&i.measurements_saved?w.jG.MEASUREANDVIEW:i.measurements?w.jG.MEASURE:w.jG.DISABLED;t.measurements={set:e}}void 0!==i.tour_buttons&&(t.tourButtonsOverride=i.tour_buttons?w.D6.ENABLED:w.D6.DISABLED),void 0!==i.fast_transitions&&(t.tourFastTransitionsOverride=i.fast_transitions?w.D6.ENABLED:w.D6.DISABLED),void 0!==i.pan_alignment&&(t.tourPanAlignment={set:y.np[i.pan_alignment]}),void 0!==i.pan_angle&&(t.tourPanAngle={set:i.pan_angle}),void 0!==i.pan_direction&&(t.tourPanDirection={set:y.vr[i.pan_direction]}),void 0!==i.pan_speed&&(t.tourPanSpeed={set:i.pan_speed}),void 0!==i.transition_speed&&(t.tourTransitionSpeed={set:i.transition_speed}),void 0!==i.transition_time&&(t.tourTransitionTime={set:i.transition_time}),void 0!==i.zoom_duration&&(t.tourZoomDuration={set:i.zoom_duration}),void 0!==i.dollhouse_pan_speed&&(t.tourDollhousePanSpeed={set:i.dollhouse_pan_speed});const o={};void 0!==i.presented_by&&(o.presentedByOverride=i.presented_by?w.D6.ENABLED:w.D6.DISABLED),void 0!==i.contact_email&&(o.contactEmailOverride=i.contact_email?w.D6.ENABLED:w.D6.DISABLED),void 0!==i.contact_name&&(o.contactNameOverride=i.contact_name?w.D6.ENABLED:w.D6.DISABLED),void 0!==i.contact_phone&&(o.contactPhoneOverride=i.contact_phone?w.D6.ENABLED:w.D6.DISABLED),void 0!==i.external_url&&(o.externalUrlOverride=i.external_url?w.D6.ENABLED:w.D6.DISABLED),void 0!==i.model_name&&(o.modelNameOverride=i.model_name?w.D6.ENABLED:w.D6.DISABLED),void 0!==i.model_summary&&(o.modelSummaryOverride=i.model_summary?w.D6.ENABLED:w.D6.DISABLED),void 0!==i.address&&(o.addressOverride=i.address?w.D6.ENABLED:w.D6.DISABLED);return{options:t,publication:Object.keys(o).length>0?{options:o}:void 0}}}const x=new s.Vy("mds-player-options-store");class C extends m.g{constructor(){super(...arguments),this.serializer=new T,this.deserializer=new S,this.prefetchKey="data.model.publication.options"}async read(e={}){var t,i;const o={modelId:this.getBaseViewId()},s=await this.query(p.GetModelDetails,o,e);let n=this.deserializer.deserialize(null===(t=null==s?void 0:s.data)||void 0===t?void 0:t.model);if(!n){const t={modelId:this.getViewId(),viewLookup:"self"},s=Object.assign(Object.assign({},e),{fetchPolicy:"no-cache"});x.warn("Failed to read model options for model from view:root, some options/details may be stale",o,"retry with",t);const a=await this.query(p.GetModelDetails,t,s);n=this.deserializer.deserialize(null===(i=null==a?void 0:a.data)||void 0===i?void 0:i.model)}return n||x.error("Failed to read model options, using default options"),n}async update(e){const t=this.getBaseViewId(),i=this.serializer.serialize(e);if(0===Object.keys(i).length)throw new Error("No data to update?");return this.mutate(p.PatchModel,{modelId:t,patch:i}).then((e=>{x.debug(e)}))}}function k(e,t){const i=window!==window.parent,s=i=>{var o;(null===(o=i.data)||void 0===o?void 0:o.action)===e&&t(i)};return(0,o.Sh)((()=>{i&&window.addEventListener("message",s)}),(()=>{i&&window.removeEventListener("message",s)}),!0)}var P;!function(e){e.ShowcaseOptionsChanged="showcase-options-changed",e.PluginConfigChanged="plugin-config-changed"}(P||(P={}));class F extends o.nV{constructor(){super(...arguments),this.name="showcase-settings",this.data=new r.EY,this.updateTransitionType=(e,t)=>{const i=e.options.fast_transitions?h.fl.FadeToBlack:h.fl.Interpolate;t.settingsData.hasSetting(l.zk)?t.settingsData.setSetting(l.zk,i):t.registerSetting("player_options",l.zk,i)}}async init(e,t){const{readonly:i,baseUrl:l}=e,h=s.Vy.for(this);this.engine=t;const c=await t.market.waitForData(u.P);this.store=new C({baseUrl:l,context:c.mdsContext,readonly:i}),this.data.copy(await this.store.read()),t.market.register(r.EY,this.data),this.bindings.push(k(P.ShowcaseOptionsChanged,(()=>this.refresh())),k(P.PluginConfigChanged,(()=>this.resetPlugins())));const m=await t.getModuleBySymbol(n.ZF);for(const e in r.Q$){const t=r.Q$[e],i=this.data.options[t];if(m.hasSetting(t)){const e=m.getSetting(t);m.updateSetting(t,i&&e),h.debug(`Updated player_options setting ${t} = ${i&&e}`)}else m.registerSetting("player_options",t,i),h.debug(`Registered player_options setting ${t} = ${i}`);this.bindings.push(this.data.options.onPropertyChanged(t,(e=>{h.debugInfo("PlayerOption changed",{key:t,previousValue:m.getSetting(t),newValue:this.data.options[t]}),m.updateSetting(t,e)})))}if(this.updateTransitionType(this.data,m),this.bindings.push(m.settingsData.onSettingChanged(r.Q$.InstantTransitions,(()=>this.updateTransitionType(this.data,m)))),!i){const[e]=await Promise.all([t.getModuleBySymbol(a.T9)]);this.bindings.push(e.onSave((()=>this.save()),{dataType:o.pe.SETTINGS})),this.monitor=new o.VA(this.data,{aggregationType:o.DF.NextFrame},this.engine),this.monitor.onChanged((()=>this.engine.commandBinder.issueCommand(new d.F({dataTypes:[o.pe.SETTINGS]}))))}}async refresh(){const e=await this.store.read({fetchPolicy:"no-cache"});e&&this.data.copy(e)}async resetPlugins(){const e=new c.ho([],!0);await this.engine.commandBinder.issueCommand(e)}async save(){if(!this.store||!this.monitor)return void s.Vy.for(this).warn("Settings changes will NOT be saved");const e=this.monitor.getDiffRecord(),t=e.options;return t&&(t&&void 0===t.measurements&&void 0!==t.measurements_saved&&(t.measurements=this.data.options.measurements),t&&void 0!==t.measurements&&void 0===t.measurements_saved&&(t.measurements_saved=this.data.options.measurements_saved),void 0!==(null==t?void 0:t.floor_select)&&(t.floor_select=this.data.options.floor_select),void 0!==(null==t?void 0:t.labels_dh)&&(t.labels_dh=this.data.options.labels_dh),void 0===t.presented_by&&void 0===t.contact_email&&void 0===t.contact_name&&void 0===t.contact_phone&&void 0===t.external_url&&void 0===t.model_name&&void 0===t.model_summary&&void 0===t.address||(t.presented_by=this.data.options.presented_by,t.contact_email=this.data.options.contact_email,t.contact_name=this.data.options.contact_name,t.contact_phone=this.data.options.contact_phone,t.external_url=this.data.options.external_url,t.model_name=this.data.options.model_name,t.model_summary=this.data.options.model_summary,t.address=this.data.options.address)),this.monitor.clearDiffRecord(),this.store.update(e)}}},6025:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>S});var o=i(68909),s=i(77201),n=i(97800),a=i(86866),r=i(44455),l=i(71687),h=i(12837),d=i(2993),c=i(15930),u=i(15580),m=i(26482),p=i(13893),g=i(50018),v=i(25316),f=i(50178),w=i(78115),y=i(56208),D=i(88090),b=i(38939);class S extends s.nV{constructor(){super(...arguments),this.name="showcase-start",this.firstRenderPromise=new s.iB,this.flyInPromise=new s.iB,this.handleFlyIn=async(e,t,i)=>{this.renderer.startRender(!1);try{await this.doStandardStart(e,t,i,!0)}catch(e){n.Vy.for(this).error(e),this.renderer.startRender(!0)}}}async init(e,t){const[i,o,a,r]=await Promise.all([t.market.waitForData(v.o),t.market.waitForData(m.G),t.market.waitForData(y.EY),t.getModuleBySymbol(l.Qm),t.getModuleBySymbol(l.yT)]);if([this.sweepData,this.sweepModule,this.cameraModule,this.renderer,this.appData]=await Promise.all([t.market.waitForData(h.A),t.getModuleBySymbol(l.Wh),t.getModuleBySymbol(l.jh),t.getModuleBySymbol(l.M7),t.market.waitForData(s.zH)]),this.bindings.push(t.commandBinder.addBinding(b.c,(async e=>{this.handleFlyIn(e.pose||o.getStartingPose(),t,i)})),t.commandBinder.addBinding(b.W,(async e=>{this.fadeToStartLocation(o,t)})),t.subscribe(w.tj,(async()=>{this.appData.application!==s.lg.WORKSHOP&&o.moveCameraOnViewChange&&this.fadeToStartLocation(o,t)}))),r.viewportManager.viewports.length>1)return this.firstRenderPromise.resolve(),this.flyInPromise.resolve(),this.waitForFirstRender;const d=i.tryGetSetting("quickstart",!1),c=this.getStartingPose(o,a);return(d?this.doQuickStart(c,t,p.fl.Instant):this.doStandardStart(c,t,i,!1)).catch((e=>{n.Vy.for(this).error("Handling error during initial fly-in, attempting recover",{startingPose:c,error:e}),this.doQuickStart(c,t,p.fl.FadeToBlack),this.renderBeforeStarting(t)})).finally((()=>this.flyInPromise.resolve())),this.waitForFirstRender}getStartingPose(e,t){const i=e.getStartingPose(),o=!t.options.dollhouse,s=!t.options.floor_plan;return o&&i.mode===d.N3.Dollhouse||s&&i.mode===d.N3.Floorplan?new m.n:i}fadeToStartLocation(e,t){const i=e.getStartingPose();this.doQuickStart(i,t,p.fl.FadeToBlack)}get waitForFirstRender(){return this.firstRenderPromise.nativePromise()}get waitForFlyin(){return this.flyInPromise.nativePromise()}async doQuickStart(e,t,i){const o=this.sweepData.getStartSweep(e),s=o&&o.id,n=await t.getModuleBySymbol(l.SD);return await n.switchToMode(e.mode,i,{sweepID:s,position:e.camera.position||o&&o.position,rotation:e.camera.rotation,zoom:-1!==e.camera.zoom?e.camera.zoom:void 0}),t.broadcast(new f.c7(!1)),e.mode!==d.N3.Dollhouse&&e.mode!==d.N3.Floorplan||e.floorVisibility&&t.getModuleBySymbol(l.QW).then((t=>{e.floorVisibility&&t.moveToFloorIndex(e.floorVisibility.lastIndexOf(1),{suppressCameraMovement:!0,transitionTime:0})})),this.renderBeforeStarting(t)}async doStandardStart(e,t,i,s){var h;const[m]=await Promise.all([t.getModuleBySymbol(l.SD)]);await t.getModuleBySymbol(D.K4);const g=!i.tryGetSetting(u.n9,!1),v=!i.tryGetSetting(u._z,!1);e&&(e.mode===d.N3.Dollhouse&&g||e.mode===d.N3.Floorplan&&v||e.mode===d.N3.Panorama&&!e.pano)&&(e=null);const w=!e||e&&(e.mode===d.N3.Dollhouse||e.mode===d.N3.Floorplan),y=!e||e&&!this.is360Pano(e)&&(0,d.nI)(e.mode)&&!g,b=e?e.mode:d.N3.Panorama,S=this.sweepData.getStartSweep(e),M=S&&S.id,T=this.sweepData.getFirstSweep();let x=T&&T.rotation;if((null===(h=null==e?void 0:e.camera)||void 0===h?void 0:h.rotation)&&!(0,r.PH)(e.camera.rotation)&&(x=e.camera.rotation),x&&b!==d.N3.Floorplan&&(x=(0,a.V5)(x)),await(await t.getModuleBySymbol(l.GR)).firstMeshLoadPromise,y){const i=await m.getFlyinEndPose({sweepID:M,position:e?e.camera.position:void 0,rotation:x}),a=m.getFlyinStartPose(i,s?new o.Vector3(0,0,0):void 0);t.broadcast(new f.c7(!0));const r=M?this.sweepModule.activateSweepUnsafe({sweepId:M}):Promise.resolve();await m.switchToMode(d.N3.Dollhouse,p.fl.Instant,a),await this.renderBeforeStarting(t),await(0,n.cb)(750),await this.cameraModule.getCameraControllerForViewport().moveTo({transitionType:p.fl.Interpolate,pose:i}).nativePromise(),await r,t.broadcast(new f.c7(!1)),await m.switchToMode(b,p.fl.Interpolate,{sweepID:M,rotation:x},c.Ou)}else{if(await m.switchToMode(b,p.fl.Instant,{sweepID:M,position:e?e.camera.position:void 0,rotation:x,zoom:e&&-1!==e.camera.zoom?e.camera.zoom:void 0}),w&&e)if(e.floorVisibility)t.getModuleBySymbol(l.QW).then((t=>{e.floorVisibility&&t.moveToFloorIndex(e.floorVisibility.lastIndexOf(1),{suppressCameraMovement:!0,transitionTime:0})}));else{(await t.getModuleBySymbol(l.QW)).moveToFloor(null,{})}await this.renderBeforeStarting(t)}}is360Pano(e){if(e.pano.uuid){const t=this.sweepData.getSweep(e.pano.uuid);if(t)return t.alignmentType!==g.c$.ALIGNED}else{const e=this.sweepData.getFirstSweep();if(void 0!==e)return e.alignmentType!==g.c$.ALIGNED}return!1}async renderBeforeStarting(e){await this.renderer.renderOnce(),await e.getModuleBySymbol(D.XT),this.renderer.startRender(!0),this.firstRenderPromise.resolve()}}},79109:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>a});var o=i(77201),s=i(99583),n=i(71687);class a extends o.nV{constructor(){super(...arguments),this.name="common-controls",this.modeControls=new Map,this.viewportDescriptors=new Map}async init(e,t){this.modeControls=new Map,t.market.waitForData(s.X).then((e=>{this.viewmodeData=e,this.bindings.push(this.viewmodeData.onChanged((()=>this.setControllerForCurrViewmode()))),this.setControllerForCurrViewmode()})),[this.viewportModule,this.cameraModule]=await Promise.all([t.getModuleBySymbol(n.Qm),t.getModuleBySymbol(n.jh)]);const i=e=>{const t=this.cameraModule.getCameraPoseProxyForViewport(e),i={cameraPoseProxy:t,poseController:null,sub:null};i.sub=t.newSession({onAccessGranted(e){i.poseController=e},onAccessRevoked(e){i.poseController=null}}),this.viewportDescriptors.set(e,i);for(const i of this.modeControls.values())i.controls.createControlsForViewport(e,t.pose)},o=e=>{var t;const i=this.viewportDescriptors.get(e);if(i){null===(t=i.sub)||void 0===t||t.cancel();for(const t of this.modeControls.values())t.controls.removeControlsForViewport(e);this.viewportDescriptors.delete(e)}};for(const e of this.viewportModule.viewportManager.viewports)i(e.id);this.bindings.push(this.viewportModule.viewportManager.viewports.onElementChanged({onAdded:e=>i(e.id),onRemoved:e=>o(e.id)})),this.setControllerForCurrViewmode()}startRotateTransition(e,t,i=!0){return this.checkControlsForAction((o=>o.startRotateTransition(e,t,i)))}startZoomTransition(e,t,i=!0){return this.checkControlsForAction((o=>o.startZoomTransition(e,t,i)))}startTranslateTransition(e,t,i=!0){return this.checkControlsForAction((o=>o.startTranslateTransition(e,t,i)))}stop(){return this.checkControlsForAction((e=>(e.stop(),Promise.resolve())))}rotateBetweenOrientations(e,t,i,o,s=!1){return this.checkControlsForAction((n=>n.rotateBetweenOrientations(e,t,i,o,s)))}setControllerForCurrViewmode(){var e,t;if(null===(e=this.viewmodeData)||void 0===e?void 0:e.currentMode){const e=null===(t=this.modeControls.get(this.viewmodeData.currentMode))||void 0===t?void 0:t.controls;if(e)for(const[t,i]of this.viewportDescriptors)e.setController(t,i.poseController);for(const t of this.modeControls.values()){const i=t.controls;if(i!==e)for(const[e]of this.viewportDescriptors)i.setController(e,null)}}}checkControlsForAction(e){var t;if(null===(t=this.viewmodeData)||void 0===t?void 0:t.currentMode){const t=this.modeControls.get(this.viewmodeData.currentMode);if(t){const i=t.controls.getControlsForViewport(this.viewportModule.viewportManager.activeViewport.id);if(i)return e(i)}}return Promise.reject("checkControlsForAction() -> Current view mode is null")}addControls(e,t,i){if(!this.modeControls.get(e)||i){this.modeControls.set(e,{mode:e,controls:t});for(const e of this.viewportModule.viewportManager.viewports)t.createControlsForViewport(e.id,this.cameraModule.getCameraDataForViewport(e.id).pose);this.setControllerForCurrViewmode()}}}},51887:(e,t,i)=>{"use strict";i.d(t,{$V:()=>d,DQ:()=>a,Dw:()=>w,X8:()=>c,Yf:()=>v,Yp:()=>h,aY:()=>m,bI:()=>f,eW:()=>l,g1:()=>g,mK:()=>u,ol:()=>r,pz:()=>p,qD:()=>s,vc:()=>n});var o=i(53172);const s=1e3/60,n=89*o.fy,a=90*o.fy,r=.001*o.fy,l=10*o.fy,h=20*o.fy,d=30*o.fy,c=.25,u=500,m=.1,p=.16,g=.08,v=Math.PI/1e3,f=.02,w=150},82010:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>H});var o,s=i(71687),n=i(81662),a=i(44667),r=i(94790),l=i(60043),h=i(71397),d=i(28337),c=i(2993),u=i(53172),m=i(68909),p=i(92598),g=i(72268),v=i(77201),f=i(33007),w=i(4994),y=i(3249),D=i(13893),b=i(51887),S=i(28995),M=i(19968);!function(e){e[e.NONE=0]="NONE",e[e.ROTATE=1]="ROTATE",e[e.PAN=2]="PAN",e[e.ZOOM=3]="ZOOM"}(o||(o={}));g.O.NONE,o.NONE,g.O.PRIMARY,o.ROTATE,g.O.SECONDARY,o.PAN,g.O.MIDDLE,o.ZOOM,g.O.BACK,o.NONE,g.O.FORWARD,o.NONE,g.O.ALL,o.NONE;const T={[g.O.NONE]:o.NONE,[g.O.PRIMARY]:o.PAN,[g.O.SECONDARY]:o.ROTATE,[g.O.MIDDLE]:o.ZOOM,[g.O.BACK]:o.NONE,[g.O.FORWARD]:o.NONE,[g.O.ALL]:o.NONE};var x;!function(e){e[e.NONE=0]="NONE",e[e.MOUSE=1]="MOUSE",e[e.KEYBOARD=2]="KEYBOARD",e[e.TOUCH=3]="TOUCH"}(x||(x={}));class C{constructor(e,t,i,o,s,a){this.pose=e,this.poseConstrainer=t,this.getRayPoint=i,this.getFocusPoint=o,this.invalidateParentOrbitCache=s,this.movingCamera=!1,this.smoothedTouch0=new m.Vector2,this.smoothedTouch1=new m.Vector2,this.origTouchAxis=new m.Vector2,this.origCenterPt=new m.Vector2,this.plane=new m.Plane(n.B1.UP.clone(),0),this.focusPlane=new m.Plane(n.B1.UP.clone(),0),this.maxScale=1,this.minScale=1,this.originalPinchLength=0,this.pointersMoved=(()=>{const e=new m.Vector2,t=new m.Vector3,i=new m.Vector3,o=new m.Vector2,s=new S.J(1),a=new m.Ray,r=new m.Vector3;return l=>{if(!this.poseController||!this.movingCamera)return;s.copy(this.pose);this.smoothedTouch0.lerp(l[0].position,.2),this.smoothedTouch1.lerp(l[1].position,.2),o.copy(this.smoothedTouch1).sub(this.smoothedTouch0).normalize();const h=this.origTouchAxis.angle()-o.angle();t.copy(this.initialPose.fovCorrectedPosition());const d=new m.Vector3(-this.intersectionPt.x,0,-this.intersectionPt.z);t.add(d),t.applyAxisAngle(n.B1.UP,h),d.negate(),t.add(d);const c=(new m.Quaternion).copy(this.initialPose.rotation),u=(new m.Quaternion).setFromAxisAngle(n.B1.UP,h);c.premultiply(u);const p=this.smoothedTouch0.clone().lerp(this.smoothedTouch1,.5),g=new m.Vector3;if(i.copy(n.B1.FORWARD).applyQuaternion(c),this.castFrom(p.x,p.y,g),isNaN(g.x))return void(this.movingCamera=!1);g.sub(this.intersectionPt),g.negate(),g.applyAxisAngle(n.B1.UP,h);const v=e.subVectors(this.smoothedTouch0,this.smoothedTouch1).length()/this.originalPinchLength,f=1-1/(0,y.qE)(v,this.minScale,this.maxScale),w=t.add(g).lerp(this.intersectionPt,f).clone();if(a.set(w,i),a.intersectPlane(this.focusPlane,r)){const e=r.distanceTo(w);s.position.copy(w),s.rotation.copy(c),s.focalDistance=e,s.resetProjMatrix(),s.applyPhiBasedFovSquish(),this.poseConstrainer.constrain(s),this.poseController.updateCameraPose(s),this.invalidateParentOrbitCache()}}})(),this.initMove=(()=>{const e=new m.Vector2,t=new m.Ray;return i=>{const o=i[0].position,s=i[1].position;this.smoothedTouch0.copy(o),this.smoothedTouch1.copy(s),this.originalPinchLength=e.subVectors(o,s).length(),this.origTouchAxis.copy(s).sub(o).normalize(),this.origCenterPt.copy(o).lerp(s,.5);const{pose:a}=this;this.initialPose=a.clone();const r=new m.Vector3,l=new m.Vector3;(0,M.Ft)(this.initialPose,r.set(this.origCenterPt.x,this.origCenterPt.y,-1),r),(0,M.Ft)(this.initialPose,l.set(this.origCenterPt.x,this.origCenterPt.y,1),l),l.sub(r).normalize(),t.set(r,l),this.intersectionPt=this.getRayPoint(t);const h=this.getFocusPoint();a.focalDistance=a.position.distanceTo(h),this.initialPose.focalDistance=a.position.distanceTo(h),this.maxScale=this.initialPose.fovCorrectedFocalDistance()/this.poseConstrainer.minZoomDistance,this.minScale=this.initialPose.fovCorrectedFocalDistance()/this.poseConstrainer.maxZoomDistance,this.poseConstrainer.setStartPose(this.initialPose);const d=a.phi()<b.Yp?a.forward().clone().multiplyScalar(-1):n.B1.UP;this.plane.setFromNormalAndCoplanarPoint(d,this.intersectionPt),this.focusPlane.setFromNormalAndCoplanarPoint(d,h)}})(),this.castFrom=(()=>{const e=new m.Ray,t=new m.Vector3,i=new m.Vector3;return(o,s,n)=>{(0,M.Ft)(this.initialPose,t.set(o,s,-1),t),(0,M.Ft)(this.initialPose,i.set(o,s,1),i),i.sub(t).normalize(),e.set(t,i),e.intersectPlane(this.plane,n)&&!n.equals(t)||(n.x=NaN)}})(),a.onGrabStart((e=>{this.movingCamera=!0,this.initMove(e.pointers)})),a.onGrabEnd((()=>{this.movingCamera=!1}))}isMovingCamera(){return this.movingCamera}rawPointerUpdate(e){this.pointersMoved(e.pointers)}setController(e){e?this.poseController=e:(this.poseController=void 0,this.movingCamera=!1)}}var k=i(52885);var P;!function(e){e.NONE="none",e.GRAB="grab",e.SPIN="spin"}(P||(P={}));class F{constructor(){this.t1=new m.Vector2,this.t2=new m.Vector2,this.initT1=new m.Vector2,this.initT2=new m.Vector2,this.deltaT1=new m.Vector2,this.deltaT2=new m.Vector2,this.twoFingerEventCt=0,this.currGesture=P.NONE,this.contiguousGrabEventCt=0,this.grabStartObservers=new Set,this.grabEndObservers=new Set,this.spinStartObservers=new Set,this.spinEndObservers=new Set,this.gesturePointerIds=[null,null],this.currPos=new m.Vector2}rawPointerUpdate(e){if(e.pointers.length>=2){0===this.twoFingerEventCt?(this.t1.copy(e.pointers[0].clientPosition),this.t2.copy(e.pointers[1].clientPosition),this.initT1.copy(e.pointers[0].clientPosition),this.initT2.copy(e.pointers[1].clientPosition),this.gestureStartPointers=e,this.gesturePointerIds[0]=e.pointers[0].id,this.gesturePointerIds[1]=e.pointers[1].id,this.setCurrGesureAndNotifyObservers(P.NONE)):(this.t1.lerp(e.pointers[0].clientPosition,.2),this.t2.lerp(e.pointers[1].clientPosition,.2),(this.currGesture===P.NONE||this.currGesture===P.GRAB&&this.contiguousGrabEventCt<30)&&this.setCurrGesureAndNotifyObservers(this.nextGesture()));const t=(e.pointers[0].position.x+e.pointers[1].position.x)/2,i=(e.pointers[0].position.y+e.pointers[1].position.y)/2;this.currPos.set(t,i),this.twoFingerEventCt++}else this.twoFingerEventCt=0,this.setCurrGesureAndNotifyObservers(P.NONE),this.gesturePointerIds[0]=null,this.gesturePointerIds[1]=null;this.currGesture===P.GRAB&&this.contiguousGrabEventCt++}onGrabStart(e){return(0,v.Sh)((()=>this.grabStartObservers.add(e)),(()=>this.grabStartObservers.delete(e)),!0)}onGrabEnd(e){return(0,v.Sh)((()=>this.grabEndObservers.add(e)),(()=>this.grabEndObservers.delete(e)),!0)}onSpinStart(e){return(0,v.Sh)((()=>this.spinStartObservers.add(e)),(()=>this.spinStartObservers.delete(e)),!0)}onSpinEnd(e){return(0,v.Sh)((()=>this.spinEndObservers.add(e)),(()=>this.spinEndObservers.delete(e)),!0)}setCurrGesureAndNotifyObservers(e){const t=this.currGesture;if(this.currGesture=e,t===P.NONE)e===P.GRAB?this.notifyGrabStartObservers():e===P.SPIN&&this.notifySpinStartObservers();else if(t===P.GRAB)e===P.SPIN?(this.notifyGrabEndObservers(),this.notifySpinStartObservers()):e===P.NONE&&this.notifyGrabEndObservers();else if(t===P.SPIN)if(e===P.NONE)this.notifySpinEndObservers();else if(e===P.GRAB)throw new Error("Gesture recognizer should never switch from SPIN -> GRAB")}notifyGrabStartObservers(){for(const e of this.grabStartObservers)e(this.gestureStartPointers)}notifySpinStartObservers(){for(const e of this.spinStartObservers)e(this.gestureStartPointers)}notifyGrabEndObservers(){this.contiguousGrabEventCt=0;for(const e of this.grabEndObservers)e()}notifySpinEndObservers(){for(const e of this.spinEndObservers)e()}nextGesture(){if(this.twoFingerEventCt>5){const e=this.t1.y-this.initT1.y,t=this.t2.y-this.initT2.y,i=this.t1.x-this.initT1.x,o=this.t2.x-this.initT2.x;this.deltaT1.set(i,e),this.deltaT2.set(o,t);const s=this.deltaT1.length(),n=this.deltaT2.length(),a=Math.min(s,n)/Math.max(s,n)>.7,r=this.deltaT1.normalize().dot(this.deltaT2.normalize())>.7;return a&&r&&s>2&&n>2?P.SPIN:P.GRAB}return P.NONE}}var V=i(97800),O=i(78649),I=i(62568);const B=f.A.epsilon,A=b.DQ,N=.15*Math.PI;class E extends w.A{constructor(e,t,i,s,a,r,l,h){super(),this.pose=e,this.poseConstrainer=t,this.getOrbitPoint=i,this.getGrabPoint=s,this.isPeekabooSoftDisabled=r,this.constrolsData=l,this.messageBus=h,this.controlState=o.NONE,this.tempOrientation=new m.Quaternion,this.tempAxis=new m.Vector3,this.nextPosition=new m.Vector3,this.nextOrientation=new m.Quaternion,this.currentPose=new S.J(1),this.positionDelta=new m.Vector3,this.angularAccel=new m.Vector2,this.angularVelocity=new m.Vector2,this.linearAccel=new m.Vector2,this.linearVelocity=new m.Vector2,this.grabPlane=(new m.Plane).setFromNormalAndCoplanarPoint(n.B1.UP,n.B1.ZERO),this.grabPt=new m.Vector3,this.ndcPos=new m.Vector2,this.zoomAccel=0,this.zoomVelocity=0,this.orbitPoint=new m.Vector3,this.orbitDistance=0,this.orbitPlane=new m.Plane,this.needsOrbitDataInit=!0,this.autoOrbitStartPhi=0,this.aimTarget=new m.Vector3,this.currentPhiLowerLimit=b.ol,this.currentPhiUpperLimit=b.vc,this.activeAction=o.NONE,this.activeDevice=x.NONE,this.touchGestureRecognizer=new F,this.isTouchSpinning=!1,this.prevTouchY=0,this.prevTouchX=0,this.zoomDirection=new m.Vector3,this.castFromNdc=(()=>{const e=new m.Vector3,t=new m.Vector3(0,0,-1),i=new m.Ray(e,t),o=new m.Vector3;return()=>{(0,M.Ft)(this.grabCameraPose,e.set(this.ndcPos.x,this.ndcPos.y,-1),e),(0,M.Ft)(this.grabCameraPose,t.set(this.ndcPos.x,this.ndcPos.y,1),t),t.sub(e).normalize(),i.set(e,t);return i.intersectPlane(this.grabPlane,o)}})(),this.dampedZoomDir=(()=>{const e=new m.Vector3,t=new m.Quaternion,i=new m.Vector3,o=new m.Vector3,s=new m.Quaternion;return(n=b.qD)=>{const a=this.pose,r=a.forward().clone(),l=this.getGrabPoint(),h=l.clone().sub(this.pose.fovCorrectedPosition()).normalize(),d=this.poseConstrainer.modelBoundingBox.containsPoint(l)&&a.phi()>b.eW?h:r,c=s.angleTo(a.rotation)>1e-8;if(s.copy(a.rotation),e.length()<.1||c)e.copy(d),this.zoomDirection.copy(d);else{const s=e.angleTo(d);o.crossVectors(e,d);const a=(0,u.pu)(1*n),r=Math.min(s,a);t.setFromAxisAngle(o,r);const l=i.copy(e).applyQuaternion(t);e.copy(l),this.zoomDirection.copy(l)}}})(),this.touchControls=new C(e,t,a,i,(()=>this.invalidateOrbitMetadata()),this.touchGestureRecognizer),e.autoOrtho&&(this.currentPhiUpperLimit=b.DQ),this.transition={active:!1,startTime:0,elapsed:0,duration:0,angularVelocity:new m.Vector2,linearVelocity:new m.Vector2,zoomVelocity:0,easeOut:!1},this.touchGestureRecognizer.onGrabStart((()=>{this.messageBus.broadcast(new O.i),this.stopAndClearState()})),this.touchGestureRecognizer.onGrabEnd((()=>this.stopAndClearState())),this.touchGestureRecognizer.onSpinStart((e=>{this.isTouchSpinning=!0,this.prevTouchX=(e.pointers[0].position.x+e.pointers[1].position.x)/2,this.prevTouchY=(e.pointers[0].position.y+e.pointers[1].position.y)/2,this.initMove(o.ROTATE,x.MOUSE)})),this.touchGestureRecognizer.onSpinEnd((()=>{this.endMove(),this.isTouchSpinning=!1}))}touchGestureIds(){return this.touchGestureRecognizer.gesturePointerIds}rawPointerUpdate(e){this.isActive&&(this.touchGestureRecognizer.rawPointerUpdate(e),this.touchControls.rawPointerUpdate(e))}setController(e){return super.setController(e),this.touchControls.setController(e),null===e&&this.activeAction!==o.NONE&&this.endMove(),this}setOrbitalAcceleration(e,t=!1){this.transition.active||(t&&this.haltVelocity(e,this.angularVelocity),this.angularAccel.x=void 0!==e.x?e.x:this.angularAccel.x,this.angularAccel.y=void 0!==e.y?e.y:this.angularAccel.y)}setPanAcceleration(e,t=!1){this.transition.active||(t&&this.haltVelocity(e,this.linearVelocity),this.linearAccel.x=void 0!==e.x?e.x:this.linearAccel.x,this.linearAccel.y=void 0!==e.y?e.y:this.linearAccel.y)}setNdcPos(e){this.ndcPos.copy(e)}initMove(e,t,i){if(t!==x.KEYBOARD&&(this.setPanAcceleration({x:0,y:0}),this.stop()),i&&this.setNdcPos(i),e!==this.activeAction||t!==this.activeDevice){this.updateOrbitState(),this.activeDevice=t,this.activeAction=e;const i=this.pose;this.poseConstrainer.setStartPose(i);const s=this.getGrabPoint(),a=i.phi()<b.Yp?i.forward().clone().multiplyScalar(-1):n.B1.UP;this.grabPlane.setFromNormalAndCoplanarPoint(a,s),this.grabCameraPose=this.pose.clone(),this.grabPt.copy(s),e===o.ROTATE&&this.messageBus.broadcast(new O.i)}}stopAndClearState(e=!1){((0,V.Fr)()||e)&&this.stop(),this.updateOrbitState(),this.activeDevice=x.NONE,this.activeAction=o.NONE}softStopAndClearState(){this.stopAcceleration(),this.updateOrbitState(),this.activeDevice=x.NONE,this.activeAction=o.NONE}endMove(e){e&&this.setNdcPos(e),this.isTouchSpinning?this.softStopAndClearState():this.stopAndClearState();const t=this.pose.pitchFactor();!this.isAutoOrbitting&&t<1&&t>1e-10&&this.pose.autoOrtho&&this.startAutoOrbitTo(),this.controlState=o.NONE}startAutoOrbitTo(e="top"){const t="top"===e?A:b.$V;if(Math.abs(this.pose.phi()-t)<1e-10)return Promise.resolve();const i=this.constrolsData.startAutoOrbit(e);return this.autoOrbitStartPhi=this.pose.phi(),i}stopAutoOrbit(){this.stopAndClearState(!0),this.constrolsData.stopAutoOrbit(),this.invalidateOrbitMetadata()}invalidateOrbitMetadata(){this.needsOrbitDataInit=!0}get isAutoOrbitting(){return this.constrolsData.isAutoOrbitting}get mouseDown(){return this.activeDevice===x.MOUSE||this.activeDevice===x.TOUCH}updateOrbitState(){if(this.activeAction!==o.ROTATE||this.needsOrbitDataInit){const e=this.pose,t=this.getOrbitPoint();this.orbitPoint.copy(t);const i=e.position.distanceTo(this.orbitPoint);this.orbitDistance=i/e.fovDistanceScale(),this.orbitPlane.setFromNormalAndCoplanarPoint(n.B1.UP,this.orbitPoint),this.pose.focalDistance=i,this.needsOrbitDataInit=!1}}setZoomAcceleration(e){this.transition.active||(this.zoomAccel=e)}async setPhiLimits(e,t,i){this.currentPhiLowerLimit=e,this.currentPhiUpperLimit=t;const o=this.pose.phi(),s=(0,y.qE)(0,this.currentPhiLowerLimit-o,this.currentPhiUpperLimit-o);Math.abs(s)>B&&i&&await this.orbit(new m.Vector2,!0)}haltVelocity(e,t){e.x&&t.x&&Math.sign(e.x)!==Math.sign(t.x)&&(t.x=0),e.y&&t.y&&Math.sign(e.y)!==Math.sign(t.y)&&(t.y=0)}startTransition(e,t,i,o,s){if(null===this.poseController)return v.iB.reject("Unable to start transition, since controller is unavailable.");const n=new v.iB;return this.transition.active=!0,this.transition.duration=e,this.transition.elapsed=0,this.transition.startTime=Date.now(),this.transition.deferred=n,this.transition.angularVelocity.copy(t),this.transition.linearVelocity.copy(i),this.transition.zoomVelocity=o,this.transition.easeOut=s,this.angularAccel.set(0,0),this.linearAccel.set(0,0),this.zoomAccel=0,this.angularVelocity.copy(t),this.linearVelocity.copy(i),this.zoomVelocity=o,this.poseController.beginExternalTransition(),n.promise()}stopTransition(){this.transition.active&&(this.poseController&&this.poseController.endExternalTransition(),this.transition.active=!1,this.endMove()),this.transition.deferred&&(this.transition.deferred.resolve(),this.transition.deferred=void 0)}updateTransition(e,t,i,o){let s=1,n=e/b.qD;if(this.transition.elapsed+=e,this.transition.elapsed>=this.transition.duration){s=(this.transition.duration-(this.transition.elapsed-e))/e,n=1}t&&(this.angularVelocity.copy(this.transition.angularVelocity).multiplyScalar(s*n),this.orbit(this.angularVelocity)),i&&(this.linearVelocity.copy(this.transition.linearVelocity).multiplyScalar(s*n),this.pan(this.linearVelocity)),o&&(this.zoomVelocity=this.transition.zoomVelocity*s*n,this.zoom(this.zoomVelocity)),this.transition.elapsed>=this.transition.duration&&(this.stop(this.transition.easeOut),this.transition.active=!1)}updateDefault(e,t,i,o){if(this.touchControls.isMovingCamera())return;const s=e/b.qD;if(t&&!o){this.angularVelocity.addScaledVector(this.angularAccel,s);const e=this.isTouchSpinning?1.1:1;this.orbit(this.angularVelocity.clone().multiplyScalar(s/e)),this.angularVelocity.multiplyScalar(Math.pow(1-b.g1,s)/e)}i&&(this.linearVelocity.addScaledVector(this.linearAccel,s),this.pan(this.linearVelocity),this.linearVelocity.multiplyScalar(Math.pow(1-b.g1,s))),o&&(this.zoomVelocity+=this.zoomAccel*s,this.zoom(this.zoomVelocity),this.zoomVelocity*=Math.pow(1-b.pz,s),this.angularVelocity.set(0,0),this.angularAccel.set(0,0))}startRotateTransition(e,t,i){return t.x*=-1,this.orbitDistance=this.pose.focalDistance,this.initMove(o.ROTATE,x.KEYBOARD),this.startTransition(e,t.clone().multiplyScalar(b.qD),new m.Vector2,0,i).nativePromise()}startTranslateTransition(e,t,i=!0){return this.initMove(o.PAN,x.KEYBOARD),this.startTransition(e,new m.Vector2,t.clone().multiplyScalar(b.qD),0,i).nativePromise()}startZoomTransition(e,t,i){return this.startTransition(e,new m.Vector2(0,0),new m.Vector2(0,0),t,i).nativePromise()}update(e){const t=this.linearAccel.length()>B||this.linearVelocity.length()>B,i=this.angularAccel.length()>B||this.angularVelocity.length()>B,s=Math.abs(this.zoomAccel)>B||Math.abs(this.zoomVelocity)>B,n=i||this.isAutoOrbitting,a=t||this.mouseDown&&this.activeAction===o.PAN,r=s;this.dampedZoomDir(e),this.updateMultiTouchGesture(e),this.activeDevice!==x.KEYBOARD||t||i||s?this.transition.active?this.updateTransition(e,n,a,r):this.updateDefault(e,n,a,r):this.endMove()}stopMomentum(){this.transition.active||(this.angularVelocity.set(0,0),this.linearVelocity.set(0,0),this.zoomVelocity=0)}stopAcceleration(){this.transition.active||(this.setOrbitalAcceleration({x:0,y:0}),this.setPanAcceleration({x:0,y:0}),this.setZoomAcceleration(0))}stop(e=!1){this.stopTransition(),this.stopAcceleration(),e||this.stopMomentum()}pan(e){if(!this.poseController)return;this.setupCurrentPose();const t=this.pose;if(this.mouseDown){const e=this.castFromNdc();if(e){const t=e.sub(this.grabPt);t.lengthSq()>0&&(this.nextPosition.copy(this.grabCameraPose.fovCorrectedPosition()).addScaledVector(t,-1),this.currentPose.position.copy(this.nextPosition),this.currentPose.applyPhiBasedFovSquish(),this.poseConstrainer.constrain(this.currentPose),this.poseController.updateCameraPose(this.currentPose))}}else this.positionDelta.x=e.x,this.positionDelta.z=e.y,this.positionDelta.y=0,this.nextPosition.copy(t.fovCorrectedPosition()).add(this.positionDelta),this.currentPose.position.copy(this.nextPosition),this.currentPose.applyPhiBasedFovSquish(),this.poseConstrainer.constrain(this.currentPose),this.poseController.updateCameraPose(this.currentPose)}orbit(e,t=!1){if(!this.poseController)return;this.setupCurrentPose();const i=this.pose,o=i.phi(),s=this.isAutoOrbitting?this.calcAutoOrbitVelocity(o):e;let a=this.currentPhiUpperLimit;this.isPeekabooSoftDisabled()&&a>I.Xj&&(a=I.Xj);const r=this.isAutoOrbitting?A:a,l=this.isAutoOrbitting?b.$V:this.currentPhiLowerLimit,h=(0,y.qE)(s.y,l-o,r-o),d=r-o<1e-10,c=o-l<1e-10,u="top"===this.constrolsData.autoOrbitTarget?d:c;if(this.isAutoOrbitting&&u)return void this.stopAutoOrbit();if(d&&h>0&&!(Math.abs(e.x)>0))return this.angularVelocity.y=0,void(this.angularAccel.y=0);const m=this.orbitDistance;if(this.aimTarget.copy(n.B1.FORWARD).applyQuaternion(i.rotation),this.aimTarget.setLength(m),this.aimTarget.addVectors(i.fovCorrectedPosition(),this.aimTarget),this.tempAxis.copy(n.B1.RIGHT),this.tempOrientation.setFromAxisAngle(this.tempAxis.applyQuaternion(i.rotation),-h),this.nextPosition.copy(i.fovCorrectedPosition()).sub(this.aimTarget).applyQuaternion(this.tempOrientation),this.nextOrientation.copy(i.rotation).premultiply(this.tempOrientation),this.tempOrientation.setFromAxisAngle(n.B1.UP,s.x),this.nextPosition.applyQuaternion(this.tempOrientation),this.nextOrientation.premultiply(this.tempOrientation),this.nextPosition=this.nextPosition.add(this.aimTarget),this.nextOrientation.normalize(),this.currentPose.position.copy(this.nextPosition),this.currentPose.rotation.copy(this.nextOrientation),this.currentPose.focalDistance=m,this.currentPose.applyPhiBasedFovSquish(),t)return this.poseController.moveTo({transitionType:D.fl.Interpolate,pose:{position:this.currentPose.position.clone(),rotation:this.currentPose.rotation.clone()},transitionTime:500}).nativePromise();this.poseController.updateCameraPose(this.currentPose)}zoom(e){if(!this.poseController)return;this.setupCurrentPose(),this.updateOrbitState();const t=this.pose;this.poseConstrainer.setStartPose(t);const i=t.forward().clone(),o=1/(this.getGrabPoint().distanceTo(t.position)/t.fovDistanceScale())*2,s=this.poseConstrainer.modelSize,n=e*b.aY/(o*s*b.mK),a=this.zoomDirection,r=this.orbitPoint,l=this.poseConstrainer.maxZoomDistance-this.poseConstrainer.minZoomDistance,h=r.distanceTo(t.position)/t.fovDistanceScale(),d=(0,y.qE)(n*l+h,this.poseConstrainer.minZoomDistance,this.poseConstrainer.maxZoomDistance)-h,c=a.setLength(-d);this.nextPosition.copy(t.fovCorrectedPosition()).add(c);const u=new m.Ray(this.nextPosition,i),p=new m.Vector3;let g=u.intersectPlane(this.orbitPlane,p);g&&!g.equals(this.nextPosition)||(g=r),this.currentPose.position.copy(this.nextPosition),this.currentPose.focalDistance=g.distanceTo(this.nextPosition),this.currentPose.resetProjMatrix(),this.currentPose.applyPhiBasedFovSquish(),this.poseConstrainer.constrain(this.currentPose),this.poseController.updateCameraPose(this.currentPose)}setupCurrentPose(){const e=this.pose;this.currentPose.copy(e),this.currentPose.unapplyPhiBasedFovSquish()}calcAutoOrbitVelocity(e){const t="top"===this.constrolsData.autoOrbitTarget?1:-1,i="top"===this.constrolsData.autoOrbitTarget?A:b.$V,o=Math.abs((i-e)/(i-this.autoOrbitStartPhi)),s=(0,k.C)(.002,.08,o);return new m.Vector2(0,t*s)}getDebugState(){return{plane:this.orbitPlane.clone(),orbitPt:this.orbitPoint.clone(),zoomDir:this.zoomDirection.clone().normalize()}}updateMultiTouchGesture(e){if(this.isTouchSpinning){const t=this.touchGestureRecognizer.currPos.x,i=this.touchGestureRecognizer.currPos.y,o=this.prevTouchX-t,s=this.prevTouchY-i,n=Math.abs(o)>.001?o:0,a=Math.abs(s)>.001?s:0,r=e/b.qD;this.setOrbitalAcceleration({x:N*n*r,y:N*a*r}),this.prevTouchX=t,this.prevTouchY=i}}}var R=i(12767);class _{constructor(e){this.idealOrbitCenter=new m.Vector3,this.gestureStartPose=new S.J(1),this.constrain=(()=>{const e=new m.Vector3,t=new m.Vector3,i=new m.Vector3,o=new m.Ray;return s=>{const n=this.gestureStartPose.focalPoint(),a=s.focalPoint();if(a.distanceTo(n)<1e-10)return;const r=i.subVectors(s.position,this.gestureStartPose.position);o.set(this.gestureStartPose.position,r);const l=this.maxDeviationOfOrbitPoint.clampPoint(a,e),h=s.fovDistanceScale(),d=this.minOrbitDistance*h,c=this.maxOrbitDistance*h,u=(0,y.qE)(s.focalDistance,d,c),m=t.copy(l).addScaledVector(s.forward(),-1*u);s.focalDistance=u,s.position.copy(m),s.commit()}})(),this.updateConstraints(e)}updateConstraints(e){const t=e.getSize(new m.Vector3);this.modelSize=Math.max(t.length(),1),this.modelBoundingBox=e,this.idealOrbitCenter=e.getCenter(this.idealOrbitCenter);const i=e.max.distanceTo(this.idealOrbitCenter);this.minOrbitDistance=2;const o=2*i;this.maxOrbitDistance=o/Math.tan(R.Bv.fov/2*u.fy);const s=2*i;this.maxDeviationOfOrbitPoint=new m.Box3(this.idealOrbitCenter.clone().add(new m.Vector3(-s,0,-s)),this.idealOrbitCenter.clone().add(new m.Vector3(s,0,s))),this.maxDeviationOfOrbitPoint.min.y=this.modelBoundingBox.min.y,this.maxDeviationOfOrbitPoint.max.y=this.modelBoundingBox.max.y}get minZoomDistance(){return this.minOrbitDistance}get maxZoomDistance(){return this.maxOrbitDistance}setStartPose(e){this.gestureStartPose.copy(e)}containsPoint(e){return this.maxDeviationOfOrbitPoint.containsPoint(e)}}var L=i(2998),z=i(17986);class U extends v.B_{constructor(){super(...arguments),this.name="dollhouse-control-data",this.autoOrbitPromise=null,this._autoOrbitTarget="top"}get isAutoOrbitting(){return null!==this.autoOrbitPromise}get autoOrbitTarget(){return this._autoOrbitTarget}get targetState(){return this.isAutoOrbitting?this.autoOrbitTarget:null}startAutoOrbit(e="top"){return this._autoOrbitTarget=e,this.autoOrbitPromise=new v.iB,this.commit(),this.autoOrbitPromise.nativePromise()}stopAutoOrbit(){const e=this.autoOrbitPromise;this.autoOrbitPromise=null,this.commit(),null==e||e.resolve()}}var G=i(90082),j=i(99583);class H extends z.A{constructor(){super(...arguments),this.name="dollhouse-controls",this.movementKeys=new m.Vector2,this.didDrag=!1,this.displayDollhouseMetadata=!1,this.convertDeltaToLocal=(()=>{const e=new m.Vector3,t=new m.Vector3;return(i,o)=>{const s=o.x||0,a=o.y||0,r=i.phi()>(0,u.pu)(85)?n.B1.UP:n.B1.FORWARD,l=2*s*i.fovCorrectedFocalDistance(),h=2*a*i.fovCorrectedFocalDistance()/i.aspect();return e.copy(n.B1.RIGHT).applyQuaternion(i.rotation).setY(0).setLength(l),t.copy(r).applyQuaternion(i.rotation),e.add(t.setY(0).setLength(h)),e}})()}newControlsForViewport(e,t){const i=new E(t,this.poseConstrainer,(()=>this.computeOrbitPoint(t)),(()=>this.computeGrabPoint(t)),(e=>this.focusPointHelper(t,e)),(()=>this.viewmodeData.isExterior()),this.controlsData,this.messageBus);return i.setPhiLimits(this.getDefaultPhiLowerLimit(),this.getDefaultPhiUpperLimit(t),!1),i}async init(e,t){[this.visibleMeshBounds,this.commonControlsModule,this.inputIni,this.raycaster,this.renderer,this.settings,this.viewmodeData,this.viewportModule]=await Promise.all([t.getModuleBySymbol(s.UN),t.getModuleBySymbol(s.X7),t.getModuleBySymbol(s.mL),t.getModuleBySymbol(s.sA),t.getModuleBySymbol(s.M7),t.getModuleBySymbol(G.ZF),t.market.waitForData(j.X),t.getModuleBySymbol(s.Qm)]),this.settings.registerMenuButton({header:"Dollhouse",buttonName:"Toggle Orbit point display",callback:()=>{this.displayDollhouseMetadata=!this.displayDollhouseMetadata,this.displayDollhouseMetadata?this.createDebugObjects():this.removeDebugObjects()}}),this.messageBus=t.msgBus,this.poseConstrainer=new _(this.visibleMeshBounds.getVisibleBounds()),this.controlsData=new U,t.market.register(U,this.controlsData),this.bindings.push(this.visibleMeshBounds.onVisibleBoundsChanged((e=>{this.poseConstrainer.updateConstraints(e);for(const e of this.viewportControls.values())e.invalidateOrbitMetadata()})));const i=this.inputIni;this.commonControlsModule.addControls(c.N3.Dollhouse,this),this.commonControlsModule.addControls(c.N3.ExteriorSplat,this);const o=e=>{this.didDrag=!1;const t=this.getControlsForViewport(e.viewportId);t&&this.onDragBegin(t,e.buttons,e.position,e.device,e.ctrlKey)},n=e=>{const t=this.getControlsForViewport(e.viewportId);t&&(e.timeSinceLastMove<100&&this.didDrag&&(this.onDrag(t,e.delta,e.position),t.update(b.qD),t.stopAcceleration()),this.onDragEnd(t,e.delta,e.buttons,e.position))},h=e=>{this.didDrag=!0;const t=this.getControlsForViewport(e.viewportId);t&&(this.onDrag(t,e.delta,e.position),t.update(b.qD),t.stop())};this.bindings.push(i.registerHandler(a.s,(e=>{this.onScrollWheel(e)}))),this.bindings.push(i.registerHandler(r.SK,(e=>{const t=this.getControlsForViewport(e.viewportId);t&&(this.isTouchDrag(t,e.pointerId)||o(e))}))),this.bindings.push(i.registerHandler(r._w,(e=>{const t=this.getControlsForViewport(e.viewportId);t&&(this.isTouchDrag(t,e.pointerId)||n(e))}))),this.bindings.push(i.registerHandler(r.jF,(e=>{const t=this.getControlsForViewport(e.viewportId);t&&(this.isTouchDrag(t,e.pointerId)||h(e))}))),this.bindings.push(i.registerHandler(p.H,(e=>{const t=this.getControlsForViewport(e.viewportId);t&&t.rawPointerUpdate(e)}))),this.bindings.push(i.registerHandler(l.k,(e=>{e.state!==d.$.PRESSED&&this.onKey(e.key,e.state)})))}onUpdate(e){for(const t of this.viewportControls.values())t.isActive&&t.update(e);this.updateDebugObjects()}isTouchDrag(e,t){const i=e.touchGestureIds();return i[0]===t||i[1]===t}async setDollhouseVerticalLimits(e){await Promise.all(Array.from(this.viewportControls.values()).map((t=>t.setPhiLimits(void 0!==e.phiLowerLimitDegrees?e.phiLowerLimitDegrees*u.fy:this.getDefaultPhiLowerLimit(),void 0!==e.phiUpperLimitDegrees?e.phiUpperLimitDegrees*u.fy:this.getDefaultPhiUpperLimit(t.pose),void 0!==e.noTransition?!e.noTransition:t.isActive))))}getDefaultPhiUpperLimit(e){return this.viewmodeData.isFloorplanDisabled()?I.Xj:e.autoOrtho?b.DQ:b.vc}getDefaultPhiLowerLimit(){return this.viewmodeData.isDollhouseDisabled()?b.DQ:b.ol}onScrollWheel(e){const t=this.getControlsForViewport(e.viewportId);t&&this.zoom(t,e.delta.y)}zoom(e,t){0!==t&&(e.setZoomAcceleration(t),e.update(b.qD),e.setZoomAcceleration(0))}onDragBegin(e,t,i,s,n=!1){if(e.controlState===o.NONE){const i=T;if(s===L.o.MOUSE){const o=this.applyKeyboardModifier(t,n);e.controlState=i[o]}else e.controlState=o.PAN}const a=s===L.o.TOUCH?x.TOUCH:x.MOUSE;e.initMove(e.controlState,a,i)}onDrag(e,t,i){switch(e.setNdcPos(i),e.controlState){case o.ROTATE:e.setOrbitalAcceleration({x:-Math.PI*t.x,y:-Math.PI*t.y});break;case o.ZOOM:0!==t.y&&e.setZoomAcceleration(-t.y)}}onDragEnd(e,t,i,s){i&e.controlState||(e.controlState=o.NONE,e.endMove(s))}onKey(e,t){const i=this.getControlsForViewport(this.viewportModule.viewportManager.activeViewport.id);if(!i)return;const s=t===d.$.DOWN;let n=!1;switch(e){case h.D.LEFTARROW:case h.D.J:i.setOrbitalAcceleration({x:s?b.Yf:0},!0),i.initMove(o.ROTATE,x.KEYBOARD);break;case h.D.RIGHTARROW:case h.D.L:i.setOrbitalAcceleration({x:s?-b.Yf:0},!0),i.initMove(o.ROTATE,x.KEYBOARD);break;case h.D.UPARROW:case h.D.I:i.setOrbitalAcceleration({y:s?-b.Yf:0},!0),i.initMove(o.ROTATE,x.KEYBOARD);break;case h.D.DOWNARROW:case h.D.K:i.setOrbitalAcceleration({y:s?b.Yf:0},!0),i.initMove(o.ROTATE,x.KEYBOARD);break;case h.D.W:this.movementKeys.y=s?1:0,n=!0;break;case h.D.S:this.movementKeys.y=s?-1:0,n=!0;break;case h.D.D:this.movementKeys.x=s?1:0,n=!0;break;case h.D.A:this.movementKeys.x=s?-1:0,n=!0;break;case h.D.PLUSEQUALS:this.zoom(i,-b.Dw);break;case h.D.DASHUNDERSCORE:this.zoom(i,b.Dw)}if(n){const e=this.convertDeltaToLocal(i.pose,this.movementKeys).setLength(b.bI);i.setPanAcceleration({x:e.x,y:e.z}),i.initMove(o.PAN,x.KEYBOARD)}}computeGrabPoint(e){const t=this.inputIni.getCurrentPointerRay();return this.focusPointHelper(e,t,!0)}computeOrbitPoint(e){const t=new m.Ray(e.position.clone(),e.forward().clone());return this.focusPointHelper(e,t)}focusPointHelper(e,t,i=!1){const o=()=>this.visibleMeshBounds.computeFocusPoint(t,(e=>this.poseConstrainer.containsPoint(e)));if(e.autoOrtho&&!i)return o();{const e=this.raycaster.picking.pick(t.origin,t.direction);return e?e.point.clone():o()}}applyKeyboardModifier(e,t){let i=e;return t&&e===g.O.PRIMARY&&(i=g.O.SECONDARY),i}createDebugObjects(){if(null==this.debugPlane){const e=new m.PlaneHelper(new m.Plane,100,16711680);e.material.depthTest=!1,this.debugPlane=e}if(null==this.debugOrbit){const e=new m.SphereGeometry(.1,2,2),t=new m.MeshBasicMaterial({color:16711680,side:m.DoubleSide,depthTest:!1}),i=new m.Mesh(e,t);this.debugOrbit=i}if(null==this.debugZoom){const e=new m.SphereGeometry(.2,2,2),t=new m.MeshBasicMaterial({color:65280,side:m.DoubleSide,depthTest:!1}),i=new m.Mesh(e,t);this.debugZoom=i}if(null==this.debugVisibleBounds){const e=new m.Box3Helper(this.visibleMeshBounds.getVisibleBounds(),new m.Color(0,0,0));this.debugVisibleBounds=e}if(null==this.debugSceneBounds){const e=new m.Box3Helper(this.visibleMeshBounds.getFullBounds(),new m.Color(0,0,1));this.debugSceneBounds=e}this.renderer.getScene().add(this.debugPlane,this.debugOrbit,this.debugZoom,this.debugVisibleBounds,this.debugSceneBounds)}removeDebugObjects(){null!=this.debugPlane&&(this.renderer.getScene().remove(this.debugPlane),this.debugPlane=null),null!=this.debugOrbit&&(this.renderer.getScene().remove(this.debugOrbit),this.debugOrbit=null),null!=this.debugZoom&&(this.renderer.getScene().remove(this.debugZoom),this.debugZoom=null),null!=this.debugVisibleBounds&&(this.renderer.getScene().remove(this.debugVisibleBounds),this.debugVisibleBounds=null),null!=this.debugSceneBounds&&(this.renderer.getScene().remove(this.debugSceneBounds),this.debugSceneBounds=null)}updateDebugObjects(){if(this.displayDollhouseMetadata){const e=this.viewportControls.get(this.viewportModule.viewportManager.activeViewport.id);if(!e)return;const{plane:t,orbitPt:i,zoomDir:o}=e.getDebugState();if(null!=this.debugPlane&&(this.debugPlane.plane=t,this.debugPlane.updateMatrixWorld(!0)),null!=this.debugOrbit&&this.debugOrbit.position.copy(i),null!=this.debugZoom){const t=e.pose.fovCorrectedPosition().clone().addScaledVector(o,e.pose.fovCorrectedFocalDistance());this.debugZoom.position.copy(t)}null!=this.debugVisibleBounds&&this.debugVisibleBounds.box.copy(this.visibleMeshBounds.getVisibleBounds()),null!=this.debugSceneBounds&&this.debugSceneBounds.box.copy(this.visibleMeshBounds.getFullBounds())}}}},43440:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>D});var o=i(77201),s=i(71687),n=i(81530),a=i(47737),r=i(98585),l=i(20968),h=i(97800),d=i(68909);class c{constructor(){this.list=[]}insort(e){const t=this.binarySearch(e);let i=t.index;if(!t.success)for(;this.compare(e,this.list[i])>=0&&i<this.list.length;)i++;for(let e=this.list.length;e>i;e--)this.list[e]=this.list[e-1];this.list[i]=e}removeIndex(e){if(e>this.list.length)throw Error("OrderList.removeIndex() -> Invalid index: "+e);this.list.splice(e,1)}getElement(e){if(e>=0&&e<this.list.length)return this.list[e];throw new Error("OrderList.getElement() -> Invalid index: "+e)}get length(){return this.list.length}find(e){const t=this.binarySearch(e);return t.success?t.index:-1}compare(e,t){return void 0===t?1:"number"==typeof e&&"number"==typeof t?e===t?0:e<t?-1:1:e.compare(t)}binarySearch(e){let t,i=0,o=this.list.length-1,s=-1,n=0;for(;i<=o;){if(s=Math.floor((i+o)/2),t=this.list[s],n=this.compare(e,t),0===n)return{success:!0,index:s};n<0?o=s-1:i=s+1}return{success:!1,index:s}}}var u=i(81662);class m extends o.vm{constructor(e={}){super(),this.name="",this.sourceViewIds=new Set,this.center=new d.Vector3,this.centerOfMass=new d.Vector3,this.size=new d.Vector3,this.sweepHeights=new c,this.sweepFloorHeights=new c,this._boundingBox=new o.Lj(new d.Box3),this._groundPlane=new d.Plane,this._groundPt=new d.Vector3,this.medianSweepHeight=()=>this.sweepHeights.length>0?this.sweepHeights.getElement(Math.floor(this.sweepHeights.length/2)):this.center.y,this.minSweepFloorHeight=()=>this.sweepFloorHeights.length>0?this.sweepFloorHeights.getElement(0):this.boundingBox.min.y,Object.assign(this,e)}get boundingBox(){return this._boundingBox.value}set boundingBox(e){this.setBounds(e)}setBounds(e){this._boundingBox.value.copy(e),this._boundingBox.value.getSize(this.size),this._boundingBox.value.getCenter(this.center),this._boundingBox.setDirty(!0)}setCenterOfMass(e){this.centerOfMass.copy(e)}onBoundsChanged(e){return this._boundingBox.onChanged(e)}addSweep(e,t){this.sweepHeights.insort(e.y),this.sweepFloorHeights.insort(t.y)}medianSweepFloorHeight(){return this.sweepFloorHeights.length>0?this.sweepFloorHeights.getElement(Math.floor(this.sweepFloorHeights.length/2)):this.bottom}get bottom(){return this.minSweepFloorHeight()}get groundPlane(){return this._groundPt.set(0,this.bottom,0),this._groundPlane.setFromNormalAndCoplanarPoint(u.B1.UP,this._groundPt),this._groundPlane}get top(){return this.sweepFloorHeights.length>0?this.sweepFloorHeights.getElement(this.sweepFloorHeights.length-1):this.boundingBox.max.y}deepCopy(){return(0,h.A4)({id:this.id,meshGroup:this.meshGroup,index:this.index,name:this.name,center:this.center,boundingBox:this.boundingBox,size:this.size,medianSweepHeight:this.medianSweepHeight(),bottom:this.bottom})}}const p=new h.Vy("mds-floor-deserializer");class g{deserialize(e,t){var i;if(!e||!this.validate(e))return p.debug("Deserialized invalid floor data from MDS",e),null;const o=e.label||"",s=e.dimensions||{areaFloor:-1},{areaFloor:n}=s,a=((null===(i=e.layer)||void 0===i?void 0:i.views)||[]).filter((e=>!e.view.type.startsWith("matterport.model.composite"))).map((e=>e.view.id));return new m({id:e.id,index:e.sequence,meshGroup:e.meshId,name:o,areaFloor:n||-1,sourceViewIds:new Set(a)})}validate(e){return["id","sequence","meshId"].every((t=>t in e))}}class v{serialize(e){return{label:e.name}}}class f extends l.g{constructor(){super(...arguments),this.deserializer=new g,this.prefetchKey="data.model.floors"}async read(e={}){var t;const i={modelId:null!==(t=null==e?void 0:e.modelId)&&void 0!==t?t:this.getBaseViewId()};return this.query(r.GetFloors,i,e).then((e=>{var t,i;const o=null===(i=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.model)||void 0===i?void 0:i.floors;if(!o||!Array.isArray(o))return null;return o.reduce(((e,t)=>{const i=this.deserializer.deserialize(t,this.context);return i&&(e[t.id]=i),e}),{})}))}async update(e,t){const i=this.getBaseViewId(),o=(new v).serialize(t);if(!o)throw new Error("Could not update Floor");return this.mutate(r.PatchFloor,{modelId:i,floorId:e,data:o})}}var w=i(79875),y=i(58229);class D extends o.nV{constructor(){super(...arguments),this.name="floors"}async init(e,t){const{readonly:i,baseUrl:r}=e;this.engine=t;const{mdsContext:l}=await t.market.waitForData(a.P);this.store=new f({context:l,readonly:i,baseUrl:r});const h=await this.store.read();if(this.data=new y.q(h||{}),t.market.register(y.q,this.data),!1===i){const e=this.data.getCollection();this.monitor=new o.Fy(e,{aggregationType:o.DF.NextFrame,shallow:!0},t),this.monitor.onChanged((()=>this.engine.commandBinder.issueCommand(new n.F({dataTypes:[o.pe.FLOORS]}))));const[i]=await Promise.all([t.getModuleBySymbol(s.T9)]);this.bindings.push(i.onSave((()=>this.save()),{dataType:o.pe.FLOORS}))}}onUpdate(){}async save(){const e=this.monitor.getDiffRecord();this.monitor.clearDiffRecord();const t=[];for(const i of e){const e=i.index;if(!e)throw new w.v(`Invalid floor '${i.index}'`);i.action===o.Xw.updated&&t.push(this.store.update(e,i.diff))}return Promise.all(t)}}},59805:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>J});var o=i(77201),s=i(97800),n=i(71687),a=i(60043),r=i(81544),l=i(71397),h=i(28337),d=i(12837),c=i(99583),u=i(10459),m=i(83075),p=i(51313),g=i(47004),v=i(98309),f=i(5243),w=i(2993),y=i(21875),D=i(58229),b=i(3249),S=i(52885),M=i(47299);class T{constructor(e,t,i,o,s,n,a,r,l){this.getAngleModifier=e,this.floorsViewData=t,this.meshQuery=i,this.viewmodeData=o,this.raycasterData=s,this.cameraData=n,this.applicationData=a,this.touchDevice=r,this.meshModule=l}activate(){}init(){}dispose(){}deactivate(){}beforeRender(){const e=this.floorsViewData.nearestFloor,t=this.floorsViewData.transition.progress.active,i=!(!e||this.viewmodeData.isInside()),n=this.meshModule.getMeshGroupVisuals(this.floorsViewData.sourceViewId);if(!n)return void s.Vy.for(this).debug("No current mesh group visuals found");const a=M.u7.FADE_OPAQUE;let r=a,l=a;const h=this.getAngleModifier(),d=this.floorsViewData.onlyShowActiveFloor.value?0:1;n.globalOpacityModifier.value=n.allFloorsVisibleInOrtho.value||this.floorsViewData.isInAllFloorsMode||this.applicationData.application!==o.lg.SHOWCASE?1:this.cameraData.pose.pitchFactor(),i&&(this.viewmodeData.isDollhouse()||this.viewmodeData.isOrthographic()?(r=a*h*d*M.u7.FADE_IN_VALUE,l=r*M.u7.FADE_BELOW_MULT+M.u7.FADE_BELOW_START):(r=M.u7.FADE_ABOVE,l=M.u7.FADE_BELOW));const{floorOpacity:c}=n;for(const e of c.keys){const i=this.floorsViewData.floors.getFloorByMeshGroup(Number(e),this.floorsViewData.sourceViewId);let o=a;const s=this.isBelowSelectedFloor(i)?l:r;let n=(0,b.qE)(s+M.u7.FADE_IN_HOVER_BOOST_VALUE,0,1);this.floorsViewData.roomSelectModeActive&&(n=s),o=this.isHoveredFloor(null==i?void 0:i.id)&&!t&&s>0?n:s,o=this.isFloorTransitioningOut(i)?s:o;const h=this.isSelectedFloor(null==i?void 0:i.id)||this.isFloorTransitioningIn(i);if(o=h?a:o,o=this.clampForViewmodeTransitions(o),h)c.set(e,o);else{const t=c.get(e);if(null==t)c.set(e,o);else if(t!==o){let i=(0,S.C)(t,o,.2);Math.abs(o-i)<1e-4&&(i=o),c.set(e,i)}}}}render(){}clampForViewmodeTransitions(e){var t,i,o;if(this.viewmodeData.currentMode===w.N3.Transition){const{to:s}=this.viewmodeData.transition;if(s===w.N3.Panorama){const s=null!==(o=null===(i=null===(t=this.meshModule.getMeshGroupVisuals(this.floorsViewData.sourceViewId))||void 0===t?void 0:t.meshTextureOpacity)||void 0===i?void 0:i.value)&&void 0!==o?o:0;return Math.max(1-s,e)}}return e}isHoveredFloor(e){if(void 0!==e&&this.raycasterData.hit&&(this.viewmodeData.isDollhouse()||this.viewmodeData.isOrthographic())&&!this.touchDevice&&this.floorsViewData.isNavigable(e)){const t=this.raycasterData.hit.object;return e===this.meshQuery.floorIdFromObject(t)}return!1}isSelectedFloor(e){const t=this.floorsViewData.nearestFloor;return!t||!(!e||t.id!==e)}isBelowSelectedFloor(e){const t=this.floorsViewData.nearestFloor;return!!(e&&t&&t.index>e.index)}isFloorTransitioningIn(e){return!(!e||!this.floorsViewData.transition.progress.active||this.floorsViewData.transition.to&&this.floorsViewData.transition.to!==e.id)}isFloorTransitioningOut(e){return!(!e||!this.floorsViewData.transition.progress.active||this.floorsViewData.transition.from&&this.floorsViewData.transition.from!==e.id&&this.floorsViewData.transition.to===e.id)}}var x=i(89928),C=i(13893),k=i(9997),P=i(68909),F=i(81662),V=i(40397),O=i(78229),I=i(96659),B=i(79875),A=i(63362),N=i(72773),E=i(19968);const R=(e,t)=>{const i=t.singleFloor;return i&&!e?i.id:e};class _{constructor(e,t,i,s,n,a,r,l,h,d){this.engine=e,this.floorsData=t,this.floorsViewData=i,this.sweepData=s,this.sweepDataState=n,this.cameraData=a,this.cameraController=r,this.viewmodeData=l,this.updateCurrentFloor=h,this.getMeshDataFor=d,this.MOVE_TO_BLACK_TRANSITION_TIME=2e3,this.moveFloorUp=(e=!1,t)=>{const i=this.floorsViewData.currentFloorId,o=this.floorsViewData.getNavigableFloorIds(),s=i?o.indexOf(i):-1;let n=o[s+1];return void 0===n&&(n=this.viewmodeData.isInside()?o[o.length-1]:o[0]),this.moveToFloor(n,e,t)},this.moveFloorDown=(e=!1,t)=>{const i=this.floorsViewData.currentFloorId,o=this.floorsViewData.getNavigableFloorIds(),s=i?o.indexOf(i):o.length;let n=o[s-1];return void 0===n&&(n=this.viewmodeData.isInside()?o[0]:o[o.length-1]),this.moveToFloor(n,e,t)},this.moveToFloor=(e,t=!1,i,s)=>{const n=this.floorsViewData.currentFloorId,a=R(e,this.floorsViewData),r=n===a,l=a?this.floorsViewData.floors.getFloor(a):null;if(r||!this.floorsViewData.floorsEnabled)return this.updateCurrentFloor(a),o.iB.resolve();if(l&&!this.canMoveToFloor(l,t))return o.iB.reject(new B.v("Invalid floor ID"));this.engine.broadcast(new x.G(n,a)),void 0===i&&(i=N.t$);const h=new o.iB;let d;this.floorsViewData.transitionToFloor(n,a,i,h.nativePromise()),this.floorsViewData.commit();let c,u=s;if(this.viewmodeData.isInside()){const e=e=>e=>this.floorsViewData.isCurrentOrAllFloors(e.floorId),t=!!a?O.Eo:e,i=[(0,O.Zx)(),(0,O.Ol)(),t(a)],o=[(0,I.cv)(s||this.cameraData.pose.position)],n=this.sweepData.sortByScore(i,o).shift();n&&(u=n.sweep.position,d=n.sweep.id)}else null!==a&&this.engine.commandBinder.issueCommand(new A.HP);c=t?Promise.resolve():this.getCameraTransition(a,i,d,u);const m=this,p=o.iB.all([h,c]);return this.engine.startGenerator((function*(){let e=Date.now();for(;m.floorsViewData.transition.progress.active;){yield new o.oN;const t=Date.now(),i=t-e;m.floorsViewData.transition.progress.tick(i),m.floorsViewData.commit(),e=t}m.updateCurrentFloor(m.floorsViewData.transition.to),h.resolve()})),p}}moveToFloorIndex(e,t=!1,i,s){let n=null;if(e!==N.Zu){const t=this.floorsViewData.floors.getFloorAtIndex(e);if(!t)return o.iB.reject(new B.v(`Invalid floor index ${e}`));n=t.id}return this.moveToFloor(n,t,i,s)}canMoveToFloor(e,t=!1){if(!e)return!1;const i=this.floorsViewData.transition.progress.active,o=this.cameraData.canTransition()||t,s=e.index<=this.floorsViewData.totalFloors-1,n=e.index>=-1;return!i&&o&&s&&n}getCameraTransition(e,t,i,o){if(this.viewmodeData.currentMode===w.N3.Dollhouse&&!(0,E.aY)(this.cameraData.pose.pitchFactor())){const i=this.getPoseForFloor(e,o);return this.cameraController.moveTo({transitionType:C.fl.Interpolate,pose:i.pose,focalDistance:i.focalDistance,transitionTime:t,autoOrtho:this.cameraData.pose.autoOrtho}).nativePromise()}return this.viewmodeData.isInside()&&i?this.engine.commandBinder.issueCommand(new k.aj({transition:C.fl.MoveToBlack,sweep:i,transitionTime:this.MOVE_TO_BLACK_TRANSITION_TIME,cameraData:this.cameraData,sweepDataState:this.sweepDataState})):Promise.resolve()}getPoseForFloor(e,t){const i=this.cameraData.pose.fovCorrectedPosition(),o=this.cameraData.pose.rotation,s=e?this.floorsData.getFloor(e):null,n=this.getMeshDataFor(this.floorsViewData.sourceViewId),a=(null==n?void 0:n.meshCenter)||new P.Vector3,r=s?s.medianSweepHeight():a.y,l=s?s.center:a;l.setY(r);const h=F.B1.FORWARD.clone().applyQuaternion(o),d=i.clone();let c,u;if(t){const e=i.clone().addScaledVector(h,this.cameraData.pose.fovCorrectedFocalDistance()),o=(new P.Vector3).set(0,i.y,0),s=(new P.Vector3).set(0,e.y,0),n=o.distanceTo(s);d.setY(r+n);const a=e.clone().setY(t.y);u=a.distanceTo(d),this.viewmodeData.isDollhouse()&&(c=(0,V.kf)(d,a))}else{const e=(s?s.size.y:L)/2+L*-h.y;d.setY(r+e),u=d.distanceTo(l)}return{focalDistance:u,pose:{position:d,rotation:c}}}}const L=8;var z=i(39209),U=i(94814),G=i(86866),j=i(53172);class H{constructor(e,t,i){this.floorsViewData=e,this.viewmodeData=t,this.pose=i,this.vectors={lookDir:new P.Vector3,flattenedLookDir:new P.Vector3},this.getAngleModifier=this.getAngleModifier.bind(this)}update(){const e=this.getAngleModifier(),t=1===this.floorsViewData.totalFloors,i=!!this.floorsViewData.nearestFloor,o=!this.viewmodeData.isInside()&&!this.viewmodeData.transitionActive();this.floorsViewData.roomSelectModeActive=o&&(t||i&&e<1||this.viewmodeData.isFloorplan()),this.floorsViewData.floorSelectModeActive=o&&1===e&&!t,this.floorsViewData.showFloorSelection=!this.viewmodeData.transitionActive()&&(this.viewmodeData.isDollhouse()||this.viewmodeData.isFloorplan())&&i&&!t,this.floorsViewData.floorSelectable=this.viewmodeData.isDollhouse()||this.viewmodeData.isOrthographic()}getAngleModifier(){const e=this.vectors.lookDir.copy(F.B1.FORWARD).applyQuaternion(this.pose.rotation),t=this.vectors.flattenedLookDir.copy(e).setY(0),i=e.angleTo(t)*j.tm,o=M.u7.FADE_IN_START_ANGLE,s=M.u7.FADE_IN_END_ANGLE,n=1-(0,G.m9)(i,o,s,0,1);return(0,U.Do)(n,0,1,1)}}var Q=i(23184),$=i(35699),W=i(77510),q=i(25316),K=i(80303),Z=i(1197),Y=i(56208),X=i(47737);class J extends o.nV{constructor(){super(),this.name="floors-viewdata",this.floorsViewDatas=new o.Es,this.dataHelpers=new Map,this.currentFloors=new o.Es,this.floorHoverBindings=[],this.onEndMoveToSweepMessage=e=>{const t=this.sweepData.getSweep(e.toSweep);(0,w.nI)(this.viewmodeData.closestMode)&&t&&this.updateCurrentFloor(t.floorId)},this.applicationChanged=()=>{for(const e of this.floorsViewDatas.values)e.updateViewData()},this.updateCurrentFloor=(e,t)=>{if(!this.floorChangesAllowed())return;if(e&&!t){const i=this.floorsData.getFloor(e);t=this.floorsViewDatas.values.find((e=>i.sourceViewIds.has(e.sourceViewId)))}if(!t)return;const i=R(e,t);t.currentFloorId!==i&&(t.transitionToFloorInstant(i),this.engine.broadcast(new p.P(i,t.getFloorName(i)))),this.currentFloors.set(t.id,e?this.floorsData.getFloor(e):null)},this.updateFloorSelectMode=()=>{for(const e of this.dataHelpers.values())e.floorsSelectModeHelper.update()},this.floorSelectFeatureEnabledCheck=()=>{const e=this.settingsData.tryGetSetting(K.p,!0),t=this.settingsData.tryGetSetting(Y.Q$.FloorSelect,!0),i=this.applicationData.application===o.lg.WORKSHOP;this.toggleFloors(i||e&&t)}}async init(e,t){var i,a,r;this.engine=t,this.config=e,[this.floorsData,this.settingsData,this.applicationData,this.sweepData,this.viewmodeData,this.cameraData,this.input,this.raycasterData]=await Promise.all([t.market.waitForData(D.q),t.market.waitForData(q.o),t.market.waitForData(o.zH),t.market.waitForData(d.A),t.market.waitForData(c.X),t.market.waitForData(u.M),t.getModuleBySymbol(n.mL),t.market.waitForData(f.$)]);const[l,h,m,p,b,S]=await Promise.all([t.getModuleBySymbol(n.jh),t.getModuleBySymbol(n.GR),t.getModuleBySymbol(n.gS),t.getModuleBySymbol(n.Qm),t.getModuleBySymbol(n.PM),t.market.waitForData(X.P)]),M={floorChangesEnabled:()=>this.floorChangesAllowed()},{switchableData:x,dataMap:C,bindings:k}=p.manageDataForViewports((e=>{const i=new z.X(this.floorsData,this.viewmodeData,this.sweepData,this.applicationData,m.t.bind(m),M);i.sourceViewId=S.getBaseModelId();const o=l.getCameraDataForViewport(e.id),n=this.sweepData.getStateForViewport(e.id),a=new _(t,this.floorsData,i,this.sweepData,n,o,l.getCameraControllerForViewport(e.id),this.viewmodeData,(e=>this.updateCurrentFloor(e,i)),(e=>{var t;return(null===(t=h.getMeshDetails(e))||void 0===t?void 0:t.meshData)||null})),r=new H(i,this.viewmodeData,o.pose),d=new T(r.getAngleModifier,i,b,this.viewmodeData,this.raycasterData,o,this.applicationData,(0,s.C8)(),h);return t.addComponent(this,d),this.dataHelpers.set(i.id,{floorNavigation:a,floorsSelectModeHelper:r,floorsRenderer:d}),i}));if(this._floorsViewData=x,this.floorsViewDatas=C,this.bindings.push(...k),this.bindings.push(C.onElementChanged({onRemoved:e=>{const i=this.dataHelpers.get(e.id);if(!i)throw new Error("FloorsViewData: No state for viewport!");t.removeComponent(this,i.floorsRenderer),this.dataHelpers.delete(e.id)}})),t.market.register(z.X,this.floorsViewData),this.floorSelectFeatureEnabledCheck(),this.floorChangesAllowed()){const e=null===(i=this.config.startingFloorsVisibility)||void 0===i?void 0:i.lastIndexOf(1),t=null===(a=this.floorsData.getFloorAtIndex(e))||void 0===a?void 0:a.id,o=null===(r=this.sweepData.currentSweepObject)||void 0===r?void 0:r.floorId,n=o||t||null;(o||t)&&(s.Vy.for(this).debug(`Set initial floor to ${n} from current pose`),this.updateCurrentFloor(n))}this.floorChangesAllowed()&&this.registerFloorHoverCursorEffect(),this.bindings.push(this.registerKeys(),t.subscribe(o.E5,this.applicationChanged),this.floorsData.onChanged(this.floorsViewData.updateViewData),t.subscribe(g.A,this.onEndMoveToSweepMessage),t.subscribe(v.A,function(e,t,i){let s=!0;return n=>{const a=e.tryGetData(y.R);if(!a||a&&a.isTourActive())return;(0,w.nI)(n.toMode)&&i.phase===o.Jj.PLAYING&&(s=null!==t.floorsViewData.currentFloorId);const r=(0,w.nI)(n.fromMode),l=n.toMode===w.N3.Floorplan,h=n.toMode===w.N3.Dollhouse,d=n.toMode===w.N3.ExteriorSplat;if(!r||!h&&!l)return;let c=null;!s&&!l||d||(c=t.floorsViewData.currentFloorId),t.moveToFloor(c,{suppressCameraMovement:!0,transitionTime:0})}}(t.market,this,this.applicationData)),t.subscribe(Z.A,this.updateFloorSelectMode),this.cameraData.pose.onChanged(this.updateFloorSelectMode),this.floorsViewData.onChanged(this.updateFloorSelectMode),this.settingsData.onSettingChanged(K.p,this.floorSelectFeatureEnabledCheck),this.settingsData.onSettingChanged(Y.Q$.FloorSelect,this.floorSelectFeatureEnabledCheck),this.applicationData.onPropertyChanged("application",this.floorSelectFeatureEnabledCheck)),this.updateFloorSelectMode(),this.sweepData.currentSweepObject&&this.updateCurrentFloor(this.sweepData.currentSweepObject.floorId)}get floorsViewData(){return this._floorsViewData}onUpdate(){}async moveToFloor(e,t={}){await this.getHelperForViewport(t.viewportId).floorNavigation.moveToFloor(e,!!t.suppressCameraMovement,t.transitionTime,t.focusPoint).nativePromise()}async moveToFloorIndex(e,t={}){await this.getHelperForViewport(t.viewportId).floorNavigation.moveToFloorIndex(e,t.suppressCameraMovement,t.transitionTime,t.focusPoint)}async showAllFloors(e=!0,t){await this.moveToFloor(null,{suppressCameraMovement:!e,viewportId:t})}async enableAllFloorsOption(){for(const e of this.floorsViewDatas.values)e.showAllFloorsOption=!0,e.commit()}async disableAllFloorsOption(){for(const e of this.floorsViewDatas.values){if(e.currentFloorIndex===N.Zu){const t=this.dataHelpers.get(e.id);if(!t)throw new Error("No helper for floorsViewData!");await t.floorNavigation.moveToFloorIndex(0,!0)}e.showAllFloorsOption=!1,e.commit()}}async disableFloorHoverCursor(){for(const e of this.floorsViewDatas.values)e.floorSelectHoverEnabled=!0,e.commit()}async enableFloorHoverCursor(){for(const e of this.floorsViewDatas.values)e.floorSelectHoverEnabled=!1,e.commit()}toggleFloors(e){e||null===this.floorsViewData.currentFloorId||this.updateCurrentFloor(null),this.config.allowFloorChanges=e,this.updateFloorSelectMode(),this.floorChangesAllowed()?this.registerFloorHoverCursorEffect():this.clearFloorHoverBindings()}registerKeys(){return this.input.registerHandler(a.k,(async e=>{if(!this.cameraData.canTransition())return;const t=this.getHelperForViewport(),i=e.modifiers.shiftKey;if(e.state===h.$.PRESSED)switch(e.key){case l.D.UPARROW:i&&t.floorNavigation.moveFloorUp();break;case l.D.DOWNARROW:i&&t.floorNavigation.moveFloorDown();break;case l.D.R:t.floorNavigation.moveFloorUp();break;case l.D.F:t.floorNavigation.moveFloorDown();break;case l.D.Y:t.floorNavigation.moveToFloor(null)}}))}registerFloorHoverCursorEffect(){if(0===this.floorHoverBindings.length){const e=Q.f.is((e=>m.m.isVisibleRoomMesh(e)&&this.floorsViewData.floorSelectable)),t=new o.PF(this.input.registerMeshHandler(r.L,e,(e=>{this.engine.commandBinder.issueCommand(new $.X(W.b.FINGER))})),this.input.registerMeshHandler(r.q,e,(e=>{this.engine.commandBinder.issueCommand(new $.X(W.b.DEFAULT))})));t.cancel();const i=(()=>{let e=!1;return()=>{const i=this.floorsViewData.floorSelectHoverEnabled;i!==e&&(e=i,e?t.renew():(t.cancel(),this.engine.commandBinder.issueCommand(new $.X(W.b.DEFAULT))))}})();i(),this.floorHoverBindings.push(this.viewmodeData.onChanged(i),this.floorsViewData.onFloorSelectModeChange(i),this.floorsViewData.makeFloorChangeSubscription(i),t)}}clearFloorHoverBindings(){for(const e of this.floorHoverBindings)e.cancel();this.floorHoverBindings=[]}floorChangesAllowed(){return!this.floorsData.isMultifloor()||this.config.allowFloorChanges}dispose(e){super.dispose(e),this.clearFloorHoverBindings()}getViewDataForViewport(e){if(void 0===e)return this._floorsViewData;const t=this.floorsViewDatas.get(e);if(!t)throw new Error("No FloorsViewData for viewport");return t}getHelperForViewport(e){const t=e?this.floorsViewDatas.get(e):this.floorsViewData,i=this.dataHelpers.get(t.id);if(!i)throw new Error("No floor navigation for viewport");return i}}},71188:(e,t,i)=>{"use strict";i.d(t,{w:()=>s});var o=i(12103);function s(e){return e.width<=o._8}},94790:(e,t,i)=>{"use strict";i.d(t,{Qm:()=>r,SK:()=>s,Ve:()=>l,_w:()=>a,jF:()=>n});var o=i(92475);class s extends o.E{constructor(e,t,i,o,s,n=0){super(e),this.position=t,this.buttons=i,this.device=o,this.ctrlKey=s,this.pointerId=n}}class n extends o.E{constructor(e,t,i,o,s,n,a=0){super(e),this.ctrlKey=!1,this.position=t,this.clientPosition=s,this.delta=i,this.buttons=o,this.device=n,this.pointerId=a}}class a extends o.E{constructor(e,t,i,o,s,n,a,r=0){super(e),this.ctrlKey=!1,this.position=t,this.delta=i,this.buttons=o,this.timeSinceLastMove=s,this.fullDelta=n,this.device=a,this.pointerId=r}}class r extends o.E{constructor(e,t,i){super(e),this.position=t,this.pointer=i}}class l extends o.E{constructor(e,t,i,o,s){super(e),this.position=t,this.startPosition=i,this.fullDelta=o,this.pointer=s}}},60043:(e,t,i)=>{"use strict";i.d(t,{k:()=>s});var o=i(49586);class s extends o.T{constructor(e,t,i){super(),this.key=e,this.state=t,this.modifiers=i}}},90834:(e,t,i)=>{"use strict";i.d(t,{O:()=>n});var o=i(77201),s=i(44351);class n extends o.B_{constructor(){super(...arguments),this.name="interaction",this._source=n.defaultSource,this._mode=n.defaultMode}static get defaultMode(){return s.o.Desktop}static get defaultSource(){return s.m.None}get mode(){return this._mode}get source(){return this._source}updateSource(e){this._source=e}updateMode(e){this._mode=e}hasController(e=this.mode){return e===s.o.VrWithController||e===s.o.VrWithTrackedController}isVR(e=this.mode){return e===s.o.VrOrientOnly||e===s.o.VrWithTrackedController||e===s.o.VrWithController||e===s.o.VrTransientPointer||-1!==e.indexOf(s.o.VrUnknown)}isMobile(e=this.mode){return e===s.o.Mobile}}},38208:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>u});var o=i(77201),s=i(71687),n=i(78079),a=i(2998),r=i(60043),l=i(90834),h=i(44351),d=i(72354),c=i(97800);class u extends o.nV{constructor(){super(...arguments),this.name="interactionmode",this.onPointerButtonEvent=e=>{let t=this.data.source;switch(e.device){case a.o.TOUCH:t=h.m.Touch;break;case a.o.MOUSE:t=h.m.Mouse;break;case a.o.PEN:t=h.m.Pen;break;case a.o.GAMEPAD:this.renderer.xr.enabled&&this.renderer.xr.isPresenting&&(t=h.m.XRController);break;default:c.Vy.for(this).debug("source:",e.device,e)}this.updateSource(t)},this.onKeyEvent=()=>{this.updateSource(h.m.Key)}}async init(e,t){this.engine=t,this.data=new l.O,this.mobileBrowser=(0,c.Fr)();const i=await t.getModuleBySymbol(s.M7);this.renderer=i.threeRenderer,this.updateMode(this.getInteractionMode(),this.data.mode),this.engine.market.register(l.O,this.data),t.getModuleBySymbol(s.mL).then((e=>{this.bindings.push(e.registerHandler(n.CD,this.onPointerButtonEvent),e.registerHandler(r.k,this.onKeyEvent))}))}onUpdate(e){const t=this.getInteractionMode();this.updateMode(t,this.data.mode)}getInteractionMode(){if(this.renderer.xr.enabled&&this.renderer.xr.isPresenting){let e=h.o.VrUnknown+"unknown",t=!1;const i=this.renderer.xr.getSession();if(null!==i&&i.inputSources.length>0)for(const o of i.inputSources)switch(o.targetRayMode){case"gaze":case"screen":e=h.o.VrOrientOnly,t=!0;break;case"tracked-pointer":e=h.o.VrWithTrackedController,t=!0;break;case"transient-pointer":e=h.o.VrTransientPointer,t=!0;break;default:t||"string"!=typeof o.targetRayMode||(e=h.o.VrUnknown+o.targetRayMode)}return e}return this.mobileBrowser?h.o.Mobile:h.o.Desktop}updateMode(e,t){e!==this.data.mode&&(this.data.updateMode(e),this.data.commit(),this.engine.broadcast(new d.b(this.data.mode,t)))}updateSource(e){e!==this.data.source&&(this.data.updateSource(e),this.data.commit(),this.engine.broadcast(new d.J(this.data.source)))}}},65051:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>c});var o=i(77201),s=i(97800),n=i(71687),a=i(58229),r=i(12837),l=i(39118),h=i(24790),d=i(47737);class c extends o.nV{constructor(){super(...arguments),this.name="mesh-api-data-fixups"}async init(e,t){const{market:i}=t;[this.floorData,this.sweepData,this.modelMeshModule,this.meshQuery,this.analytics,this.layersData]=await Promise.all([i.waitForData(a.q),i.waitForData(r.A),t.getModuleBySymbol(n.GR),t.getModuleBySymbol(n.PM),t.getModuleBySymbol(n.aF),i.waitForData(d.P)]),await this.modelMeshModule.firstMeshLoadPromise,this.assignSweepToFloors(),this.assignBoundingBoxesToFloors(),this.assignMissingSweepFloors(),this.registerRoomAssociationSource(t),this.sweepData.getCollectionUnfiltered().onElementsChanged((async e=>{(e.added||e.updated)&&(await this.modelMeshModule.getMeshLoadPromise(this.layersData.currentViewId),this.assignMissingSweepFloors(e.added||e.updated,!1))}))}async assignBoundingBoxesToFloors(){const e=await this.modelMeshModule.getMeshLoadPromise(this.layersData.currentViewId);if(e&&e.length){const t=e[0].meshData.meshGroups.floors;this.floorData.iterate(((e,i)=>{const o=t.get(e.meshGroup);o&&(e.setBounds(o.boundingBox),e.setCenterOfMass(o.centerOfMass))})),this.floorData.commit()}}assignMissingSweepFloors(e,t=!0){let i=0;try{this.sweepData.getCollectionUnfiltered().atomic((()=>{var t;const o=null!=e?e:this.sweepData.getCollectionUnfiltered().entries();for(const[,e]of o)if(!e.isUnplaced()){let o;if(null===e.floorId||!this.floorData.hasFloor(e.floorId)){const n=this.meshQuery.floorIdFromObject(null===(t=this.meshQuery.nearestMeshInfo(e.position))||void 0===t?void 0:t.object);n&&this.floorData.hasFloor(n)&&(o=this.floorData.getFloor(n)),(null==o?void 0:o.id)&&o.id!==e.floorId&&(s.Vy.for(this).debug(`Setting ${e.alignmentType} sweep ${e.id} from floor ${e.floorId} to ${o.id}`),e.floorId=o.id,e.commit(),i++)}}}))}finally{0!==i&&t&&this.analytics.track("mesh_api_data_fixup_sweeps_assigned",{missing_floor_count:i})}}assignSweepToFloors(){this.sweepData.getSweepList().forEach((e=>{var t;if(!e.isUnplaced()&&e.isAligned()){let i;if(e.floorId&&this.floorData.hasFloor(e.floorId))i=this.floorData.getFloor(e.floorId);else{const o=this.meshQuery.floorIdFromObject(null===(t=this.meshQuery.nearestMeshInfo(e.position))||void 0===t?void 0:t.object);o&&this.floorData.hasFloor(o)&&(i=this.floorData.getFloor(o))}i&&i.addSweep(e.position,e.floorPosition)}})),this.floorData.commit()}registerRoomAssociationSource(e){const t=this.sweepData;e.commandBinder.issueCommandWhenBound(new l.l({type:"locations",getPositionId:function*(){for(const e of t.sweeps())yield{id:e.id,roomId:e.roomId||void 0,floorId:e.floorId||void 0,position:e.position,layerId:h.qw}},updateRoomForId:(e,i)=>{const o=t.getSweep(e);if(!o)throw new Error("Invalid sweep id!");o.roomId=i||null,o.commit()}}))}}},35396:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>p});var o=i(68909),s=i(77201),n=i(97800),a=i(71687);const r=(...e)=>function(t){return e.every((e=>e(t)))};var l=i(46192),h=i(58229),d=i(47737),c=i(83075),u=i(50485),m=i(12866);class p extends s.nV{constructor(){super(...arguments),this.name="mesh-query",this.roomBoundData=null,this.isSegmentTrimmed=(e,t)=>{var i;const o=null===(i=this.engine.getModuleBySymbolSync(a.GR))||void 0===i?void 0:i.meshTrimData;return!!(o&&o.numberOfTrims>0)&&o.isSegmentTrimmed(e,t)},this.isSegmentOccluded=(()=>{const e=new o.Ray,t=new o.Vector3,i=new o.Vector3;return(o,s,n=0)=>{if(0===n){e.origin.set(o.x,o.y,o.z),e.lookAt(t.set(s.x,s.y,s.z));const i=this.raycaster.picking.pick(e.origin,e.direction,c.m.isRoomMesh);return!!i&&i.distance*i.distance<=t.distanceToSquared(e.origin)}return e.direction.subVectors(s,o).normalize(),this.raycaster.picking.intersectsCapsule(t.copy(o).addScaledVector(e.direction,n),i.copy(s).addScaledVector(e.direction,-n),n,c.m.isRoomMesh)}})()}async init(e,t){const{market:i}=t;this.engine=t,[this.raycaster,this.floorData,this.roomData,this.layersData]=await Promise.all([t.getModuleBySymbol(a.sA),i.waitForData(h.q),i.waitForData(u.q),i.waitForData(d.P)]),i.waitForData(m.A).then((e=>this.roomBoundData=e))}nearestMeshInfoOnFloor(e,t){const i=r(c.m.isRoomMesh,this.matchesFloorId(t));return this.raycaster.picking.nearest((new o.Vector3).set(e.x,e.y,e.z),i)}nearestMeshInfo(e){return this.raycaster.picking.nearest((new o.Vector3).set(e.x,e.y,e.z),c.m.isRoomMesh)}inferMeshIdsFromPoint(e,t,i=!0){const s=i&&(0,l.C)(this.roomBoundData,this.layersData,e.layerId),a=!!this.roomBoundData&&this.roomBoundData.hasRooms()&&s;let h=!s||!e.roomId||!this.roomData.get(e.roomId);const d=!e.floorId||!this.floorData.hasFloor(e.floorId);if(!d&&h&&a&&this.roomBoundData){const i=this.roomBoundData.findRoomIdForPosition(t,e.floorId);i&&(e.roomId=i,h=!1)}if(h||d){const i=d?c.m.isRoomMesh:r(c.m.isRoomMesh,this.matchesFloorId(e.floorId)),s=this.raycaster.picking.nearest((new o.Vector3).set(t.x,t.y,t.z),i);let l;if(this.roomBoundData&&this.roomBoundData.hasRooms()){if(s&&c.m.hasMeshGroup(s.object)){const e=s.object.meshGroup;if(void 0!==e){const i=this.floorData.getFloorByMeshGroup(e,s.object.sourceViewId);i&&(l={floorId:i.id,roomId:a&&this.roomBoundData.findRoomIdForPosition(t,i.id)||void 0})}}}else l=s&&this.roomIdFloorIdFromObject(s.object);if(l){const{roomId:t,floorId:i}=l;n.Vy.for(this).debug("data-fixup:",h?{roomId:t,prev:e.roomId}:"",d?{floorId:i,prev:e.floorId}:"",{data:e}),h&&(e.roomId=t),d&&(e.floorId=i)}else n.Vy.for(this).warn("Nearest Room/Floor not found for:",{point:t,data:e,invalidRoomId:h,invalidFloorId:d})}return e}roomIdFloorIdFromObject(e){if(!c.m.hasMeshGroup(e))return;const t=this.floorData.getFloorByMeshGroup(e.meshGroup,e.sourceViewId);if(void 0===t)return;const i=(0,l.C)(this.roomBoundData,this.layersData,null)&&c.m.hasMeshSubgroup(e)?this.roomData.getByMeshSubgroup(e.meshSubgroup):void 0;return{floorId:t.id,roomId:null==i?void 0:i.id,layerId:c.m.hasLayerId(e)?e.layerId:void 0}}floorIdFromObject(e){if(c.m.hasMeshGroup(e)){const t=this.floorData.getFloorByMeshGroup(e.meshGroup,e.sourceViewId);return null==t?void 0:t.id}}mdsRoomIdFromObject(e){if(!(0,l.C)(this.roomBoundData,this.layersData,null)||!c.m.hasMeshSubgroup(e)||!c.m.hasMeshGroup(e))return;const t=this.roomData.getByMeshSubgroup(e.meshSubgroup);if(!t)return;const i=this.floorData.getFloorByMeshGroup(e.meshGroup,e.sourceViewId);return t.floorId===(null==i?void 0:i.id)?t.id:void 0}mdsFloorIdFromObject(e){if(!c.m.hasMeshGroup(e))return;const t=this.floorData.getFloorByMeshGroup(e.meshGroup,e.sourceViewId);return t?t.id:void 0}matchesFloorId(e){return t=>{const i=this.roomIdFloorIdFromObject(t);return(null==i?void 0:i.floorId)===e}}}},56035:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>Ae});var o=i(68909),s=i(77201),n=i(97800),a=i(90082),r=i(71687),l=i(81662),h=i(94814),d=i(70046),c=i(97171),u=i(12837),m=i(72773),p=i(11018),g=i(79388),v=i(99583),f=i(2993),w=i(7662),y=i(79545);const D=new o.Ray,b=new o.Matrix4,S=o.Mesh.prototype.raycast;function M(e,t){if(this.geometry.boundsTree){if(void 0===this.material)return;b.copy(this.matrixWorld).invert(),D.copy(e.ray).applyMatrix4(b);const i=this.geometry.boundsTree;if(!0===e.firstHitOnly){const o=(0,w.sP)(i.raycastFirst(D,this.material),this,e);o&&t.push(o)}else{const o=i.raycast(D,this.material);for(let i=0,s=o.length;i<s;i++){const s=(0,w.sP)(o[i],this,e);s&&t.push(s)}}}else S.call(this,e,t)}function T(e){return this.boundsTree=new y.G(this,e),this.boundsTree}function x(){this.boundsTree=null}let C=!1;var k=i(35457),P=i(37374),F=i(85227),V=i(90572),O=i(22278);class I{constructor(e){this.floorData={},this.floorUniforms={},this.isPanoMode=e}getSharedFloorUniforms(e){var t,i,o;return null!==(t=(i=this.floorUniforms)[o=`${e}`])&&void 0!==t?t:i[o]=this.buildFloorUniforms(e)}setFloorTrims(e,t){var i,o;const s=this.floorData[e]={};for(const e of t){if(e.enabled&&(!this.isPanoMode||this.isPanoMode&&e.activeInPanoMode)){(e.discardContents?null!==(i=s.discardTrims)&&void 0!==i?i:s.discardTrims=[]:null!==(o=s.keepTrims)&&void 0!==o?o:s.keepTrims=[]).push(e)}}(`${e}`==`${m.Zu}`?Object.keys(this.floorUniforms):[e]).forEach((e=>{var t,i,o,s;const n=this.floorUniforms[e];n&&(null===(t=n.meshTrimDiscardIndexTex)||void 0===t||t.dispose(),null===(i=n.meshTrimDiscardMatricesTex)||void 0===i||i.dispose(),null===(o=n.meshTrimKeepIndexTex)||void 0===o||o.dispose(),null===(s=n.meshTrimKeepMatricesTex)||void 0===s||s.dispose()),delete this.floorUniforms[e]}))}buildFloorUniforms(e){const t=this.floorData[e],i=this.floorData[m.Zu],o=[...(null==t?void 0:t.discardTrims)||[],...(null==i?void 0:i.discardTrims)||[]],s=[...(null==t?void 0:t.keepTrims)||[],...(null==i?void 0:i.keepTrims)||[]],{indexBounds:n,indexTex:a,matricesTex:r}=this.buildUniformsForTrims(o),{indexBounds:l,indexTex:h,matricesTex:d}=this.buildUniformsForTrims(s);return{meshTrimDiscardIndexBounds:n,meshTrimDiscardIndexTex:a,meshTrimDiscardMatricesTex:r,meshTrimKeepIndexBounds:l,meshTrimKeepIndexTex:h,meshTrimKeepMatricesTex:d}}buildUniformsForTrims(e){var t;const i=new o.Box3,s=new Map;e.forEach((e=>{i.union(e.getContainingAABB()),s.set(e,e.getOBB())}));const{min:{x:n,z:a},max:{x:r,z:l}}=i;if(!e.length||i.isEmpty())return{indexBounds:null,indexTex:null,matricesTex:null};const h=Math.min(128,Math.ceil(r-n)),d=Math.min(128,Math.ceil(l-a)),c=(r-n)/h,u=(l-a)/d,m=new Int32Array(h*d*2).fill(-1),p=new Map,g=[],v=new o.Box3;v.min.y=i.min.y,v.max.y=i.max.y;for(let i=0;i<h;i++){v.min.x=n+c*i,v.max.x=n+c*(i+1);for(let o=0;o<d;o++){v.min.z=a+u*o,v.max.z=a+u*(o+1);let n=null;for(const i of e)(null===(t=s.get(i))||void 0===t?void 0:t.intersectsBox3(v))&&(null!=n?n:n=[]).push(i);if(n){const e=n.map((e=>e.id)).sort().join("|");let t=p.get(e);if(!t){const i=g.length;for(const e of n)g.push(e.getInverseTransformationMatrix());t={offset:i,count:n.length},p.set(e,t)}m[2*(o*h+i)]=t.offset,m[2*(o*h+i)+1]=t.count}}}const f=new o.Vector4(n,a,r,l),w=new o.DataTexture(m,h,d,o.RGIntegerFormat,o.IntType),y=Math.min(1024,4*g.length),D=Math.ceil(4*g.length/y),b=new Float32Array(y*D*4);g.forEach(((e,t)=>{b.set(e.elements,16*t)}));const S=new o.DataTexture(b,y,D,o.RGBAFormat,o.FloatType);return w.needsUpdate=S.needsUpdate=!0,{indexBounds:f,indexTex:w,matricesTex:S}}}var B=i(25316),A=i(84440),N=i(10459),E=i(32502),R=i(37458),_=i(48539);function L(e,t){if(null==t)return t;if(t.isVector3||t.isVector4||t.isMatrix3||t.isMatrix4||t.isColor)return null!=e?(e.copy(t),e):t.clone();if(Array.isArray(t)&&(Array.isArray(e)||null==e)){null==e&&(e=[]);const i=0===e.length;let o=e.length===t.length;for(let s=0;s<t.length;s++){o=o||void 0===e[s]||e[s]!==t[s];const n=L(i?void 0:e[s],t[s]);i?e.push(n):o&&(e[s]=n)}return e}return t}var z=i(70497),U=i(2593);class G extends o.ShaderMaterial{constructor(e,t,i,o){const s={};for(const e of t)s[e]=!0;super({fragmentShader:U.f.fragmentShader,vertexShader:U.f.vertexShader,uniforms:i,name:e,defines:s}),this.getSide=o,this.capabilities=t}get side(){return this.getSide()}set side(e){}}var j=i(50839),H=i(39994),Q=i(47299);let $,W=1;try{$=(0,H.QN)(0,0)}catch(e){}const q=[{key:j.d.PanoTextureTransition,enabled:function(e){return e.progress.value>0&&e.progress.value<1&&e.pano0Map.value!==e.pano1Map.value},dependsOn:[j.d.PanoTexture],uniformsUsed:["progress","pano0Map","pano1Map"]},{key:j.d.PanoTexture,enabled:function(e){return e.panoOpacity.value>0},dependsOn:[],uniformsUsed:["panoOpacity"]},{key:j.d.ColorOverlay,enabled:function(e){return null!==e.colorOverlay.value},dependsOn:[],uniformsUsed:["colorOverlay"]},{key:j.d.MeshPreviewSphere,enabled:function(e){return null!==e.meshPreviewCenter.value},dependsOn:[j.d.MeshTexture],uniformsUsed:[]},{key:j.d.MeshTexture,enabled:function(e){return e.meshOpacity.value>0&&e.map.value},dependsOn:[],uniformsUsed:["meshOpacity","map"]},{key:j.d.Wireframe,enabled:function(e){return!1},dependsOn:[],uniformsUsed:[]},{key:j.d.FlatShading,enabled:function(e){return!1},dependsOn:[],uniformsUsed:[]},{key:j.d.PanoOverlay,enabled:function(e){return!!e.overlay0Map.value},dependsOn:[j.d.PanoTexture],uniformsUsed:["overlay0Map"]},{key:j.d.PanoOverlayTransition,enabled:function(e){return!!(e.progress.value>0&&e.progress.value<1&&e.overlay0Map.value&&e.overlay1Map.value&&e.overlay0Map.value!==e.overlay1Map.value)},dependsOn:[j.d.PanoOverlay,j.d.PanoTexture,j.d.PanoTextureTransition],uniformsUsed:["progress","overlay0Map","overlay1Map"]},{key:j.d.MeshTrimDiscard,enabled:function(e){return!!e.meshTrimDiscardIndexBounds.value},dependsOn:[j.d.MeshTexture],uniformsUsed:["meshTrimDiscardIndexBounds","meshTrimDiscardIndexTex","meshTrimDiscardMatricesSize","meshTrimDiscardMatricesTex"]},{key:j.d.MeshTrimKeep,enabled:function(e){return!!e.meshTrimKeepIndexBounds.value},dependsOn:[j.d.MeshTexture],uniformsUsed:["meshTrimKeepIndexBounds","meshTrimKeepIndexTex","meshTrimKeepMatricesSize","meshTrimKeepMatricesTex"]},{key:j.d.FloorTrimVertex,enabled:function(e){return!!(e.floorTrimHeight.value<1)},dependsOn:[j.d.MeshTexture],uniformsUsed:["floorTrimHeight"]},{key:j.d.FloorTrimPixel,enabled:function(e){return!!(e.floorTrimHeight.value<1)},dependsOn:[j.d.MeshTexture],uniformsUsed:["floorTrimHeight"]}],K=new Set(q.map((e=>e.uniformsUsed)).reduce(((e,t)=>e.concat(t)),[])),Z=new Set([j.d.MeshTrimDiscard,j.d.MeshTrimKeep]),Y=new Set(["progress","panoOpacity","meshOpacity","pano0Map","pano0Position","pano0Matrix1","pano0Matrix2","pano1Map","pano1Position","pano1Matrix1","pano1Matrix2","overlay0Map","overlay0Matrix","overlay1Map","overlay1Matrix","floorTrimHeight","floorHeightMin","floorHeightMax"]);class X{constructor(e,t,i,s,n="",a="",r=!1){this.meshGroup=e,this.meshSubgroup=t,this.geometry=i,this.sharedState=s,this.textureName=n,this.sourceKey=a,this.id=W++,this.name="",this.lod=z.X.Standard,this.capabilityOverrides={},this.onMaterialUpdate=new Set,this.uniformCache=X.getUniformDefaults(),this.opacity=1,this.needsVertexNormalRecompute=!0,this.temp={m1:new o.Matrix4,m2:new o.Matrix4,quat:new o.Quaternion,m3:null},this.textureCacheKey=`${a}${n}`,this.standardMaterial=this.getChunkMaterial(this.getCapabilities(),!1),this.updateRenderingMode(),r&&this.setMaterialsUniform(s.globalUniforms)}dispose(){this.geometry.dispose()}static getUniformDefaults(){const e={};for(const t in U.f.uniforms){const i=o.UniformsUtils.clone(U.f.uniforms[t]);for(const t in i)e[t]=i[t]}const t=o.UniformsUtils.clone(U.A.ceilingProcess.uniforms);for(const i in t)e[i]=t[i];return e}set material(e){if(this._material!==e&&this.onMaterialUpdate)for(const t of this.onMaterialUpdate.values())t(e);this._material=e}get material(){return this._material}notifyOnMaterialUpdated(e){return(0,s.Sh)((()=>this.onMaterialUpdate.add(e)),(()=>this.onMaterialUpdate.delete(e)),!0)}setMeshTexture(e){this.setMaterialsUniform({map:e})}getColorOverlay(){return this._colorOverlay}setColorOverlay(e){this._colorOverlay!==e&&(this.setMaterialsUniform({colorOverlay:e}),this._colorOverlay=e)}setMeshTextureOpacity(e){e!==this._meshTextureOpacity&&(this.setMaterialsUniform({meshOpacity:e,panoOpacity:1-e}),this._meshTextureOpacity=e)}setProgress(e){this._progress!==e&&(this.setMaterialsUniform({progress:e}),this._progress=e)}needsTransparent(){return this.opacity<Q.u7.FADE_OPAQUE}setOpacity(e){this.opacity=e;const t=this.needsTransparent();return this.onOpacityUpdate&&this.onOpacityUpdate(e),t!==this._material.transparent}getOpacity(){return this.opacity}setTime(e){this.sharedState.renderingMode===E.f.Wireframe&&this.setMaterialsUniform({time:e})}setMeshPreviewSphere(e,t=.3){this.setMaterialsUniform({meshPreviewCenter:e,meshPreviewSize:t})}setWireframe(e){if(e){if(this.geometry.getIndex()){const e=this.geometry;e.boundsTree&&(e.boundsTree.geometry=this.geometry.clone()),this.geometry.copy(this.geometry.toNonIndexed())}(0,H.tn)(this.geometry)}this.overrideCapability(j.d.Wireframe,e)}setFlatShading(e){e&&this.computeVertexNormals(),this.overrideCapability(j.d.FlatShading,e)}computeVertexNormals(){this.needsVertexNormalRecompute&&(this.geometry.computeVertexNormals(),this.needsVertexNormalRecompute=!1)}getCapabilities(){const e=new Set;for(const t in this.capabilityOverrides)this.capabilityOverrides[t]&&e.add(t);for(const t of q)if(!e.has(t.key)&&t.enabled(this.uniformCache,this.sharedState)){e.add(t.key);for(const i of t.dependsOn)e.add(i)}return e}overrideCapability(e,t){this.capabilityOverrides[e]=t,this.updateMaterialCapabilities()}updateMaterialCapabilities(){const e=this.getCapabilities(),t=this.standardMaterial,i=this.needsTransparent();if((0,_.Mq)(t.capabilities,e)&&i===t.transparent)return this._material;const o=this.getChunkMaterial(e,i);return this.standardMaterial=o,this.sharedState.renderingMode===E.f.Standard&&(this.material=o),this._material}getChunkMaterial(e,t){let i=`chunkMaterial_${this.sourceKey}`;for(const t of q)i+=e.has(t.key)?"1":"0";const s=-1===this.meshGroup&&-1===this.meshSubgroup;i+=s?"f":t?"1":"0";const{chunkMaterials:n}=this.sharedState;if(!n[i]){const a=new G(i,e,this.getUniformsForCapabilities(e),(()=>s?o.BackSide:this.sharedState.side));s?(a.transparent=!0,a.depthWrite=!1):(a.transparent=t,a.depthWrite=!t),n[i]=a}return n[i]}getUniformsForCapabilities(e){const t={};for(const i of e){const e=U.f.uniforms[i];for(const i in e)t[i]=this.uniformCache[i]}return o.UniformsUtils.clone(t)}setMaterialsUniform(e,t=!1){let i,o=!1;for(const s in e){let n=!1;const a=e[s];if(!(s in this.uniformCache))throw new Error(`Uniform ${s} does not exist in Chunk`);const r=this.uniformCache[s],l=r.value;n="meshPreviewCenter"===s?n||null===l!=(null===a):"meshTrimMatrices"===s||(n||K.has(s)&&l!==a),r.value=L(r.value,a),"opacity"===s&&(i=a),t&&Y.has(s)&&(this.sharedState.globalUniforms[s]=L(this.sharedState.globalUniforms[s],a)),o=o||n}return void 0!==i&&(o=this.setOpacity(i)||o),o&&this.updateMaterialCapabilities(),this._material}updateRenderingMode(){const{renderingMode:e,modeMaterials:t}=this.sharedState;e===E.f.Standard?this.material=this.standardMaterial:(this.material=t.get(e),e!==E.f.CeilingSample&&e!==E.f.FloorSample||this.handleCeilingProcessUpdates())}handleCeilingProcessUpdates(){if(this.computeVertexNormals(),this.material instanceof o.ShaderMaterial){const e=this.material.uniforms;for(const t of Z){delete this.material.defines[t];const i=U.f.uniforms[t];if(i)for(const t in Object.keys(i))delete e[t]}const t=this.getCapabilities();for(const i of Z)if(t.has(i)){this.material.defines[i]=!0;const t=U.f.uniforms[i];if(t)for(const i of Object.keys(t)){const t=this.standardMaterial.uniforms[i];t&&(e[i]=t)}}this.material.needsUpdate=!0}}setProjectedPano(e,t,i,o,s=!1){let n=1===e?"pano1Map":"pano0Map";const a={};a[n]=o||$,t&&(n=1===e?"pano1Position":"pano0Position",a[n]=t),i&&t&&(n=1===e?"pano1Matrix":"pano0Matrix",this.temp.m1.makeRotationFromQuaternion(this.temp.quat.copy(i).invert()),this.temp.m2.makeScale(-1,1,1),a[`${n}1`]=this.temp.m1,a[`${n}2`]=this.temp.m2),this.setMaterialsUniform(a,s)}setOverlayPano(e,t,i,s=!1){const n=`overlay${e}`,a={};if(t){this.temp.m3||(this.temp.m3=new o.Matrix4);const e=this.temp.m3.makeRotationFromQuaternion(t);a[n+"Matrix"]=e}a[n+"Map"]=i||$,this.setMaterialsUniform(a,s)}onBeforeDraw(e){if(this.sharedState.renderingMode===E.f.Standard||this.sharedState.renderingMode===E.f.CeilingSample||this.sharedState.renderingMode===E.f.FloorSample){for(const t of Object.keys(e.uniforms))this.uniformCache[t]&&null!==this.uniformCache[t].value&&(e.uniforms[t].value=this.uniformCache[t].value);e.uniformsNeedUpdate=!0}}getSortKey(){var e,t,i;return null!==(i=null===(t=null===(e=this.uniformCache.map)||void 0===e?void 0:e.value)||void 0===t?void 0:t.id)&&void 0!==i?i:0}}const J=new o.Vector3(0,0,0),ee=new o.Vector3(100,100,100),te=new o.Vector3,ie=new o.Vector3,oe=new o.Box3;class se extends o.Mesh{constructor(e){super(),this.bounds=new o.Box3,this.geometry=new o.BoxGeometry(1,1,1),this.geometry.computeBoundingBox(),this.geometry.computeBoundingSphere(),this.chunk=new X(-1,-1,this.geometry,e);const t=e=>{this.material=e};this.chunk.notifyOnMaterialUpdated(t),t(this.chunk.material),this.name="FallbackMesh",this.renderOrder=R.X.boundingSkybox,this.setFromCenterAndSize(J,ee),this.onBeforeRender=(e,t,i,s,n,a)=>{n instanceof o.ShaderMaterial&&this.chunk.onBeforeDraw(n)}}setBounds(e){if(this.bounds.equals(e))return;this.bounds.copy(e);const t=e.getSize(te);this.position.copy(e.getCenter(ie)),this.scale.set(t.x,t.y,t.z),this.updateMatrixWorld(!0)}setFromCenterAndSize(e,t=ee){this.setBounds(oe.setFromCenterAndSize(e,t))}}var ne=i(44345),ae=i(92237);class re{constructor(){this.allFloorsVisibleInOrtho=new s.Lj(!0),this.floorOpacity=new s.Es,this.globalOpacityModifier=new s.Lj(1),this.meshTextureOpacity=new ae.z(1)}}class le{constructor(e,t,i,n,a,r,l,h,d){this.container=e,this.mesh=t,this.meshData=i,this.sweepData=n,this.chunkSharedState=a,this.renderOptions=r,this.viewportManager=l,this.cameraModule=h,this.viewportState=new Map,this.chunkRenderingModeOverride=null,this.lastChunkRenderingModeOverride=null,this.fallbackMesh=null,this.overlayColors=[],this.meshGroupVisuals=new re,this.overlayTextures=[{sweepId:void 0,texture:void 0,renderTarget:new o.WebGLCubeRenderTarget(2048,{format:o.RGBAFormat}),quaternion:new o.Quaternion},{sweepId:void 0,texture:void 0,renderTarget:new o.WebGLCubeRenderTarget(2048,{format:o.RGBAFormat}),quaternion:new o.Quaternion}],this.overlayEnabled=!1,this.bindings=[],this.updateFallbackMesh=(()=>{const e=new o.Box3;return t=>{if(this.fallbackMesh){if(this.sweepData.currentAlignedSweepObject&&this.viewmodeData.isInside()){const t=e.copy(this.meshData.extendedBounds).expandByScalar(.2);this.fallbackMesh.setBounds(t)}else this.cameraData&&this.fallbackMesh.setFromCenterAndSize(this.cameraData.pose.position);this.fallbackMesh.material&&(this.fallbackMesh.material.transparent=!(t<1e-5))}}})(),this.opacity=null,this.updateRenderState=()=>{if(this.viewmodeData.currentMode!==this.lastViewmode||this.lastChunkRenderingModeOverride!==this.chunkRenderingModeOverride){this.lastChunkRenderingModeOverride=this.chunkRenderingModeOverride;const e=this.viewmodeData.isInside();this.updateChunkMaterialMode(e,this.chunkRenderingModeOverride),this.lastViewmode=this.viewmodeData.currentMode}if(this.viewmodeData.transition.active&&(0,f.nI)(this.viewmodeData.transition.to)||this.viewmodeData.isInside())for(const e of this.viewportManager.viewports){const t=this.getViewportState(e.id),i=this.sweepData.getStateForViewport(e.id),o=i.currentSweep,n=i.transition,a=n.active&&(this.applicationData.phase===s.Jj.PLAYING||this.applicationData.phase===s.Jj.STARTING),r=a?n.from:o,l=a?n.to:o,h=t.currentSweepId,d=t.targetSweepId;if(t.currentSweepId=r||null,t.targetSweepId=l||null,this.handleSweepChange(0,h,t.currentSweepId,t),this.handleSweepChange(1,d,t.targetSweepId,t),this.overlayEnabled){const e=this.overlayTextures.find((e=>e.sweepId===t.currentSweepId)),i=this.overlayTextures.find((e=>e.sweepId===t.targetSweepId));let o=!0;for(const t of this.allChunks())t.setOverlayPano(0,e?e.quaternion:void 0,e?e.texture:void 0,o),t.setOverlayPano(1,i?i.quaternion:void 0,i?i.texture:void 0,o),o=!1}}},this.debugColorizeChunks=(()=>{let e=!1;return(t,i)=>{const s=new o.Vector4(1,1,1,0);e=!e,(e=>{for(const t of this.mesh.chunks){const o=i?100*t.id:100*t.meshSubgroup,n=e?(0,A.Zd)(.5,o):s;t.setColorOverlay(n)}})(t||e)}})(),this.container.add(this.mesh),d&&(this.fallbackMesh=new se(this.chunkSharedState),this.fallbackMesh.layers.mask=this.container.layers.mask,this.container.add(this.fallbackMesh))}init(){}dispose(){this.container.remove(this.mesh),this.fallbackMesh&&this.container.remove(this.fallbackMesh)}async activate(e){[this.applicationData,this.viewmodeData,this.settings,this.cameraData,this.renderer]=await Promise.all([e.market.waitForData(s.zH),e.market.waitForData(v.X),e.market.waitForData(B.o),e.market.waitForData(N.M),e.getModuleBySymbol(r.M7)]),this.panoRenderer=(await e.getModuleBySymbol(r.qD)).getRenderer(),this.updateRenderState(),this.bindings.push(this.viewmodeData.onChanged(this.updateRenderState),this.sweepData.onChanged(this.updateRenderState),this.settings.onSettingChanged(Q._Z,(e=>this.toggleWireframe(e))),this.settings.onChanged(this.updateRenderState)),this.bindings.push(this.mesh.notifyOnChunksLoaded((t=>{for(const e of this.overlayColors)e(t);e.msgBus.broadcast(new ne.qZ)}))),this.renderOptions.colorizeRooms&&this.debugColorizeChunks(!0),this.renderOptions.colorizeChunks&&this.debugColorizeChunks(!0,!0),this.renderOptions.wireframe&&this.toggleWireframe(!0);const t=[...this.meshData.meshGroups.floors.keys()].sort();for(const e of t)this.meshGroupVisuals.floorOpacity.set(`${e}`,1)}deactivate(){for(const e of this.bindings)e.cancel();this.bindings=[];for(const e of this.viewportState.values())e.currentSweepId&&this.panoRenderer.freeTexture(e.currentSweepId);this.viewportState.clear()}updateSweepRenderTarget(e,t,i,o,s){const n=this.panoRenderer.useTexture(t,s.cameraId);if(n){const t=s.slotInfo[e];t.texture=n,t.position.copy(i),t.rotation.copy(o);let a=!0;for(const t of this.allChunks())t.setProjectedPano(e,i,o,n,a),a=!1}}*allChunks(){yield*this.mesh.chunks,this.fallbackMesh&&(yield this.fallbackMesh.chunk)}updateExistingTexture(e,t,i,o){for(const i of this.viewportState.values())i.currentSweepId===e?i.slotInfo[0].texture=t:i.targetSweepId===e&&(i.slotInfo[1].texture=t)}beforeRenderViewport(e){var t,i,o;const{floorOpacity:s,globalOpacityModifier:n,meshTextureOpacity:a}=this.meshGroupVisuals;for(const e of this.mesh.visibleChunks){const i=(null!==(t=s.get(`${e.meshGroup}`))&&void 0!==t?t:1)*n.value;e.setMaterialsUniform({meshOpacity:a.value,panoOpacity:1-a.value,opacity:null!==this.opacity?this.opacity:i,progress:this.sweepData.state.transition.progress.value})}const r=(0,h.p_)(a.value,0,1,1);null===(i=this.fallbackMesh)||void 0===i||i.chunk.setMeshTextureOpacity(r),null===(o=this.fallbackMesh)||void 0===o||o.chunk.setProgress(this.sweepData.state.transition.progress.value),this.updateFallbackMesh(r);const l=this.getViewportState();let d=!0;for(const e of this.allChunks())e.setProjectedPano(0,l.slotInfo[0].position,l.slotInfo[0].rotation,l.slotInfo[0].texture,d),e.setProjectedPano(1,l.slotInfo[1].position,l.slotInfo[1].rotation,l.slotInfo[1].texture,d),d=!1}render(){}beforeRender(){}updateChunkMaterialMode(e,t){const i=e?o.DoubleSide:o.FrontSide;this.chunkSharedState.side=i,this.chunkSharedState.renderingMode=t||E.f.Standard;for(const e of this.mesh.chunks)e.updateRenderingMode()}handleSweepChange(e,t,i,o){if(t!==i&&(t&&this.panoRenderer.freeTexture(t),i)){const t=this.sweepData.getSweep(i);this.updateSweepRenderTarget(e,i,t.position,t.rotation,o)}}async onPanoOverlayCommand(e){this.overlayEnabled=!0;const t=t=>{const i=t.renderTarget;t.renderTarget.width=e.texture.image.width,t.renderTarget.height=e.texture.image.height,t.sweepId=e.sweepId,t.texture=i.texture,t.quaternion=e.quaternion,this.renderer.cwfRenderer.copyCubemap(e.texture,t.renderTarget)};let i=!1;for(const o of this.overlayTextures)i||o.sweepId!==e.sweepId||(t(o),i=!0);const s=Array.from(this.viewportState.values()).map((e=>[e.currentSweepId,e.targetSweepId])).flat();for(const e of this.overlayTextures)i||e.sweepId&&s.includes(e.sweepId)||(t(e),i=!0);if(!i){const e={sweepId:void 0,texture:void 0,renderTarget:new o.WebGLCubeRenderTarget(2048,{format:o.RGBAFormat}),quaternion:new o.Quaternion};t(e),this.overlayTextures.push(e)}this.updateRenderState()}setMeshOverlay(e="all",t="explicit",i,s,n=-1){let a=()=>!0;switch(e){case"all":a=()=>!0,this.overlayColors.length=0;break;case"byMeshGroup":a=e=>e.meshGroup===n;break;case"byMeshSubGroup":a=e=>e.meshSubgroup===n}if(!a)return;let r="rand";"explicit"===t&&(r=i?new o.Vector4(i.x,i.y,i.z,i.w):null);const l=e=>{for(const t of e)-1!==t.meshGroup&&a(t)&&t.setColorOverlay("rand"===r?(0,A.Zd)(s):r)};l([...this.allChunks()]),"all"===e&&null===r||this.overlayColors.push(l)}setChunkRenderingMode(e){this.chunkRenderingModeOverride=e,this.updateRenderState()}toggleWireframe(e){for(const t of this.mesh.chunks)t.setWireframe(e)}onUpdate(e){this.meshGroupVisuals.meshTextureOpacity.active&&(this.viewmodeData.transition.active?(this.meshGroupVisuals.meshTextureOpacity.updateProgress(this.viewmodeData.transition.progress),this.meshGroupVisuals.meshTextureOpacity.commit()):(this.meshGroupVisuals.meshTextureOpacity.tick(e),this.meshGroupVisuals.meshTextureOpacity.commit()))}getViewportState(e){var t;const i=e||(null===(t=this.viewportManager.renderingViewport)||void 0===t?void 0:t.id)||this.viewportManager.activeViewport.id||this.viewportManager.defaultViewport.id;let s=this.viewportState.get(i);return s||(s={currentSweepId:null,targetSweepId:null,slotInfo:[{position:new o.Vector3,rotation:new o.Quaternion},{position:new o.Vector3,rotation:new o.Quaternion}],cameraId:this.cameraModule.getCameraDataForViewport(i).id},this.viewportState.set(i,s)),s}}var he=i(97084),de=i(66726),ce=i(3249),ue=i(40397),me=i(65936),pe=i(596);class ge{constructor(e,t,i=z.X.Standard,o){this.textureName=e,this.mesh=t,this.lod=i,this.chunkedTexInfo=o,this.chunks=new Set,this.loading=!1,this.unloaded=!1,this.screenCoverage=0,this.screenCoverageScore=0,this.sightings=new n.CZ(Q.xT.sightingMaxAge),o&&(this.textureQualityMap.registerQualities(i,o.maxTextureSize,o.maxTexelSize,o.minScale),this.quality=this.textureQualityMap.min(i),this.targetQuality=this.quality),this.minQuality=this.textureQualityMap.min(i),this.maxQuality=this.minQuality}get textureQualityMap(){return this.mesh.textureQualityMap}setTexture(e){const t=this.texture;if(this.texture=e,t&&t!==e&&t.dispose(),e)for(const t of this.chunks)t.setMeshTexture(e)}getEmbeddedTexture(){var e;const t=null===(e=this.chunks.entries().next())||void 0===e?void 0:e.value;return t?t[0].embeddedTexture:void 0}}class ve{constructor(e,t,i=.85){this.renderer=e,this.maxBudget=t,this.pctTotalMemory=i,this.slots=[],this.lods=new Map,this.orders={},this.slotTexSizes=new Map}dispose(){this.slots=[],this.lods.clear(),this.orders={}}update(e){this.updateBudget(void 0),this.updateTargetQualitiesFromBudget()}updateBudget(e){if(e){this.dispose();const t=new Map;this.slots=e,e.forEach((e=>{const i=this.lods.get(e.lod)||new Set;i.add(e),this.lods.set(e.lod,i);const o=t.get(e.lod)||new Set;e.textureQualityMap.order(e.lod).forEach((e=>o.add(e))),t.set(e.lod,o)}));for(const e of t.keys()){const i=t.get(e);i&&(this.orders[e]=Array.from(i.values()).sort())}}if(this.shouldRestrictBudget()){const e=this.calcCurrentTexturesSize(),t=this.renderer.estimatedGPUMemoryAllocated()-e,i=this.maxBudget()-t;this.budget=i*this.pctTotalMemory}else this.budget=1/0;return this}updateTargetQualitiesFromBudget(){let e=0;for(const t of this.slots)this.updateBudgetSize(t),t.targetQuality=t.minQuality,e+=this.getBudgetSize(t,t.targetQuality);const t=(t,i)=>t.maxQuality<i||!t.textureQualityMap.valid(i)||(e-=this.getBudgetSize(t,t.targetQuality),e+=this.getBudgetSize(t,i),!(e>this.budget)&&(t.targetQuality=i,!0));if(this.shouldRestrictBudget()){for(const e of this.slots)for(const i of this.orders[e.lod])if(!t(e,i))return}else for(const[e,i]of this.lods.entries())for(const o of this.orders[e])for(const e of i)if(!t(e,o))return}shouldRestrictBudget(){return this.maxBudget()!==1/0}getBudgetSize(e,t){if(!t)return 0;const i=e.textureQualityMap.get(t);let o=0;if(e){const i=e.textureQualityMap.min(e.lod);i!==t&&e.getEmbeddedTexture()&&(o=this.getBudgetSize(e,i));const s=e.textureName+t,n=this.slotTexSizes.get(s);if(n)return n+o}return(i?i.textureSize:4096)**2*4+o}updateBudgetSize(e){var t;const i=e.textureName+e.quality,o=null!==(t=e.texture)&&void 0!==t?t:e.getEmbeddedTexture();this.slotTexSizes.set(i,this.texSizeBytes(o))}calcCurrentTexturesSize(){return this.slots.reduce(((e,t)=>{var i;const o=t.getEmbeddedTexture(),s=null!==(i=t.texture)&&void 0!==i?i:o;return s===o?e+this.texSizeBytes(s):e+this.texSizeBytes(s)+this.texSizeBytes(o)}),0)}texSizeBytes(e){var t;if(!e)return 0;if(null===(t=e.mipmaps)||void 0===t?void 0:t.length){let t=0;for(const i of e.mipmaps)if("data"in i)t+=i.data.length;else{const{width:e,height:o}="image"in i?i.image:i;t+=e*o*4}return t}let i=e.image.width*e.image.height*4,o=i/4;for(;o>=1;)i+=o,o/=4;return i}}const fe=new n.Vy("tex-lod");class we{constructor(e,t,i,o,s,n,a){this.textureLOD=e,this.api=t,this.camera=i,this.renderToTextureModule=o,this.engine=s,this.chunkVisibilityChecker=n,this.rendererModule=a,this.name="texture-streaming",this.limitMemoryUsage=!1,this.allocatedMegsBeforeLimitingLod=350,this.slots=[],this.textureKeyToSlot={},this.chunkSourceToMesh=new Map,this.meshes=new Map,this.chunkIdToSlot={},this._systemMin=pe.M.LOW,this._systemMax=pe.M.ULTRA,this.meshMinMax=new Map,this.allowTextureDownload=()=>!0,this.concurrentLoadingTextures=1,this.concurrentDownloadingTiles=12,this.autoLoadTiles=!1,this.lastSortedAt=0,this.loadingTextures=0,this.downloadingTiles=0,this.totalTextures={},this.totalTiles=0,this.abortController=new AbortController,this.bindings=[],this.textureApiInfo=new Map,this._chunkSlotsSet=new Set,this.loadImage=async(e,t,i,o,s)=>{var n;const a=e.textureQualityMap.get(t),{assetType:r,lod:l}=a,h=(null===(n=e.chunkedTexInfo)||void 0===n?void 0:n.maxTextureSize)||a.assetSize;let d,c=e.textureName;if(this.textureApiInfo){if(!e.chunkedTexInfo){const e=c.match(/[_.]([0-9]{3})[_.]/);if(!e)throw new Error(`Could not parse texture index from texture name: ${c}`);c=e[1]}const t=this.textureApiInfo.get(e.mesh);if(!t)throw new Error(`No texture URLs found for mesh: ${e}`);d=(await t[r].get()).urlTemplate.replace("<folder>",`${l}`).replace("<texture>",c)}else{const e=c.match(/^([a-f0-9]+(_10k|_50k)?)/);if(!e)throw new Error(`Unknown format for texture name: ${c}`);d=`${e[0]}_texture_jpg_${r}/${c}`}const{sourceSize:u=h,sourceX:m=0,sourceY:p=0,destSize:g=u}=o,v={};return g!==u&&(v.width=`${g}`),u!==h&&(v.crop=`${u},${u},x${m/h},y${p/h}`),d=(0,de.Gm)(d,v),i.getImageBitmap(d,g,g,s)},this.textureBudgeter=new ve(this.rendererModule,(()=>this.limitMemoryUsage?this.allocatedMegsBeforeLimitingLod*2**20:1/0)),this.bindings.push(this.chunkVisibilityChecker.notifyOnNewSighting(((e,t)=>{const i=this.chunkSourceToMesh.get(e.sourceKey);if(i){const o=this.addChunkSlots(i,[e]);for(const e of o)e.sightings.push(t)}})))}setModel(e,t,i){if(this.textureApiInfo.set(e,i),0===t.length)throw new Error("Chunks required");this.addChunkSlots(e,[...t]),this.textureBudgeter.updateBudget(this.slots),this.updateSystemQualityRanges()}clearSlots(){this.abortController.abort(),this.slots.forEach((e=>{this.removeChunks([...e.chunks])})),this.abortController=new AbortController}dispose(){this.abortController.abort(),this.bindings.forEach((e=>e.cancel())),this.bindings.length=0,this.clearSlots(),this._chunkSlotsSet.clear(),this.textureBudgeter.dispose(),this.textureApiInfo.clear()}addChunkSlots(e,t){const i=this.meshes.get(e)||0;this.meshes.set(e,i+t.length),t.forEach((t=>{this.chunkSourceToMesh.set(t.sourceKey,e)})),this._chunkSlotsSet.clear();let o=!1;for(const i of t){const t=i.textureName;let s=this.textureKeyToSlot[i.textureCacheKey];s||(o=!0,s=new ge(t,e,i.lod,i.textureLODInfo),i.embeddedTexture&&s.setTexture(i.embeddedTexture),this.textureKeyToSlot[i.textureCacheKey]=s,this.slots.push(s)),s.chunks.has(i)||(o=!0,s.chunks.add(i),s.texture&&i.setMeshTexture(s.texture)),this._chunkSlotsSet.add(s),this.chunkIdToSlot[i.id]=s}return o&&this.textureBudgeter&&(this.textureBudgeter.updateBudget(this.slots),this.updateSystemQualityRanges()),this._chunkSlotsSet}removeChunks(e){var t;for(const i of e){const e=this.chunkIdToSlot[i.id];if(!e){fe.error("Missing slot for chunk!",i.id,i.textureCacheKey,i);continue}if(e.chunks.delete(i),0===e.chunks.size){e.unloaded=!0,e.setTexture(null);const t=this.slots.indexOf(e);this.slots.splice(t,1),delete this.textureKeyToSlot[i.textureCacheKey]}delete this.chunkIdToSlot[i.id];const o=this.chunkSourceToMesh.get(i.sourceKey);if(o){(null!==(t=this.meshes.get(o))&&void 0!==t?t:1)-1<=0&&(this.meshes.delete(o),this.meshMinMax.delete(o.textureQualityMap))}this.chunkSourceToMesh.delete(i.sourceKey)}}setQuality(e,t){this._systemMin=e,this._systemMax=t,this.updateSystemQualityRanges()}updateSystemQualityRanges(){this.meshMinMax.clear();for(const e of this.meshes.keys()){const t=e.textureQualityMap.lods(),i={min:{},max:{}};for(const o of t)i.min[o]=e.textureQualityMap.nearestQuality(o,this._systemMin),i.max[o]=e.textureQualityMap.nearestQuality(o,this._systemMax);this.meshMinMax.set(e.textureQualityMap,i)}for(const e of this.slots){const t=this.meshMinMax.get(e.textureQualityMap);t?(e.minQuality=t.min[e.lod],e.maxQuality=e.maxQuality?Math.min(t.max[e.lod],e.maxQuality):t.max[e.lod]):fe.error("Missing min/max lod for slot")}}get textureCount(){return this.slots.length}async loadAll(e,t){const i=this.slots.filter((t=>t.mesh===e));i[0]&&i[0].textureName&&await this.loadSlots(i,t)}async loadSlots(e,t=(e.length>0?e[0].textureQualityMap.min(z.X.Standard):z.X.Standard)){if(!e.length)return;const i=e[0].textureQualityMap;i.valid(t)?await Promise.all(e.map((e=>this.loadTexture(e,t,!1)))):fe.warn(t,"not found in",i)}onWebGLContextLost(){this.abortController.abort();for(const e of this.slots)e.texture=null}onWebGLContextRestored(){this.abortController=new AbortController;for(const e of this.slots)this.loadTexture(e,e.quality)}async loadTexture(e,t,i=!0){var o,s;const n=e.textureQualityMap;n.valid(t)||fe.warn(t,"not found in",n);const a=n.get(t),r=(null===(o=e.chunkedTexInfo)||void 0===o?void 0:o.maxTextureSize)||a.assetSize,l=Math.min(r,a.textureSize);e.lastLoadedAt=performance.now();let h=e.texture;if(!h||t!==e.quality)if(h&&t<e.quality&&e.texture){const i=null===(s=e.chunks.values().next().value)||void 0===s?void 0:s.embeddedTexture;if(i&&i.image.width>=l&&i.mipmaps[0].data.length<=l*l*4)e.quality=t,e.setTexture(i);else{const i=this.renderToTextureModule.resizeTexture(h,l);ye(i,e),e.quality=t,e.setTexture(i)}this.engine.msgBus.broadcast(new ne.Ny)}else{e.loading=!0,this.loadingTextures++,this.totalTextures[l]=(this.totalTextures[l]||0)+1;try{h=this.textureLOD!==V.R.NONE&&i?await this.loadTextureTiled(l,t,e,this.abortController.signal):await this.loadTextureSolid(l,t,e,this.abortController.signal),e.unloaded?h.dispose():(ye(h,e),e.setTexture(h),this.engine.msgBus.broadcast(new ne.Gf))}catch(e){}finally{this.loadingTextures--,e.quality=t,e.loading=!1}}}async loadTextureTiled(e,t,i,n){var a;const r=this.rendererModule.cwfRenderer,l=r.initSizedTexture2D(e,{generateMipmaps:!1,minFilter:o.LinearFilter,magFilter:o.LinearFilter}),h=i.textureQualityMap,d=(null===(a=i.chunkedTexInfo)||void 0===a?void 0:a.maxTextureSize)||h.get(t).assetSize,c=Math.min(d,h.get(t).textureSize),u=Math.min(c,h.get(t).tileSize),m=async(e,o)=>{let a;this.downloadingTiles+=1,this.totalTiles+=1;const h=i.mesh.flipDownload;try{a=await this.loadImage(i,t,this.api,{sourceSize:d*(u/c),sourceX:d*(e/c),sourceY:d*(o/c),destSize:u},{priority:he.QK.LOW,flipY:h,signal:n})}finally{this.downloadingTiles-=1}const m=e,p=i.mesh.flipUpload?c-o-u:o,g=new me.m("mesh/texture/upload-tiles",(()=>this.engine.after(s.Rb.End).then((()=>{if(n.aborted)throw new DOMException("Aborted","AbortError");l.flipY=h&&a instanceof HTMLImageElement,r.uploadTexture2D(a,l,m,p)}))),100);return(await this.engine.commandBinder.issueCommand(g)).promise.finally((()=>{var e,t;a&&(null===(t=(e=a).close)||void 0===t||t.call(e))}))},p=[];for(let e=0;e<c;e+=u)for(let t=0;t<c;t+=u)p.push(m(e,t));try{await Promise.all(p)}catch(e){throw l.dispose(),e}return l}async loadTextureSolid(e,t,i,o){var s,n;const a=this.rendererModule.cwfRenderer,r=a.initSizedTexture2D(e);let l=null;try{const e=i.textureQualityMap.get(t).textureSize,s=i.mesh.flipDownload;l=await this.loadImage(i,t,this.api,{destSize:e},{priority:he.QK.LOW,flipY:s,signal:o}),r.flipY=s&&l instanceof HTMLImageElement,a.uploadTexture2D(l,r,0,0)}catch(e){throw r.dispose(),e}finally{l&&(null===(n=(s=l).close)||void 0===n||n.call(s))}return r}setImageLoader(e){this.loadImage=e}analyzeTextureScreenCoverageFromRaycasts(){const e=this.rendererModule.cwfRenderer.getSize().x,t=this.camera.getWorldPosition(new o.Vector3);for(const i of this.slots){i.screenCoverage=0,i.screenCoverageScore=0,i.maxQuality=i.minQuality;const o=i.sightings.getList(),s=i.sightings.index-1;for(let n=0;n<o.length;n++){const a=o[(s-n+o.length)%o.length];if(a.raycastAge<this.chunkVisibilityChecker.raycastCounter-Q.Ay.sightingMaxAge)break;const r=t.distanceTo(a.point),l=(0,ue.ff)(r,this.camera.projectionMatrix,e);let h=i.textureQualityMap.fromPixelSize(i.lod,l);const d=this.meshMinMax.get(i.textureQualityMap);h=Math.min(h,d?d.max[i.lod]:this._systemMax),i.screenCoverageScore+=h,i.screenCoverage+=1,i.maxQuality=Math.max(h,i.maxQuality)}}this.slots.sort(((e,t)=>t.screenCoverageScore-e.screenCoverageScore)),this.textureBudgeter.updateTargetQualitiesFromBudget()}update(e){if(!this.camera||!this.autoLoadTiles||this.abortController.signal.aborted)return;this.textureBudgeter.update(e);const t=performance.now();this.textureLOD===V.R.RAYCAST&&this.scheduleRaycastTasks(t);let i=!1;for(let e=this.slots.length-1;e>=0;e--){const o=this.slots[e],s=(0,ce.qE)(o.targetQuality,o.minQuality,o.maxQuality),n=t-o.lastLoadedAt<1e3;if(!o.loading&&o.quality>s){n?i=!0:this.loadTexture(o,s);break}}if(this.allowTextureDownload()&&!i)for(const e of this.slots){if(this.loadingTextures>=this.concurrentLoadingTextures||this.downloadingTiles>=this.concurrentDownloadingTiles)break;const t=(0,ce.qE)(e.targetQuality,e.minQuality,e.maxQuality);!e.loading&&e.quality<t&&this.loadTexture(e,e.textureQualityMap.moreDetailed(e.lod,e.quality))}}scheduleRaycastTasks(e){if(!this.analyzeTaskPromise&&e-this.lastSortedAt>200){const e=()=>{this.analyzeTextureScreenCoverageFromRaycasts(),this.lastSortedAt=performance.now()},t=async e=>{await e.promise,this.analyzeTaskPromise=null},i=new me.m("mesh/texture/analyze-screen-coverage",e,100);this.analyzeTaskPromise=this.engine.commandBinder.issueCommand(i).then(t)}}}function ye(e,t){e.addEventListener("dispose",(()=>{e===t.texture&&fe.warn("Streamed texture disposed while still in use")}))}var De=i(21100),be=i(6687),Se=i(99276),Me=i(14971);const Te=Math.round(Q.Ay.sightingMaxAge/60/5)||1;class xe{resetCounter(){this.lastReset=this.raycastCounter}constructor(e,t,i,s){this.scene=e,this.raycaster=t,this.pose=i,this.viewportManager=s,this.raycastCounter=0,this.onNewSighting=new Set,this.lastReset=0,this.raycastRandomScreenLocation=(()=>{const e=new o.Vector3,t=new o.Vector3,i=new o.Vector3;function s(e){return!!((0,be.aV)(e)&&e instanceof Se.B)&&e.chunks.some((e=>e.getOpacity()>Q.u7.FADE_TILE_VISIBLE_THRESHOLD))}return(o,n,a)=>{this.raycastCounter++;const r=(2-2*n)/o,l=-1+n,h=this.raycastCounter%(o*o),d=h%o,c=l+(h-d)/o*r,u=l+d*r+Math.random()*r,m=c+Math.random()*r,p=this.viewportManager.viewports.values.map((e=>e.camera));for(const o of p){e.set(u,m,-1).unproject(o),t.set(u,m,1).unproject(o),i.subVectors(t,e).normalize();const n=this.raycaster.pick(e,i,s);if(n){if(n.face&&n.object instanceof Se.B){const e=n.object.getChunk(n.face.materialIndex),t={point:n.point.clone(),raycastAge:this.raycastCounter};for(const i of this.onNewSighting.values())i(e,t)}a&&a(n)}}}})()}update(){const e=Q.Ay.debugLOD?(0,Me.rt)(65280,this.scene,this.pose):void 0,t=performance.now();for(let i=0;i<Te&&performance.now()-t<.5&&this.raycastCounter<=this.lastReset+Q.Ay.sightingMaxAge;i++)this.raycastRandomScreenLocation(5,.05,e)}notifyOnNewSighting(e){return(0,s.Sh)((()=>this.onNewSighting.add(e)),(()=>this.onNewSighting.delete(e)),!0)}}var Ce=i(32024);const ke=i.p+"images/uv_grid_opengl.jpg",Pe=e=>new o.ShaderMaterial({fragmentShader:U.A.ceilingProcess.fragmentShader,vertexShader:U.A.ceilingProcess.vertexShader,transparent:!0,defines:e,uniforms:o.UniformsUtils.clone(U.A.ceilingProcess.uniforms),side:o.BackSide,name:"materialFloorProcess",stencilRef:1,stencilFuncMask:65535,stencilWrite:!0,stencilFunc:o.EqualStencilFunc,stencilFail:o.KeepStencilOp,stencilZFail:o.KeepStencilOp,stencilZPass:o.KeepStencilOp,blending:o.MultiplyBlending});class Fe{constructor(){this.materials=new Map}get(e){let t=this.materials.get(e);return t||(t=Ve[e](),this.materials.set(e,t)),t}}const Ve={[E.f.Depth](){const e=o.UniformsUtils.clone(U.A.depth.uniforms);return new o.ShaderMaterial({fragmentShader:U.A.depth.fragmentShader,vertexShader:U.A.depth.vertexShader,uniforms:e,side:o.FrontSide,name:"materialDepth"})},[E.f.Transparent](){const e=o.UniformsUtils.clone(U.A.modelOutside.uniforms);return e.opacity.value=.2,e.colorOverlay.value.set(1,1,1,1),new o.ShaderMaterial({fragmentShader:U.A.modelOutside.fragmentShader,vertexShader:U.A.modelOutside.vertexShader,uniforms:e,side:o.FrontSide,transparent:!0,name:"materialTransparent"})},[E.f.Wireframe](){const e=o.UniformsUtils.clone(U.A.modelOutside.uniforms);return e.opacity.value=.5,e.colorOverlay.value.set(1,1,1,1),new o.ShaderMaterial({fragmentShader:U.A.modelOutside.fragmentShader,vertexShader:U.A.modelOutside.vertexShader,uniforms:e,side:o.FrontSide,transparent:!0,wireframe:!0,name:"materialWireframe"})},[E.f.UV]:()=>new o.MeshBasicMaterial({name:"uv-debug",map:(0,Ce.y)(ke)}),[E.f.CeilingSample]:()=>Pe({CEILING_SAMPLE:!0}),[E.f.FloorSample]:()=>Pe({FLOOR_SAMPLE:!0})};class Oe{constructor(){this.side=o.FrontSide,this.renderingMode=E.f.Standard,this.chunkMaterials={},this.modeMaterials=new Fe,this.globalUniforms={}}forEachChunkMaterial(e){const{chunkMaterials:t}=this;for(const i in t)e(t[i])}dispose(){const{chunkMaterials:e}=this;for(const t in e){const i=e[t];for(const e in i.uniforms)i.uniforms[e].value instanceof o.Texture&&i.uniforms[e].value.dispose();i.dispose(),delete e[t]}}}const Ie=new n.Vy("MeshTrimData");class Be extends s.B_{constructor(){super(),this.name="mesh-trim-data",this.numberOfTrims=0,this.meshTrimsByMeshGroup=new s.Es,this.meshTrimsById=new s.Es,this.onMeshGroupChangedCallbacks=new Set,this.onMeshTrimChangedCallbacks=new Set,this.updateMeshTrim=e=>{for(const t of this.onMeshTrimChangedCallbacks)t(e)},this.notifyMeshGroupChanges=e=>{for(const t of this.onMeshGroupChangedCallbacks)t(e)},this.meshTrimsByMeshGroup.set(`${m.Zu}`,new s.XD)}addMeshGroups(e){for(const t of e)if(!this.meshTrimsByMeshGroup.has(`${t}`)){const e=new s.XD;this.meshTrimsByMeshGroup.set(`${t}`,e)}this.singleFloorMeshGroup||1!==e.length||(this.singleFloorMeshGroup=e[0])}add(...e){const t=new Set;this.meshTrimsById.atomic((()=>{this.meshTrimsByMeshGroup.atomic((()=>{for(const i of e){void 0!==this.singleFloorMeshGroup&&(i.meshGroup=this.singleFloorMeshGroup);const e=`${i.meshGroup}`;this.meshTrimsByMeshGroup.has(e)||this.meshTrimsByMeshGroup.set(e,new s.XD);this.meshTrimsByMeshGroup.get(e).push(i),this.meshTrimsById.set(i.id,i),t.add(i.meshGroup),i.onChanged(this.updateMeshTrim)}}))})),t.forEach((e=>{const t=this.meshTrimsByMeshGroup.get(`${e}`);this.sortList(t),this.reassignIndexes(t),this.notifyMeshGroupChanges(e)})),this.updateDerivedProperties()}delete(...e){const t=new Set;this.meshTrimsByMeshGroup.atomic((()=>{for(const i of e){const e=this.meshTrimsByMeshGroup.get(`${i.meshGroup}`),o=e.indexOf(i);if(o>=0){e.splice(o,1)[0].enabled=!1,t.add(i.meshGroup),i.removeOnChanged(this.updateMeshTrim)}else Ie.error("Could not delete mesh trim:"+i.id)}})),t.forEach((e=>{const t=this.meshTrimsByMeshGroup.get(`${e}`);this.reassignIndexes(t),this.notifyMeshGroupChanges(e)})),this.meshTrimsById.atomic((()=>{e.forEach((e=>{this.meshTrimsById.delete(e.id)}))})),this.updateDerivedProperties()}updateDerivedProperties(){this.numberOfTrims=this.meshTrimsById.length,this.commit()}onMeshGroupChanged(e){return(0,s.Sh)((()=>this.onMeshGroupChangedCallbacks.add(e)),(()=>this.onMeshGroupChangedCallbacks.delete(e)))}onMeshTrimChanged(e){return(0,s.Sh)((()=>this.onMeshTrimChangedCallbacks.add(e)),(()=>this.onMeshTrimChangedCallbacks.delete(e)))}getTrimById(e){return this.meshTrimsById.get(e)||null}getTrim(e,t){return this.meshTrimsByMeshGroup.has(`${e}`)?this.meshTrimsByMeshGroup.get(`${e}`).get(t):null}getTrimsForMeshGroup(e){return this.meshTrimsByMeshGroup.has(`${e}`)?this.meshTrimsByMeshGroup.get(`${e}`).values():[]}getAllMeshGroups(){return this.meshTrimsByMeshGroup.keys}*activeTrimsForMeshGroup(e){if(this.meshTrimsByMeshGroup.has(`${e}`))for(const t of this.meshTrimsByMeshGroup.get(`${e}`))t.enabled&&(yield t);if(this.meshTrimsByMeshGroup.has(`${m.Zu}`))for(const e of this.meshTrimsByMeshGroup.get(`${m.Zu}`))e.enabled&&(yield e)}isPointTrimmed(e,t){const i=t=>t.containsPoint(e);return this.isShapeTrimmed(Object.assign({intersectsOBB:i,isInsideOBB:i},t))}isSegmentTrimmed(e,t,i){const s=new o.Ray,n=new o.Vector3;return this.isShapeTrimmed(Object.assign({intersectsOBB:i=>{if(i.containsPoint(e)||i.containsPoint(t))return!0;s.origin.copy(e),s.direction.subVectors(t,e).normalize();const o=i.intersectRay(s,n);return!!o&&e.distanceToSquared(o)<=e.distanceToSquared(t)},isInsideOBB:i=>i.containsPoint(e)&&i.containsPoint(t)},i))}isShapeTrimmed({intersectsOBB:e,isInsideOBB:t,panoMode:i,meshGroup:o}){let s=void 0===o?this.meshTrimsById.values.filter((e=>e.enabled)):[...this.activeTrimsForMeshGroup(o)];i&&(s=s.filter((e=>e.activeInPanoMode)));let n=!1,a=!1;for(const i of s)if(i.discardContents){if(e(i.getOBB()))return!0}else n=n||t(i.getOBB()),a=!0;return!!a&&!n}reassignIndexes(e){e.forEach(((e,t)=>{e.index=t}))}sortList(e){e.sort(((e,t)=>e.index-t.index))}}class Ae extends s.nV{constructor(){super(...arguments),this.name="model-mesh",this.commands={MeshPreviewSetPositonCommand:k.P,SetPanoOverlayCommand:P.a},this.meshTrimData=new Be,this.inactiveMeshes=new Map,this.meshes=new s.Es,this.meshesLoaded=0,this.meshLoadPromises=new Map,this._firstMeshLoadPromise=new s.iB,this._renderMode=F.p.Hidden,this.onPanoOverlayCommand=e=>{for(const t of this.allMeshes())t.renderer.onPanoOverlayCommand(e)},this.meshTrimUpdateRenderMode=e=>{this.meshTrimUniforms&&e!==this.meshTrimUniforms.isPanoMode&&(this.meshTrimUniforms.isPanoMode=e,this.meshTrimUpdate(-1))},this.meshTrimFilter=e=>!(this.meshTrimData&&this.viewmodeData&&(0,be.dW)(e.object))||!this.meshTrimData.isPointTrimmed(e.point,{panoMode:this.viewmodeData.isPano(),meshGroup:e.object.meshGroup})}get firstMeshLoadPromise(){return this._firstMeshLoadPromise.nativePromise()}getMeshLoadPromise(e){return this.meshLoadPromises.get(e)||null}onActiveMeshesChanged(e){return this.meshes.onElementsChanged(e)}*allMeshes(){yield*this.meshes.values,yield*this.inactiveMeshes.values()}getAllMeshes(){const e=[];for(const t of this.allMeshes())e.push(t.modelMesh);return e}getMesh(e){var t,i;return(null===(t=this.meshes.get(e))||void 0===t?void 0:t.modelMesh)||(null===(i=this.inactiveMeshes.get(e))||void 0===i?void 0:i.modelMesh)||null}getMeshDetails(e){return this.meshes.get(e)||this.inactiveMeshes.get(e)||null}getMeshGroupVisuals(e){var t,i,o,s,n;return e?(null===(i=null===(t=this.meshes.get(e))||void 0===t?void 0:t.renderer)||void 0===i?void 0:i.meshGroupVisuals)||(null===(s=null===(o=this.inactiveMeshes.get(e))||void 0===o?void 0:o.renderer)||void 0===s?void 0:s.meshGroupVisuals)||null:0===this.meshes.length?null:null!==(n=this.meshes.values[0].renderer.meshGroupVisuals)&&void 0!==n?n:null}hasMesh(e){return this.meshes.has(e)||this.inactiveMeshes.has(e)||this.meshLoadPromises.has(e)}async init(e,t){C||(o.Mesh.prototype.raycast=M,o.BufferGeometry.prototype.computeBoundsTree=T,o.BufferGeometry.prototype.disposeBoundsTree=x,C=!0),this.engine=t,this.config=e,this.market=t.market;const[i,s,n,a,l,h,u,m]=await Promise.all([t.getModuleBySymbol(r.qL),t.getModuleBySymbol(r.jh),t.getModuleBySymbol(r.mL),t.getModuleBySymbol(r.M7),t.getModuleBySymbol(r.sA),t.getModuleBySymbol(r.kM),t.market.waitForData(v.X),t.getModuleBySymbol(r.Qm)]);this.viewmodeData=u,this.webglScene=a.getScene(),this.raycasterModule=l,this.input=n,this.cameraModule=s,this.chunkVisibilityChecker=new xe(this.webglScene,l.picking,s.cameraData.pose,m.viewportManager),s.cameraData.pose.onChanged((()=>this.chunkVisibilityChecker.resetCounter())),this.chunkSharedState=new Oe,this.chunkSharedState.maxVaryings=a.maxVaryings,this.meshTextureLoader=new we(e.textureLOD,i.getApi(),this.webglScene.camera,h,t,this.chunkVisibilityChecker,a),this.initRenderMode(e.startingMode,u),this.meshTrimInit(this.meshTrimData,l),this.bindings.push(this.engine.subscribe(p.A,(e=>{this.meshes.forEach((t=>{t.renderer.updateExistingTexture(e.sweepId,e.renderTarget.texture)}))}))),this.bindings.push(t.commandBinder.addBinding(k.P,this.setPreviewPosition.bind(this)),t.subscribe(g.ul,(()=>{this.meshTextureLoader.onWebGLContextLost()})),t.subscribe(g.aF,(()=>{this.meshTextureLoader.onWebGLContextRestored()})),t.commandBinder.addBinding(P.a,this.onPanoOverlayCommand.bind(this))),t.broadcast(new d.sb(c.D.ModelMesh)),t.broadcast(new d.sb(c.D.StreamingMesh)),t.broadcast(new d.sb(c.D.StreamingTexture))}onUpdate(e){this.chunkVisibilityChecker&&this.chunkVisibilityChecker.update(),this.meshTextureLoader&&!Q.Ay.debugPauseTexStream&&this.meshTextureLoader.update(e);const t=performance.now()/1e3;this.meshes.forEach((i=>{for(const e of i.modelMesh.chunks)e.setTime(t);i.modelMesh.onUpdate(e),i.renderer.onUpdate(e)}))}dispose(e){super.dispose(e),this.meshTextureLoader.dispose();const t=e=>{e.modelMesh.dispose(),e.roomMeshData.floors.clear(),e.roomMeshData.rooms.clear(),this.meshLoadPromises.delete(e.id)};for(const e of this.allMeshes())t(e);this.meshLoadPromises.size>0&&Promise.all(this.meshLoadPromises.values()).then((e=>{e.forEach((e=>e.forEach(t)))}))}async removeMesh(e){const t=this.meshes.get(e)||this.inactiveMeshes.get(e)||await this.meshLoadPromises.get(e)||null;t&&(await this.engine.removeComponent(this,t.renderer),t.modelMesh.dispose(),t.roomMeshData.floors.clear(),t.roomMeshData.rooms.clear(),t.modelMesh.unregisterCollision(this.input),this.meshes.delete(e),this.inactiveMeshes.delete(e),this.meshLoadPromises.delete(e))}async isolateMesh(e){this.meshes.get(e.sid)||this.inactiveMeshes.get(e.sid)||(this.meshLoadPromises.get(e.sid)?await this.meshLoadPromises.get(e.sid):await this.loadMesh(e,e.sid,{loadInactive:this.meshes.length>0,registerMeshAsDynamic:Object.keys(e.meshAssets).length>1}));for(const t of this.allMeshes())t.setActive(t.id===e.sid)}async loadMesh(e,t,i={loadInactive:!1,registerMeshAsDynamic:!1}){var s;const{loadInactive:a,registerMeshAsDynamic:l}=i,h=null===(s=i.useFallbackMesh)||void 0===s||s,d=i.container||new o.Group;d.name="meshes";const c=async s=>{this.meshesLoaded++;const{engine:a,config:c,meshTrimUniforms:m,chunkVisibilityChecker:p,chunkSharedState:g}=this,v=a.claimRenderLayer(Q.vz),f=this.isTiled(s),w=await this.getModelMeshFactory(f),y=new De.$;y.sourceViewId=s.modelId,y.layerId=e.layerId;const D=await w({uuid:e.uuid,model:s,renderLayer:v,engine:a,settings:Q.Ay,roomMeshData:y,chunkSharedState:g,chunkFactory:(e,t,i,o)=>{const n=s.key()||"unknown",a=new X(e,t,i,g,o,n,!0);if(m){const t=m.getSharedFloorUniforms(e);a.setMaterialsUniform(t)}return a},chunkVisibilityChecker:p,gltfConfig:c.gltfConfig});D.addToOctree=!l;const b=D.initTextureLoader(this.meshTextureLoader,s.textures),S=await a.market.waitForData(u.A),M=1===Object.keys(e.meshAssets).length?null:s.modelId,T=this.makeMeshData(M,D.chunks,S);1===this.meshesLoaded&&(this.raycasterModule.setupOctree(D.boundingBox.clone().applyMatrix4(D.matrixWorld)),this.market.register(De.$,y),this.market.register(O.U,T));const x=await a.getModuleBySymbol(r.Qm);let C=d;s.modelId!==e.sid&&(C=new o.Group,C.name=s.modelId,d.add(C)),this.setupRaycasting(D,this.input);const k=new le(C,D,T,S,g,c,x.viewportManager,this.cameraModule,h);k.meshGroupVisuals.floorOpacity.onChanged((()=>this.chunkVisibilityChecker.resetCounter()));const P=k.meshGroupVisuals.meshTextureOpacity;this.bindings.push(P.onActivate((()=>{this.meshTrimUpdateRenderMode(0===P.endValue)})),P.onComplete((()=>{this.meshTrimUpdateRenderMode(0===P.value)}))),await a.addComponent(this,k),this.setRenderModeMesh(D,k,this.getRenderMode()),D.overrideMaxDetail(this.getMeshDetail()),await b,C.position.copy(s.position),C.quaternion.copy(s.rotation),C.updateWorldMatrix(!1,!0);const F={id:t,meshData:T,modelMesh:D,roomMeshData:y,renderer:k,tiled:f,setActive:o=>{if(n.Vy.for(this).debug(`setActive:${o} for ${e.sid}`),o){if(!this.meshes.has(s.modelId)){n.Vy.for(this).debug("showing",e),this.inactiveMeshes.delete(s.modelId),this.meshes.set(s.modelId,F),D.registerCollision(this.input);const t=this.webglScene.getSubTree([e.sid]),i=t.children.find((e=>"meshes"===e.name));i&&i.removeFromParent(),t.add(d)}}else this.inactiveMeshes.has(t)||(d.removeFromParent(),i.container===d&&this.webglScene.scene.remove(d),D.unregisterCollision(this.input),this.meshes.delete(s.modelId),this.inactiveMeshes.set(s.modelId,F))}};return F},m=this.meshLoadPromises.get(t);if(m)return m;const p=0===this.meshesLoaded,g=(async()=>{const t=[];for(const i of Object.values(e.meshAssets))t.push(await c(i));return t})();this.meshLoadPromises.set(t,g);const v=await g;return v.forEach((e=>e.setActive(!a))),p&&this._firstMeshLoadPromise.resolve(),v}async getModelMeshFactory(e=!0){return(e?await Promise.all([i.e(2026),i.e(8287),i.e(1916),i.e(4892),i.e(7392),i.e(5834),i.e(4015),i.e(3443),i.e(9114)]).then(i.bind(i,16284)):await Promise.all([i.e(2026),i.e(8287),i.e(1916),i.e(4892),i.e(7392),i.e(5834),i.e(4015),i.e(3443),i.e(9114)]).then(i.bind(i,59228))).createModelMesh}setupRaycasting(e,t){e.registerCollision(t)}setChunkSide(e){const t=this.chunkSharedState.side;return this.chunkSharedState.side=e,t}getChunkRenderingMode(){return this.chunkSharedState.renderingMode}stats(){return{textureCount:this.meshTextureLoader.textureCount,streaming:[...this.meshes.values].some((e=>e.tiled))}}getRenderMode(){return this._renderMode}setRenderMode(e,t=0,i=h.AU){for(const o of this.allMeshes())this.setRenderModeMesh(o.modelMesh,o.renderer,e,t,i);n.Vy.for(this).debug(`setRenderMode from ${this._renderMode} to ${e}`),this._renderMode=e}setMeshOptions(e){var t;for(const i of this.allMeshes()){const o=null!==(t=e.overrideMaxDetail)&&void 0!==t?t:i.modelMesh.detail;i.modelMesh.overrideMaxDetail(o)}}getMeshDetail(){let e="default";return this.meshes.forEach((t=>e=t.modelMesh.detail)),e}setTextureLimits(e,t){for(const i of this.allMeshes())i.modelMesh.setTextureQuality(this.meshTextureLoader,e,t)}setTextureStreamMode(e){switch(e){case V.R.NONE:this.meshTextureLoader.autoLoadTiles=!1;break;case V.R.RAYCAST:this.meshTextureLoader.autoLoadTiles=!0}}setRenderModeMesh(e,t,i,o=0,s=h.AU){let n=1;switch(i){case F.p.Hidden:n=1,e.visible=!1;break;case F.p.Mesh:n=1,e.visible=!0;break;case F.p.PanoramaMesh:n=0,e.visible=!0;break;case F.p.PanoramaCube:n=0,e.visible=!1;break;default:throw new Error(`unknown mode ${i}!`)}const a=t.meshGroupVisuals.meshTextureOpacity;return a.value===n&&a.easing===s&&a.duration===o||(a.modifyAnimation(a.value,n,o,s),0===o&&(t.onUpdate(1/60),t.updateRenderState(),t.beforeRenderViewport(1/60))),n}initRenderMode(e,t){let i=e;switch(null===i&&(i=t.transition.active?t.transition.to:t.currentMode),i){case f.N3.Dollhouse:case f.N3.Floorplan:case f.N3.Mesh:this.setRenderMode(F.p.Mesh);break;case f.N3.ExteriorSplat:this.setRenderMode(F.p.Hidden);break;default:this.setRenderMode(F.p.PanoramaMesh)}this.bindings.push(t.transitionActiveObservable.onChanged((e=>{if(e){const e=this.viewmodeData.transition.to===f.N3.Panorama,t=this.viewmodeData.transition.to===f.N3.ExteriorSplat,i=this.viewmodeData.transition.from!==f.N3.Panorama,o=e?F.p.PanoramaMesh:t?F.p.Hidden:F.p.Mesh,s=i?100:0,n=e?h.AU:h.p_;this.setRenderMode(o,s,n)}else this.viewmodeData.isExterior()&&this.setRenderMode(F.p.Hidden,0)})))}makeMeshData(e,t,i){var s;const n=new Map,a=new Map,r=new Map,h=new o.Box3,d=new o.Vector3;t.forEach((e=>{if(e.geometry.boundingBox&&h.union(e.geometry.boundingBox),e.geometry){const i=(0,H.yL)(e.geometry);r.set(e,i),d.addScaledVector(i,1/t.length)}n.set(e.meshGroup,(n.get(e.meshGroup)||[]).concat(e)),a.set(e.meshSubgroup,(a.get(e.meshSubgroup)||[]).concat(e))}));const c=h.clone(),u=new o.Box3;i.getCollectionUnfiltered().forEach((t=>{t.isUnplaced()||t.sourceViewId!==e||(u.setFromCenterAndSize(t.position,l.B1.UNIT),c.union(u))}));const m=new O.U([...h.min.toArray(),...h.max.toArray()],[...c.min.toArray(),...c.max.toArray()],d);for(const[e,t]of n.entries()){const i=new o.Box3,n=new o.Vector3;t.forEach((e=>{e.geometry.boundingBox&&i.union(e.geometry.boundingBox);const o=r.get(e);o&&n.addScaledVector(o,1/t.length)})),m.meshGroups.floors.set(e,{meshGroup:e,boundingBox:i,parentMeshGroup:null,centerOfMass:n});const l=[...new Set(t.map((e=>e.meshSubgroup)))].sort(((e,t)=>t-e));m.meshGroups.roomsByFloor.set(e,l);const h=m.meshGroups.rooms;for(const t of l){const i=new o.Box3,n=new o.Vector3,l=a.get(t)||[];l.forEach((e=>{e.geometry.boundingBox&&i.union(e.geometry.boundingBox);const t=r.get(e);t&&n.addScaledVector(t,1/l.length)}));const d={meshGroup:t,boundingBox:i,parentMeshGroup:e,centerOfMass:n},c=h.get(t);c?c.parentMeshGroup=Math.min(null!==(s=c.parentMeshGroup)&&void 0!==s?s:1/0,e):h.set(t,d)}}const p=[...m.meshGroups.floors.keys()].sort();return this.meshTrimData.addMeshGroups(p),m}async setPreviewPosition(e){const t=e.enabled&&e.previewCirclePosition?e.previewCirclePosition:null,i=e.size?e.size:.3;this.meshes.forEach((e=>{e.modelMesh.chunks.forEach((e=>{e.setMeshPreviewSphere(t,i)}))}))}setMeshOpacity(e,t){const i=e.length>0?e:this.meshes.keys;for(const e of i){const i=this.meshes.get(e)||this.inactiveMeshes.get(e);if(!i)throw Error("Unknown mesh id");i.renderer.opacity=t}}setMeshOpacityModifier(e,t){const i=e.length>0?e:this.meshes.keys;for(const e of i){const i=this.meshes.get(e);if(!i)throw Error("Unknown mesh id");i.renderer.meshGroupVisuals.globalOpacityModifier.value=t}}setChunkRenderingMode(e){for(const t of this.allMeshes())t.renderer.setChunkRenderingMode(e)}setMaterialUniforms(e){for(const t of this.allMeshes())t.modelMesh.chunks.forEach((t=>{t.setMaterialsUniform(e)}))}setMeshOverlay(e){const t=e.meshIds||null;for(const i of this.allMeshes())t&&-1===t.indexOf(i.id)||i.renderer.setMeshOverlay(e.selectBy,e.colorizeStyle,e.color||null,e.alpha||.5,e.index)}setMeshesOverlay(e){for(const t of this.allMeshes()){const i=e.get(t.id);void 0!==i&&t.renderer.setMeshOverlay("all","explicit",i,.5)}}isTiled(e){var t,i;const o=null!==(i=null===(t=this.engine.tryGetModuleBySymbolSync(a.ZF))||void 0===t?void 0:t.tryGetSetting(Q.sz,!1))&&void 0!==i&&i;return!!e.tileset&&o&&!(0,n.w2)()}meshTrimInit(e,t){this.meshTrimUniforms=new I(this.getRenderMode()===F.p.PanoramaMesh);const{meshTrimsByMeshGroup:i}=e;this.bindings.push(e.onMeshGroupChanged((e=>this.meshTrimUpdate(e))),e.onMeshTrimChanged((e=>{this.meshTrimUpdate(e.meshGroup)}))),i.keys.forEach((e=>{this.meshTrimUpdate(e)}));const o=()=>{t.setIntersectionFilter(e.meshTrimsById.values.some((e=>e.enabled))?this.meshTrimFilter:null)};this.bindings.push(e.onChanged(o)),o()}meshTrimUpdate(e){const t=e!==m.Zu?[e]:this.meshTrimData.getAllMeshGroups();for(const e of t){const t=this.meshTrimData.getTrimsForMeshGroup(e);this.meshTrimUniforms.setFloorTrims(e,t);for(const e of this.allMeshes())e.modelMesh.chunks.forEach((e=>{e.setMaterialsUniform(this.meshTrimUniforms.getSharedFloorUniforms(e.meshGroup))}))}}}},99276:(e,t,i)=>{"use strict";i.d(t,{B:()=>h});var o=i(68909),s=i(77201),n=i(30443),a=i(37458),r=i(5984),l=i(47299);class h extends r.r{constructor(e,t,i=s.HU.ALL){super(),this._opacity=1,this._chunks=[],this.size=new o.Vector3,this.center=new o.Vector3,this.built=!1,this.layers.mask=i.mask,this.meshGroup=e,this.meshSubgroup=t,this.renderOrder=a.X.default,this.castShadow=h.ShouldCastShadow,this.onBeforeRender=(e,t,i,o,s,n)=>{this.updateUniforms(s,n)}}dispose(){this.reset()}reset(){this._chunks.length=0,this.geometry.dispose(),delete this.onBuild,delete this.onOpacityUpdate,this.built=!1}addChunk(e){-1===this._chunks.indexOf(e)&&this._chunks.push(e)}getChunk(e){return this._chunks[e]}build(){if(this.built)throw new Error("build() should only be called once");if(!this._chunks.length)return;this.name=`RoomMesh:${this.meshGroup}-${this.meshSubgroup}`;const e=(0,n.h0)(this._chunks.map((e=>e.geometry)));e.clearGroups();let t=0;this.material=[],this._chunks.forEach(((i,o)=>{i.geometry&&i.geometry.index&&(e.addGroup(t,i.geometry.index.count,o),t+=i.geometry.index.count,i.geometry.dispose(),i.geometry=e,i.notifyOnMaterialUpdated((e=>{Array.isArray(this.material)&&(this.material[o]=e),this.onMaterialUpdate&&this.onMaterialUpdate()})),i.onOpacityUpdate=e=>{this.opacity=e})})),this.geometry=e,this.geometry.computeBoundingBox(),this.geometry.computeBoundingSphere(),this.material=this._chunks.map((e=>e.material)),this.size=this.boundingBox.getSize(this.size),this.center=this.boundingBox.getCenter(this.center),this.built=!0,this.onBuild&&this.onBuild()}buildWithSingleChunk(e){if(this.built)return;const{meshGroup:t,meshSubgroup:i,lod:o}=e;this.name=`RoomMesh:${o}-${t}-${i}-${e.chunkIndex} | ${this.name}`,this.meshGroup=t,this.meshSubgroup=i,this._chunks.push(e),e.notifyOnMaterialUpdated((e=>{this.material=e,this.onMaterialUpdate&&this.onMaterialUpdate()})),e.onOpacityUpdate=e=>{this.opacity=e},this.size=this.boundingBox.getSize(this.size),this.center=this.boundingBox.getCenter(this.center),this.built=!0,this.onBuild&&this.onBuild()}updateUniforms(e,t){e instanceof o.ShaderMaterial&&(t?this.chunks[t.materialIndex].onBeforeDraw(e):this.chunks.length&&this.chunks[0].onBeforeDraw(e))}get boundingBox(){return(0,n.UX)(this.geometry)}set opacity(e){e!==this.opacity&&(this._opacity=e,this.raycastEnabled=e>l.u7.FADE_CLICKABLE_THRESHOLD,this.renderOrder=e<l.u7.FADE_OPAQUE?a.X.ghostFloor:a.X.default,this.onOpacityUpdate&&this.onOpacityUpdate(e))}get opacity(){return this._opacity}get chunks(){return this._chunks}getSortKey(){return this.chunks.length?this._chunks[0].getSortKey():0}}h.ShouldCastShadow=!1},21100:(e,t,i)=>{"use strict";i.d(t,{$:()=>s});var o=i(77201);class s extends o.B_{constructor(){super(),this.name="room-mesh-data",this.floors=new Set,this.rooms=new Set}}},37374:(e,t,i)=>{"use strict";i.d(t,{a:()=>s});var o=i(77201);class s extends o.uB{constructor(e,t,i){super(),this.payload={sweepId:e,texture:t,quaternion:i}}}s.id="SET_PANO_OVERLAY"},85227:(e,t,i)=>{"use strict";var o;i.d(t,{p:()=>o}),function(e){e.Mesh="mesh",e.PanoramaMesh="mesh.inside",e.PanoramaCube="cubemap.inside",e.Hidden="mesh.hidden"}(o||(o={}))},59228:(e,t,i)=>{"use strict";i.r(t),i.d(t,{createModelMesh:()=>M});var o=i(71687),s=i(44345),n=i(68909),a=i(77201),r=i(97800),l=i(23870),h=i(99276),d=i(75078);class c extends n.Object3D{constructor(e,t=a.HU.ALL){super(),this.renderLayer=t,this.roomMeshes=new l.A((e=>e.meshSubgroup)),this.boundingBox=new n.Box3,this.size=new n.Vector3,this.center=new n.Vector3,this._chunks=[],this.built=!1,this.name=`FloorMesh:${e}`,this.meshGroup=e}dispose(){this.reset(),this.roomMeshes.clear()}reset(){for(const e of this.roomMeshes)e.dispose(),this.remove(e);this._chunks.length=0,this.built=!1}addChunk(e){const t=this.getOrCreateRoomMesh(e.meshSubgroup);this._chunks.push(e),t.addChunk(e)}build(){if(this.built)throw new Error("build() should only be called once");this.boundingBox.makeEmpty();for(const e of this.roomMeshes)this.add(e),this.boundingBox.union(e.boundingBox);this.center=this.boundingBox.getCenter(this.center),this.size=this.boundingBox.getSize(this.size),this.built=!0}get chunks(){return this._chunks}getOrCreateRoomMesh(e){let t=this.roomMeshes.get(e);if(!t){t=new h.B(this.meshGroup,e,this.renderLayer),t.layerId=this.layerId,t.sourceViewId=this.sourceViewId;const i=new d.$(t);this.roomMeshes.add(t),this.add(t),this.add(i)}return t}}var u=i(52018);class m extends u.t{constructor(e){super(e),this.name="MeshCreationException"}}var p=i(93121),g=i(70497);var v=i(15335),f=i(39994);const w=new r.Vy("dam-loader");class y{constructor(e){this.chunkFactory=e,this.decoder=i(27419)}async load(e,t,i){w.time("download");const o=await t.get(e,{responseType:"arraybuffer",onProgress:i});return w.timeEnd("download"),this.parse(o)}parse(e){w.time("parse proto");const t=this.decoder.binary_mesh.read(new v(e));w.timeEnd("parse proto"),w.time("convert to webgl");const i=this.convertProtobufToSceneObject(t);return w.timeEnd("convert to webgl"),i}convertProtobufToSceneObject(e){if(0===e.chunk.length)return w.warn("No chunks in damfile..."),[];const t=new n.Matrix4;t.set(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1);return e.chunk.map((e=>{const i=new n.BufferGeometry;i.setAttribute("position",new n.BufferAttribute(new Float32Array(e.vertices.xyz),3)),e.vertices.uv.length>0&&i.setAttribute("uv",new n.BufferAttribute(new Float32Array(e.vertices.uv),2)),i.setIndex(new n.BufferAttribute(new Uint32Array(e.faces.faces),1)),i.applyMatrix4(t),i.computeBoundingBox();const{group:o,subgroup:s}=(0,f.g8)(e.chunk_name);return this.chunkFactory(o,s,i,e.material_name)}))}}class D{static async load(e,t,i,o,s=0){const n=new y(t),a=i[s];if(!a)return Promise.reject("No suitable model file found...");const r=await a.url.get();return n.load(r,e,o).catch((()=>this.load(e,t,i,o,++s)))}}const b=new r.Vy("mesh");class S extends p.o{constructor(e,t,i=a.HU.ALL,o){var s;super(),this.uuid=e,this.api=t,this.renderLayer=i,this.damMeshUrls=o,this.floorMeshes=new l.A((e=>e.meshGroup)),this.built=!1,this.name=`ModelMesh:${e}`,this.layers.mask=i.mask,(s=this.textureQualityMap).reset(),s.registerQualities(g.X.Standard,512,.048,.5,"low"),s.registerQualities(g.X.Standard,2048,.012,.5,"high")}dispose(){super.dispose(),this.floorMeshes.mapElements((e=>{e.dispose(),this.remove(e)})),this.floorMeshes.clear(),this.built=!1}reset(){this.floorMeshes.mapElements((e=>{e.reset(),this.remove(e)})),this._chunks.length=0,this.built=!1}async load(e){const{roomMeshData:t}=e;(0,r.w2)()&&(e.chunks=[]);let i=e.chunks?e.chunks:await D.load(this.api,e.chunkFactory,this.damMeshUrls,e.onProgress).catch((e=>{b.error(e);const t=e instanceof Error?e.message:"Failed to load model mesh";throw new m(t)}));if(0===i.length){b.warn("No geometry found for model, loading faux geometry, disabling outside view-mode");const t=new n.PlaneGeometry(5,5,1,1);t.rotateX(-Math.PI/2),t.computeBoundingBox();const o=e.chunkFactory(0,0,t);o.sharedState.forEachChunkMaterial((e=>e.visible=!1)),i=[o]}i.forEach((e=>{this.addChunk(e)})),this.build(t)}addChunk(e){const t=this.getOrCreateFloorMesh(e.meshGroup);this._chunks.push(e),t.addChunk(e)}build(e){var t,i;if(this.built)throw new Error("build() should only be called once");let o=0,s=0;for(const e of this.floorMeshes){this.add(e);for(const s of e.roomMeshes)s.build(),s.geometry.boundsTree||null===(i=(t=s.geometry).computeBoundsTree)||void 0===i||i.call(t),o++;e.build(),s++}b.debug(`FloorMeshes: ${s} RoomMeshes: ${o} Chunks: ${this._chunks.length}`),this.boundingBox.makeEmpty();for(const e of this.floorMeshes)this.boundingBox.union(e.boundingBox);this.size=this.boundingBox.getSize(this.size),this.center=this.boundingBox.getCenter(this.center),e.root=this,e.floors=new Set(this.floorMeshes),e.rooms=this.roomMeshes,e.commit(),this.built=!0}get roomMeshes(){const e=new Set;for(const t of this.floorMeshes)for(const i of t.roomMeshes)e.add(i);return e}async initTextureLoader(e,t){e.limitMemoryUsage=!1,e.setModel(this,this.chunks,t),await e.loadAll(this,this.textureQualityMap.min(g.X.Standard))}registerCollision(e){e.registerMesh(this,this.addToOctree);for(const t of this.roomMeshes)e.registerSnappingMeshGeometry(t.name,t.geometry,{meshGroup:t.meshGroup})}unregisterCollision(e){e.unregisterMesh(this);for(const t of this.roomMeshes)e.unregisterSnappingMeshGeometry(t.name)}setTextureQuality(e,t,i){e.setQuality(t,i)}onUpdate(){}getOrCreateFloorMesh(e){let t=this.floorMeshes.get(e);return t||(t=new c(e,this.renderLayer),this.floorMeshes.add(t),this.add(t)),t}}const M=async function({model:e,renderLayer:t,engine:i,chunkFactory:n,roomMeshData:a}){var r;const[l]=await Promise.all([i.getModuleBySymbol(o.qL)]),h=e.meshUrls||[],d=new S(null===(r=h[0])||void 0===r?void 0:r.uuid,l.getApi(),t,h);return await d.load({roomMeshData:a,chunkFactory:n,onProgress:e=>{i.broadcast(new s.EX(e.loaded,e.total))}}),d}},16284:(e,t,i)=>{"use strict";i.r(t),i.d(t,{createModelMesh:()=>a});var o=i(71687),s=i(10459),n=i(90351);const a=async function({uuid:e,model:t,engine:i,renderLayer:a,settings:r,roomMeshData:l,chunkFactory:h,chunkVisibilityChecker:d,chunkSharedState:c,gltfConfig:u}){const[m,p,g]=await Promise.all([i.getModuleBySymbol(o.M7),i.getModuleBySymbol(o.qL),i.market.waitForData(s.M)]),v=new n.f(e,a,c);return await v.load(i,m,m.getCamera(),g,t.tileset,l,h,d,p.getApi(),u),v}},93224:(e,t,i)=>{"use strict";i.r(t),i.d(t,{Cursor:()=>s.b,SetMouseCursorCommand:()=>n.X,default:()=>a});var o=i(77201),s=i(77510),n=i(35699);class a extends o.nV{constructor(){super(...arguments),this.name="mouse-cursor",this.activeCursor=null}async init(e,t){this.config=Object.assign({classPrefix:"cursor"},e),this.bindings.push(t.commandBinder.addBinding(n.X,(async e=>this.changeCursor(e.cursor))))}changeCursor(e){const{container:t,classPrefix:i}=this.config;e!==this.activeCursor&&(this.activeCursor&&t.classList.remove(`${i}-${this.activeCursor}`),e&&t.classList.add(`${i}-${e}`),this.activeCursor=e)}}},12014:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>Pe});var o=i(77201),s=i(25316),n=i(71687),a=i(10459),r=i(13893),l=i(62568),h=i(90834),d=i(9997),c=i(27960);class u extends c.d{constructor(e){super(e),this.name="NavigationException"}}const m={Locked:"Cannot move while navigation is locked",InsideOnly:"Cannot navigate between panos when not in Panorama mode",InvalidSweep:"Not at a valid sweep",InTransition:"Cannot move while in a transition",NoDestinationFound:"Cannot move in that direction",InvalidMode:"Cannot move to mode"};var p=i(68909),g=i(97800),v=i(31002),f=i(23184),w=i(3694),y=i(6687),D=i(63362),b=i(35699),S=i(77510),M=i(45979);var T=i(52026);class x{constructor(e,t,i,o,s,n,a,r,l,h,d){this.canStartTransition=e,this.commandBinder=t,this.input=i,this.floorsViewData=o,this.floorsViewDataModule=s,this.navigation=n,this.sweepData=a,this.cameraController=r,this.meshQuery=l,this.doubleClickToEnter=h,this.hasRoomBounds=d,this.bindings=[],this.cancelTransition=!1,this.targetFloorId=null,this.targetHitPoint=new p.Vector3,this.changeFloorPromise=null,this.toggleInput=e=>{this.bindings.forEach((t=>e?t.renew():t.cancel()))},this.onRoomClick=(e,t,i)=>{if(!this.canStartTransition())return!1;if(this.changeFloorPromise)return!0;if(!i||!i.point)return!1;const o=this.meshQuery.floorIdFromObject(t);if(!o)return!1;if(!this.floorsViewData.isNavigable(o))return this.onBackgroundClick();if(this.cancelTransition)return!0;const s=this.floorsViewData.currentFloorId;return 1!==this.floorsViewData.totalFloors&&o!==s?(this.targetFloorId||(this.targetFloorId=o,this.targetHitPoint.copy(i.point)),!s&&(this.changeFloorIfNeeded(),!0)):this.floorsViewData.roomSelectModeActive||this.floorsViewData.floorSelectModeActive?!!this.doubleClickToEnter||this.roomNavZoom(e,t,i):this.floorsViewData.floorSelectModeActive?(this.cancelTransition=!1,!1):(this.navigation.focus(i.point).then((()=>{this.cancelTransition||this.setFocusSweep(i),this.cancelTransition=!1})),!0)},this.roomNavZoom=(e,t,i)=>!i||(this.cancelTransition=!0,(async()=>{this.doubleClickToEnter||this.hasRoomBounds&&await(0,g.cb)(100),await this.changeFloorPromise,await this.cameraController.cancelTransition(),this.navigation.navigateToPanoNearIntersection(i),this.cancelTransition=!1})(),this.commandBinder.issueCommand(new b.X(S.b.DEFAULT)),!0),this.onBackgroundClick=()=>!!this.canStartTransition()&&(!!this.floorsViewData.isMultifloor()&&(!!this.floorsViewData.showAllFloorsOption&&(!this.targetFloorId&&(!!this.cancelTransition||(this.cancelTransition=!0,void this.cameraController.cancelTransition().then((()=>this.floorsViewDataModule.moveToFloor(null,{suppressCameraMovement:!1}))).then((()=>{this.cancelTransition=!1}))))))),this.onFloorChange=()=>{null===this.floorsViewData.currentFloorId&&this.commandBinder.issueCommand(new b.X(S.b.DEFAULT))},this.clearFloorChange=()=>{this.targetFloorId=null},this.changeFloorIfNeeded=async()=>{this.targetFloorId&&(this.changeFloorPromise=this.floorsViewDataModule.moveToFloor(this.targetFloorId,{suppressCameraMovement:!1,focusPoint:this.targetHitPoint}),await this.changeFloorPromise,this.targetFloorId=null,this.changeFloorPromise=null)},this.bindings.push(this.input.registerMeshHandler(v.rX,f.f.is(y.aV),this.onRoomClick,{default:!0}),this.input.registerUnfilteredHandler(v.rX,this.clearFloorChange),this.input.registerHandler(v.rX,this.changeFloorIfNeeded),this.input.registerMeshHandler(v.rX,f.f.isType(w.W),this.onBackgroundClick,{default:!0}),this.floorsViewData.makeFloorChangeSubscription(this.onFloorChange)),h&&this.bindings.push(this.input.registerMeshHandler(v.wR,f.f.is((e=>(0,y.aV)(e)||function(e){return e instanceof M.z&&!!e.visible}(e))),this.roomNavZoom,{default:!0}))}async setFocusSweep(e){if(!this.canStartTransition())return;if(this.cancelTransition)return;const t=(0,T.I9)(this.sweepData,!1,e,this.meshQuery);t.length>0&&t[0].sweep&&await this.commandBinder.issueCommand(new D.HP(t[0].sweep.id))}}var C=i(81662),k=i(71397),P=i(44667),F=i(60043),V=i(28337),O=i(5984),I=i(72268);const B=new g.Vy("nav-input");class A{constructor(e,t,i){this.navigation=e,this.inputIni=t,this.insideNav=[],this.insideVrNav=[],this.toggleInput=e=>{this.insideNav.forEach((t=>e?t.renew():t.cancel()))},this.toggleVrInput=e=>{this.insideVrNav.forEach((t=>e?t.renew():t.cancel()))},this.registerInsideClickHandlers=e=>[e.registerMeshHandler(v.rX,f.f.is(y.aV),((e,t,i)=>(this.tryExecuteAction(((e,t)=>_(e)&&N(t)),((e,t)=>N(t)&&this.navigation.navigateTowardsIntersection(t)),e,i),!0)),{default:!0}),e.registerMeshHandler(v.rX,f.f.isType(w.W),((e,t,i)=>this.tryExecuteAction(((e,t)=>_(e)&&N(t)),((e,t)=>N(t)&&this.navigation.navigateTowardsIntersection(t)),e,i)),{default:!0})],this.registerVrClickHandlers=e=>[e.registerMeshHandler(v.rX,f.f.isInstanceOf(O.r),((e,t,i)=>(this.tryExecuteAction(((e,t)=>_(e)&&N(t)),((e,t)=>N(t)&&this.navigation.navigateToPanoNearIntersection(t)),e,i),!0)),{default:!0})],this.registerWheelInput=e=>[e.registerHandler(P.s,(e=>this.tryExecuteAction((e=>!0),(e=>{if(e instanceof P.s){const t=new p.Vector3(0,0,Math.sign(e.delta.y));return!!this.navigation.navigateInLocalDirection(t)}return!1}),e)))],this.hotkeys=e=>[e.registerHandler(F.k,(e=>this.tryExecuteAction((e=>(E(e)||R(e))&&e.key in A.hotkeyDirections),(e=>{if(E(e)){this.continuousMovementHotkey=e.key;const t=A.hotkeyDirections[e.key];this.navigation.setContinuousNavigationLocalDirection(t)}else R(e)&&e.key===this.continuousMovementHotkey&&this.navigation.setContinuousNavigationLocalDirection();return!1}),e)))],this.tryExecuteAction=(e,t,i,o)=>{let s=!1;try{this.navigation.isNavigationInputAllowed()&&e(i,o)&&(s=t(i,o))}catch(e){if(!(e instanceof u))throw B.warn(e),e;B.debug(e)}return s},this.insideVrNav.push(...this.registerVrClickHandlers(this.inputIni)),this.insideNav.push(...this.registerInsideClickHandlers(this.inputIni),...this.hotkeys(this.inputIni)),i&&this.insideNav.push(...this.registerWheelInput(this.inputIni))}get bindings(){return[...this.insideNav,...this.insideVrNav]}}function N(e){return void 0!==e&&void 0!==e.point}function E(e){return e instanceof F.k&&e.state===V.$.DOWN}function R(e){return e instanceof F.k&&e.state===V.$.UP}function _(e){return e instanceof v.rX&&e.button===I.m.PRIMARY}A.hotkeyDirections={[k.D.W]:C.B1.FORWARD,[k.D.A]:C.B1.LEFT,[k.D.S]:C.B1.BACK,[k.D.D]:C.B1.RIGHT,[k.D.UPARROW]:C.B1.FORWARD,[k.D.DOWNARROW]:C.B1.BACK};var L=i(12837),z=i(46793),U=i(99583),G=i(2993),j=i(88664),H=i(39209),Q=i(96319),$=i(40397),W=i(51666);function q(e){if(e&&"object"==typeof e&&"min"in e&&"max"in e){const t=e;if((0,W.Z)(t.min)&&(0,W.Z)(t.max))return!0}return!1}var K=i(25481);function Z(e){if(e&&"object"==typeof e&&"x"in e&&"y"in e){const t=e;return(0,K.Et)(t.x)&&(0,K.Et)(t.y)}return!1}function Y(e){if(e&&"object"==typeof e&&"min"in e&&"max"in e){const t=e;if(Z(t.min)&&Z(t.max))return!0}return!1}var X=i(65882);var J=i(53172);class ee{constructor(e,t,i){this.canStartTransition=e,this.cameraModule=t,this.viewmodeData=i,this.focus=this.focus.bind(this),this.focusFloorplan=this.focusFloorplan.bind(this)}async focus(e,t){if(!this.canStartTransition())return;let i,o,s;q(e)?(o=e,i=o.getCenter(new p.Vector3)):Y(e)?(o=new p.Box3,o.min.set(e.min.x,0,e.min.y),o.max.set(e.max.x,0,e.max.y),s=new p.Box2(e.min,e.max),i=o.getCenter(new p.Vector3)):(i=e,o=void 0);const{from:n,transition:a,mode:l}=null!=t?t:{},h=this.cameraModule.cameraData;let{position:d,rotation:c,focalDistance:u}=h.pose;const m=h.pose.pitchFactor()<.01;if(l!==G.N3.Dollhouse||!m&&!1!==(null==t?void 0:t.forceOrtho)||(c=(0,$.MN)(c,-55)),s&&Y(s)||(null==t?void 0:t.forceOrtho)||l===G.N3.Floorplan){if(s||(o&&(s=new p.Box2(new p.Vector2(o.min.x,o.min.z),new p.Vector2(o.max.x,o.max.z))),!o&&i&&(s=new p.Box2(new p.Vector2(i.x-5,i.z-5),new p.Vector2(i.x+5,i.z+5)))),!s)throw new Error("Floorplan mode requires a box or point");return this.focusFloorplan(i,s,l===G.N3.Dollhouse)}n?(d=n,c=(0,$.kf)(d,i)):o?({focalDistance:u,rotation:c,position:d}=this.getPoseForBox({box:o,targetRotation:c})):d=(0,$.fg)(c,i,u);const g={pose:{position:d,rotation:c},transitionType:null!=a?a:r.fl.Interpolate,focalDistance:u,transitionTime:X.U.TRANSITION_TIME_DH,autoOrtho:m};return this.cameraModule.getCameraControllerForData(h).moveTo(g).nativePromise()}async focusFloorplan(e,t,i){const o=this.cameraModule.cameraData,s=this.cameraModule.getCameraControllerForData(o);i&&await s.moveTo({transitionType:r.fl.OrbitTo,pose:{},autoOrtho:!0,targetPhi:r.mG.Top});const n=function(e,t,i,o){const s=e.pose,n=(new p.Vector3).copy(i());let a=null,r=s.focalDistance;const l=o.min.distanceTo(o.max)/(0,$.ff)(s.position.distanceTo(n),s.projection.asThreeMatrix4(),e.width)/e.screenDiagonalPx,h=l<.2,d=l>1.2,c=(h?.2+.1:1.2-.1)/l;if(t.isFloorplan()&&(n.y=s.position.y,r=s.focalDistance,a=s.projection.clone(),(h||d)&&(a.elements[0]*=c,a.elements[5]*=c)),t.isDollhouse()&&(n.y=s.fovCorrectedPosition().y,r=s.fovCorrectedFocalDistance(),h||d)){const e=s.fovCorrectedFocalDistance()/c,t=s.fovCorrectedPosition().y-s.fovCorrectedFocalDistance()+e;n.y=t,r=e}return{position:n,projection:a,focalDistance:r}}(o,this.viewmodeData,(()=>e),t);return s.moveTo({pose:{position:n.position},projection:n.projection?n.projection:void 0,transitionType:r.fl.Interpolate,transitionTime:X.U.TRANSITION_TIME_ROOM,autoOrtho:o.pose.autoOrtho,focalDistance:n.focalDistance}).nativePromise()}getPoseForBox({box:e,targetRotation:t}){let i=this.cameraModule.cameraData.pose;i.pitchFactor()<.01&&(i=i.clone(),i.unapplyPhiBasedFovSquish(),i.resetProjMatrix());const o=t||i.rotation,s=35*J.fy;(0,$.nk)(o,s);const n=i.aspect(),a=e.getCenter(new p.Vector3),r={targetPosition:a,targetRotation:o.clone(),angleDown:undefined,box:e,fovY:i.fovY(),aspectRatio:n},l=(0,$.hm)(r),h=a.distanceTo(l.position);return{position:l.position,rotation:l.rotation,focalDistance:h}}}var te=i(78229),ie=i(96659),oe=i(19968),se=i(73065);const ne=!0,ae=8,re=.1,le=-25,he=500,de=-2,ce=32,ue=32;class me{constructor(e,t,i,o){this.viewmodeModule=e,this.picking=t,this.issueCommand=i,this.navigateToSweep=o,this.sweepCanSeeNote=(()=>{const e=new p.Vector3;return(t,i)=>{e.copy(t).sub(i.position);const o=e.length();e.normalize();let s=this.picking.pick(i.position,e,y.aV);return(!s||s.distance>o)&&(s=this.picking.pick(t,e.negate(),y.aV)),!s||o<=s.distance}})(),this.notTooCloseFilter=e=>t=>Math.abs(t.position.x-e.x)>re||Math.abs(t.position.z-e.z)>re,this.notTooFarFilter=e=>t=>t.position.distanceTo(e)>ae,this.withinLatitudeFilter=e=>t=>{const i=(new p.Vector3).copy(e).sub(t.position),o=-Math.atan(i.y/Math.sqrt(i.x*i.x+i.z*i.z)),s=(0,J.pu)(le);return se.ol-s<o&&o<se.vc+s},this.scoreByLatitude=(()=>{const e=new p.Vector3;return(t,i)=>o=>{e.copy(t).sub(o.position);const s=Math.abs(Math.atan(e.y/Math.sqrt(e.x*e.x+e.z*e.z)))/(Math.PI/2),n=Math.floor(20*s)/20;return i*(1-n)}})(),this.scoreByDirection=(()=>{const e=new p.Vector3,t=new p.Vector3;return(i,o,s)=>n=>{if(Math.abs(o.dot(C.B1.UP))>.75)return 0;t.copy(o).normalize(),e.copy(i).sub(n.position).normalize();return-1*e.dot(t)*s}})(),this.scoreByFloor=(e,t)=>i=>i.floorId===e?t:0}async focusPin({position:e,transition:t,onSweepChosen:i,orientationAdjust:o,neighborDistanceThreshold:s,viewportState:n,sweepFilters:a}){const{anchorPosition:r,stemNormal:l,stemLength:h}=e,d=r.clone().add(l.clone().setLength(h)),c=[this.scoreByDirection(d,l,ue),this.scoreByFloor(e.floorId,32)];return this.focusPoint({position:d,transition:t,onSweepChosen:i,orientationAdjust:o,neighborDistanceThreshold:s,scorers:c,viewportState:n,filters:a})}focus(e,t,i){var o;let s;if(q(e))s=e.getCenter(new p.Vector3);else if(Y(e)){const t=e.getCenter(new p.Vector2);s=new p.Vector3(t.x,0,t.y)}else s=e;return this.focusPoint({position:s,transition:null!==(o=null==i?void 0:i.transition)&&void 0!==o?o:r.fl.Interpolate,scorers:(null==i?void 0:i.from)?[ie.d$(null==i?void 0:i.from,100)]:[],filters:[te.Pi(s,.25)],viewportState:t})}async focusPoint({position:e,transition:t,onSweepChosen:i,orientationAdjust:o,neighborDistanceThreshold:s,scorers:n,filters:a,viewportState:l}){const{cameraData:h,sweepDataState:d,sweepData:c}=l;if(!h.canTransition()||!c.state.canTransition())return;if(await this.tryNavigateToPoint({position:e,transition:t,onSweepChosen:i,orientationAdjust:o,neighborDistanceThreshold:s,initialScorers:n,initialFilters:a,cameraData:h,sweepDataState:d,sweepData:c}))return;const u=e=>!a||a.every((t=>t(e)));if(t!==r.fl.Interpolate)return this.goToNearestSweep(e,t,d,c,h,i,o,u);try{await this.issueCommand(new z.S2(z.w5.DOLLHOUSE,r.fl.Interpolate))}catch(s){await this.goToNearestSweep(e,t,d,c,h,i,o)}await this.tryNavigateToPoint({position:e,transition:t,onSweepChosen:i,orientationAdjust:o,neighborDistanceThreshold:s,initialScorers:n,initialFilters:a,cameraData:h,sweepDataState:d,sweepData:c})||await this.goToNearestSweep(e,t,d,c,h,i,o,u)}async tryNavigateToPoint({position:e,transition:t,onSweepChosen:i,orientationAdjust:o,neighborDistanceThreshold:s,initialScorers:n,initialFilters:a,cameraData:l,sweepDataState:h,sweepData:d}){const c=a?a.slice():[],u=n?n.slice():[];if(c.push(te.Zx()),c.push(te.Ol()),u.push(this.scoreByLatitude(e,ce)),t===r.fl.Interpolate&&(0,G.nI)(this.viewmodeModule.currentMode)&&h.currentSweep){const t=h.currentSweep,i=d.getSweep(t),o=i.position.clone().sub(e).normalize();c.push(te.f(i)),u.push(ie.oW(e,o))}c.push(this.withinLatitudeFilter(e)),c.push(this.notTooCloseFilter(e)),ne||c.push(this.notTooFarFilter(e)),u.push(ie.d$(e,de));const m=d.sortByScore(c,u),g=h.currentSweep?d.getSweep(h.currentSweep):void 0,v=new p.Vector3;let f=null,w=!1,y=null;const D=(0,G.nI)(this.viewmodeModule.currentMode),b=null!=s?s:15,S=D&&g?new Set(g.neighbours.filter((e=>d.getSweep(e).position.distanceTo(g.position)<b)).concat([g.id])):new Set;for(const s of m)if(this.sweepCanSeeNote(e,s.sweep)){if(y=s.sweep,t===r.fl.Interpolate||S.has(y.id)){v.copy(e).sub(y.position).normalize(),w=!0;const s=(0,T.Y7)(y.position,e,o),n=l.pose.projection.asThreeMatrix4(),{width:a,height:d}=l,c=(0,oe.bA)(e,y.position,s,a,d,n);i&&i(c),f=D?this.navigateToSweep(y.id,{transitionType:r.fl.Interpolate,rotation:s},l,h):this.viewmodeModule.switchToMode(G.N3.Panorama,t,{rotation:s,sweepID:y.id},void 0,void 0,l,h)}break}return!(!y||!w&&t===r.fl.Interpolate)&&(f||(f=this.navigateToSweep(y.id,{transitionType:t,transitionTime:he,rotation:(0,T.Y7)(y.position,e,o)},l,h)),f&&await f,!0)}async goToNearestSweep(e,t,i,o,s,n,a,l){const h=e,d=o.getClosestSweep(h,!0,l);if(!d)throw new Error("Cannot find sweep closest to Mattertag disc");const c=(0,T.Y7)(d.position,h,a),u=s.pose.projection.asThreeMatrix4(),{width:m,height:p}=s,g=(0,oe.bA)(h,d.position,c,m,p,u);n&&n(g),await this.navigateToSweep(d.id,{rotation:c,transitionType:t||r.fl.Interpolate},s,i)}}var pe=i(86866);class ge extends o.vm{get active(){return this._active}get currentValue(){return this._value}get endValue(){return this._endValue}get speed(){return this._speed}get isSlowingDown(){return this._isSlowingDown}get maxSpeed(){return this._maxSpeed}get acceleration(){return this._acceleration}getProgressPercent(){return(this._value-this._startValue)/(this._endValue-this._startValue)}onComplete(e){return this._onComplete=e,this}setStartValue(e){return this._startValue=e,this}setCurrentValue(e){return this._value=e,this}setEndValue(e){return this._endValue=e,this}setInitialSpeed(e){return this._initialSpeed=e,this}setMaxSpeed(e){return this._maxSpeed=e,this}setDesiredAcceleration(e){return this._desiredAcceleration=e,this._jerk=3*Math.abs(this._desiredAcceleration-this._acceleration),this}activate(e){return this._active=e,this}setAccel(e){return this._acceleration=Math.abs(e),this}start(){this._active=!0,this._value=this._startValue,this._speed=this._initialSpeed}setSlowdown(e){return this._slowdown=e,this}constructor(e=1,t=0){super(),this._slowdown=!0,this._initialSpeed=0,this._speed=0,this._acceleration=1,this._desiredAcceleration=1,this._jerk=1,this._maxSpeed=1,this._minSpeed=.05,this._startValue=0,this._value=0,this._endValue=e,this._delay=t}tick(e){if(!this._active||e<=0)return;if(this._delay>0)return void(this._delay-=e);e>33&&(e=33);const t=.001*e,i=this._value,o=this._speed*t,s=(0,pe.cP)(i,this.endValue,o),n=this._endValue-i<=this.getSlowdownDistance(),a=this._slowdown&&n,r=a?this._minSpeed:this._maxSpeed,l=this.acceleration*t;this._speed=(0,pe.cP)(this._speed,r,l),this._isSlowingDown=a;const h=this._desiredAcceleration,d=this._jerk*t;return this._acceleration=(0,pe.cP)(this._acceleration,h,d),this._value=s,s===this.endValue?(this.activate(!1),this.commit(),void(this._onComplete&&this._onComplete())):void 0}getSlowdownDistance(){const e=this.speed,t=this._acceleration,i=e/(0===t?1e-5:t);return this.speed*i+.5*t*i*i}stop(e){this._active=!1,this._endValue=e,this.commit()}}var ve=i(93941);const fe=new g.Vy("walk");class we{get isActive(){return this.active}get targetSweep(){return this.nextSweep}constructor(e,t,i,o,s,n,a,r){this.cameraData=e,this.sweepDataState=t,this.viewportId=i,this.sweepControl=o,this.cameraControl=s,this.generators=n,this.navigation=a,this.active=!1,this.path=[],this.lastQueueTime=0,this.repeatedQueueDelayMS=150,this.positionTracker=(new ge).setAccel(15).setMaxSpeed(5),this.baseTransitionTime=l.Ay.camera.baseTransitionTime,this.baseTransitionSpeed=l.Ay.camera.transitionSpeed,r.onSettingChanged(l.l6,(e=>{this.baseTransitionTime=e}))}setContinuousMovementDirection(e){this.continuousMovementDirection=e,!this.active&&e&&this.navigation.navigateInLocalDirection(e,this.viewportId)}stop(){this.path.length=0,this.cameraControl.endExternalTransition(),this.nextSweep=void 0,this.active=!1,this.generator&&(this.generators.stopGenerator(this.generator),this.generator=null)}appendNode(e,t){if(!this.canQueueSweeps(e))return Promise.resolve();if(!e)return Promise.resolve();if(this.path.push(e),this.lastQueueTime=Date.now(),!this.active){this.active=!0;const{generator:t,deferred:i}=this.createTransition();this.generators.startGenerator(t),this.generator=t,this.activePromise=i.nativePromise().then((()=>{this.activePromise=null})),this.positionTracker.setEndValue(this.getDistanceToSweep(e)),this.checkForSpeedIncrease(e)}return this.activePromise?this.activePromise:Promise.resolve()}canQueueSweeps(e){if(e&&this.path.indexOf(e)>=0)return!1;return!(this.path.length>=2)&&!(this.active&&Date.now()-this.lastQueueTime<this.repeatedQueueDelayMS)}attemptContinuousNavigation(){try{this.continuousMovementDirection&&this.navigation.navigateInLocalDirection(this.continuousMovementDirection,this.viewportId)}catch(e){if(!(e instanceof u||e instanceof ve.d))throw fe.warn(e),e;fe.debug(e)}}createTransition(){const e=this,t=new o.iB;return{generator:function*(){let i=Date.now();e.cameraControl.beginExternalTransition();const s=(new p.Vector3).copy(e.cameraData.pose.position),n=new p.Vector3,a=new p.Vector3,r=e.positionTracker;for(r.setMaxSpeed(5).setAccel(15);e.path.length>0;){const t=e.path.shift();if(!t){e.nextSweep=void 0;break}e.nextSweep=t,s.copy(e.cameraData.pose.position);const l=s.distanceTo(t.position);for(r.setStartValue(0).setEndValue(l).setInitialSpeed(r.speed).activate(!0),a.subVectors(t.position,s),a.normalize(),yield new o.sv(e.sweepControl.activateSweepUnsafe({sweepId:t.id}).then((()=>{e.sweepControl.beginSweepTransition({sweepId:t.id,internalProgress:!1,sweepDataState:e.sweepDataState})}))),r.start(),e.checkForSpeedIncrease(t);r.active;){const l=Date.now()-i,h=0===e.path.length;let d=!1,c=!1;if(!h){const i=e.path[0];d=r.endValue-r.currentValue+t.position.distanceTo(i.position)<r.getSlowdownDistance();const o=n.subVectors(i.position,t.position);o.normalize();a.dot(o)<.3&&(c=!0)}r.setSlowdown(h||d||c),r.tick(l);const u=r.getProgressPercent();e.cameraControl.updateCameraPosition(n.lerpVectors(s,t.position,u)),e.sweepDataState.transition.progress.modifyAnimation(u,1,0),i=Date.now(),e.continuousMovementDirection&&e.canQueueSweeps()&&r.isSlowingDown&&e.attemptContinuousNavigation(),r.active&&(yield new o.oN)}e.sweepControl.endSweepTransition({sweepId:t.id,sweepDataState:e.sweepDataState})}t.resolve(),e.stop()},deferred:t}}getDistanceToSweep(e){return(this.nextSweep?this.nextSweep.position:this.cameraData.pose.position).distanceTo(e.position)}checkForSpeedIncrease(e){const t=this.positionTracker,i=this.getDistanceToSweep(e),o=t.endValue-t.currentValue,s=o+i-t.getSlowdownDistance();if(o+i>12){const e=this.baseTransitionTime,i=this.baseTransitionSpeed,o=.001*(e+Math.log2(1+s)*l.mn*i)-t.maxSpeed/t.acceleration,n=s/o;o>0&&t.setMaxSpeed(n).setDesiredAcceleration(3*n)}else t.setMaxSpeed(5).setDesiredAcceleration(15)}}var ye=i(56208),De=i(73566);class be{constructor(e,t,i,o,s,n){this.engine=e,this.navigation=t,this.settingsData=i,this.cameraData=o,this.viewmodeData=s,this.toolsData=n,this.defaultSize=(new p.Vector3).fromArray([3,3,3])}async enforceLabelEditorFriendlyViewmode(){var e;let t=!0;await(null===(e=this.cameraData.transition.promise)||void 0===e?void 0:e.nativePromise());const i=this.determineViewmode();if(this.viewmodeData.currentMode!==i)try{await this.engine.commandBinder.issueCommand(new z.S2(i===G.N3.Dollhouse?z.w5.DOLLHOUSE:z.w5.FLOORPLAN,r.fl.Interpolate))}catch(e){t=!1}return t}async navigateToLabel(e){try{const t=this.determineViewmode();return await this.navigation.focus((new p.Box3).setFromCenterAndSize(new p.Vector3(0,1,0).add(e.position),this.defaultSize),{floorId:e.floorId,mode:t}),this.viewmodeData.currentMode===G.N3.Dollhouse||this.viewmodeData.currentMode===G.N3.Floorplan}catch(e){return!1}}determineViewmode(){const e=this.toolsData.activeToolName===De.S0.LABELS||this.settingsData.tryGetSetting(ye.Q$.LabelsDollhouse,!0),t=!this.viewmodeData.isDollhouseDisabled()&&e?G.N3.Dollhouse:G.N3.Floorplan,i=this.viewmodeData.currentMode;return(0,oe.aY)(this.cameraData.pose.pitchFactor())?G.N3.Floorplan:i===G.N3.Floorplan||i===G.N3.Dollhouse?i:t}}var Se=i(70046),Me=i(97171),Te=i(12767);var xe=i(3035),Ce=i(7584),ke=i(49953);class Pe extends o.nV{constructor(){super(...arguments),this.name="navigation",this.navigationRules=[()=>!0],this.navigationWalk=new Map,this.navigationEnabled=!0,this.inputOutside=[],this.navigationFilters=new Set,this.addNavigationRule=e=>{-1===this.navigationRules.indexOf(e)&&this.navigationRules.push(e)},this.removeNavigationRule=e=>{const t=this.navigationRules.indexOf(e);-1!==t&&this.navigationRules.splice(t,1)},this.isNavigationInputAllowed=()=>{const e=this.navigationRules.reduce(((e,t)=>e&&t()),!0);return!(!this.navigationEnabled||!e)||(g.Vy.for(this).debug("Cannot move while navigation is locked",{blockedByRules:!e,blockedByCommand:!this.navigationEnabled}),!1)},this.navigationFilter=e=>{for(const t of this.navigationFilters.values())if(!t(e))return!1;return!0}}async init(e,t){const{market:i}=t;this.config=e,this.commandBinder=t.commandBinder,this.bindings.push(this.commandBinder.addBinding(d.Jq,(async()=>this.lockNavigation())),this.commandBinder.addBinding(d.sD,(async()=>this.unlockNavigation())),this.commandBinder.addBinding(d.rH,(async e=>{const{focusPosition:t,transition:i,orientationAdjust:o,onSweepChosen:s,neighborDistanceThreshold:n}=e,a={cameraData:this.cameraData,sweepDataState:this.sweepData.state,sweepData:this.sweepData};return this.navigationPoint.focusPoint({position:t,transition:i,onSweepChosen:s,orientationAdjust:o,neighborDistanceThreshold:n,viewportState:a})})),this.commandBinder.addBinding(d.E4,(async e=>{const{pinPosition:t,transition:i,orientationAdjust:o,onSweepChosen:s,neighborDistanceThreshold:n}=e,a=this.viewportModule.viewportManager.viewportIdForLayerId(t.layerId),r={cameraData:this.cameraModule.getCameraDataForViewport(a),sweepDataState:this.sweepModule.data.getStateForViewport(a),sweepData:this.sweepModule.data},l=this.layersModule.layersData,h=l.getSweepSourceIdFilterValue(l.getLayerSource(t.layerId)),d=[e=>!h||e.sourceViewId===h];return this.navigationPoint.focusPin({position:t,transition:i,onSweepChosen:s,orientationAdjust:o,neighborDistanceThreshold:n,viewportState:r,sweepFilters:d})})),this.commandBinder.addBinding(d.aj,(e=>this.navigateToSweep(e.sweep,{rotation:e.rotation,transitionType:e.transition,transitionTime:e.transitionTime,transitionSpeedMultiplier:e.transitionSpeedMultiplier,viewId:e.viewId},e.cameraData,e.sweepDataState))),this.commandBinder.addBinding(d.UZ,(async({position:e,floorId:t,viewmodeOnly:i})=>i?this.navigationLabel.enforceLabelEditorFriendlyViewmode():!(!e||!t)&&this.navigationLabel.navigateToLabel({position:e,floorId:t}))),this.commandBinder.addBinding(d.Dd,(async({room:e})=>{var t;const i=isNaN(e.floorHeight)?this.floorsViewData.getFloor(null!==(t=e.floorId)&&void 0!==t?t:this.floorsViewData.topFloorId).medianSweepHeight():e.floorHeight;let o=e.getMinCeilingHeight();isNaN(o)&&(o=.1);const s=new p.Box3(new p.Vector3(e.bbox.min.x,i,e.bbox.min.y),new p.Vector3(e.bbox.max.x,i+o,e.bbox.max.y)),n=!this.viewmodeData.isInside()&&this.cameraData.pose.isPitchFactorOrtho||this.viewmodeData.isDollhouseDisabled()?G.N3.Floorplan:G.N3.Dollhouse;return this.focus(s,{mode:n,floorId:e.floorId})})),this.commandBinder.addBinding(d.r,(async e=>this.navigateToPose(e.pose)))),[this.settingsData,this.sweepData,this.sweepModule,this.viewmodeData,this.viewmodeModule,this.cameraData,this.cameraModule,this.interactionmodeData,this.meshQuery,this.viewportModule,this.layersModule]=await Promise.all([i.waitForData(s.o),i.waitForData(L.A),t.getModuleBySymbol(n.Wh),i.waitForData(U.X),t.getModuleBySymbol(n.SD),i.waitForData(a.M),t.getModuleBySymbol(n.jh),i.waitForData(h.O),t.getModuleBySymbol(n.PM),t.getModuleBySymbol(n.Qm),t.getModuleBySymbol(n.az)]);const[r,l,c,u,m,g]=await Promise.all([t.getModuleBySymbol(n.sA),i.waitForData(Q.M),i.waitForData(H.X),t.getModuleBySymbol(n.QW),i.waitForData(ke.L),i.waitForData(o.zH)]);this.floorsViewData=c,this.floorsViewDataModule=u,this.navigationPoint=new me(this.viewmodeModule,null==r?void 0:r.picking,t.commandBinder.issueCommand,this.navigateToSweep.bind(this)),this.navigationLabel=new be(t,this,this.settingsData,this.cameraData,this.viewmodeData,l);const v=await t.getModuleBySymbol(n.mL),f=()=>this.isNavigationInputAllowed()&&this.viewmodeData.canStartTransition()&&this.sweepData.state.canTransition(),w=()=>f()&&(this.viewmodeData.isDollhouse()||this.viewmodeData.isFloorplan()||this.viewmodeData.isOrthographic());this.navigationOutside=new ee(w,this.cameraModule,this.viewmodeData),this.inputOutside.push(new x(w,t.commandBinder,v,c,u,this,this.sweepData,this.cameraModule.getCameraControllerForViewport(),this.meshQuery,e.doubleClickToGoInside,(0,Ce.m2)(m,this.settingsData,g.application===o.lg.WORKSHOP))),this.inputInside=new A(this,v,!!e.enableWheel),this.inputOutside.forEach((e=>this.bindings.push(...e.bindings))),this.bindings.push(...this.inputInside.bindings),this.updateInputBindings(),this.bindings.push(this.viewmodeData.makeModeChangeSubscription((()=>{this.viewmodeData.currentMode!==G.N3.Transition&&this.updateInputBindings()}))),this.syncViewports(t),t.broadcast(new Se.sb(Me.D.Navigation))}syncViewports(e){const t=t=>{const i=this.cameraModule.getCameraDataForViewport(t),o=this.sweepModule.data.getStateForViewport(t),s=this.cameraModule.getCameraControllerForViewport(t),n=new we(i,o,t,this.sweepModule,s,e,this,this.settingsData);this.navigationWalk.set(t,n)};for(const e of this.viewportModule.viewportManager.viewports)t(e.id);this.bindings.push(this.viewportModule.viewportManager.viewports.onElementChanged({onAdded:e=>t(e.id),onRemoved:e=>this.navigationWalk.delete(e.id)}))}updateInputBindings(){const e=this.interactionmodeData.isVR(),t=this.viewmodeData.isInside();this.inputInside.toggleInput(t&&!e),this.inputInside.toggleVrInput(t&&e),this.inputOutside.forEach((e=>e.toggleInput(!t)))}navigateInLocalDirection(e,t){const i=this.cameraData.pose.rotation;return this.navigateInDirection(e.clone().applyQuaternion(i),t)}setContinuousNavigationLocalDirection(e){this.getNavWalk().setContinuousMovementDirection(e)}addNavigationFilter(e){this.navigationFilters.add(e)}removeNavigationFilter(e){this.navigationFilters.delete(e)}navigateTowardsIntersection(e){try{this.navigateInDirection(e.point.clone().sub(this.cameraData.pose.position))}catch(e){return!1}return!0}navigateToPanoNearIntersection(e,t,i,o){const s=(0,T.I9)(this.sweepData,this.viewmodeData.isInside(),e,this.meshQuery,[],[this.navigationFilter]),n=s.length>0?s[0].sweep:this.sweepData.getClosestSweep(e.point,!0),a=(0,l.xl)(this.interactionmodeData.mode);if(this.viewmodeData.isInside()&&n)return this.navigateToSweep(n.id,{rotation:o,transitionType:a},t,i),!0;if(this.viewmodeData.canSwitchViewMode(G.N3.Panorama)){const e=n?n.id:void 0;return this.commandBinder.issueCommand(new z.S2(z.w5.INSIDE,a,{sweepID:e})),!0}return!1}navigateInDirection(e,t){var i,o;const s=this.getNavWalk(t);if(!this.viewmodeData.isInside())throw new u(m.InsideOnly);if(!s.sweepDataState.currentSweep)throw new u(m.InvalidSweep);const n=(0,l.xl)(this.interactionmodeData.mode);let a;if(a||(a=null===(i=(0,T.IV)({additionalFilter:this.navigationFilter,considerTrims:!0,direction:e,directionFactor:s.isActive?.65:void 0,meshQuery:this.meshQuery,sourceSweep:s.isActive?s.targetSweep:void 0,sweepData:this.sweepData})[0])||void 0===i?void 0:i.sweep),!a&&this.config.raycastNeighbors&&(a=null===(o=(0,T.GI)({additionalFilter:this.navigationFilter,direction:e,directionFactor:s.isActive?.65:void 0,meshQuery:this.meshQuery,sourceSweep:s.isActive?s.targetSweep:void 0,sweepData:this.sweepData,viewDirection:this.cameraData.pose.forward()})[0])||void 0===o?void 0:o.sweep),a)return this.navigateToSweep(a.id,{transitionType:n},s.cameraData,s.sweepDataState);throw new u(m.NoDestinationFound)}async focus(e,t){var i;if(!(t=Object.assign({mode:this.viewmodeData.currentMode,transition:r.fl.Interpolate},t)).mode||!this.isNavigationInputAllowed())throw new u(m.Locked);let o;if(await(0,xe.L)(this.cameraData,this.viewmodeData),this.cameraData.pose.autoOrtho&&t.mode===G.N3.Floorplan&&(t.forceOrtho=!0),(t.floorId&&t.floorId!==this.floorsViewData.currentFloorId||null===this.floorsViewData.currentFloorId||this.viewmodeData.isInside())&&this.floorsViewDataModule.moveToFloor(t.floorId||this.floorsViewData.getHighestVisibleFloorId(),{suppressCameraMovement:!0,transitionTime:X.U.TRANSITION_TIME_DH/2}),this.viewmodeData.isInside()){let s;if(q(e))s=e;else if(Y(e)){const o=this.floorsViewData.floors.getFloor(null!==(i=t.floorId)&&void 0!==i?i:this.floorsViewData.getHighestVisibleFloorId()).medianSweepFloorHeight();s=new p.Box3(new p.Vector3(e.min.x,o,e.min.y),new p.Vector3(e.max.x,o,e.max.y))}o=function(e,t){t||(t=(e.currentFloor||e.getFloor(e.bottomFloorId)).boundingBox);const i=t.min.y,o=t.getCenter(new p.Vector3),s=t.max.clone();s.y=i;const n=o.distanceTo(s)/Math.tan(Te.Bv.fov/2*J.fy),a=C.YF.DOWNWARD.clone().multiply((new p.Quaternion).setFromAxisAngle(C.B1.RIGHT,45*J.fy)),r=C.B1.FORWARD.clone().applyQuaternion(a).multiplyScalar(-1*n);return{position:o.clone().add(r),rotation:a}}(this.floorsViewData,s)}const s=t.viewportState||{cameraData:this.cameraData,sweepDataState:this.sweepData.state,sweepData:this.sweepData};try{switch(t.mode){case G.N3.Panorama:await this.navigationPoint.focus(e,s,t);break;case G.N3.Dollhouse:await this.viewmodeModule.switchToMode(t.mode,t.transition,o),await this.navigationOutside.focus(e,t);break;case G.N3.Floorplan:await this.viewmodeModule.switchToMode(t.mode,t.transition),await this.navigationOutside.focus(e,t);break;case G.N3.ExteriorSplat:await this.viewmodeModule.switchToMode(t.mode,t.transition),await this.navigationOutside.focus(e,t);default:throw g.Vy.for(this).warn(`navigation.focus: ${t.mode} not implemented yet`),new u(m.InvalidMode)}}catch(i){throw g.Vy.for(this).debug("Unable to set focus",e,t,i),i}}lockNavigation(){this.navigationEnabled=!1,g.Vy.for(this).debug("Navigation input locked")}unlockNavigation(){this.navigationEnabled=!0,g.Vy.for(this).debug("Navigation input unlocked")}async navigateToSweep(e,{rotation:t,transitionType:i,transitionTime:o,transitionSpeedMultiplier:s}={},n=this.cameraData,a=this.sweepData.state){const l=this.settingsData.tryGetSetting(j.zk,r.fl.Interpolate);let h;void 0===i&&(i=l);const d=a.currentSweep;if(i===r.fl.Interpolate){const t=!d||this.sweepData.isSweepAligned(d),o=this.sweepData.isSweepAligned(e),s=d!==e,n=!t||!o,a=this.viewmodeData.isInside();s&&n&&a&&(i=r.fl.FadeToBlack)}if(this.viewmodeData.isInside()||this.viewmodeData.transition.active){if(!this.viewmodeData.transition.active||(0,G.nI)(this.viewmodeData.transition.to)){const l=void 0===t&&void 0===o&&void 0===s,d=n.canTransition()&&a.canTransition(),c=l?Array.from(this.navigationWalk.values()).find((e=>e.cameraData.id===n.id)):void 0;if(i===r.fl.Interpolate&&a.currentSweep!==e&&c&&(d||c.isActive)){const t=this.sweepModule.getSweepOnView(e);h=c.appendNode(t,a.currentSweep)}else{if(!d)return a.currentSweep;h=this.sweepModule.moveToSweep({transitionType:i,sweepId:e,rotation:t,transitionTime:o,transitionSpeedMultiplier:s,cameraData:n,sweepDataState:a})}}}else h=this.viewmodeModule.switchToMode(G.N3.Panorama,i,{sweepID:e,rotation:t},void 0,void 0,n,a);return await h,this.sweepData.state.currentSweep}navigateToPose(e){const t={2:z.w5.DOLLHOUSE,3:z.w5.FLOORPLAN},{sweepIndex:i,quaternion:o,mode:s}=e;let{panoId:n,position:a}=e;if(!n&&void 0!==i){const e=this.sweepData.getSweepByIndex(i);e&&(n=e.id)}if(n)this.commandBinder.issueCommand(new d.aj({sweep:n,rotation:o,transition:r.fl.FadeToBlack}));else{if(!(s in t))throw new Error("Unknown navigation link pose: "+JSON.stringify(e));this.commandBinder.issueCommand(new z.S2(t[s],r.fl.Interpolate,{rotation:o,position:a}))}}getNavWalk(e=this.viewportModule.viewportManager.activeViewport.id){const t=this.navigationWalk.get(e);if(!t)throw new Error("No navigation walk for viewport!");return t}}},69583:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>V});var o,s=i(68909),n=i(77201),a=i(72268),r=i(46771),l=i(71828),h=i(33007),d=i(86866),c=i(40397),u=i(4994),m=i(13893),p=i(3249),g=i(81662),v=i(28995);!function(e){e[e.NONE=a.O.NONE]="NONE",e[e.PAN=a.O.PRIMARY]="PAN",e[e.ROTATE=a.O.SECONDARY]="ROTATE",e[e.ZOOM=a.O.MIDDLE]="ZOOM"}(o||(o={}));class f extends u.A{constructor(e,t,i,n,a=!1,h=!1,d=!1){super(),this.pose=e,this.visibleMeshBounds=t,this.allowPhiRotate=h,this.allowAzimutRotate=d,this.targetProjection=new r.k,this.currentOrientation=new s.Quaternion,this.currentPosition=new s.Vector3,this.positionDelta=new s.Vector3,this.angularAccel=new s.Vector2,this.angularVelocity=new s.Vector2,this.linearAccel=new s.Vector2,this.linearVelocity=new s.Vector2,this.zoomAccel=0,this.zoomVelocity=0,this.scale=1,this.maxZoom=0,this.minZoom=l.WU,this.bindings=[],this.controlState=o.NONE,this.controlsEngaged=!1,this.aimTarget=new s.Vector3,this.tempAxis=new s.Vector3,this.tempOrientation=new s.Quaternion,this.nextPosition=new s.Vector3,this.nextOrientation=new s.Quaternion,this.currentPose=new v.J(1),this.checkBounds=a,this.bounds=i.clone(),this.boundsCenter=n.clone(),this.setupBounds(),this.transition={active:!1,startTime:0,elapsed:0,duration:0,linearVelocity:new s.Vector2,angularVelocity:new s.Vector2,zoomVelocity:0,easeOut:!1}}start(){this.scale=1,this.bindings.push(this.visibleMeshBounds.onFullBoundsChanged(this.updateZoomLevels.bind(this))),this.updateZoomLevels()}setPanAcceleration(e,t=!1,i){if(!this.transition.active){t&&this.haltVelocity(e,this.linearVelocity);const o=this.pose,s=o.projection.elements[0],n=o.projection.elements[5];this.linearAccel.x=void 0!==e.x?e.x/s:this.linearAccel.x,this.linearAccel.y=void 0!==e.y?e.y/n:this.linearAccel.y,void 0!==i&&this.linearAccel.setLength(i)}}setZoomAcceleration(e){this.transition.active||(this.zoomAccel=e)}setOrbitalAcceleration(e,t=!1){this.transition.active||(t&&this.haltVelocity(e,this.angularVelocity),this.angularAccel.x=void 0!==e.x?e.x:this.angularAccel.x,this.angularAccel.y=void 0!==e.y?e.y:this.angularAccel.y)}haltVelocity(e,t){e.x&&t.x&&Math.sign(e.x)!==Math.sign(t.x)&&(t.x=0),e.y&&t.y&&Math.sign(e.y)!==Math.sign(t.y)&&(t.y=0)}startRotateTransition(e,t,i){return t.x*=-1,this.startTransition(e,t.clone().multiplyScalar(l.qD),new s.Vector2,0,i).nativePromise()}startTranslateTransition(e,t,i=!0){return this.startTransition(e,new s.Vector2,t.clone().multiplyScalar(l.qD),0,i).nativePromise()}startZoomTransition(e,t,i){return this.startTransition(e,new s.Vector2,new s.Vector2(0,0),t,i).nativePromise()}startTransition(e,t,i,o,s){const a=new n.iB;return this.poseController?(this.transition.active=!0,this.transition.duration=e,this.transition.elapsed=0,this.transition.startTime=Date.now(),this.transition.deferred=a,this.transition.angularVelocity.copy(t),this.transition.linearVelocity.copy(i),this.transition.zoomVelocity=o,this.transition.easeOut=s,this.angularAccel.set(0,0),this.linearAccel.set(0,0),this.zoomAccel=0,this.angularVelocity.copy(t),this.linearVelocity.copy(i),this.zoomVelocity=o,this.poseController.beginExternalTransition(),a.promise()):a.resolve().promise()}stopTransition(){var e;this.transition.active&&(null===(e=this.poseController)||void 0===e||e.endExternalTransition(),this.transition.active=!1),this.transition.deferred&&(this.transition.deferred.resolve(),this.transition.deferred=void 0)}updateTransition(e,t,i,o){let s=1,n=e/l.qD;this.transition.elapsed+=e;const a=this.getTransitionScale(e);if(this.transition.elapsed>=this.transition.duration){s=(this.transition.duration-(this.transition.elapsed-e))/e,n=1}i&&(this.linearVelocity.copy(this.transition.linearVelocity).multiplyScalar(a),this.pan(this.linearVelocity)),o&&(this.zoomVelocity=this.transition.zoomVelocity*a,this.zoom(this.zoomVelocity)),t&&(this.angularVelocity.copy(this.transition.angularVelocity).multiplyScalar(s*n),this.orbit(this.angularVelocity)),this.transition.elapsed>=this.transition.duration&&(this.stop(this.transition.easeOut),this.transition.active=!1)}getTransitionScale(e){if(this.transition.elapsed>=this.transition.duration){return(this.transition.duration-(this.transition.elapsed-e))/e}return e/l.qD}updateDefault(e,t,i,o){const s=e/l.qD;if(i&&(this.linearVelocity.addScaledVector(this.linearAccel,s),this.pan(this.linearVelocity),this.linearVelocity.multiplyScalar(Math.pow(1-l.g1,s))),o&&(this.zoomVelocity=this.zoomVelocity+this.zoomAccel*s,this.zoom(this.zoomVelocity),this.zoomVelocity*=Math.pow(1-l.pz,s),this.angularVelocity.set(0,0),this.angularAccel.set(0,0)),t&&!o){this.angularVelocity.addScaledVector(this.angularAccel,s);const e=1;this.orbit(this.angularVelocity.clone().multiplyScalar(s/e)),this.angularVelocity.multiplyScalar(Math.pow(1-l.g1,s)/e)}}update(e){const t=this.linearAccel.length()>h.A.epsilon||this.linearVelocity.length()>h.A.epsilon,i=Math.abs(this.zoomAccel)>h.A.epsilon||Math.abs(this.zoomVelocity)>h.A.epsilon,o=this.angularAccel.length()>h.A.epsilon||this.angularVelocity.length()>h.A.epsilon;this.transition.active?this.updateTransition(e,o,t,i):this.updateDefault(e,o,t,i)}stopMomentum(){this.transition.active||(this.linearVelocity.set(0,0),this.zoomVelocity=0,this.angularVelocity.set(0,0))}stopAcceleration(){this.transition.active||(this.setPanAcceleration({x:0,y:0}),this.setZoomAcceleration(0),this.setOrbitalAcceleration({x:0,y:0}))}stop(e=!1){this.stopTransition(),this.stopAcceleration(),e||this.stopMomentum(),this.bindings.forEach((e=>e.cancel())),this.bindings.length=0}pan(e){if(!this.poseController)return;const t=this.pose;this.positionDelta.x=e.x,this.positionDelta.y=e.y,this.positionDelta.z=0,this.positionDelta.applyQuaternion(t.rotation),this.currentPosition.copy(t.position).add(this.positionDelta),this.checkBounds&&!this.insideBounds(this.currentPosition,t.rotation,t.projection)||this.poseController.updateCameraPosition(this.currentPosition)}zoom(e){if(!this.poseController)return;const t=this.pose;this.targetProjection.copy(t.projection);const i=this.scale*(1-e);if(Math.abs(i-this.scale)>h.A.epsilon){this.targetProjection.elements[0]*=i/this.scale,this.targetProjection.elements[5]*=i/this.scale;const o=(0,c.BN)(this.targetProjection);if(e<0&&o<=this.minZoom||e>0&&o>=this.maxZoom)return;if(this.checkBounds&&!this.insideBounds(t.position,t.rotation,this.targetProjection))return;this.scale=i,this.poseController.updateCameraProjection(this.targetProjection.clone())}}calculateAimTarget(e,t){t.copy(g.B1.FORWARD).applyQuaternion(e.rotation),t.setLength(e.focalDistance)}orbit(e,t=!1){if(!this.poseController)return;this.currentPose.copy(this.pose);const i=this.pose,o=i.phi(),s=e,n=Math.PI/2,a=(0,p.qE)(s.y,0-o,n-o);return n-o<1e-5&&a>0&&!(Math.abs(e.x)>0)?(this.angularVelocity.y=0,void(this.angularAccel.y=0)):(this.calculateAimTarget(i,this.aimTarget),this.nextPosition.copy(i.position).sub(this.aimTarget),this.nextOrientation.copy(i.rotation),this.allowPhiRotate&&(this.tempAxis.copy(g.B1.RIGHT),this.tempOrientation.setFromAxisAngle(this.tempAxis.applyQuaternion(i.rotation),-a),this.nextPosition.applyQuaternion(this.tempOrientation),this.nextOrientation.premultiply(this.tempOrientation)),this.allowAzimutRotate&&(this.tempOrientation.setFromAxisAngle(g.B1.UP,s.x),this.nextPosition.applyQuaternion(this.tempOrientation),this.nextOrientation.premultiply(this.tempOrientation)),this.nextPosition=this.nextPosition.add(this.aimTarget),this.nextOrientation.normalize(),this.currentPose.position.copy(this.nextPosition),this.currentPose.rotation.copy(this.nextOrientation),t?this.poseController.moveTo({transitionType:m.fl.Interpolate,pose:{position:this.currentPose.position.clone(),rotation:this.currentPose.rotation.clone()},transitionTime:500}).nativePromise():void this.poseController.updateCameraPose(this.currentPose))}updateZoomLevels(){const e=this.visibleMeshBounds.getFullBounds().getBoundingSphere(new s.Sphere);this.maxZoom=e.radius*l.SO}setupBounds(){this.bounds.min.x=this.adjustBound(this.bounds.min.x,2),this.bounds.min.y=this.adjustBound(this.bounds.min.y,2),this.bounds.min.z=this.adjustBound(this.bounds.min.z,2),this.bounds.max.x=this.adjustBound(this.bounds.max.x,-2),this.bounds.max.y=this.adjustBound(this.bounds.max.y,-2),this.bounds.max.z=this.adjustBound(this.bounds.max.z,-2),this.worldBounds=(new s.Box3).setFromCenterAndSize(this.boundsCenter,new s.Vector3(this.bounds.max.x-this.bounds.min.x,this.bounds.max.y-this.bounds.min.y,this.bounds.max.z-this.bounds.min.z))}insideBounds(e,t,i){return!!(0,d.i0)(e,t,i,this.worldBounds)}adjustBound(e,t){return Math.sign(e+t)===Math.sign(e)?e+t:0}setController(e){return super.setController(e),this.controlState=o.NONE,this}}var w=i(71397),y=i(28337),D=i(2993),b=i(1197),S=i(98309),M=i(44667),T=i(94790),x=i(20014),C=i(60043),k=i(22278),P=i(71687),F=i(17986);class V extends F.A{constructor(){super(...arguments),this.name="orthographic-controls",this.movementKeys=new s.Vector2,this.allowRotation=!1,this.resetControlState=e=>{e.controlState=o.NONE}}async init(e,t){const[i,o,s,n]=await Promise.all([t.getModuleBySymbol(P.jh),t.getModuleBySymbol(P.X7),t.getModuleBySymbol(P.UN),t.getModuleBySymbol(P.Qm)]),a=t.market.tryGetData(k.U)||new k.U;this.meshData=a,this.visibleMeshBoundsModule=s,this.viewportModule=n,this.cameraModule=i,this.allowRotation=e.allowRotation,this.modelSize=Math.max(a.extendedSize.length(),1),this.commonControlsModule=o,t.getModuleBySymbol(P.mL).then((e=>{this.bindings.push(e.registerHandler(M.s,(e=>{const t=this.getControlsForViewport(e.viewportId);t&&this.onScrollWheel(t,e)}))),this.bindings.push(e.registerHandler(T.SK,(e=>{const t=this.getControlsForViewport(e.viewportId);t&&this.onDragBegin(t,e.buttons)}))),this.bindings.push(e.registerHandler(T.jF,(e=>{const t=this.getControlsForViewport(e.viewportId);t&&(t.controlsEngaged=!0,this.onDrag(t,e.delta),t.update(l.qD),t.stop())}))),this.bindings.push(e.registerHandler(T._w,(e=>{const t=this.getControlsForViewport(e.viewportId);t&&t.controlsEngaged&&(e.timeSinceLastMove<100&&(this.onDrag(t,e.delta),t.update(l.qD),t.stopAcceleration()),this.onDragEnd(t,e.delta,e.buttons),t.controlsEngaged=!1)}))),this.bindings.push(e.registerHandler(x.l,(e=>{const t=this.getControlsForViewport(e.viewportId);t&&(t.setZoomAcceleration(-e.pinchDelta*l.Tv),t.update(l.qD),t.stop())}))),this.bindings.push(e.registerHandler(x.g,(e=>{const t=this.getControlsForViewport(e.viewportId);t&&this.resetControlState(t)}))),this.bindings.push(e.registerHandler(C.k,(e=>{e.state!==y.$.PRESSED&&this.onKey(e)})))})),this.bindings.push(t.subscribe(b.A,(e=>{for(const e of this.viewportControls.values())e.isActive&&e.start()})),t.subscribe(S.A,(e=>{for(const e of this.viewportControls.values())e.isActive&&e.stop()}))),this.commonControlsModule.addControls(D.N3.Orthographic,this)}onUpdate(e){for(const t of this.viewportControls.values())t.isActive&&t.update(e)}newControlsForViewport(e,t){return new f(t,this.visibleMeshBoundsModule,this.meshData.extendedBounds,this.meshData.meshCenter,!0,this.allowRotation,this.allowRotation)}onScrollWheel(e,t){if(0!==t.delta.y){const i=(0,d.OF)(this.modelSize,1,1500,2,.125);e.setZoomAcceleration(t.delta.y*l.aY/(i*l.mK)),e.update(l.qD),e.setZoomAcceleration(0)}}onDragBegin(e,t){if(e.controlState===o.NONE){const i=t;e.controlState=i}e.stop()}onDrag(e,t){switch(e.controlState){case o.PAN:const i=t;e.setPanAcceleration({x:-i.x,y:-i.y});break;case o.ZOOM:0!==t.y&&e.setZoomAcceleration(-t.y);break;case o.ROTATE:e.setOrbitalAcceleration({x:-Math.PI*t.x,y:-Math.PI*t.y})}}onDragEnd(e,t,i){i&e.controlState||(e.controlState=o.NONE)}onKey(e){const t=this.getControlsForViewport(this.viewportModule.viewportManager.activeViewport.id);if(!t)return;const{key:i,state:o}=e,s=o===y.$.DOWN;let n=!1;switch(i){case w.D.A:this.movementKeys.x=s?-1:0,n=!0;break;case w.D.D:this.movementKeys.x=s?1:0,n=!0;break;case w.D.W:this.movementKeys.y=s?1:0,n=!0;break;case w.D.S:this.movementKeys.y=s?-1:0,n=!0;break;case w.D.K:t.setZoomAcceleration(s?l.Dw:0);break;case w.D.I:t.setZoomAcceleration(s?-l.Dw:0);break;case w.D.J:case w.D.LEFTARROW:t.setOrbitalAcceleration({x:s?l.$6:0,y:0},!0);break;case w.D.L:case w.D.RIGHTARROW:t.setOrbitalAcceleration({x:s?-l.$6:0,y:0},!0)}if(n){const e=this.movementKeys;t.setPanAcceleration({x:e.x,y:e.y},!1,l.bI)}}}},41122:(e,t,i)=>{"use strict";i.d(t,{My:()=>l,W:()=>h,YB:()=>n,ho:()=>s,nq:()=>a,u3:()=>r});var o=i(77201);class s extends o.uB{constructor(e,t=!1){super(),this.payload={exclude:e||[],hard:t}}}s.id="PLUGIN_RESET_ALL";class n extends o.uB{constructor(e,t,i,o,s){super(),this.payload={name:e,config:t,configMeta:i,permissions:o||{},force:s||!1}}}n.id="PLUGIN_RELOAD";class a extends o.uB{constructor(e,t,i,o){super(),this.payload={name:e,config:t,configMeta:i,permissions:o||{}}}}a.id="PLUGIN_LOAD";class r extends o.uB{constructor(e){super(),this.payload={name:e}}}r.id="PLUGIN_UNLOAD";class l extends o.uB{constructor(e,t){super(),this.payload={operation:e,callback:t}}}l.id="PLUGIN_CONFIG_FETCH_DATA";class h extends o.uB{constructor(e,t){super(),this.payload={attachmentId:e,pluginId:t}}}h.id="ATTACHMENT_ASSOCIATE_WITH_PLUGIN";class d extends o.uB{constructor(e,t){super(),this.payload={attachmentId:e,pluginId:t}}}d.id="ATTACHMENT_DISSOCIATE_FROM_PLUGIN"},53028:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>x});var o=i(77201),s=i(97800),n=i(71687),a=i(68909),r=i(70694),l=i.n(r),h=i(52492),d=i.n(h),c=i(16249),u=i.n(c),m=i(88140),p=i.n(m),g=i(91254),v=i.n(g),f=i(50652),w=i.n(f);const y={circle_projection:new a.ShaderMaterial({uniforms:{textureSampleScale:{value:5},panoTexture:{value:null},borderSize:{value:0},borderColor:{value:new a.Vector4(1,1,1,1)}},depthWrite:!1,depthTest:!0,side:a.DoubleSide,vertexShader:l(),fragmentShader:d()}),equirectangular:new a.ShaderMaterial({uniforms:{cubemap:{value:null},yaw:{value:0}},depthWrite:!1,depthTest:!1,vertexShader:u(),fragmentShader:p()}),compose:new a.ShaderMaterial({uniforms:{mask:{value:null},bg:{value:null}},transparent:!0,vertexShader:v(),fragmentShader:w()})};var D=i(95102),b=i(18821);class S{constructor(e,t){this._renderer=e,this._renderTarget=t}get target(){return this._renderTarget}get width(){return this._renderTarget.width}get height(){return this._renderTarget.height}get bpp(){return 4}readRenderTargetData(e){const t=this._renderTarget.width,i=this._renderTarget.height;return e=e||new Uint8Array(t*i*4),this._renderer.readRenderTargetPixels(this._renderTarget,0,0,t,i,e),e}setSize(e,t){this._renderTarget.setSize(e,t)}dispose(){this._renderTarget.dispose()}}var M=i(30443);const T=new a.DataTexture(new Uint8Array([255,255,255,255]),1,1);T.needsUpdate=!0;class x extends o.nV{constructor(){super(...arguments),this.name="render-to-texture",this.circleProjectionPlane=new D.m((0,M.Wi)(),y.circle_projection),this.equirectProjectionPlane=new D.m((0,M.Wi)(),y.equirectangular),this.composePlane=new D.m((0,M.Wi)(),y.compose),this.cachedSize=new a.Vector2,this.cachedViewport=new a.Vector4,this.cachedViewport2=new a.Vector4,this.debugRenderOffset=0,this.tempColor=new a.Color}async init(e,t){this.engine=t;const i=await t.getModuleBySymbol(n.M7);this.cwfRenderer=i.cwfRenderer,this.renderer=i.threeRenderer,this.camera=new a.PerspectiveCamera,this.orthoCamera=new a.OrthographicCamera(-.5,.5,.5,-.5,0,1),this.camera.layers.mask=o.HU.ALL.mask,this.scene=new a.Scene,this.scene.name="rtt",this.scene.matrixWorldAutoUpdate=!1,this.bindings.push(t.commandBinder.addBinding(b.q6,(async()=>new S(this.renderer,this.createRenderTarget2D(0)))),t.commandBinder.addBinding(b.X7,(async e=>{this.renderContext(e.renderTarget.target,e.context)})),t.commandBinder.addBinding(b.Is,(async e=>{this.render(e.renderTarget.target,e.sceneObject,e.camera)})),t.commandBinder.addBinding(b.cl,(async e=>{this.renderEquirectangular(e.texture,e.renderTarget.target,e.heading)})),t.commandBinder.addBinding(b.aD,(async e=>{this.render(e.renderTarget,e.sceneObject,e.camera)})))}getRenderSize(){const e=this.renderer.getPixelRatio(),t=this.renderer.getSize(this.cachedSize);return t.width*=e,t.height*=e,t}onUpdate(){this.debugRenderOffset=0}createRenderTarget2D(e,t=e,i,o=!0){const s=new a.WebGLRenderTarget(e,t,i);return s.texture.generateMipmaps=o,s}clearRenderTarget2D(e,t,i){const o=this.renderer.getClearColor(this.tempColor),s=this.renderer.getClearAlpha(),n=this.renderer.getRenderTarget();this.renderer.setRenderTarget(e),t&&this.renderer.setClearColor(t),null!=i&&this.renderer.setClearAlpha(i),this.renderer.clear(),this.renderer.setRenderTarget(n),t&&this.renderer.setClearColor(o),null!=i&&this.renderer.setClearAlpha(s)}disposeRenderTarget2D(e){e.texture.dispose(),e.depthTexture&&e.depthTexture.dispose(),e.dispose()}getRenderTargetData(e,t){const i=e.width,o=e.height;return t=t||new Uint8Array(i*o*4),this.renderer.readRenderTargetPixels(e,0,0,i,o,t),t}compose(e,t,i){var o;const s=Object.assign({sourceMask:T,sourceResize:!0,sourceScale:1},i),{uniforms:n}=this.composePlane.material;n.bg.value=this.isRenderTarget(t)?t.texture:t,n.mask.value=this.isRenderTarget(s.sourceMask)?s.sourceMask.texture:s.sourceMask,this.scene.add(this.composePlane);const{z:r,w:l}=null!==(o=null==e?void 0:e.viewport)&&void 0!==o?o:this.renderer.getViewport(new a.Vector4),h=n.bg.value.image.width,d=n.bg.value.image.height,c=!s.sourceResize&&(r!==h||l!==d);if(c){const e=new a.Vector3(s.sourceScale*h/r,s.sourceScale*d/l,1),t=.01,i=new a.Vector3(.5-t-.5*e.x,-.5+t+.5*e.y,0);this.composePlane.applyMatrix4((new a.Matrix4).compose(i,new a.Quaternion,e)),this.composePlane.updateMatrixWorld()}this.overrideRenderTarget(e,(()=>{this.renderer.render(this.scene,this.orthoCamera)})),this.scene.remove(this.composePlane),c&&(this.composePlane.position.set(0,0,0),this.composePlane.scale.set(1,1,1),this.composePlane.updateMatrixWorld()),n.bg.value=null,n.mask.value=null}copyTexture(e,t){return this.compose(e,t)}resizeTexture(e,t){const i=new a.WebGLRenderTarget(t,t);return e.isCompressedTexture?i.texture.format=a.RGBAFormat:i.texture.format=e.format,i.texture.addEventListener("dispose",i.dispose.bind(i)),this.copyTexture(i,e),i.texture}renderToScreen(e,t=!0,i,s){const n=()=>{const t=this.isRenderTarget(e)?e.width:e.image.width,o=this.isRenderTarget(e)?e.height:e.image.height,n=i?i.x:this.debugRenderOffset,a=i?i.y:60;this.renderer.getViewport(this.cachedViewport),this.renderer.setViewport(n,a,t,o),this.compose(null,e,s?{sourceMask:s}:void 0),this.renderer.setViewport(this.cachedViewport),i||(this.debugRenderOffset+=t+4)};t?n():this.engine.after(o.Rb.Render).then(n)}isRenderTarget(e){return e.isRenderTarget}renderContext(e,t){e.texture.image=t.canvas,e.texture.needsUpdate=!0}render(e,t,i,o,s=!0){const n=t.parent;if(n&&this.scene.applyMatrix4(n.matrixWorld),this.scene.add(t),e.isWebGLCubeRenderTarget){const t=new a.CubeCamera(.01,1e3,e);i.getWorldPosition(t.position),i.getWorldQuaternion(t.quaternion),this.scene.add(t),this.scene.updateMatrixWorld(),t.layers.mask=o?o.mask:i.layers.mask,t.update(this.renderer,this.scene),this.scene.remove(t)}else{i.getWorldPosition(this.camera.position),i.getWorldQuaternion(this.camera.quaternion),this.camera.projectionMatrix.copy(i.projectionMatrix),this.camera.layers.mask=o?o.mask:i.layers.mask;const t=this.renderer.getSize(this.cachedSize),n=t.width/t.height,a=e.width/e.height,r=this.camera.projectionMatrix;n>a?r.elements[0]=r.elements[5]/a:r.elements[5]=r.elements[0]*a,this.overrideRenderTarget(e,(()=>{s&&this.renderer.clear(),this.renderer.render(this.scene,this.camera)}))}return n&&(n.add(t),this.scene.matrixWorld.identity()),this.scene.remove(t),e}setScissors(e,t){if(e){if(!t)throw Error("Rect to restrict rendering to required when enabling scissors.");this.renderer.setScissorTest(!0),this.renderer.setScissor(t.x,t.y,t.width,t.height)}else{const e=this.renderer.getSize(this.cachedSize);this.renderer.setScissor(0,0,e.width,e.height),this.renderer.setScissorTest(!1)}}renderSphericalProjection(e,t,i,o,s){const n=y.circle_projection;n.uniforms.borderColor.value.copy(s||new a.Vector4(1,1,1,1)),n.uniforms.borderSize.value=o||0,n.uniforms.textureSampleScale.value=i||5,n.uniforms.panoTexture.value=e,this.scene.add(this.circleProjectionPlane),this.circleProjectionPlane.position.z=0,this.overrideRenderTarget(t,(()=>{this.renderer.render(this.scene,this.orthoCamera)})),this.scene.remove(this.circleProjectionPlane),n.uniforms.panoTexture.value=null}renderEquirectangular(e,t,i=0){const o=this.equirectProjectionPlane.material;o.uniforms.cubemap.value=e,o.uniforms.yaw.value=i,this.scene.add(this.equirectProjectionPlane),this.equirectProjectionPlane.position.z=0,this.overrideRenderTarget(t,(()=>{this.renderer.render(this.scene,this.orthoCamera)})),this.scene.remove(this.equirectProjectionPlane),o.uniforms.cubemap.value=null,o.uniforms.yaw.value=0}overrideRenderTarget(e,t){const i=this.renderTargetSwap(e);t(),this.renderTargetRestore(i)}renderTargetSwap(e){const t=this.renderer.xr.enabled,i=this.renderer.getRenderTarget(),o=this.renderer.getViewport(this.cachedViewport2);return this.renderer.xr.enabled=!1,this.renderer.setRenderTarget(e),{xr:t,rtt:i,viewport:o}}renderTargetRestore(e){this.renderer.xr.enabled=e.xr,this.renderer.setRenderTarget(e.rtt),this.renderer.setViewport(e.viewport)}async readFloatPixelsAsync(e,t){for(const t of e.textures)if(t.type!==a.FloatType||t.format!==a.RGBAFormat)throw new Error("[Render to Texture]: All Textures in WebGLRenderTarget.textures must be of type: FloatType and format: RGBAFormat");if(e.textures.length!==t.length)throw new Error("[Render To Texture]: WebGLRenderTarget.textures.length should be equal to buffers.length.");const i=t.length;for(let o=0;o<i;o++){if(t[o].length!==e.width*e.height*4)throw new Error(`[Render To Texture]: Not enough space allocated in buffer at index ${o}`)}const o=this.renderTargetSwap(e),s=this.renderer.getContext(),n=[];for(let o=0;o<i;o++){const i=t[o],a=s.createBuffer();if(null==a)throw new Error(`[Render To Texture]: glCreateBuffer failed at index ${o}`);n.push(a),s.bindBuffer(s.PIXEL_PACK_BUFFER,a),s.bufferData(s.PIXEL_PACK_BUFFER,i.byteLength,s.STREAM_READ),s.readBuffer(s.COLOR_ATTACHMENT0+o),s.readPixels(0,0,e.width,e.height,s.RGBA,s.FLOAT,0)}this.renderTargetRestore(o);const r=s.fenceSync(s.SYNC_GPU_COMMANDS_COMPLETE,0);r&&(s.flush(),await this.waitUntilSync(r,4));for(let e=0;e<i;e++){const i=n[e];s.bindBuffer(s.PIXEL_PACK_BUFFER,i),s.getBufferSubData(s.PIXEL_PACK_BUFFER,0,t[e]),s.deleteBuffer(i)}return s.deleteSync(r),t}async waitUntilSync(e,t){const i=this.renderer.getContext();return new Promise((function(o,s){setTimeout((function n(){switch(i.clientWaitSync(e,i.SYNC_FLUSH_COMMANDS_BIT,0)){case i.WAIT_FAILED:s();break;case i.TIMEOUT_EXPIRED:setTimeout(n,t);break;default:o()}}),t)}))}renderAndReadAsync(e,t,i){const o=i.buffer;if(!this.renderer.capabilities.isWebGL2)return s.Vy.for(this).debug("renderAsync call webgl2, falling back to sync render/read"),this.render(e.target,e.mesh,e.camera),Promise.resolve(this.getRenderTargetData(e.target,o));const n=this.renderTargetSwap(e.target),a=this.renderer.getContext(),r=i.webglBuffer||a.createBuffer();if(!r)throw Error("Unable to create pack buffer");return a.bindBuffer(a.PIXEL_PACK_BUFFER,r),a.bufferData(a.PIXEL_PACK_BUFFER,o.byteLength,a.DYNAMIC_READ),e.clear&&this.renderer.clear(),this.renderer.render(e.mesh,e.camera),a.readPixels(t.x,t.y,t.width,t.height,a.RGBA,a.UNSIGNED_BYTE,0),a.bindBuffer(a.PIXEL_PACK_BUFFER,null),this.renderTargetRestore(n),this.cwfRenderer.fence(a).then((()=>(a.bindBuffer(a.PIXEL_PACK_BUFFER,r),a.getBufferSubData(a.PIXEL_PACK_BUFFER,0,o),a.bindBuffer(a.PIXEL_PACK_BUFFER,null),i.webglBuffer||a.deleteBuffer(r),o)))}}},46192:(e,t,i)=>{"use strict";i.d(t,{C:()=>n});var o=i(93877),s=i(56547);function n(e,t,i){const n=e&&e.hasRooms(),a=i?t.getLayer(i):t.getActiveLayer();return a&&a.layerType===o.ku.COMMON_USER_LAYER?!n:!!(0,s.XF)(t.getCurrentView())||!n}},93358:(e,t,i)=>{"use strict";i.d(t,{W:()=>o});class o{constructor(e){this.tags=[],e&&Object.assign(this,e)}}},69325:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>w});var o=i(77201),s=i(50485),n=i(12837),a=i(99583),r=i(63846),l=i(26172),h=i(20968),d=i(97800),c=i(93358);const u=new d.Vy("mds-floor-deserializer");class m{deserialize(e){var t,i,o,s;if(!e||!this.validate(e))return u.debug("Deserialized invalid room data from MDS",e),null;const n=e=>null!==e?e:void 0,a=e.dimensions||{height:null,width:null,depth:null,areaFloor:null},{height:r,width:l,depth:h,areaFloor:d}=a;return new c.W({id:e.id,meshSubgroup:e.meshId||-1,floorId:null!==(i=null===(t=e.floor)||void 0===t?void 0:t.id)&&void 0!==i?i:"",height:n(r),width:n(l),depth:n(h),areaFloor:n(d),tags:null!==(s=null===(o=e.tags)||void 0===o?void 0:o.filter((e=>e)))&&void 0!==s?s:void 0})}validate(e){const t=["id","meshId"].every((t=>t in e)),i=e.floor&&e.floor.id&&"number"==typeof e.floor.meshId;return t&&!!i}}class p extends h.g{constructor(){super(...arguments),this.prefetchKey="data.model.rooms"}async read(e){const t=new m,i={modelId:this.getViewId()};return this.query(l.GetRooms,i,e).then((e=>{var i,o;const s=null===(o=null===(i=null==e?void 0:e.data)||void 0===i?void 0:i.model)||void 0===o?void 0:o.rooms;if(!s||!Array.isArray(s))return null;return s.reduce(((e,i)=>{const o=t.deserialize(i);return o&&(e[o.id]=o),e}),{})}))}}var g=i(47737),v=i(12866),f=i(8694);class w extends o.nV{constructor(){super(...arguments),this.name="room-data",this.visitedRooms={}}async init(e,t){const{baseModelId:i,baseUrl:o}=e,n=await t.market.waitForData(g.P);this.store=new p({context:n.mdsContext,baseUrl:o,readonly:!0,viewId:i});const a=await this.store.read();this.data=new s.q(a||{}),t.market.register(s.q,this.data),await this.setupRoomChangeListeners(t)}async setupRoomChangeListeners(e){const t=await e.market.waitForData(a.X),i=await this.isRoomBoundsEnabled(e);i?this.setupPIERoomChangeAnalytics(e,t,i):await this.setupLegacyRoomChangeAnalytics(e,t)}async setupPIERoomChangeAnalytics(e,t,i){const o=o=>{const s=i.rooms.size,n=this.updateVisitCounts(o.id);e.broadcast(new r.h(o.id,null,t.closestMode,n,s,"","property_layout",o.roomTypeIds))},s=await e.market.waitForData(f.y);s.currentRoom&&o(s.currentRoom);const n=s.makeCurrentRoomChangeSubscription((e=>{e&&o(e)}));this.bindings.push(n)}async setupLegacyRoomChangeAnalytics(e,t){const i=i=>{const o=this.data.roomCount,s=this.updateVisitCounts(i.id);e.broadcast(new r.h(i.id,i.meshSubgroup,t.closestMode,s,o,"","vision"))},o=await e.market.waitForData(n.A),s=o.makeSweepChangeSubscription((e=>{if(e){const t=o.getSweep(e);this.data.selected.value=t.roomId,this.data.commit()}})),a=this.data.selected.onChanged((e=>{if(null!==e){const t=this.data.get(e);t&&i(t)}}));this.bindings.push(s,a)}updateVisitCounts(e){this.visitedRooms[e]||(this.visitedRooms[e]={visitCount:0}),this.visitedRooms[e].visitCount++;return this.visitedRooms[e].visitCount}async isRoomBoundsEnabled(e){const t=await e.market.waitForData(v.A);return t.rooms.size>0?t:null}}},98217:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>S});var o=i(77201),s=i(71687),n=i(68909),a=i(91177),r=i.n(a),l=i(99515),h=i.n(l);const d={sky:{uniforms:{topColor:{value:new n.Vector3(.094,.102,.11)},bottomColor:{value:new n.Vector3(.2,.216,.235)},cameraMatrix:{value:new n.Matrix4},inverseProjectionMatrix:{value:new n.Matrix4},radius:{value:1e4}},vertexShader:r(),fragmentShader:h()}};class c extends n.ShaderMaterial{constructor(e={}){super(Object.assign({fragmentShader:d.sky.fragmentShader,vertexShader:d.sky.vertexShader,uniforms:n.UniformsUtils.clone(d.sky.uniforms),name:"SkyboxMaterial"},e))}}var u=i(3694),m=i(37458),p=i(12767),g=i(81662),v=i(87389);class f{constructor(e,t,i,s,n=o.HU.ALL){this.scene=e,this.cameraData=t,this.addToRaycasting=i,this.removeFromRaycasting=s,this.renderLayer=n,this.bindings=[]}init(){const{visualMesh:e,colliderMesh:t}=this.setupSkysphere();this.skyVisual=e,this.material=this.skyVisual.material,this.skyCollider=t}dispose(){this.material.uniforms.pano0Map&&this.material.uniforms.pano0Map.value.dispose(),this.material.uniforms.pano1Map&&this.material.uniforms.pano1Map.value.dispose(),this.material.dispose(),this.skyVisual.geometry.dispose()}activate(e){this.scene.addChild(this.scene.ids.Root,this.skyVisual),this.skyVisual.updateMatrixWorld(!0),this.skyVisual.visible=!0,this.addToRaycasting(this.skyCollider,!1)}deactivate(e){for(const e of this.bindings)e.cancel();this.bindings=[],this.scene.removeChild(this.scene.ids.Root,this.skyVisual),this.scene.removeChild(this.scene.ids.CameraRig,this.skyCollider),this.removeFromRaycasting(this.skyCollider)}updateBackgroundColors(e,t){const i=new n.Color(e),o=new n.Color(t);this.material.uniforms.topColor.value.set(i.r,i.g,i.b),this.material.uniforms.bottomColor.value.set(o.r,o.g,o.b)}beforeRender(){this.skyCollider.position.copy(this.cameraData.pose.position),this.material.uniforms.cameraMatrix.value.compose(this.cameraData.pose.position,this.cameraData.pose.rotation,g.B1.UNIT),this.material.uniforms.inverseProjectionMatrix.value.copy(this.cameraData.pose.projection.asThreeMatrix4()),this.material.uniforms.inverseProjectionMatrix.value.invert()}render(){}setupSkysphere(e){const t=new n.SphereGeometry(1e4,5,5);t.computeBoundingBox();const i=p.Bv.far-10,o=new v.A;e||(e=new c({side:n.FrontSide}));const s=new u.W(o,e);s.layers.mask=this.renderLayer.mask,s.name="Skysphere",s.renderOrder=m.X.boundingSkybox,s.updateMatrixWorld(!0),s.frustumCulled=!1,e.uniforms.radius.value=i,e.depthWrite=!1,e.depthTest=!1;return{visualMesh:s,colliderMesh:new u.W(t,new n.MeshBasicMaterial({opacity:0,depthWrite:!1,side:n.BackSide}))}}}var w=i(25316),y=i(5601),D=i(56208),b=i(10459);class S extends o.nV{constructor(){super(...arguments),this.name="skybox-module"}async init(e,t){const[i,o,n,a]=await Promise.all([t.getModuleBySymbol(s.M7),t.market.waitForData(w.o),t.getModuleBySymbol(s.mL),t.market.waitForData(b.M)]),r=t.claimRenderLayer("skybox"),l=i.getScene();this.skybox=new f(l,a,n.registerMesh,n.unregisterMesh,r),t.addComponent(this,this.skybox);const h=o.tryGetSetting(D.Q$.BackgroundColor,y.v.default);this.skybox.updateBackgroundColors(y.t[h].bgPrimary,y.t[h].bgSecondary),this.bindings.push(o.onSettingChanged(D.Q$.BackgroundColor,(e=>{this.skybox.updateBackgroundColors(y.t[e].bgPrimary,y.t[e].bgSecondary)})))}}},45979:(e,t,i)=>{"use strict";i.d(t,{z:()=>r});var o=i(37458),s=i(68909),n=i(19968),a=i(97831);class r extends s.Object3D{constructor(e){super(),this.cameraData=e,this.visible=!0,this.width=1,this.height=1,this.renderOrder=o.X.exteriorSplat}updateDepthBuffer(e,t,i){this.depthBuffer=e,this.width=t,this.height=i}raycast(e,t){if(this.depthBuffer&&this.visible){const i=l(e.ray,this.cameraData,this.depthBuffer,this.width,this.height);i&&t.push({distance:e.ray.origin.distanceTo(i.pt),object:this,point:i.pt.clone(),normal:i.normal.clone(),face:{a:-1,b:-1,c:-1,materialIndex:-1,normal:i.normal.clone()}})}}}const l=(()=>{const e=new s.Vector2,t=new s.Vector3,i=new s.Vector3,o=new s.Vector3,a=new s.Vector3,r=new s.Vector3,l=new s.Vector3,d=new s.Vector3;return(c,u,m,p,g)=>{const v=(0,n.jn)(c.origin,u.pose.position,u.pose.rotation,u.pose.projection.asThreeMatrix4());e.set(2/u.width,2/u.height);const f=h(v,e,u,m,p,g);t.copy(v),t.y+=10*e.y;const w=h(t,e,u,m,p,g);i.copy(v),i.y-=10*e.y;const y=h(i,e,u,m,p,g);o.copy(v),o.x-=10*e.y;const D=h(o,e,u,m,p,g);a.copy(v),a.x+=10*e.y;const b=h(a,e,u,m,p,g);if(f){const e=new s.Vector3(0,0,0);let t=0;const i=[w,D,y,b];for(let o=0;o<i.length;o++){const s=i[o],n=i[(o+1)%i.length];s&&n&&(r.subVectors(s,f).normalize(),l.subVectors(n,f).normalize(),d.crossVectors(r,l).normalize(),e.add(d),t++)}if(t>1)return e.multiplyScalar(1/t),{pt:f,normal:e}}return null}})(),h=(()=>{const e=Math.floor(5),t=new s.Vector2,i=new s.Vector2(1,1),o=new s.Vector2,r=new s.Vector2,l=new s.Vector3,h=new s.Vector3;return(d,c,u,m,p,g)=>{const v=new s.Vector3(0,0,0);let f=0;for(let s=-e;s<=e;s++)for(let w=-e;w<=e;w++){t.set(w*c.x,s*c.y),o.copy(d).add(t),r.copy(o).add(i).multiplyScalar(.5),r.x*=p,r.y*=g;const e=m[4*(Math.floor(r.y)*Math.floor(p)+Math.floor(r.x))]*a.t;if(e<a.t&&e>0){const t=u.pose.position,i=(0,n.Ft)(u.pose,l.set(o.x,o.y,1),l);i.sub(t).normalize(),h.copy(t).addScaledVector(i,e),v.add(h),f++}}return f<5?null:(v.multiplyScalar(1/f),v)}})()},82390:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>V});var o=i(77201),s=i(97800),n=i(25316),a=i(49953),r=i(71687),l=i(12715),h=i(20968),d=i(68909),c=i(48539);class u extends o.vm{constructor(){super(...arguments),this.location="unpublished",this.translation=new d.Vector3,this.rotation=new d.Quaternion,this.scale=(new d.Vector3).setScalar(1)}equals(e){return this.id===e.id&&this.layerId===e.layerId&&(0,c.Ww)(this.viewIds,e.viewIds)&&this.location===e.location&&this.translation.equals(e.translation)&&this.rotation.equals(e.rotation)&&this.scale.equals(e.scale)}copy(e){return this.id=e.id,this.layerId=e.layerId,this.viewIds=e.viewIds.slice(),this.location=e.location,this.url=e.url,this.urlTemplate=e.urlTemplate,this.translation.copy(e.translation),this.rotation.copy(e.rotation),this.scale.copy(e.scale),this}clone(){return(new u).copy(this)}}var m=i(86866),p=i(76185),g=i(81587),v=m.U$.fromVisionVector,f=m.U$.fromVisionQuaternion,w=m.U$.fromVisionScale;class y{deserialize(e){let t=null;return e.forEach((e=>{(0,p.$)(e.id),(null!=t?t:t={})[e.id]=this.deserializeSplat(e)})),t}deserializeSplat(e){var t,i,o,n,a;(0,p.$)(e.id),(0,p.$)(e.url),(0,p.$)(e.urlTemplate),(0,p.$)(e.layer);const r=new u;return r.id=e.id,r.layerId=e.layer.id,r.viewIds=(null===(t=e.layer.views)||void 0===t?void 0:t.map((e=>e.view.id)))||[],r.location=(null===(i=e.layer.views)||void 0===i?void 0:i.find((({view:e})=>"matterport.model.layered"===e.type)))?"published":"unpublished",r.url=new s.fN(e.url,(0,g.X)(e.validUntil)),r.urlTemplate=new s.fN(e.urlTemplate,(0,g.X)(e.validUntil)),r.translation=v((null===(o=e.transform)||void 0===o?void 0:o.translation)||{x:0,y:0,z:0}),r.scale=w((null===(n=e.transform)||void 0===n?void 0:n.scale)||{x:1,y:1,z:1}),r.rotation=f((null===(a=e.transform)||void 0===a?void 0:a.rotation)||{x:0,y:0,z:0,w:1}),r}}var D=i(79955),b=i(78498),S=m.U$.toVisionVector,M=m.U$.toVisionQuaternion,T=m.U$.toVisionScale;class x extends h.g{constructor(e,t="published"){super(e),this.splatLocation=t,this.deserializer=new y}async read(e){var t,i,o,s,n,a,r;const l={modelId:this.getViewId()};if("published"===this.splatLocation){const n=null!==(s=null===(o=null===(i=null===(t=(await this.query(D.GetSplats,l,e)).data)||void 0===t?void 0:t.model)||void 0===i?void 0:i.assets)||void 0===o?void 0:o.splats)&&void 0!==s?s:[];return this.deserializer.deserialize(n)}{const t=(null===(r=null===(a=null===(n=(await this.query(D.GetUnpublishedSplats,l,e)).data)||void 0===n?void 0:n.model)||void 0===a?void 0:a.views)||void 0===r?void 0:r.flatMap((e=>{var t;return(null===(t=e.model.assets)||void 0===t?void 0:t.splats)||[]})))||[];return this.deserializer.deserialize(t)}}async create(e,t,i){var o,s,n,a,r,l;null==i||i(0);const h=null!==(l=null===(r=null===(a=null===(n=null===(s=null===(o=(await this.client.upload(D.UploadSplat,"UploadSplat",{modelId:this.getBaseViewId(),contents:{blob:e,filename:e.name}},i&&(e=>{i(e.lengthComputable?e.loaded/e.total*.95:0)}))).data)||void 0===o?void 0:o.uploadExteriorView)||void 0===s?void 0:s.model)||void 0===n?void 0:n.assets)||void 0===a?void 0:a.splats)||void 0===r?void 0:r[0])&&void 0!==l?l:null;(0,p.$)(h);let d=this.deserializer.deserializeSplat(h);return d&&t&&(d.location=t.location,d.translation=t.translation,d.rotation=t.rotation,d.scale=t.scale,d=await this.update(d)),null==i||i(1),d}async update(e){var t;const i=e.location,o=await this.client.mutate(D.PatchSplat,{modelId:e.viewIds[0],splatId:e.id,transform:{translation:(0,b.I)(S(e.translation)),rotation:(0,b.p)(M(e.rotation)),scale:(0,b.I)(T(e.scale))}});(0,p.$)(null===(t=o.data)||void 0===t?void 0:t.patchModelSplat);const s=this.deserializer.deserializeSplat(o.data.patchModelSplat);return s.location!==i&&(await this.updatePublished(s,"published"===i),s.location=i),s}async updatePublished(e,t){await this.client.mutate(t?D.PublishSplat:D.UnpublishSplat,{modelId:this.getBaseViewId(),splatLayerId:e.layerId})}async delete(e){await this.mutate(D.DeleteSplat,{splatLayerId:e.layerId,viewId:e.viewIds[0]})}}var C=i(97831);var k=i(25481),P=i(10833);function F(e){const t=e.getOverrideParam("splat_preview","");if(t)try{const e=JSON.parse(t),i=(e,t)=>{return i=e,o=k.Et,!!Array.isArray(i)&&i.every(o)&&e.length===t;var i,o};if(e&&(0,P.K)(e.id)&&i(e.t,3)&&i(e.r,4)&&i(e.s,3))return{id:e.id,translation:(new d.Vector3).fromArray(e.t),rotation:(new d.Quaternion).fromArray(e.r),scale:(new d.Vector3).fromArray(e.s)}}catch(e){new s.Vy("parseSplatPreviewParam").warn("Invalid splat_preview url param")}return null}class V extends o.nV{constructor(){super(...arguments),this.name="splats-data-module"}async init(e,t){const[i,o,h]=await Promise.all([t.getModuleBySymbol(r.az),t.market.waitForData(a.L),t.market.waitForData(n.o)]);if(this.data=new l.O(null),function(e,t){return!!e.hasPolicy("org.spaces.exterior_views")&&t.tryGetSetting(C.G,!1)}(o,h)){const t=F(h),o=t?"unpublished":e.splatsLocation,n=i.layersData.getBaseModelId(),a=i.layersData.mdsContext;this.store=new x({viewId:n,context:a,readonly:!0},o),this.bindings.push(this.store.onNewData((async e=>{var i;if(e){(0,s._z)(e,(async()=>{var e;await(null===(e=this.store)||void 0===e?void 0:e.refresh())}));const o=t&&e[t.id];o&&Object.assign(o,t),null===(i=this.data)||void 0===i||i.splats.replace(e)}}))),await this.store.refresh()}t.market.register(l.O,this.data)}hasSplats(){return this.data.hasSplats}}},81530:(e,t,i)=>{"use strict";i.d(t,{F:()=>s});var o=i(77201);class s extends o.uB{constructor(e){super(),this.payload=e}}s.id="SAVE_COMMAND"},11018:(e,t,i)=>{"use strict";i.d(t,{A:()=>s});var o=i(77201);class s extends o.QB{constructor(e,t,i){super(),this.size=e,this.sweepId=t,this.renderTarget=i}}},18136:(e,t,i)=>{"use strict";i.r(t),i.d(t,{AssetDockedMessage:()=>m.I7,AssetUndockedMessage:()=>m.f1,CloseAndRemoveToolsCommand:()=>u._S,CloseCurrentToolCommand:()=>u.Te,CloseToolCommand:()=>u.u3,CollapseBottomPanelCommand:()=>u.oe,OpenInitialToolCommand:()=>u.M_,OpenPreviousToolCommand:()=>u.kC,OpenToolCommand:()=>u.Wm,PanelCollapseMessage:()=>m.rP,PanelTransitionEndMessage:()=>m._5,RegisterToolsCommand:()=>u.Kw,SetAppBarVisibleMessage:()=>m.k_,ToggleToolCommand:()=>u.yU,ToggleViewingControlsMessage:()=>m.Vk,Tool:()=>x.N,ToolAnnouncement:()=>d.Q7,ToolAnnouncementState:()=>d.zR,ToolPalette:()=>d.o6,ToolPanelLayout:()=>d.L$,ToolToggleCollapseCommand:()=>u.li,Tools:()=>d.S0,ToolsData:()=>h.M,default:()=>C});var o=i(77201),s=i(97800),n=i(71687);var a=i(10459),r=i(99583),l=i(3035),h=i(96319),d=i(73566),c=i(66355),u=i(17084),m=i(20246),p=i(66846),g=i(50178),v=i(12103),f=i(97573),w=i(25316),y=i(81088),D=i(29106),b=i(56147),S=i(71188),M=i(58480);class T extends o.nV{constructor(){super(...arguments),this.name="tools-module",this.toolsData=new h.M,this.activeToolDurationMap={},this.bottomPanelHeight=0,this.sidePanelWidth=0,this.sidePanelLeft=0,this.initialUrlToolOpened=!1,this.toolClosing=!1,this._adjustCanvas=!0,this.closeAndRemoveTools=async e=>!(e&&!await this.deactivateCurrentTool())&&(this.closeModal(),this.toolsData.setActiveTool(null),this.toolsData.removeAllTools(),!0),this.onAssetDocked=()=>{this.toolsData.assetDocked=!0,this.toolsData.commit()},this.onAssetUndocked=()=>{this.toolsData.assetDocked=!1,this.toolsData.commit()},this.onToggleModal=async e=>{this.toggleModal(e.modal,e.open)},this.closeModal=()=>{this.toolsData.openModal&&this.toggleModal(this.toolsData.openModal,!1)},this.allowToolOrViewChange=async()=>{var e;const t=this.toolsData.getActiveTool();if(!(null===(e=null==t?void 0:t.manager)||void 0===e?void 0:e.hasPendingEdits))return!0;if(await t.manager.hasPendingEdits()){const e={title:b.A.TOOLS.UNSAVED_CHANGES_TITLE,message:b.A.TOOLS.UNSAVED_CHANGES_MESSAGE,cancellable:!0,confirmPhraseKey:b.A.TOOLS.UNSAVED_CHANGES_CONFIRM,cancelPhraseKey:b.A.TOOLS.UNSAVED_CHANGES_CANCEL};return await this.engine.commandBinder.issueCommand(new y.nX(D.Y.DISPLAY,e))===D.$.CLOSE}return!0},this.toggleTool=async({toolName:e,active:t})=>t?this.openTool(e,!1):this.closeTool(e),this.closeCurrentTool=async()=>!!await this.deactivateCurrentTool()&&(this.toolsData.setActiveTool(null),!0),this.openInitialTool=async()=>{var e;const t=(0,p.X)(this.settingsData,this.initialUrlToolOpened);if(t){const i=this.toolsData.getTool(t);if(i){const o=(0,p.I)(this.settingsData,i);o&&(null===(e=i.manager)||void 0===e?void 0:e.deepLink)?i.manager.deepLink(o):this.engine.commandBinder.issueCommandWhenBound(new u.yU(t,!0))}}this.initialUrlToolOpened=!0},this.openPreviousTool=async()=>{this.toolsData.softOpening=!1,this.toolsData.commit();const e=this.toolsData.previousToolName;if(null===e)return;const t=this.toolsData.getTool(e)||null;null!==t?await this.deactivateCurrentTool(t)&&(await this.activateTool(t),this.toolsData.setActiveTool(e)):s.Vy.for(this).error(`Tool not loaded: ${e}`)},this.updateLayoutSize=()=>{const{toolPanelLayout:e}=this.toolsData;let t=e;const i=this.isSidePanelLayout();switch(e){case d.L$.NORMAL:i||(t=d.L$.NARROW);break;case d.L$.SIDE_PANEL:i||(t=d.L$.BOTTOM_PANEL);break;case d.L$.NARROW:i&&(t=d.L$.NORMAL);break;case d.L$.BOTTOM_PANEL:i&&(t=d.L$.SIDE_PANEL)}t!==e?(this.toolsData.toolPanelLayout=t,this.toolsData.commit()):e===d.L$.BOTTOM_PANEL&&this.adjustCanvasForPanel()},this.handleToolCollapse=async e=>{e!==this.toolsData.toolCollapsed&&(this.toolsData.toolCollapsed=e,this.toolsData.commit(),e||this.toolsData.toolPanelLayout!==d.L$.BOTTOM_PANEL||this.closeModal(),this.engine.broadcast(new m.rP(e)))},this.handleBottomPanelCollapse=async e=>{if(this.toolsData.toolPanelLayout===d.L$.BOTTOM_PANEL)return this.handleToolCollapse(e.collapse)},this.adjustCanvasForPanelActual=async()=>{if(!this.adjustCanvas)return;const{toolPanelLayout:e,toolCollapsed:t,assetDocked:i,openModal:o}=this.toolsData,{sidePanelWidth:s,bottomPanelHeight:n,sidePanelLeft:a}=this,r=this.toolsData.getActiveTool(),l=e===d.L$.SIDE_PANEL,h=r&&l&&!t,u=h&&!!(null==r?void 0:r.panelLeft),m=h?-v._2:0,p=m!==s?m:void 0,g=u?v._2:0,w=g!==a?g:void 0,y=e===d.L$.BOTTOM_PANEL&&!o&&i,D=-Math.floor((this.containerData.size.height-55)*c.P6/100),b=y?D:0,S=b!==n?b:void 0,M=0===p||0===S?0:c.Cp;this.resizeCanvas((0,f.v6)(p,S,w,M)),this.bottomPanelHeight=b,this.sidePanelWidth=m,this.sidePanelLeft=g},this.adjustCanvasForPanel=(0,s.sg)(this.adjustCanvasForPanelActual,50),this.resizeCanvas=async e=>{await this.canvasModule.resizeCanvas(e)}}async init(e,t){this.engine=t,await t.getModuleBySymbol(n.$c),this.analytics=await t.getModuleBySymbol(n.aF),[this.settingsData,this.appData,this.containerData,this.canvasModule]=await Promise.all([t.market.waitForData(w.o),t.market.waitForData(o.zH),t.market.waitForData(M.G),t.getModuleBySymbol(n.CE)]),this.updateLayoutSize(),this.bindings.push(t.commandBinder.addBinding(u.yU,this.toggleTool),t.commandBinder.addBinding(u.kC,this.openPreviousTool),t.commandBinder.addBinding(u.Wm,(async e=>this.openTool(e.toolName,e.softOpening))),t.commandBinder.addBinding(u.M_,this.openInitialTool),t.commandBinder.addBinding(u.u3,(async e=>this.closeTool(e.toolName))),t.commandBinder.addBinding(u.Te,this.closeCurrentTool),t.commandBinder.addBinding(y.X6,this.onToggleModal),t.commandBinder.addBinding(y.rH,(async()=>this.closeModal())),t.commandBinder.addBinding(u.li,(async e=>{this.handleToolCollapse(e.collapse)})),t.commandBinder.addBinding(u.oe,this.handleBottomPanelCollapse),this.containerData.onPropertyChanged("size",this.updateLayoutSize),t.subscribe(m.I7,this.onAssetDocked),t.subscribe(m.f1,this.onAssetUndocked),this.toolsData.onPropertyChanged("toolPanelLayout",this.adjustCanvasForPanel),this.toolsData.onPropertyChanged("activeToolName",this.adjustCanvasForPanel),this.toolsData.onPropertyChanged("toolCollapsed",this.adjustCanvasForPanel),this.toolsData.onPropertyChanged("assetDocked",this.adjustCanvasForPanel),t.commandBinder.addBinding(u._S,(({checkForEdits:e})=>this.closeAndRemoveTools(e))),t.commandBinder.addBinding(u.Kw,(async({tools:e})=>this.registerTools(...e)))),e.registerConfirmViewChange&&e.registerConfirmViewChange(this.allowToolOrViewChange),t.market.register(h.M,this.toolsData)}dispose(e){super.dispose(e),this.closeAndRemoveTools(!1),e.market.unregister(h.M)}registerTools(...e){e.forEach((e=>{e.featureFlag&&this.bindings.push(this.settingsData.onSettingChanged(e.featureFlag,(()=>this.updateEnabledTools())))})),this.toolsData.addTool(...e)}registerToolUi(e,t){this.toolsData.addToolUi(e,t)}unregisterToolUi(e,t){this.toolsData.removeToolUi(e,t)}get adjustCanvas(){return this._adjustCanvas}set adjustCanvas(e){this._adjustCanvas=e,e&&this.adjustCanvasForPanel()}closePanel(){this.toolsData.toolPanelLayout=this.isSidePanelLayout()?d.L$.NORMAL:d.L$.NARROW,this.toolsData.commit()}openPanel(e){if(!e.panel)return this.toolsData.toolCollapsed=!!e.panelBar,void this.toolsData.commit();const t=this.isSidePanelLayout();this.toolsData.toolPanelLayout=t?d.L$.SIDE_PANEL:d.L$.BOTTOM_PANEL;const i=!t&&!this.toolsData.softOpening;this.toolsData.toolCollapsed=i,this.toolsData.commit()}toggleModal(e,t){const{openModal:i,toolPanelLayout:s}=this.toolsData;if(t&&i===e||!t&&e!==i)return;const n=e.toLowerCase(),a=this.appData.application===o.lg.WORKSHOP?"workshop_gui":"showcase_gui";this.analytics.track(a,{gui_action:`open_${n}`}),e&&this.analytics.track("modal_shown",{modal:e}),this.toolsData.openModal=t?e:null,this.toolsData.commit(),s===d.L$.BOTTOM_PANEL&&t!==!!i&&this.adjustCanvasForPanel(),this.engine.broadcast(new g.rn(e,t))}async activateTool(e){if(this.toolInit)throw new Error("Current tool has not finished initializing!");this.toolsData.toolChangeInProgress=!0,this.toolsData.commit(),this.closeModal(),this.openPanel(e),e.manager&&(this.toolInit=e.manager.activate(),await this.toolInit,this.toolInit=null),this.toolsData.toolChangeInProgress=!1,this.toolsData.commit(),this.startTrackingTool(e)}async deactivateCurrentTool(e,t=!0){if(this.toolClosing)return!1;this.toolClosing=!0;const i=this.toolsData.getActiveTool();if(!i)return this.toolClosing=!1,!0;if(await this.toolInit,t&&!await this.allowToolOrViewChange())return this.toolClosing=!1,!1;this.engine.broadcast(new g.XR(!0)),i.manager?(this.toolsData.toolChangeInProgress=!0,this.toolsData.commit(),await i.manager.deactivate(),this.toolsData.toolChangeInProgress=!1,this.toolsData.commit(),this.engine.broadcast(new g.XR(!1))):setTimeout(this.engine.broadcast,100,new g.XR(!1)),this.closeModal();const o=this.toolsData.toolPanelLayout===d.L$.BOTTOM_PANEL||this.toolsData.toolPanelLayout===d.L$.NARROW||(null==e?void 0:e.panelLeft)===i.panelLeft;return!(e&&e.panel&&e.panel===i.panel&&o)&&this.closePanel(),this.toolClosing=!1,this.stopTrackingTool(i),!0}async activateToolName(e,t){const{activeToolName:i,toolChangeInProgress:o}=this.toolsData;if(o)return;if(i===e)return this.toolsData.softOpening=t,void this.toolsData.commit();const n=this.toolsData.getTool(e)||null;if(null===n)return void s.Vy.for(this).error(`Tool not loaded: ${e}`);const[h,d]=await Promise.all([this.engine.market.waitForData(a.M),this.engine.market.waitForData(r.X)]);await(0,l.L)(h,d),await this.deactivateCurrentTool(n)&&(await(0,l.L)(h,d),this.toolsData.softOpening=t,this.toolsData.commit(),await this.activateTool(n),this.toolsData.setActiveTool(n.id))}async deactivateToolName(e,t){e===this.toolsData.activeToolName&&await this.deactivateCurrentTool(t)&&this.toolsData.setActiveTool(null)}async openTool(e,t){await this.activateToolName(e,t)}async closeTool(e){await this.deactivateToolName(e)}startTrackingTool(e){this.activeToolDurationMap[e.analytic]=Date.now()}stopTrackingTool(e){const{analytic:t}=e;this.activeToolDurationMap[t]=Date.now()-this.activeToolDurationMap[t];const i={tool:`${t}_session_time`,duration:this.activeToolDurationMap[t]};this.analytics.track("tool_session_time",i)}updateEnabledTools(){const e=this.toolsData.toolsMap;e.atomic((()=>{for(const t of e)if(t.featureFlag){const e=this.settingsData.tryGetSetting(t.featureFlag,!1);t.enabled!==e&&(t.enabled=e,t.commit())}}))}isSidePanelLayout(){return!(0,S.w)(this.containerData.size)}}var x=i(23864);const C=T},15506:(e,t,i)=>{"use strict";i.d(t,{Ux:()=>h,j7:()=>l,nl:()=>r,np:()=>c,vr:()=>d,zc:()=>a});var o=i(74381),s=i(13893),n=i(1333);const a={[o.ES.FADE_TO_BLACK]:s.fl.FadeToBlack,[o.ES.INSTANT]:s.fl.Instant,[o.ES.INTERPOLATE]:s.fl.Interpolate},r={[o.Zw.LEFT]:n.ND.Left,[o.Zw.RIGHT]:n.ND.Right,[o.Zw.AUTO]:n.ND.Auto},l={[o.h6.START]:"start",[o.h6.CENTER]:"center"},h={[s.fl.FadeToBlack]:o.ES.FADE_TO_BLACK,[s.fl.Instant]:o.ES.INSTANT,[s.fl.Interpolate]:o.ES.INTERPOLATE,[s.fl.MoveToBlack]:o.ES.FADE_TO_BLACK,[s.fl.OrbitTo]:o.ES.INTERPOLATE},d={[n.ND.Left]:o.Zw.LEFT,[n.ND.Right]:o.Zw.RIGHT,[n.ND.Auto]:o.Zw.AUTO},c={start:o.h6.START,center:o.h6.CENTER}},30794:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>T});var o=i(77201),s=i(71687),n=i(25316),a=i(2993),r=i(13893),l=i(22278),h=i(81662),d=i(68909),c=i(40397),u=i(12837),m=i(78229),p=i(96659),g=i(10459),v=i(56208),f=i(9997),w=i(26482),y=i(39209),D=i(9231),b=i(46793),S=i(15580),M=i(97800);class T extends o.nV{constructor(){super(...arguments),this.name="viewmode-change",this.recenterFloorplanModeSwitch=!0}async init(e,t){this.engine=t,this.viewmodesModule=await t.getModuleBySymbol(s.SD),this.bindings.push(t.subscribe(o.E5,(e=>this.setEnabledModes(e.application))),t.commandBinder.addBinding(b.S2,this.onChangeViewmodeCommand.bind(this)));const[i,a]=await Promise.all([t.market.waitForData(o.zH),t.market.waitForData(n.o)]);this.settings=a,(0,S.sj)(a,e.inWorkshop),(0,S.cW)(a,e.inWorkshop),this.setEnabledModes(i.application),this.bindings.push(a.onSettingChanged(v.Q$.FloorPlan,(()=>(0,S.sj)(a,e.inWorkshop))),a.onSettingChanged(v.Q$.Dollhouse,(()=>(0,S.cW)(a,e.inWorkshop))))}setShouldRecenterFloorplan(e){this.recenterFloorplanModeSwitch=e}async setEnabledModes(e){const t=await this.engine.getModuleBySymbol(s.zj),i=await this.engine.getModuleBySymbol(s.$q);if(this.viewmodesModule.data.isExteriorDisabled=()=>!i.hasSplats(),e===o.lg.SHOWCASE){if(this.viewmodesModule.data.isDollhouseDisabled=()=>!this.settings.tryGetSetting(S.n9,!1),this.viewmodesModule.data.isFloorplanDisabled=()=>!this.settings.tryGetSetting(S._z,!1),t.setDollhouseVerticalLimits({noTransition:!0}),this.previousApp){const e=await this.engine.market.waitForData(g.M),t=this.viewmodesModule.data.peekabooCorrectedMode(e);if(t===a.N3.Dollhouse&&this.viewmodesModule.data.isDollhouseDisabled()||t===a.N3.Floorplan&&this.viewmodesModule.data.isFloorplanDisabled()){const t=(await this.engine.market.waitForData(w.G)).pose;if(t&&(0,a.nI)(t.mode))this.goToInsideMode(r.fl.Interpolate,{position:t.camera.position},t.mode);else{const t=e.pose,i=(await this.engine.market.waitForData(u.A)).getClosestSweep(t.position,!0),o=i?{position:i.position}:void 0;this.goToInsideMode(r.fl.Interpolate,o,a.N3.Panorama)}}}}else e===o.lg.WORKSHOP&&(this.viewmodesModule.data.isDollhouseDisabled=()=>!1,this.viewmodesModule.data.isFloorplanDisabled=()=>!1,t.setDollhouseVerticalLimits({noTransition:!0}));this.previousApp=e}async onChangeViewmodeCommand(e){try{switch(e.mode){case b.w5.INSIDE:return this.goToInsideMode(e.transitionType,e.pose,a.N3.Panorama,e.transitionTime);case b.w5.DOLLHOUSE:return this.goToDollhouse(e.transitionType,e.pose,e.transitionTime);case b.w5.FLOORPLAN:return this.goToFloorplan(e.transitionType,e.pose,e.transitionTime);case b.w5.ORTHOGRAPHIC:return this.goToOrthographic(e.transitionType,e.pose,e.transitionTime);case b.w5.MESH:return this.goToInsideMode(e.transitionType,e.pose,a.N3.Mesh,e.transitionTime);case b.w5.EXTERIOR:return this.goToExterior(e.transitionType,e.pose,e.transitionTime)}}catch(t){throw M.Vy.for(this).error(t),new D.FA(`Could not move to mode ${e.mode}`,t)}}async changeViewmode(e){try{switch(e){case a.N3.Panorama:return this.goToInsideMode(r.fl.Interpolate,void 0,a.N3.Panorama);case a.N3.Dollhouse:return this.goToDollhouse(r.fl.Interpolate);case a.N3.Floorplan:return this.goToFloorplan(r.fl.Interpolate);case a.N3.Orthographic:return this.goToOrthographic(r.fl.Interpolate);case a.N3.Mesh:return this.goToInsideMode(r.fl.Interpolate,void 0,a.N3.Mesh);case a.N3.ExteriorSplat:return this.goToExterior(r.fl.Interpolate)}}catch(t){throw M.Vy.for(this).error(t),new D.FA(`Could not move to mode ${e}`,t)}}async goToInsideMode(e=r.fl.Interpolate,t={},i,o){const s=this.engine.market.tryGetData(u.A);if(!s)throw new D.dj;if(!(0,a.nI)(i))throw new D.dj;let n=t.sweepID||s.state.currentSweep;if(n||(n=await this.getLookAtSweep(s)),s.isSweepUnaligned(n)){const e=s.getFirstAlignedSweep();n=e?e.id:this.getFirstSweepId(s)}return(0,a.nI)(this.viewmodesModule.currentMode)&&s.isSweepUnaligned(s.state.currentSweep)?this.engine.commandBinder.issueCommand(new f.aj({sweep:n,viewId:t.viewId,rotation:t.rotation,transition:r.fl.FadeToBlack})):this.viewmodesModule.switchToMode(i,e,{sweepID:n,viewId:t.viewId,rotation:t.rotation},o)}async getLookAtSweep(e){const t=this.engine.market.tryGetData(g.M);if(!t)return this.getFirstSweepId(e);const i=this.engine.market.tryGetData(y.X),o=(null==i?void 0:i.getFloorMin())||this.getModelMinHeight(),s=new d.Plane(h.B1.DOWN,o),n=(0,c.qK)(t.pose.position,t.pose.rotation,s);if(!n)return this.getFirstSweepId(e);const a=[m.Zx(),m.Ol(),e=>!i||i.isCurrentOrAllFloors(e.floorId)],r=[p.cv(n)],l=e.sortByScore(a,r).shift();if(l)return l.sweep.id;const u=e.getClosestSweep(n,!0);return u?u.id:this.getFirstSweepId(e)}getFirstSweepId(e){const t=e.getFirstSweep();if(void 0===t)throw new Error("First enabled sweep not found");return t.id}getModelMinHeight(){return this.meshData||(this.meshData=this.engine.market.tryGetData(l.U)),this.meshData?this.meshData.extendedBounds.min.y:0}async goToDollhouse(e=r.fl.Interpolate,t={},i){if(this.viewmodesModule.data.isDollhouseDisabled())throw new D.dj;return this.viewmodesModule.switchToMode(a.N3.Dollhouse,e,t,i)}async goToExterior(e=r.fl.Interpolate,t={},i){if(this.viewmodesModule.data.isExteriorDisabled())throw new D.dj;return this.viewmodesModule.switchToMode(a.N3.ExteriorSplat,e,t,i)}async goToFloorplan(e=r.fl.Interpolate,t={},i){if(this.viewmodesModule.data.isFloorplanDisabled())throw new D.dj;const o=await this.engine.getModuleBySymbol(s.CE);return o&&await o.getTransitionPromise(),this.viewmodesModule.switchToMode(a.N3.Floorplan,e,t,i,this.recenterFloorplanModeSwitch)}async goToOrthographic(e=r.fl.Interpolate,t={},i){const o=await this.engine.getModuleBySymbol(s.CE);return o&&await o.getTransitionPromise(),this.viewmodesModule.switchToMode(a.N3.Orthographic,e,t,i)}}},9231:(e,t,i)=>{"use strict";i.d(t,{FA:()=>l,Xy:()=>n,dj:()=>r,ke:()=>a});var o=i(27960);class s extends o.d{constructor(e="Unhandled Viewmode Exception",t){super(e),this.originalError=t,this.name="ViewmodeException"}}class n extends s{constructor(e="Tried to start view-mode transition while another transition was active"){super(e),this.name="ViewmodeActiveTransition"}}class a extends s{constructor(e="Cannot change viewmode when locked"){super(e),this.name="ViewmodeLocked"}}class r extends s{constructor(e="Cannot change to disabled/invalid viewmode"){super(e),this.name="ViewmodeInvalid"}}class l extends s{constructor(e="Unhandled Error processing viewmode change command",t){super(e,t),this.name="ViewmodeCommandException"}}},304:(e,t,i)=>{"use strict";i.d(t,{_:()=>n,x:()=>s});var o=i(77201);class s extends o.uB{constructor(){super()}}s.id="LOCK_VIEWMODE";class n extends o.uB{constructor(){super()}}n.id="UNLOCK_VIEWMODE"},6002:(e,t,i)=>{"use strict";i.r(t),i.d(t,{SMALL_ROTATION_DISTANCE:()=>O,SMALL_TRANSLATION_DISTANCE:()=>V,default:()=>A});var o=i(77201),s=i(71687),n=i(2993),a=i(13893),r=i(68909),l=i(81662),h=i(4330),d=i(12767),c=i(99583),u=i(1197),m=i(98309),p=i(45862),g=i(9231),v=i(40397),f=i(53172),w=i(19968);const y=(e,t,i,o)=>{const s=i.clone().multiply((new r.Quaternion).setFromAxisAngle(l.B1.RIGHT,60*f.fy)),n=l.B1.FORWARD.clone().applyQuaternion(s).multiplyScalar(-1*e),a=t.clone().add(n);return o.position=a,o.rotation=s,e},D=e=>{const t=e.getCenter(new r.Vector3);return e.max.distanceTo(t)/Math.tan(d.Bv.fov/2*f.fy)};var b=i(46771),S=i(94814),M=i(15930),T=i(22278),x=i(304),C=i(62568),k=i(49155),P=i(97800),F=i(12715);const V=.2,O=3*f.fy,I=[n.N3.Mesh,n.N3.Panorama,n.N3.Floorplan,n.N3.Dollhouse,n.N3.Orthographic,n.N3.ExteriorSplat],B={[n.N3.Mesh]:M.Ou,[n.N3.Panorama]:M.Ou,[n.N3.Dollhouse]:M.Ou,[n.N3.Floorplan]:M.Ou,[n.N3.Orthographic]:M.Ou,[n.N3.ExteriorSplat]:M.Ou};class A extends o.nV{constructor(){super(...arguments),this.name="viewmode",this.data=new c.X,this.minDollhouseDistance=15,this.maxDollhouseDistance=50,this._orthoMatrix=new b.k,this.snapToPhiLimit=(e,t,i)=>this.cameraModule.getCameraControllerForData(i).moveTo({transitionType:a.fl.OrbitTo,transitionTime:t,pose:{},autoOrtho:!0,targetPhi:e}),this.getFlyinStartPose=(e,t,i=this.cameraData)=>{var o;const s=null!==(o=e.position)&&void 0!==o?o:new r.Vector3,n=t||i.pose.position,a=s.y-n.y,h=(0,v.bw)(s,n,this.visibleMeshBounds.getCenterOfMass()),d=l.B1.FORWARD.clone().applyQuaternion(h),c=Math.sign(d.y)*Math.PI/4;return{position:(0,v.fR)(s,n,c,!0).setY(1.5*a)}},this.getFlyinEndPose=async e=>{var t,i;const o=e.position||(null===(i=this.sweepData.getSweep(null!==(t=e.sweepID)&&void 0!==t?t:"invalid"))||void 0===i?void 0:i.position)||new r.Vector3,s=e.rotation||new r.Quaternion,n=Math.PI/180*d.Bv.fov;return await this.visibleMeshBounds.initialDataLoaded,(0,v.hm)({targetPosition:o,targetRotation:s,angleDown:-Math.PI/6,box:this.visibleMeshBounds.getVisibleBounds(),fovY:n,aspectRatio:this.cameraData.aspectRatio})}}async init(e,t){var i;this.engine=t,this.market=t.market,this.data.currentMode=null!==(i=e.startingMode)&&void 0!==i?i:n.N3.Dollhouse,this.market.register(c.X,this.data),t.market.waitForData(T.U).then((e=>{this.meshData=e,this.setDollhouseBounds()})),this.bindings.push(t.commandBinder.addBinding(x.x,this.lockViewmode.bind(this)),t.commandBinder.addBinding(x._,this.unlockViewmode.bind(this)));const[o,a,r,l]=await Promise.all([t.getModuleBySymbol(s.jh),t.getModuleBySymbol(s.Wh),t.getModuleBySymbol(s.Qm),t.getModuleBySymbol(s.UN)]);this.cameraModule=o,this.sweepModule=a,this.visibleMeshBounds=l,this.sweepData=a.data,this.cameraData=o.cameraData,this.viewportModule=r}lockViewmode(){this.data.viewmodeChangeEnabled=!1,this.data.commit()}unlockViewmode(){this.data.viewmodeChangeEnabled=!0,this.data.commit()}get currentMode(){return this.data.currentMode}async switchToMode(e,t=a.fl.FadeToBlack,i,r,l,h=this.cameraData,d=this.sweepData.state.currentObservable){var c;P.Vy.for(this).debug(`switchToMode mode:${n.N3[e]} type:${a.fl[t]}`);const v=this.fixHighPhiPose(e,i),f=!v||v&&!A.willPoseChange(h,d,v);if(this.isAlreadyInMode(e)&&f)return;if(!I.includes(e)||this.data.isFloorplanDisabled()&&e===n.N3.Floorplan||this.data.isDollhouseDisabled()&&e===n.N3.Dollhouse||this.data.isExteriorDisabled()&&e===n.N3.ExteriorSplat)throw new g.dj(`Cannot change to invalid viewmode ${e}`);this.meshData||e!==n.N3.Floorplan&&e!==n.N3.Dollhouse||await(await this.engine.getModuleBySymbol(s.GR)).firstMeshLoadPromise,(null===(c=this.engine.market.tryGetData(F.O))||void 0===c?void 0:c.hasSplats)&&e===n.N3.ExteriorSplat&&await(await this.engine.getModuleBySymbol(s.Fn)).waitForLoad();const y=!h.canTransition();if(!this.data.canStartTransition()||y)throw new g.Xy;if(e!==this.currentMode&&!this.data.viewmodeChangeEnabled)throw new g.ke;this.engine.broadcast(new k.A(e)),d.currentSweep&&this.sweepData.isSweepUnaligned(d.currentSweep)&&!(0,n.nI)(e)&&(t=a.fl.FadeToBlack);let D=void 0!==r?r:B[e],b=0;t!==a.fl.Instant&&t!==a.fl.FadeToBlack||(t===a.fl.FadeToBlack&&(b=D),D=0);const S=b>0;let M=e;e===n.N3.Floorplan&&(M=n.N3.Dollhouse),S&&(t=a.fl.Instant);const T=Object.assign({},this.data.transition),x=this.data.currentMode,C=()=>{const t=e===n.N3.Floorplan?0:1;this.data.transition.active=!0,this.data.activateTransition(this.data.currentMode,M,D,h.pose.pitchFactor(),t),this.data.currentMode=n.N3.Transition,this.data.commit(),this.engine.broadcast(new m.A(M,null!=x?x:void 0))};let V=!1;const O=e=>{this.data.transition.progress=e,this.data.commit(),e>=.5&&!V&&(V=!0,this.engine.broadcast(new p.Y(M,null!=x?x:void 0)))},N=()=>{this.data.transition.active=!1,this.data.transition.progress=1,this.data.currentMode=M,this.data.deactivateTransition(),this.data.commit()},E=async(e,t)=>{if(S){const i=this.cameraModule.getCameraControllerForData(h).moveTo({transitionType:a.fl.FadeToBlack,fadeToBlackSubType:e,pose:{},transitionTime:b/2});i.progress((e=>O(t+e/2))),await i}},R=(0,w.aY)(h.pose.pitchFactor()),_=v&&v.position&&v.rotation;let L=!1;const z=x===n.N3.Dollhouse||x===n.N3.Floorplan||x===n.N3.ExteriorSplat,U=[];!R||e!==n.N3.Dollhouse&&e!==n.N3.ExteriorSplat?!z||e!==n.N3.Floorplan||_||l?R&&z&&(e===n.N3.Panorama||e===n.N3.Mesh)&&U.push((()=>this.snapToPhiLimit(a.mG.Bottom,D,h))):(_||(L=!0),U.push((()=>this.snapToPhiLimit(a.mG.Top,D,h)))):(_||(L=!0),U.push((()=>this.snapToPhiLimit(a.mG.Bottom,D,h))));let G=null,j=!1;if(!L||l){let i=v;switch(e){case n.N3.Mesh:case n.N3.Panorama:const s=[],a=h.id===this.cameraData.id?this.cameraModule.getCameraDataForViewport(this.viewportModule.viewportManager.activeViewport.id):h;for(const e of this.viewportModule.viewportManager.viewports){const i=this.cameraModule.getCameraDataForViewport(e.id),o=this.sweepData.getStateForViewport(e.id);i.id===a.id&&o.id===d.id?s.push((()=>this.moveCameraToPanorama(x,t,D,v,h,d))):o.currentSweep&&s.push((()=>this.moveCameraToPanorama(x,t,D,void 0,i,o)))}const r=new o.iB;G=()=>{const e=s.map((e=>e())),t=e[0];return null==t||t.progress((e=>{r.notify(e)})),Promise.all(e).then((()=>{r.notify(1),r.resolve()})),r.promise()};break;case n.N3.Floorplan:const l=R||0===D;if(i=this.getPeekabooDollhousePoseFromFloorplanPose(v,l),l&&i){h.setAutoOrtho(!0),G=()=>i?this.cameraModule.getCameraControllerForData(h).moveTo({transitionType:t,pose:i,transitionTime:D,focalDistance:i.focalDistance,autoOrtho:!0}):o.iB.resolve();break}j=!0;case n.N3.Dollhouse:case n.N3.ExteriorSplat:h.setAutoOrtho(!0),G=()=>this.moveCameraToDollhouse(t,D,i,j,h,!0);break;case n.N3.Orthographic:h.setAutoOrtho(!1),G=()=>this.moveCameraToOrthographic(null!=x?x:void 0,t,D,v,h);break;default:throw new g.dj(`Invalid target mode ${e}`)}}G&&U.push(G),(!R&&x!==n.N3.Dollhouse&&x!==n.N3.ExteriorSplat&&e===n.N3.Floorplan||j)&&U.push((()=>this.snapToPhiLimit(a.mG.Top,D,h)));try{const e=U.length;C(),await E(a.pw.ClearToBlack,0);for(let t=0;t<e;t++){const i=t/e,o=U[t]();S||o.progress((t=>O(t/e+i))),await o}await E(a.pw.BlackToClear,.5),N()}catch(e){throw this.data.currentMode=x,this.data.transition=T,this.data.commit(),e}L||this.engine.broadcast(new u.A(M,null!=x?x:void 0))}isAlreadyInMode(e){const{data:t}=this,i=t.transition.from===t.transition.to;let o=t.currentMode===e;const s=t.currentMode===n.N3.Floorplan||t.currentMode===n.N3.Dollhouse;let a=t.currentMode;return s&&(a=(0,w.aY)(this.cameraData.pose.pitchFactor())?n.N3.Floorplan:n.N3.Dollhouse),o=a===e,t.transition.active&&i||o}static willPoseChange(e,t,i){return void 0!==i.position&&!e.pose.position.equals(i.position)||void 0!==i.rotation&&!e.pose.rotation.equals(i.rotation)||void 0!==i.zoom&&e.zoom()!==i.zoom||void 0!==i.sweepID&&i.sweepID!==t.currentSweep}moveCameraToPanorama(e,t,i,o,s=this.cameraData,a=this.sweepData.state){var h,c;let u=null!==(h=null==o?void 0:o.sweepID)&&void 0!==h?h:a.currentSweep;u||(u=null===(c=this.sweepData.getFirstSweep())||void 0===c?void 0:c.id);let m=null==o?void 0:o.rotation;if(!m){const t=(e===n.N3.Floorplan?l.B1.UP:l.B1.FORWARD).clone().applyQuaternion(s.pose.rotation).setY(0).normalize();m=(new r.Quaternion).setFromUnitVectors(l.B1.FORWARD,t)}const p=(0,d.hn)(this.cameraData.aspect());return this.sweepModule.moveToSweep({transitionType:t,sweepId:u,viewId:null==o?void 0:o.viewId,rotation:m,transitionTime:i,rotationDelay:.5,projection:p,cameraData:s,sweepDataState:a})}moveCameraToDollhouse(e,t,i,o=!1,s=this.cameraData,a=!1){var h;const c=this.visibleMeshBounds.getVisibleBounds(),u=this.visibleMeshBounds.getCenterOfMass(),m={};let p,g=t;if(i&&(i.position||i.rotation)){if(i.position&&i.rotation){m.position=i.position,m.rotation=i.rotation;const e=(new r.Vector3).copy(u);if((0,w.rC)(i.rotation)*f.tm>5){const t=Math.min(u.y,i.position.y-1),o=new r.Plane(l.B1.UP.clone(),t),s=(0,v.qK)(m.position,m.rotation,o);s&&e.copy(s)}p=m.position.distanceTo(e),m.rotation=(0,v.kf)(i.position,e)}else if(i.position)m.position=i.position,m.rotation=(0,v.kf)(i.position,u);else{m.rotation=null!==(h=i.rotation)&&void 0!==h?h:new r.Quaternion;const e=c.min.distanceTo(c.max);m.position=(0,v.fg)(m.rotation,u,e)}p||(p=u.clone().distanceTo(m.position))}else{const e=this.sweepData.isSweepUnaligned(this.sweepData.state.currentSweep);let t=s.pose.position;if(e||this.data.transition.from===n.N3.Floorplan?t=u:this.data.transition.from!==n.N3.Dollhouse&&this.data.transition.from!==n.N3.ExteriorSplat||(t=s.pose.focalPoint().clone().add(new r.Vector3(0,1,0))),this.data.transition.from!==n.N3.Floorplan){const e=((e,t,i,o,s=!1)=>{const n=30*f.fy,a=o<1,h=1.2*D(i),d=e.clone().add(new r.Vector3(0,-1,0)),c=(0,w.rC)(t),u=t.clone().multiply((new r.Quaternion).setFromAxisAngle(l.B1.RIGHT,c));let m=u;if(s){const e=i.getCenter(new r.Vector3);d.x=e.x,d.z=e.z;const t=i.getSize(new r.Vector3),o=t.x/t.z<1,s=l.B1.FORWARD.clone().applyQuaternion(u).normalize(),n=a===o?new r.Vector3(0,0,-(Math.sign(s.z)||1)):new r.Vector3(-(Math.sign(s.x)||1),0,0);m=(0,v.LM)(new r.Quaternion,(new r.Vector3).crossVectors(l.B1.UP,n),l.B1.UP,n),d.add(n.clone().multiplyScalar(1))}const p=m.multiply((new r.Quaternion).setFromAxisAngle(l.B1.RIGHT,-n)),g=l.B1.FORWARD.clone().applyQuaternion(p);return{position:d.clone().add(g.clone().multiplyScalar(-h)),rotation:p,focalDistance:h}})(t,s.pose.rotation,c,this.cameraData.aspectRatio,o);m.position=e.position,m.rotation=e.rotation,p=e.focalDistance;const i=m.position.distanceTo(s.pose.position)<V,n=m.rotation.angleTo(s.pose.rotation)<O;i&&n&&!a&&(g=0)}else p=((e,t,i)=>{const o=e.getCenter(new r.Vector3),s=D(e);return y(s,o,t,i)})(this.visibleMeshBounds.getVisibleBounds(),s.pose.rotation,m)}return this.cameraModule.getCameraControllerForData(s).moveTo({transitionType:e,pose:m,transitionTime:g,autoOrtho:!0,projection:(0,d.hn)(s.aspect()),focalDistance:p,rotationDuration:.5})}setDollhouseBounds(){const e=this.meshData.extendedBounds,t=e.min.distanceTo(e.max);this.minDollhouseDistance=Math.min(t/2,this.minDollhouseDistance),this.maxDollhouseDistance=Math.max(t,this.maxDollhouseDistance)}moveCameraToOrthographic(e,t,i,o,s){const n=o&&o.zoom?o.zoom:this.getDefaultFloorplanZoom(this.meshData.extendedSize),a=(0,d.Ei)(this.cameraData.width,this.cameraData.height,n,1,void 0,void 0,this._orthoMatrix),r=this.cameraModule.getCameraControllerForData(s);r.setBaseProjection(a);const l={easing:S.WD,transitionType:t,pose:o||{},transitionTime:i,projection:a,focalDistance:2};return r.moveTo(l)}getPeekabooDollhousePoseFromFloorplanPose(e,t=!1){let i;if(e&&e.position&&e.rotation&&e.zoom){const o=e.position,s=e.rotation,n=(0,v.xF)(e.zoom),a=this.visibleMeshBounds.computeFocusPoint(new r.Ray(o,l.B1.DOWN));t?i={position:new r.Vector3(o.x,this.meshData.meshCenter.y+n,o.z),rotation:e.rotation.clone(),focalDistance:n}:(i={position:new r.Vector3,rotation:new r.Quaternion,focalDistance:n},y(n,a,s,i))}return i}fixHighPhiPose(e,t){if(t){if((null==t?void 0:t.isPitchFactorOrtho)&&e===n.N3.Dollhouse)return void P.Vy.for(this).warn(`mode: ${n.N3[e]} cannot be reached with specific targetPose because targetPose's pitch is too high. targetPose was ignored`);const i=(0,h.b)(t);if(i.rotation&&i.position&&(0,w.rC)(i.rotation)>C.oO&&(e===n.N3.Dollhouse||e===n.N3.ExteriorSplat)){const[e,t]=this.setPhi(i.position,i.rotation);i.position=i.position.clone().add(t),i.rotation=e}return i}}setPhi(e,t){var i;const o=(0,w.rC)(t),s=(null===(i=this.meshData)||void 0===i?void 0:i.meshCenter.y)||0,n=Math.abs(s-e.y)*Math.tan(Math.abs(C.oO-o)),a=t.clone().multiply((new r.Quaternion).setFromAxisAngle(l.B1.RIGHT,o)).multiply((new r.Quaternion).setFromAxisAngle(l.B1.RIGHT,-C.oO)),h=l.B1.UP.clone().applyQuaternion(a);return h.y=0,h.normalize().multiplyScalar(-n),[a,h]}getDefaultFloorplanZoom(e){const t=Math.max(e.x,e.z),i=Math.min(e.x,e.z),o=this.cameraData.aspectRatio,s=Math.max(t,i/o),n=Math.max(i,t/o),a=o<1?s:n;return this.cameraData.height/(1.2*a)}}},87389:(e,t,i)=>{"use strict";i.d(t,{A:()=>s});var o=i(68909);class s extends o.BufferGeometry{constructor(){const e=new Float32Array([-1,1,0,-1,-1,0,1,-1,0,1,1,0]);super(),this.setAttribute("position",new o.Float32BufferAttribute(e,3)),this.setIndex([0,1,2,0,2,3])}}},23870:(e,t,i)=>{"use strict";i.d(t,{A:()=>n});const o=e=>""+e;class s{constructor(e=o){this.mappingFunction=e,this.list=[],this.map=new Map}add(e){const t=this.mappingFunction(e);return!this.map.has(t)&&(this.list.push(e),this.map.set(t,e),!0)}set(e){const t=this.mappingFunction(e);return this.map.has(t)?(this.map.set(t,e),!0):(this.add(e),!0)}count(){return this.list.length}*[Symbol.iterator](){for(const e of this.list)yield e}getByIndex(e){return this.list[e]}get(e){return this.map.get(e)}copyToList(e){return e.push(...this.list),e}clear(){this.list=[],this.map=new Map}mapElements(e){return this.list.map(e)}values(){return this.list.slice()}}const n=s},4330:(e,t,i)=>{"use strict";i.d(t,{b:()=>o,f:()=>s});const o=e=>({position:e.position?e.position.clone():void 0,rotation:e.rotation?e.rotation.clone():void 0,viewmode:e.viewmode?e.viewmode:void 0,sweepID:e.sweepID?e.sweepID:void 0,viewId:e.viewId,zoom:e.zoom?e.zoom:void 0,focalDistance:e.focalDistance?e.focalDistance:void 0,isPitchFactorOrtho:null!=e.isPitchFactorOrtho?e.isPitchFactorOrtho:void 0}),s=(e,t)=>{var i,o,s,n;return Object.assign({position:null===(i=e.camera.position)||void 0===i?void 0:i.clone(),rotation:null===(o=e.camera.rotation)||void 0===o?void 0:o.clone(),zoom:null===(s=e.camera)||void 0===s?void 0:s.zoom,viewmode:e.mode,sweepID:null===(n=e.pano)||void 0===n?void 0:n.uuid,viewId:void 0,focalDistance:void 0,isPitchFactorOrtho:void 0},t)}},3035:(e,t,i)=>{"use strict";async function o(e,t){if(await e.transition.promise,!t.canStartTransition()){const e=new Promise((e=>{const i=t.onChanged((()=>{t.canStartTransition()&&(i.cancel(),e())}))}));await e}}i.d(t,{L:()=>o})},28337:(e,t,i)=>{"use strict";var o;i.d(t,{$:()=>o}),function(e){e[e.DOWN=0]="DOWN",e[e.PRESSED=1]="PRESSED",e[e.UP=2]="UP"}(o||(o={}))},72268:(e,t,i)=>{"use strict";var o,s;i.d(t,{O:()=>s,m:()=>o}),function(e){e[e.PRIMARY=0]="PRIMARY",e[e.MIDDLE=1]="MIDDLE",e[e.SECONDARY=2]="SECONDARY",e[e.BACK=3]="BACK",e[e.FORWARD=4]="FORWARD",e[e.COUNT=5]="COUNT"}(o||(o={})),function(e){e[e.NONE=0]="NONE",e[e.PRIMARY=1]="PRIMARY",e[e.SECONDARY=4]="SECONDARY",e[e.MIDDLE=2]="MIDDLE",e[e.BACK=8]="BACK",e[e.FORWARD=16]="FORWARD",e[e.ALL=31]="ALL"}(s||(s={}))},51666:(e,t,i)=>{"use strict";i.d(t,{Z:()=>s});var o=i(25481);function s(e){if(e&&"object"==typeof e&&"x"in e&&"y"in e&&"z"in e){const t=e;return(0,o.Et)(t.x)&&(0,o.Et)(t.y)&&(0,o.Et)(t.z)}return!1}},52492:e=>{e.exports="precision highp float;precision highp int;vec3 closestPointToRay(vec3 point,vec3 origin,vec3 direction){vec3 d=point-origin;float D=dot(d,direction);return origin+D*direction;}vec3 rayIntersectsSphere(vec3 origin,float radius,vec3 rayOrigin,vec3 rayDirection){vec3 chordPoint=closestPointToRay(origin,rayOrigin,rayDirection);float D1=length(rayOrigin-chordPoint);float D=length(chordPoint-origin);float D2=sqrt(radius*radius-D*D);return rayOrigin+(D1+D2)*rayDirection;}uniform float borderSize;uniform float textureSampleScale;uniform samplerCube panoTexture;uniform vec4 borderColor;varying vec2 vUv;const vec4 transparent=vec4(0.,0.,0.,0.);const float PI=3.14159265359;const float HALF_PI=PI/2.;void main(){float fadeDist=0.1;float r=1.;vec2 uv=(vUv*2.)-vec2(1.,1.);float d=length(uv);float p=d*PI-HALF_PI;float y=sin(p);float h=cos(p)*textureSampleScale;vec3 sampleVec=vec3(uv.x*h,y,uv.y*h);vec4 panoColor=textureCube(panoTexture,sampleVec);panoColor.a=clamp(((1.-d)/d)/fadeDist,0.,1.);vec4 outColor=mix(panoColor,transparent,step(1.,d));float isBorder=max(sign(borderSize),0.)*step(1.-borderSize,d)*step(d,1.);gl_FragColor=linearToOutputTexel(mix(outColor,borderColor,isBorder));}"},70694:e=>{e.exports="precision highp float;precision highp int;varying vec2 vUv;void main(){vUv=uv;vec4 projectedPosition=projectionMatrix*viewMatrix*modelMatrix*vec4(position,1.);gl_Position=projectedPosition;}"},50652:e=>{e.exports="precision highp float;precision highp int;vec3 closestPointToRay(vec3 point,vec3 origin,vec3 direction){vec3 d=point-origin;float D=dot(d,direction);return origin+D*direction;}vec3 rayIntersectsSphere(vec3 origin,float radius,vec3 rayOrigin,vec3 rayDirection){vec3 chordPoint=closestPointToRay(origin,rayOrigin,rayDirection);float D1=length(rayOrigin-chordPoint);float D=length(chordPoint-origin);float D2=sqrt(radius*radius-D*D);return rayOrigin+(D1+D2)*rayDirection;}uniform sampler2D bg;uniform sampler2D mask;varying vec2 vUv;void main(){vec4 existingColor=texture2D(bg,vUv);vec4 maskColor=texture2D(mask,vUv);gl_FragColor=linearToOutputTexel(vec4(existingColor.rgb*maskColor.rgb,maskColor.a));}"},91254:e=>{e.exports="precision highp float;precision highp int;varying vec2 vUv;void main(){vUv=uv;gl_Position=projectionMatrix*modelMatrix*vec4(position,1.);}"},88140:e=>{e.exports="precision highp float;precision highp int;vec3 closestPointToRay(vec3 point,vec3 origin,vec3 direction){vec3 d=point-origin;float D=dot(d,direction);return origin+D*direction;}vec3 rayIntersectsSphere(vec3 origin,float radius,vec3 rayOrigin,vec3 rayDirection){vec3 chordPoint=closestPointToRay(origin,rayOrigin,rayDirection);float D1=length(rayOrigin-chordPoint);float D=length(chordPoint-origin);float D2=sqrt(radius*radius-D*D);return rayOrigin+(D1+D2)*rayDirection;}\n#define M_PI  3.14159265359\nuniform samplerCube cubemap;uniform float yaw;varying vec2 vUv;void main(){vec2 uv=vUv;float theta=uv.x*2.*M_PI+yaw;float phi=uv.y*M_PI;vec3 longitude=vec3(sin(theta),1.,-cos(theta));vec3 latitude=vec3(sin(phi),-cos(phi),sin(phi));vec3 dir=longitude*latitude;normalize(dir);gl_FragColor=linearToOutputTexel(vec4(textureCube(cubemap,dir).rgb,1.));}"},16249:e=>{e.exports="precision highp float;precision highp int;varying vec2 vUv;void main(){vUv=vec2(1.-uv.x,uv.y);gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}"},99515:e=>{e.exports="precision highp float;precision highp int;vec3 closestPointToRay(vec3 point,vec3 origin,vec3 direction){vec3 d=point-origin;float D=dot(d,direction);return origin+D*direction;}vec3 rayIntersectsSphere(vec3 origin,float radius,vec3 rayOrigin,vec3 rayDirection){vec3 chordPoint=closestPointToRay(origin,rayOrigin,rayDirection);float D1=length(rayOrigin-chordPoint);float D=length(chordPoint-origin);float D2=sqrt(radius*radius-D*D);return rayOrigin+(D1+D2)*rayDirection;}uniform vec3 topColor;uniform vec3 bottomColor;uniform float radius;varying vec3 rayOrigin;varying vec3 rayDirection;\n#define SRGB_TO_LINEAR(c)pow((c),vec3(2.2))\n#define LINEAR_TO_SRGB(c)pow((c),vec3(1./2.2))\n#define USE_DITHER \nfloat gradientNoise(in vec2 uv){const vec3 magic=vec3(0.06711056,0.00583715,52.9829189);return fract(magic.z*fract(dot(uv,magic.xy)));}void main(){vec3 worldPosition=rayIntersectsSphere(vec3(0.,0.,0.),radius,rayOrigin,normalize(rayDirection));float normalizedHeight=(worldPosition.y+radius)/(radius*2.);float ratio=smoothstep(0.,0.5,normalizedHeight);vec3 colorFromGradient=mix(SRGB_TO_LINEAR(bottomColor),SRGB_TO_LINEAR(topColor),ratio);vec3 color=LINEAR_TO_SRGB(colorFromGradient);\n#if defined (USE_DITHER)\ncolor+=(1./255.)*gradientNoise(gl_FragCoord.xy)-(0.5/255.);\n#endif\ngl_FragColor=linearToOutputTexel(vec4(color,1.));}"},91177:e=>{e.exports="precision highp float;precision highp int;varying vec3 rayOrigin;varying vec3 rayDirection;uniform mat4 cameraMatrix;uniform mat4 inverseProjectionMatrix;vec3 unproject(vec3 pos){vec4 v=cameraMatrix*inverseProjectionMatrix*vec4(pos,1.);return vec3(v.xyz/v.w);}void main(){rayOrigin=unproject(vec3(position.xy,-1.));vec3 end=unproject(vec3(position.xy,1.));rayDirection=normalize(end-rayOrigin);gl_Position=vec4(position,1.);}"}}]);